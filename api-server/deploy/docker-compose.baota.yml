version: '3.8'

services:
  # API服务器
  api:
    build: 
      context: ../
      dockerfile: ./api-server/Dockerfile
    image: clothing-space-capsule-api:latest
    container_name: clothing-api
    ports:
      - "4001:4001"
    environment:
      - NODE_ENV=production
      - PORT=4001
      # 数据库连接使用docker网络
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-19840911}@db:5432/clothing_capsule_db
      # 从.env文件读取其他环境变量
      - JWT_SECRET=${JWT_SECRET}
      - WECHAT_APP_ID=${WECHAT_APP_ID}
      - WECHAT_APP_SECRET=${WECHAT_APP_SECRET}
      - WECHAT_TOKEN=${WECHAT_TOKEN}
      - RUNNINGHUB_API_KEY=${RUNNINGHUB_API_KEY}
      - RUNNINGHUB_BASE_URL=${RUNNINGHUB_BASE_URL}
      - COS_SECRET_ID=${COS_SECRET_ID}
      - COS_SECRET_KEY=${COS_SECRET_KEY}
      - COS_REGION=${COS_REGION}
      - COS_BUCKET=${COS_BUCKET}
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
      - ./public:/app/public
    restart: unless-stopped
    depends_on:
      - db
      - db-init
    networks:
      - clothing-network

  # PostgreSQL数据库
  db:
    image: postgres:15-alpine
    container_name: clothing-db
    environment:
      POSTGRES_DB: clothing_capsule_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-19840911}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    restart: unless-stopped
    networks:
      - clothing-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 数据库初始化服务
  db-init:
    image: clothing-space-capsule-api:latest
    container_name: clothing-db-init
    environment:
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-19840911}@db:5432/clothing_capsule_db
    volumes:
      - ./logs:/app/logs
    command: >
      sh -c "
        echo '等待数据库启动...' &&
        sleep 15 &&
        echo '运行数据库迁移...' &&
        npx prisma migrate deploy &&
        echo '运行种子数据...' &&
        npx prisma db seed &&
        echo '数据库初始化完成'
      "
    depends_on:
      - db
    networks:
      - clothing-network

  # Redis缓存（可选，用于会话存储或缓存）
  redis:
    image: redis:7-alpine
    container_name: clothing-redis
    ports:
      - "6379:6379"
    restart: unless-stopped
    networks:
      - clothing-network
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # Nginx反向代理
  nginx:
    image: nginx:alpine
    container_name: clothing-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/certs:/etc/nginx/certs
      - ./public:/var/www/public
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - clothing-network

volumes:
  postgres_data:
  redis_data:

networks:
  clothing-network:
    driver: bridge