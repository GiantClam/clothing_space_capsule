<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•è¡£æœåŠ è½½é—®é¢˜</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>è¡£æœåŠ è½½è°ƒè¯•å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·ä¸“é—¨ç”¨äºè°ƒè¯•"API Server æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®"çš„é—®é¢˜</p>
        
        <div>
            <button onclick="debugClothingLoad()">è°ƒè¯•æœè£…åŠ è½½æµç¨‹</button>
            <button onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
            <button onclick="testDeviceAuth()">æµ‹è¯•è®¾å¤‡è®¤è¯</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div id="status"></div>
        <div id="log"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿé…ç½®å­˜å‚¨
        let appConfig = {
            server: {
                host: 'localhost',
                port: 4001
            }
        };

        // æ¨¡æ‹Ÿå…¨å±€çŠ¶æ€
        const appState = {
            getConfig: () => appConfig,
            setConfig: (config) => appConfig = config
        };

        // åˆ›å»ºAPIå®¢æˆ·ç«¯å®ä¾‹ - ä½¿ç”¨ä¸å®é™…åº”ç”¨ç›¸åŒçš„ä»£ç 
        class ApiClient {
            constructor() {
                this.baseUrl = 'http://localhost:4001';
                this.token = null;
                this.deviceId = null;
                this.initialized = false;
            }

            async initialize() {
                if (this.initialized) return;
                
                try {
                    log('ğŸ”„ å¼€å§‹åˆå§‹åŒ–APIå®¢æˆ·ç«¯é…ç½®...');
                    
                    if (typeof appState !== 'undefined' && appState.getConfig) {
                        const config = appState.getConfig();
                        log('ğŸ“„ è·å–åˆ°é…ç½®: ' + JSON.stringify({
                            serverHost: config.server?.host || 'æœªè®¾ç½®',
                            serverPort: config.server?.port || 'æœªè®¾ç½®'
                        }));
                        
                        if (config.server && config.server.host && config.server.port) {
                            const protocol = config.server.host.includes('localhost') || 
                                           config.server.host.includes('127.0.0.1') ? 'http' : 'https';
                            this.baseUrl = `${protocol}://${config.server.host}:${config.server.port}`;
                            log('âœ… ä½¿ç”¨é…ç½®é¡µé¢è®¾ç½®çš„æœåŠ¡å™¨åœ°å€: ' + this.baseUrl);
                        } else {
                            log('âš ï¸ é…ç½®é¡µé¢ä¸­æœªè®¾ç½®æœåŠ¡å™¨åœ°å€ï¼Œä½¿ç”¨é»˜è®¤åœ°å€: ' + this.baseUrl);
                        }
                    }
                    
                    this.initialized = true;
                    log('ğŸš€ APIå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆï¼Œç›®æ ‡åœ°å€: ' + this.baseUrl);
                } catch (error) {
                    log('âŒ APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                    this.initialized = true;
                }
            }

            async request(endpoint, options = {}) {
                await this.initialize();
                
                const url = `${this.baseUrl}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                };

                if (this.token) {
                    config.headers['Authorization'] = `Bearer ${this.token}`;
                }

                try {
                    log(`ğŸ“¤ APIè¯·æ±‚: ${config.method || 'GET'} ${url}`);
                    const response = await fetch(url, config);
                    const data = await response.json();

                    if (!response.ok) {
                        log(`âŒ APIè¯·æ±‚å¤±è´¥ [${endpoint}]: ${response.status} ${response.statusText}`);
                        log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(data, null, 2)}`);
                        throw new Error(data.error || `HTTP ${response.status}`);
                    }

                    log(`âœ… APIè¯·æ±‚æˆåŠŸ [${endpoint}]: ${data.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                    return data;
                } catch (error) {
                    log(`âŒ API è¯·æ±‚å¤±è´¥ [${endpoint}]: ${error.message}`);
                    throw error;
                }
            }

            async authenticateDevice(macAddress, deviceName) {
                const response = await this.request('/api/auth/device', {
                    method: 'POST',
                    body: JSON.stringify({ macAddress, deviceName })
                });

                if (response.success) {
                    this.token = response.token;
                    this.deviceId = response.device.id;
                    return response;
                }

                throw new Error(response.error || 'è®¾å¤‡è®¤è¯å¤±è´¥');
            }

            async getClothingCategories() {
                return await this.request('/api/clothes/categories');
            }

            async getClothingByCategory(categoryId, params = {}) {
                const queryString = new URLSearchParams(params).toString();
                const endpoint = queryString ? 
                    `/api/clothes/category/${categoryId}?${queryString}` : 
                    `/api/clothes/category/${categoryId}`;
                return await this.request(endpoint);
            }
        }

        const apiClient = new ApiClient();
        window.apiClient = apiClient;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('status').innerHTML = '';
        }

        async function testApiConnection() {
            try {
                log('ğŸ” å¼€å§‹æµ‹è¯•APIè¿æ¥...');
                await apiClient.initialize();
                
                const health = await apiClient.request('/health');
                log('å¥åº·æ£€æŸ¥ç»“æœ: ' + JSON.stringify(health, null, 2));
                showStatus('âœ… APIè¿æ¥æµ‹è¯•é€šè¿‡', 'success');
            } catch (error) {
                log('APIè¿æ¥å¤±è´¥: ' + error.message);
                showStatus('âŒ APIè¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function testDeviceAuth() {
            try {
                log('ğŸ” å¼€å§‹æµ‹è¯•è®¾å¤‡è®¤è¯...');
                const macAddress = 'debug-mac-' + Date.now();
                const deviceName = 'è°ƒè¯•è®¾å¤‡';
                
                const response = await apiClient.authenticateDevice(macAddress, deviceName);
                log('è®¾å¤‡è®¤è¯ç»“æœ: ' + JSON.stringify(response, null, 2));
                showStatus('âœ… è®¾å¤‡è®¤è¯æˆåŠŸ', 'success');
            } catch (error) {
                log('è®¾å¤‡è®¤è¯å¤±è´¥: ' + error.message);
                showStatus('âŒ è®¾å¤‡è®¤è¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function debugClothingLoad() {
            try {
                log('ğŸš€ å¼€å§‹è°ƒè¯•æœè£…åŠ è½½æµç¨‹...');
                log('æ¨¡æ‹Ÿå®¢æˆ·ç«¯app.jsä¸­çš„loadClothingItemså‡½æ•°...');
                
                // æ¨¡æ‹Ÿå½“å‰çŠ¶æ€
                const activeCategory = 'tops-bottoms';
                const activeGender = 'female';
                const currentSubCategory = 'tops';
                
                log('ğŸ‘• å¼€å§‹åŠ è½½æœè£…æ•°æ®: ' + JSON.stringify({
                    category: activeCategory,
                    gender: activeGender,
                    subCategory: currentSubCategory,
                    hasApiClient: !!window.apiClient,
                    hasToken: window.apiClient?.token ? 'æœ‰token' : 'æ— token'
                }));
                
                // é¦–å…ˆå°è¯•ä» API Server è·å–æ•°æ®
                let itemsToShow = [];
                
                if (window.apiClient && window.apiClient.token) {
                    try {
                        log('ğŸ” å°è¯•ä»APIæœåŠ¡å™¨è·å–åˆ†ç±»æ•°æ®...');
                        const categories = await window.apiClient.getClothingCategories();
                        log('ğŸ“‚ è·å–åˆ°åˆ†ç±»æ•°æ®: ' + JSON.stringify(categories, null, 2));
                        
                        const genderCategory = categories.data.find(cat => 
                            cat.name === (activeGender === 'male' ? 'ç”·è£…' : 'å¥³è£…')
                        );
                        log('ğŸ‘¤ æŸ¥æ‰¾æ€§åˆ«åˆ†ç±»: ' + JSON.stringify({
                            looking: activeGender === 'male' ? 'ç”·è£…' : 'å¥³è£…',
                            found: !!genderCategory,
                            available: categories.data.map(cat => cat.name)
                        }));
                        
                        if (genderCategory) {
                            let subCategoryId = null;
                            
                            if (activeCategory === 'tops-bottoms' && currentSubCategory) {
                                const subCategoryName = currentSubCategory === 'tops' ? 'å¤–å¥—' : 'è£¤å­';
                                const subCategory = genderCategory.children.find(child => 
                                    child.name === subCategoryName
                                );
                                subCategoryId = subCategory ? subCategory.id : null;
                                log('ğŸ” æŸ¥æ‰¾å­åˆ†ç±»: ' + JSON.stringify({
                                    looking: subCategoryName,
                                    found: !!subCategory,
                                    available: genderCategory.children.map(child => child.name),
                                    subCategoryId
                                }));
                            }
                            
                            if (subCategoryId) {
                                log('ğŸ‘” è·å–åˆ†ç±»æœè£…æ•°æ®: ' + subCategoryId);
                                const clothesResponse = await window.apiClient.getClothingByCategory(subCategoryId);
                                log('ğŸ“¦ è·å–åˆ°æœè£…æ•°æ®: ' + JSON.stringify(clothesResponse, null, 2));
                                
                                itemsToShow = clothesResponse.data.clothes.map(item => ({
                                    id: item.id,
                                    name: item.name,
                                    image: item.imageUrl,
                                    description: item.description,
                                    prompt: item.prompt,
                                    youzanUrl: item.youzanUrl
                                }));
                                log('âœ… æ˜ å°„åçš„æœè£…æ•°æ®: ' + itemsToShow.length + ' ä»¶');
                            } else {
                                log('âš ï¸ æœªæ‰¾åˆ°å¯¹åº”çš„å­åˆ†ç±»ID');
                            }
                        } else {
                            log('âš ï¸ æœªæ‰¾åˆ°å¯¹åº”çš„æ€§åˆ«åˆ†ç±»');
                        }
                    } catch (apiError) {
                        log('âŒ APIæœåŠ¡å™¨æ•°æ®è·å–å¤±è´¥: ' + apiError.message);
                    }
                } else {
                    log('âš ï¸ APIå®¢æˆ·ç«¯æœªå‡†å¤‡å¥½: ' + JSON.stringify({
                        hasApiClient: !!window.apiClient,
                        hasToken: window.apiClient?.token ? 'æœ‰token' : 'æ— token'
                    }));
                }
                
                // å¦‚æœ API Server æ•°æ®è·å–å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°æ•°æ®
                if (itemsToShow.length === 0) {
                    log('API Server æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                    showStatus('âš ï¸ API Server æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'warning');
                } else {
                    log('âœ… æˆåŠŸä»API Serverè·å–åˆ° ' + itemsToShow.length + ' ä»¶æœè£…');
                    showStatus('âœ… æˆåŠŸä»API Serverè·å–æœè£…æ•°æ®', 'success');
                }
                
                log('è°ƒè¯•å®Œæˆï¼');
                
            } catch (error) {
                log('è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
                showStatus('âŒ è°ƒè¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è‡ªåŠ¨åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            log('ğŸš€ è°ƒè¯•å·¥å…·å·²å¯åŠ¨');
            log('ç›®æ ‡APIæœåŠ¡å™¨: ' + apiClient.baseUrl);
            
            // è‡ªåŠ¨æµ‹è¯•APIè¿æ¥
            setTimeout(testApiConnection, 1000);
        });
    </script>
</body>
</html>