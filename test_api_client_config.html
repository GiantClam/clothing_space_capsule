<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIå®¢æˆ·ç«¯é…ç½®æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ccc;
        }
        .success {
            background-color: #e8f5e8;
            border-left-color: #4caf50;
        }
        .error {
            background-color: #ffeaea;
            border-left-color: #f44336;
        }
        .warning {
            background-color: #fff3cd;
            border-left-color: #ff9800;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .config-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
            margin: 5px;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>APIå®¢æˆ·ç«¯é…ç½®æµ‹è¯•</h1>
        <p>æµ‹è¯•APIå®¢æˆ·ç«¯æ˜¯å¦æ­£ç¡®ä½¿ç”¨é…ç½®é¡µé¢è®¾ç½®çš„æœåŠ¡å™¨åœ°å€</p>
        
        <div class="config-section">
            <h3>æ¨¡æ‹Ÿé…ç½®è®¾ç½®</h3>
            <div>
                <label>æœåŠ¡å™¨Host:</label>
                <input type="text" id="server-host" value="localhost" />
            </div>
            <div>
                <label>æœåŠ¡å™¨Port:</label>
                <input type="number" id="server-port" value="4001" />
            </div>
            <button onclick="updateConfig()">æ›´æ–°é…ç½®</button>
        </div>
        
        <div>
            <button onclick="testCurrentConfig()">æµ‹è¯•å½“å‰é…ç½®</button>
            <button onclick="testApiClientInit()">æµ‹è¯•APIå®¢æˆ·ç«¯åˆå§‹åŒ–</button>
            <button onclick="testDifferentPorts()">æµ‹è¯•ä¸åŒç«¯å£</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div id="results"></div>
        
        <h3>è¯¦ç»†æ—¥å¿—</h3>
        <div id="log"></div>
    </div>

    <script>
        // æ¨¡æ‹ŸappState
        class MockAppState {
            constructor() {
                this.configCache = null;
            }
            
            getConfig() {
                if (this.configCache) {
                    return this.configCache;
                }
                
                return {
                    runninghub: {
                        apiKey: '',
                        baseUrl: 'https://www.runninghub.cn',
                        singleItemWorkflowId: '',
                        topBottomWorkflowId: ''
                    },
                    wechat: {
                        appId: '',
                        appSecret: '',
                        token: '',
                        encodingAESKey: ''
                    },
                    server: {
                        host: 'localhost',
                        port: 4001
                    }
                };
            }
            
            setConfig(config) {
                this.configCache = config;
                localStorage.setItem('appConfig', JSON.stringify(config));
            }
        }

        // åˆ›å»ºå…¨å±€appState
        const appState = new MockAppState();

        // APIå®¢æˆ·ç«¯ç±»ï¼ˆå¤åˆ¶æ ¸å¿ƒé€»è¾‘ï¼‰
        class ApiClient {
            constructor() {
                this.baseUrl = 'http://localhost:4001';
                this.token = null;
                this.deviceId = null;
                this.initialized = false;
                
                log('ğŸ”§ APIå®¢æˆ·ç«¯å·²åˆ›å»ºï¼Œç­‰å¾…åˆå§‹åŒ–...');
            }

            async initialize() {
                if (this.initialized) {
                    return;
                }
                
                try {
                    log('ğŸ”„ å¼€å§‹åˆå§‹åŒ–APIå®¢æˆ·ç«¯é…ç½®...');
                    
                    if (typeof appState !== 'undefined' && appState.getConfig) {
                        const config = appState.getConfig();
                        log('ğŸ“„ è·å–åˆ°é…ç½®: ' + JSON.stringify({
                            serverHost: config.server?.host || 'æœªè®¾ç½®',
                            serverPort: config.server?.port || 'æœªè®¾ç½®'
                        }));
                        
                        if (config.server && config.server.host && config.server.port) {
                            const protocol = config.server.host.includes('localhost') || config.server.host.includes('127.0.0.1') ? 'http' : 'https';
                            this.baseUrl = `${protocol}://${config.server.host}:${config.server.port}`;
                            log('âœ… ä½¿ç”¨é…ç½®é¡µé¢è®¾ç½®çš„æœåŠ¡å™¨åœ°å€: ' + this.baseUrl);
                        } else {
                            log('âš ï¸ é…ç½®é¡µé¢ä¸­æœªè®¾ç½®æœåŠ¡å™¨åœ°å€ï¼Œä½¿ç”¨é»˜è®¤åœ°å€: ' + this.baseUrl);
                        }
                    } else {
                        log('âš ï¸ æ— æ³•è·å–å…¨å±€åº”ç”¨çŠ¶æ€ï¼Œä½¿ç”¨é»˜è®¤é…ç½®: ' + this.baseUrl);
                    }
                    
                    this.initialized = true;
                    log('ğŸš€ APIå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆï¼Œç›®æ ‡åœ°å€: ' + this.baseUrl);
                } catch (error) {
                    log('âŒ APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®: ' + error.message);
                    this.initialized = true;
                }
            }

            async healthCheck() {
                await this.initialize();
                
                try {
                    log('ğŸ“¤ å‘èµ·å¥åº·æ£€æŸ¥: GET ' + this.baseUrl + '/health');
                    const response = await fetch(this.baseUrl + '/health');
                    const data = await response.json();
                    
                    if (response.ok) {
                        log('âœ… å¥åº·æ£€æŸ¥æˆåŠŸ: ' + JSON.stringify(data));
                        return { success: true, data };
                    } else {
                        log('âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ' + response.status + ' ' + response.statusText);
                        return { success: false, error: `HTTP ${response.status}` };
                    }
                } catch (error) {
                    log('âŒ å¥åº·æ£€æŸ¥é”™è¯¯: ' + error.message);
                    return { success: false, error: error.message };
                }
            }
        }

        const apiClient = new ApiClient();

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showResult(message, type = 'success') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('results').innerHTML = '';
        }

        function updateConfig() {
            const host = document.getElementById('server-host').value;
            const port = parseInt(document.getElementById('server-port').value);
            
            const newConfig = appState.getConfig();
            newConfig.server.host = host;
            newConfig.server.port = port;
            
            appState.setConfig(newConfig);
            
            // é‡ç½®APIå®¢æˆ·ç«¯
            apiClient.initialized = false;
            
            log(`ğŸ“ é…ç½®å·²æ›´æ–°: ${host}:${port}`);
            showResult(`é…ç½®å·²æ›´æ–°ä¸º ${host}:${port}`, 'success');
        }

        async function testCurrentConfig() {
            try {
                log('ğŸ” æµ‹è¯•å½“å‰é…ç½®...');
                const config = appState.getConfig();
                log('å½“å‰é…ç½®: ' + JSON.stringify(config.server));
                
                const result = await apiClient.healthCheck();
                if (result.success) {
                    showResult('âœ… å½“å‰é…ç½®æµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    showResult('âŒ å½“å‰é…ç½®æµ‹è¯•å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                log('æµ‹è¯•å¤±è´¥: ' + error.message);
                showResult('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function testApiClientInit() {
            try {
                log('ğŸ” æµ‹è¯•APIå®¢æˆ·ç«¯åˆå§‹åŒ–...');
                
                // é‡ç½®åˆå§‹åŒ–çŠ¶æ€
                apiClient.initialized = false;
                
                await apiClient.initialize();
                
                log('APIå®¢æˆ·ç«¯ç›®æ ‡åœ°å€: ' + apiClient.baseUrl);
                showResult('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ: ' + apiClient.baseUrl, 'success');
            } catch (error) {
                log('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                showResult('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function testDifferentPorts() {
            const ports = [4001, 4002, 3000];
            
            for (const port of ports) {
                log(`ğŸ” æµ‹è¯•ç«¯å£ ${port}...`);
                
                // æ›´æ–°é…ç½®
                const config = appState.getConfig();
                config.server.port = port;
                appState.setConfig(config);
                
                // é‡ç½®APIå®¢æˆ·ç«¯
                apiClient.initialized = false;
                
                const result = await apiClient.healthCheck();
                if (result.success) {
                    showResult(`âœ… ç«¯å£ ${port} æµ‹è¯•æˆåŠŸ`, 'success');
                } else {
                    showResult(`âŒ ç«¯å£ ${port} æµ‹è¯•å¤±è´¥: ${result.error}`, 'error');
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹æµ‹è¯•
        window.addEventListener('load', () => {
            log('ğŸš€ APIå®¢æˆ·ç«¯é…ç½®æµ‹è¯•å·¥å…·å·²å¯åŠ¨');
            log('å½“å‰é…ç½®: ' + JSON.stringify(appState.getConfig().server));
            
            setTimeout(testCurrentConfig, 1000);
        });
    </script>
</body>
</html>