<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬ä¸‰æ–¹ç™»å½•æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #007bff;
            margin-top: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .qr-display {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin: 20px 0;
        }
        .qr-display img {
            max-width: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.waiting {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        .status.success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
            margin: 15px 0;
        }
        .info-box strong {
            color: #1976d2;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        .step {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
            border-radius: 4px;
        }
        .step.active {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .step h3 {
            margin-top: 0;
            color: #17a2b8;
        }
        .step.active h3 {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç¬¬ä¸‰æ–¹äºŒç»´ç ç™»å½•æµ‹è¯•</h1>
        
        <div class="info-box">
            <strong>æµ‹è¯•è¯´æ˜ï¼š</strong>æœ¬é¡µé¢ç”¨äºæµ‹è¯•ç¬¬ä¸‰æ–¹äºŒç»´ç ç™»å½•çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬ç”ŸæˆäºŒç»´ç ã€è½®è¯¢ç™»å½•çŠ¶æ€ç­‰åŠŸèƒ½ã€‚
        </div>

        <h2>æ­¥éª¤ 1: è®¾å¤‡è®¤è¯</h2>
        <div class="section">
            <button onclick="authenticateDevice()" id="btn-auth">ğŸ”‘ å¼€å§‹è®¾å¤‡è®¤è¯</button>
            <div id="auth-status"></div>
        </div>

        <h2>æ­¥éª¤ 2: ç”ŸæˆäºŒç»´ç </h2>
        <div class="section">
            <button onclick="generateQRCode()" id="btn-qr" disabled>ğŸ“± ç”ŸæˆäºŒç»´ç </button>
            <div class="qr-display" id="qr-display" style="display: none;">
                <img id="qr-image" alt="äºŒç»´ç ">
                <p><strong>è¯·ä½¿ç”¨ç¬¬ä¸‰æ–¹APPæ‰«æäºŒç»´ç </strong></p>
            </div>
        </div>

        <h2>æ­¥éª¤ 3: è½®è¯¢ç™»å½•çŠ¶æ€</h2>
        <div class="section">
            <button onclick="startPolling()" id="btn-poll" disabled>ğŸ”„ å¼€å§‹è½®è¯¢</button>
            <button onclick="stopPolling()" id="btn-stop-poll" disabled>â¹ï¸ åœæ­¢è½®è¯¢</button>
            <div id="poll-status"></div>
        </div>

        <h2>å½“å‰çŠ¶æ€</h2>
        <div class="section">
            <div class="step" id="step1">
                <h3>â‘  è®¾å¤‡è®¤è¯</h3>
                <div id="step1-info">ç­‰å¾…å¼€å§‹...</div>
            </div>
            <div class="step" id="step2">
                <h3>â‘¡ äºŒç»´ç ç”Ÿæˆ</h3>
                <div id="step2-info">ç­‰å¾…å¼€å§‹...</div>
            </div>
            <div class="step" id="step3">
                <h3>â‘¢ ç”¨æˆ·æ‰«ç </h3>
                <div id="step3-info">ç­‰å¾…å¼€å§‹...</div>
            </div>
            <div class="step" id="step4">
                <h3>â‘£ ç™»å½•å®Œæˆ</h3>
                <div id="step4-info">ç­‰å¾…å¼€å§‹...</div>
            </div>
        </div>

        <h2>æ—¥å¿—è¾“å‡º</h2>
        <div id="log"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://clothing-api.0086studios.xyz';
        let deviceToken = null;
        let deviceId = null;
        let pollingInterval = null;

        // æ—¥å¿—è¾“å‡º
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepNum, info, isActive = false) {
            const step = document.getElementById(`step${stepNum}`);
            const infoDiv = document.getElementById(`step${stepNum}-info`);
            infoDiv.textContent = info;
            if (isActive) {
                step.classList.add('active');
            }
        }

        // 1. è®¾å¤‡è®¤è¯
        async function authenticateDevice() {
            try {
                log('å¼€å§‹è®¾å¤‡è®¤è¯...');
                updateStep(1, 'æ­£åœ¨è®¤è¯...', true);
                
                const macAddress = 'AA:BB:CC:DD:EE:FF';
                const deviceName = 'æµ‹è¯•è®¾å¤‡-01';
                
                const response = await fetch(`${API_BASE_URL}/api/auth/device`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ macAddress, deviceName })
                });
                
                const data = await response.json();
                log('è®¤è¯å“åº”: ' + JSON.stringify(data, null, 2));
                
                if (data.success) {
                    deviceToken = data.token;
                    deviceId = data.device.id;
                    
                    log(`è®¾å¤‡è®¤è¯æˆåŠŸï¼è®¾å¤‡ID: ${deviceId}`, 'success');
                    updateStep(1, `âœ… è®¤è¯æˆåŠŸ (ID: ${deviceId})`, true);
                    
                    document.getElementById('auth-status').innerHTML = 
                        `<div class="status success">âœ… è®¾å¤‡è®¤è¯æˆåŠŸ<br>è®¾å¤‡ID: ${deviceId}</div>`;
                    
                    document.getElementById('btn-qr').disabled = false;
                } else {
                    throw new Error(data.error || 'è®¤è¯å¤±è´¥');
                }
            } catch (error) {
                log('è®¾å¤‡è®¤è¯å¤±è´¥: ' + error.message, 'error');
                updateStep(1, 'âŒ è®¤è¯å¤±è´¥', false);
                document.getElementById('auth-status').innerHTML = 
                    `<div class="status error">âŒ ${error.message}</div>`;
            }
        }

        // 2. ç”ŸæˆäºŒç»´ç 
        async function generateQRCode() {
            try {
                log('å¼€å§‹ç”ŸæˆäºŒç»´ç ...');
                updateStep(2, 'æ­£åœ¨ç”Ÿæˆ...', true);
                
                const response = await fetch(`${API_BASE_URL}/api/auth/qrcode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        deviceId: deviceId,
                        loginType: 'third_party'
                    })
                });
                
                const data = await response.json();
                log('äºŒç»´ç å“åº”: ' + JSON.stringify(data, null, 2));
                
                if (data.success) {
                    const qrDisplay = document.getElementById('qr-display');
                    const qrImage = document.getElementById('qr-image');
                    
                    qrImage.src = data.qrCode.dataURL;
                    qrDisplay.style.display = 'block';
                    
                    log('äºŒç»´ç ç”ŸæˆæˆåŠŸï¼', 'success');
                    updateStep(2, 'âœ… äºŒç»´ç å·²ç”Ÿæˆ', true);
                    updateStep(3, 'â³ ç­‰å¾…ç”¨æˆ·æ‰«ç ...', true);
                    
                    document.getElementById('btn-poll').disabled = false;
                } else {
                    throw new Error(data.error || 'ç”ŸæˆäºŒç»´ç å¤±è´¥');
                }
            } catch (error) {
                log('ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + error.message, 'error');
                updateStep(2, 'âŒ ç”Ÿæˆå¤±è´¥', false);
            }
        }

        // 3. å¼€å§‹è½®è¯¢
        function startPolling() {
            if (pollingInterval) {
                log('è½®è¯¢å·²åœ¨è¿›è¡Œä¸­', 'error');
                return;
            }
            
            log('å¼€å§‹è½®è¯¢ç™»å½•çŠ¶æ€...');
            document.getElementById('btn-poll').disabled = true;
            document.getElementById('btn-stop-poll').disabled = false;
            
            let pollCount = 0;
            const maxPolls = 100;
            
            pollingInterval = setInterval(async () => {
                pollCount++;
                log(`ç¬¬ ${pollCount} æ¬¡è½®è¯¢...`);
                
                if (pollCount > maxPolls) {
                    stopPolling();
                    log('è½®è¯¢è¶…æ—¶ï¼ŒäºŒç»´ç å·²è¿‡æœŸ', 'error');
                    updateStep(3, 'âŒ è¶…æ—¶ï¼Œè¯·é‡æ–°ç”ŸæˆäºŒç»´ç ', false);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/auth/poll-login/${deviceId}`);
                    const data = await response.json();
                    
                    if (data.success && data.isLoggedIn) {
                        stopPolling();
                        log('ç”¨æˆ·å·²ç™»å½•ï¼', 'success');
                        log('Token: ' + data.user.token);
                        log('Account: ' + data.user.account);
                        
                        updateStep(3, 'âœ… ç”¨æˆ·å·²æ‰«ç ', true);
                        updateStep(4, `âœ… ç™»å½•æˆåŠŸï¼Token: ${data.user.token}`, true);
                        
                        document.getElementById('poll-status').innerHTML = 
                            `<div class="status success">
                                âœ… ç™»å½•æˆåŠŸï¼<br>
                                ç”¨æˆ·è´¦å·: ${data.user.account}<br>
                                Token: ${data.user.token}<br>
                                æ˜µç§°: ${data.user.nickname || 'æœªè®¾ç½®'}
                            </div>`;
                    } else {
                        log('ç­‰å¾…ç”¨æˆ·æ‰«ç ...');
                    }
                } catch (error) {
                    log('è½®è¯¢è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                }
            }, 3000);
        }

        // åœæ­¢è½®è¯¢
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                log('å·²åœæ­¢è½®è¯¢');
                document.getElementById('btn-poll').disabled = false;
                document.getElementById('btn-stop-poll').disabled = true;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•ç¬¬ä¸‰æ–¹ç™»å½•');
            log('APIåœ°å€: ' + API_BASE_URL);
        };

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.onbeforeunload = function() {
            stopPolling();
        };
    </script>
</body>
</html>
