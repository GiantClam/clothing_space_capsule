// åº”ç”¨çŠ¶æ€ç®¡ç†
class AppState {
    constructor() {
        this.currentPage = 'welcome-page';
        this.welcomePageInitialized = false; // æ¬¢è¿é¡µåˆå§‹åŒ–æ ‡å¿—
        this.userProfile = {
            openid: null,
            photo: null,
            photoFileName: null,
            fullBodyShotNameInRH: null, // RunningHubä¸­çš„å…¨èº«ç…§æ–‡ä»¶åï¼ˆå»é™¤api/å‰ç¼€ï¼‰
            gender: 'female'
        };
        this.selectedClothing = null; // å½“å‰ç”Ÿæ•ˆçš„é€‰æ‹©ï¼ˆä¸ lastSelectionType åŒæ­¥ï¼‰
        this.selectedTopBottom = null; // { tops: item, bottoms: item }
        this.selectedDress = null; // { item }
        this.lastSelectionType = null; // 'topBottom' | 'dress'
        this.selectedStyle = null;
        this.currentTask = null;
        this.currentTaskId = null; // API Serverä¸­çš„ä»»åŠ¡ID
        this.apiBaseUrl = 'https://clothing-api.0086studios.xyz'; // ç”Ÿäº§ç¯å¢ƒäº‘ç«¯APIæœåŠ¡å™¨
        this.apiServerUrl = 'https://clothing-api.0086studios.xyz'; // ç”Ÿäº§ç¯å¢ƒäº‘ç«¯APIæœåŠ¡å™¨
        this.currentGender = 'female';
        this.currentCategory = 'tops-bottoms';
        this.currentSubCategory = 'tops';
        this.isDressSelected = false;
        this.configCache = null;
        this.resultImageUrl = null; // æ·»åŠ ç»“æœå›¾ç‰‡URLå­˜å‚¨
        this.resizeTimer = null; // æ·»åŠ çª—å£å¤§å°è°ƒæ•´é˜²æŠ–å®šæ—¶å™¨
        this.macAddress = null; // è®¾å¤‡MACåœ°å€
        // ä»»åŠ¡çŠ¶æ€è½®è¯¢å®šæ—¶å™¨
        this.taskPollTimer = null;
        
        // å¼€å‘æ¨¡å¼æ ‡å¿—
        this.isDevelopment = this.checkDevelopmentMode();
        // å¼€å‘æ¨¡å¼è·³è¿‡ç™»å½•æ ‡å¿—
        this.devModeSkippedLogin = false;
        
        // æ·»åŠ é»˜è®¤æœè£…æ•°æ®
        this.defaultClothing = {
            tops: [
                { id: 'top1', name: 'ç™½è‰²è¡¬è¡«', image: 'public/coats/1.jpg' },
                { id: 'top2', name: 'ç²‰è‰²Tæ¤', image: 'public/coats/2.jpg' },
                { id: 'top3', name: 'è“è‰²é’ˆç»‡è¡«', image: 'public/coats/3.jpg' }
            ],
            bottoms: [
                { id: 'bottom1', name: 'ç‰›ä»”è£¤', image: 'public/pants/9.jpg' },
                { id: 'bottom2', name: 'æ—¶å°šé•¿è£¤', image: 'public/pants/10.jpg' },
                { id: 'bottom3', name: 'ä¼‘é—²è£¤', image: 'public/pants/11.jpg' }
            ]
        };
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºå¼€å‘æ¨¡å¼
    checkDevelopmentMode() {
        try {
            // 0. ä¼˜å…ˆæ£€æŸ¥ä¸»è¿›ç¨‹æ³¨å…¥çš„ç¯å¢ƒå˜é‡ï¼ˆæœ€å¯é ï¼‰
            if (typeof window !== 'undefined' && window.__APP_ENV__) {
                if (window.__APP_ENV__.IS_PRODUCTION) {
                    console.log('ğŸ“¦ ç”Ÿäº§ç¯å¢ƒæ¨¡å¼ï¼ˆæ³¨å…¥ç¯å¢ƒå˜é‡ï¼‰');
                    return false;
                }
                if (window.__APP_ENV__.IS_DEVELOPMENT) {
                    console.log('ğŸ”§ å¼€å‘æ¨¡å¼ï¼ˆæ³¨å…¥ç¯å¢ƒå˜é‡ï¼‰');
                    return true;
                }
            }
            
            // 1. å°è¯•ç›´æ¥è®¿é—® process.env
            let nodeEnv = null;
            try {
                if (typeof process !== 'undefined' && process.env) {
                    nodeEnv = process.env.NODE_ENV;
                    if (nodeEnv === 'production') {
                        console.log('ğŸ“¦ ç”Ÿäº§ç¯å¢ƒæ¨¡å¼ï¼ˆprocess.envï¼‰');
                        return false;
                    }
                }
            } catch (e) {
                console.log('â„¹ï¸ æ— æ³•ç›´æ¥è®¿é—® process.env');
            }
            
            // 2. æ£€æŸ¥ localStorage ä¸­çš„å¼€å‘æ¨¡å¼è®¾ç½®
            const devMode = localStorage.getItem('DEV_MODE');
            if (devMode === 'true') {
                console.log('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨ï¼ˆé€šè¿‡ localStorageï¼‰');
                return true;
            }
            
            // 3. æ£€æŸ¥ URL å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('dev') === 'true') {
                console.log('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨ï¼ˆé€šè¿‡ URL å‚æ•°ï¼‰');
                return true;
            }
            
            // 4. æ£€æŸ¥æ˜¯å¦ä¸ºçœŸæ­£çš„æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆä»… localhost/127.0.0.1ï¼Œä¸åŒ…æ‹¬ file://ï¼‰
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            if (isLocalhost) {
                console.log('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨ï¼ˆæœ¬åœ°ç¯å¢ƒï¼‰');
                return true;
            }
            
            // 5. å…¶ä»–æƒ…å†µï¼ˆåŒ…æ‹¬ file:// åè®®çš„ç”Ÿäº§æ‰“åŒ…ï¼‰é»˜è®¤ä¸ºéå¼€å‘æ¨¡å¼
            console.log('ğŸŒ ç”Ÿäº§ç¯å¢ƒæ¨¡å¼');
            return false;
        } catch (error) {
            console.error('æ£€æŸ¥å¼€å‘æ¨¡å¼å¤±è´¥:', error);
            return false;
        }
    }

    // æ‹ç…§åŠŸèƒ½
    async capturePhoto() {
        try {
            // è·å–å½“å‰è§†é¢‘æµå¹¶æ‹ç…§
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');
            
            // è®¾ç½®canvaså°ºå¯¸ä¸è§†é¢‘ç›¸åŒ
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // ç»˜åˆ¶å½“å‰è§†é¢‘å¸§åˆ°canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // å°†canvasè½¬æ¢ä¸ºå›¾ç‰‡æ•°æ®URL
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            
            // æ˜¾ç¤ºæ‹ç…§ç¡®è®¤é¡µé¢
            const capturedPhoto = document.getElementById('captured-photo');
            if (capturedPhoto) {
                capturedPhoto.src = imageDataUrl;
            }
            
            // ä¿å­˜ç…§ç‰‡æ•°æ®åˆ°çŠ¶æ€
            this.capturedPhotoData = imageDataUrl;
            
            // åˆ‡æ¢åˆ°æ‹ç…§ç¡®è®¤é¡µé¢
            await this.setPage('photo-confirm-page');
        } catch (error) {
            console.error('æ‹ç…§å¤±è´¥:', error);
            this.showError('æ‹ç…§å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
    
    // é‡æ–°æ‹æ‘„
    async retakePhoto() {
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        if (typeof resetCaptureButton === 'function') {
            resetCaptureButton();
        }
        
        // è¿”å›æ‹ç…§é¡µé¢
        await this.setPage('profile-page');
    }
    
    // ç¡®è®¤ç…§ç‰‡
    async confirmPhoto() {
        try {
            // ä¸Šä¼ äººç‰©ç…§ç‰‡åˆ°æœåŠ¡å™¨
            if (this.capturedPhotoData) {
                this.showLoading('æ­£åœ¨ä¸Šä¼ ç…§ç‰‡...');
                
                // å°†base64è½¬æ¢ä¸ºBlob
                const response = await fetch(this.capturedPhotoData);
                const blob = await response.blob();
                
                console.log('ä¸Šä¼ ç…§ç‰‡ä¿¡æ¯: å°ºå¯¸ 720x1024, æ–‡ä»¶å¤§å°: ' + blob.size + ' bytes');
                
                // ç¡®ä¿APIå®¢æˆ·ç«¯å­˜åœ¨
                if (!window.apiClient) {
                    console.log('âŒ window.apiClient ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„APIå®¢æˆ·ç«¯å®ä¾‹...');
                    if (typeof window.ApiClient === 'function') {
                        window.apiClient = new window.ApiClient();
                        console.log('âœ… æ–°çš„APIå®¢æˆ·ç«¯å®ä¾‹åˆ›å»ºæˆåŠŸ');
                    } else {
                        console.error('âŒ æ— æ³•åˆ›å»ºæ–°çš„APIå®¢æˆ·ç«¯å®ä¾‹');
                        throw new Error('æ— æ³•åˆ›å»ºAPIå®¢æˆ·ç«¯å®ä¾‹');
                    }
                }
                
                // ç¡®ä¿APIå®¢æˆ·ç«¯å·²åˆå§‹åŒ–
                if (!window.apiClient.initialized) {
                    console.log('ğŸ”„ APIå®¢æˆ·ç«¯å°šæœªåˆå§‹åŒ–ï¼Œæ‰§è¡Œåˆå§‹åŒ–...');
                    await window.apiClient.initialize();
                    console.log('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ');
                }
                
                // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²è®¤è¯
                if (!window.apiClient.token) {
                    console.log('âš ï¸ è®¾å¤‡æœªè®¤è¯ï¼Œå°è¯•è¿›è¡Œè®¾å¤‡è®¤è¯...');
                    let macAddress = this.macAddress;
                    if (!macAddress) {
                        await this.getMacAddress();
                        macAddress = this.macAddress;
                    }
                    
                    if (macAddress) {
                        const deviceId = macAddress.replace(/:/g, '');
                        const authResponse = await window.apiClient.authenticateDevice(deviceId, 'è¡£ç­‰èˆ±å®¢æˆ·ç«¯');
                        if (authResponse.success) {
                            console.log('âœ… è®¾å¤‡è®¤è¯æˆåŠŸ');
                        }
                    }
                }
                
                // ä¸Šä¼ ç…§ç‰‡åˆ°äº‘ç«¯
                const uploadResponse = await window.apiClient.uploadPhoto(blob, this.qrSceneStr);
                console.log('ç…§ç‰‡ä¸Šä¼ ç»“æœ:', uploadResponse);
                
                if (!uploadResponse.success) {
                    throw new Error(uploadResponse.error || 'ç…§ç‰‡ä¸Šä¼ å¤±è´¥');
                }
                
                // ä¿å­˜ä»»åŠ¡ID
                this.currentTaskId = uploadResponse.data.taskId;
                console.log('âœ… ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼Œä»»åŠ¡ID:', this.currentTaskId);
                
                this.hideLoading();
            }
            
            // ååˆå§‹åŒ–æ‘„åƒå¤´ï¼Œé‡Šæ”¾èµ„æº
            if (typeof deinitializeCamera === 'function') {
                deinitializeCamera();
            }
            
            // è·³è½¬åˆ°æ—¶å°šåå¥½é€‰æ‹©é¡µé¢
            await this.setPage('preference-page');
        } catch (error) {
            console.error('ç¡®è®¤ç…§ç‰‡å¤±è´¥:', error);
            this.hideLoading();
            this.showError('å¤„ç†ç…§ç‰‡å¤±è´¥: ' + error.message);
        }
    }
    
    // æ•°æ®URLè½¬æ¢ä¸ºBlob
    dataURLToBlob(dataURL) {
        const parts = dataURL.split(';base64,');
        const contentType = parts[0].split(':')[1];
        const raw = atob(parts[1]);
        const rawLength = raw.length;
        const uInt8Array = new Uint8Array(rawLength);
        
        for (let i = 0; i < rawLength; ++i) {
            uInt8Array[i] = raw.charCodeAt(i);
        }
        
        return new Blob([uInt8Array], { type: contentType });
    }
    
    // ä¸Šä¼ ç…§ç‰‡åˆ°æœåŠ¡å™¨
    async uploadPhotoToServer(photoBlob) {
        try {
            if (!window.apiClient) {
                throw new Error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
            }
            
            // è°ƒç”¨APIå®¢æˆ·ç«¯ä¸Šä¼ ç…§ç‰‡
            const response = await window.apiClient.uploadPhoto(photoBlob, this.qrSceneStr);
            
            if (response.success) {
                // ä¿å­˜ç…§ç‰‡ä¿¡æ¯
                this.userProfile.photo = response.photoUrl;
                this.userProfile.photoFileName = response.fileName;
                console.log('ç…§ç‰‡ä¸Šä¼ æˆåŠŸ:', response);
            } else {
                throw new Error(response.error || 'ç…§ç‰‡ä¸Šä¼ å¤±è´¥');
            }
        } catch (error) {
            console.error('ç…§ç‰‡ä¸Šä¼ å¤±è´¥:', error);
            throw error;
        }
    }
    
    // é€‰æ‹©è‡ªå®šä¹‰é£æ ¼
    async selectCustomStyle() {
        // è·³è½¬åˆ°æœè£…é€‰æ‹©é¡µé¢
        await this.setPage('clothing-page');
    }
    
    // é€‰æ‹©æ¨èé£æ ¼
    async selectRecommendedStyle() {
        // å¼¹å‡ºæç¤ºæ¡†
        this.showInfo('æ•¬è¯·æœŸå¾…');
    }
    
    // æ‰“å¼€æœè£…é€‰æ‹©å¼¹çª—
    async openClothingModal(category) {
        try {
            // ä¿å­˜å½“å‰ç±»åˆ«
            this.currentModalCategory = category;
            
            // è®¾ç½®å¼¹çª—æ ‡é¢˜
            const modalTitle = document.getElementById('modal-title');
            if (modalTitle) {
                modalTitle.textContent = category === 'tops' ? 'é€‰æ‹©ä¸Šè¡£' : 'é€‰æ‹©ä¸‹è¡£';
            }
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            const clothingGrid = document.getElementById('clothing-grid-modal');
            if (clothingGrid) {
                clothingGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æ­£åœ¨åŠ è½½...</div>';
            }
            
            // æ˜¾ç¤ºå¼¹çª—
            const modal = document.getElementById('clothing-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
            
            // åŠ è½½æœè£…æ•°æ®
            await this.loadClothingForModal(category);
        } catch (error) {
            console.error('æ‰“å¼€æœè£…é€‰æ‹©å¼¹çª—å¤±è´¥:', error);
            this.showError('åŠ è½½æœè£…æ•°æ®å¤±è´¥');
        }
    }
    
    // å…³é—­æœè£…é€‰æ‹©å¼¹çª—
    closeClothingModal() {
        const modal = document.getElementById('clothing-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // ä¸ºå¼¹çª—åŠ è½½æœè£…æ•°æ®
    async loadClothingForModal(category) {
        try {
            if (!window.apiClient) {
                throw new Error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
            }
            
            // è·å–åˆ†ç±»æ•°æ®
            const categories = await window.apiClient.getClothingCategories();
            const genderCategory = categories.data.find(cat => 
                cat.name === (this.currentGender === 'male' ? 'ç”·è£…' : 'å¥³è£…')
            );
            
            if (!genderCategory) {
                throw new Error('æœªæ‰¾åˆ°æ€§åˆ«åˆ†ç±»');
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„å­åˆ†ç±»
            let subCategoryName = '';
            if (category === 'tops') {
                subCategoryName = this.currentGender === 'male' ? 'å¤–å¥—' : 'å¤–å¥—';
            } else {
                subCategoryName = this.currentGender === 'male' ? 'è£¤å­' : 'è£¤å­';
            }
            
            const subCategory = genderCategory.children.find(child => 
                child.name === subCategoryName
            );
            
            if (!subCategory) {
                throw new Error(`æœªæ‰¾åˆ°${subCategoryName}åˆ†ç±»`);
            }
            
            // è·å–æœè£…åˆ—è¡¨
            const clothesResponse = await window.apiClient.getClothingByCategory(subCategory.id);
            
            if (!clothesResponse.success || !clothesResponse.data.clothes) {
                throw new Error('è·å–æœè£…æ•°æ®å¤±è´¥');
            }
            
            // æ¸²æŸ“æœè£…åˆ—è¡¨
            const clothingGrid = document.getElementById('clothing-grid-modal');
            if (clothingGrid) {
                if (clothesResponse.data.clothes.length === 0) {
                    clothingGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æš‚æ— æ•°æ®</div>';
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                clothingGrid.innerHTML = '';
                
                // æ·»åŠ æœè£…é¡¹
                clothesResponse.data.clothes.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'clothing-item-modal';
                    itemEl.dataset.id = item.id;
                    itemEl.innerHTML = `
                        <img src="${this.getImageUrl(item.imageUrl)}" alt="${item.name}">
                        <div class="label">${item.name}</div>
                    `;
                    
                    // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­
                    if (this.isItemInSelection(item, category)) {
                        itemEl.classList.add('selected');
                    }
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    itemEl.onclick = () => this.selectClothingInModal(item, category, itemEl);
                    
                    clothingGrid.appendChild(itemEl);
                });
            }
        } catch (error) {
            console.error('åŠ è½½æœè£…æ•°æ®å¤±è´¥:', error);
            const clothingGrid = document.getElementById('clothing-grid-modal');
            if (clothingGrid) {
                clothingGrid.innerHTML = `<div style="text-align: center; padding: 20px; color: #b00;">åŠ è½½å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
    }
    
    // æ£€æŸ¥æœè£…é¡¹æ˜¯å¦åœ¨å½“å‰é€‰æ‹©ä¸­
    isItemInSelection(item, category) {
        if (category === 'tops' && this.selectedTopBottom && this.selectedTopBottom.tops) {
            return this.selectedTopBottom.tops.id === item.id;
        }
        
        if (category === 'bottoms' && this.selectedTopBottom && this.selectedTopBottom.bottoms) {
            return this.selectedTopBottom.bottoms.id === item.id;
        }
        
        return false;
    }
    
    // åœ¨å¼¹çª—ä¸­é€‰æ‹©æœè£…
    async selectClothingInModal(item, category, element) {
        try {
            // æ›´æ–°é€‰æ‹©çŠ¶æ€
            if (category === 'tops') {
                if (!this.selectedTopBottom) {
                    this.selectedTopBottom = { tops: item, bottoms: null };
                } else {
                    this.selectedTopBottom.tops = item;
                }
            } else if (category === 'bottoms') {
                if (!this.selectedTopBottom) {
                    this.selectedTopBottom = { tops: null, bottoms: item };
                } else {
                    this.selectedTopBottom.bottoms = item;
                }
            }
            
            // æ›´æ–°é¢„è§ˆåŒºåŸŸ
            this.updateClothingPreview(category, item);
            
            // å…³é—­å¼¹çª—
            this.closeClothingModal();
            
            console.log('é€‰æ‹©çš„æœè£…:', this.selectedTopBottom);
        } catch (error) {
            console.error('é€‰æ‹©æœè£…å¤±è´¥:', error);
            this.showError('é€‰æ‹©æœè£…å¤±è´¥');
        }
    }
    
    // æ›´æ–°æœè£…é¢„è§ˆåŒºåŸŸ
    updateClothingPreview(category, item) {
        const previewElement = document.getElementById(
            category === 'tops' ? 'tops-preview' : 'bottoms-preview'
        );
        
        if (previewElement) {
            previewElement.innerHTML = `
                <img src="${this.getImageUrl(item.imageUrl)}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;">
            `;
        }
    }
    
    // æ·»åŠ ç»“æœå›¾ç‰‡ä¿æŒé¡µé¢çš„å‡½æ•°å®ç°
    async retakeFitting() {
        try {
            // è¿”å›åˆ°æœè£…é€‰æ‹©é¡µé¢
            await this.setPage('clothing-page');
        } catch (error) {
            console.error('é‡æ–°é€‰æ‹©è¯•è¡£å¤±è´¥:', error);
            this.showError('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    async saveImage() {
        try {
            // è·³è½¬åˆ°æ‰«ç ä¸‹è½½å›¾ç‰‡é¡µé¢
            await this.setPage('scan-to-get-page');
            
            // ç”ŸæˆäºŒç»´ç 
            await this.generateWechatQRCode();
        } catch (error) {
            console.error('ä¿å­˜å›¾ç‰‡å¤±è´¥:', error);
            this.showError('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // æ·»åŠ æ‰«ç ä¸‹è½½å›¾ç‰‡é¡µé¢çš„å‡½æ•°å®ç°
    async continueFitting() {
        try {
            // è¿”å›åˆ°æœè£…é€‰æ‹©é¡µé¢
            await this.setPage('clothing-page');
        } catch (error) {
            console.error('ç»§ç»­è¯•è¡£å¤±è´¥:', error);
            this.showError('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    async goBackToPreference() {
        try {
            // è¿”å›åˆ°æ—¶å°šåå¥½é€‰æ‹©é¡µé¢
            await this.setPage('preference-page');
        } catch (error) {
            console.error('è¿”å›æ—¶å°šåå¥½é€‰æ‹©é¡µé¢å¤±è´¥:', error);
            this.showError('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    async goBackToClothing() {
        try {
            // è¿”å›åˆ°æœè£…é€‰æ‹©é¡µé¢
            await this.setPage('clothing-page');
        } catch (error) {
            console.error('è¿”å›æœè£…é€‰æ‹©é¡µé¢å¤±è´¥:', error);
            this.showError('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // ç»“æŸä¼šè¯
    async endSession() {
        try {
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            this.selectedTopBottom = null;
            this.selectedDress = null;
            this.selectedClothing = null;
            this.currentTask = null;
            this.currentTaskId = null;
            this.resultImageUrl = null;
            
            // æ›´æ–°é¢„è§ˆåŒºåŸŸ
            this.resetClothingPreviews();
            
            // è¿”å›é¦–é¡µ
            await this.setPage('welcome-page');
        } catch (error) {
            console.error('ç»“æŸä¼šè¯å¤±è´¥:', error);
            this.showError('ç»“æŸä¼šè¯å¤±è´¥');
        }
    }
    
    // é‡ç½®æœè£…é¢„è§ˆåŒºåŸŸ
    resetClothingPreviews() {
        const topsPreview = document.getElementById('tops-preview');
        const bottomsPreview = document.getElementById('bottoms-preview');
        
        if (topsPreview) {
            topsPreview.innerHTML = '<div class="preview-placeholder">ç‚¹å‡»é€‰æ‹©ä¸Šè¡£</div>';
        }
        
        if (bottomsPreview) {
            bottomsPreview.innerHTML = '<div class="preview-placeholder">ç‚¹å‡»é€‰æ‹©ä¸‹è¡£</div>';
        }
    }
    
    // è¿”å›åˆ°æ‹ç…§ç¡®è®¤é¡µé¢
    async goBackToPhotoConfirm() {
        await this.setPage('photo-confirm-page');
    }

    // è¿”å›åˆ°é¦–é¡µ
    async goBackToHome() {
        await this.setPage('welcome-page');
    }
    
    // æ˜¾ç¤ºä¿¡æ¯æç¤º
    showInfo(message) {
        // åˆ›å»ºæç¤ºå…ƒç´ 
        const notification = document.createElement('div');
        notification.className = 'info-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    showError(message) {
        // åˆ›å»ºé”™è¯¯æç¤ºå…ƒç´ 
        const notification = document.createElement('div');
        notification.className = 'error-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºå¼€å‘æ¨¡å¼
    checkDevelopmentMode() {
        try {
            // 0. ä¼˜å…ˆæ£€æŸ¥ä¸»è¿›ç¨‹æ³¨å…¥çš„ç¯å¢ƒå˜é‡ï¼ˆæœ€å¯é ï¼‰
            if (typeof window !== 'undefined' && window.__APP_ENV__) {
                if (window.__APP_ENV__.IS_PRODUCTION) {
                    console.log('ğŸ“¦ ç”Ÿäº§ç¯å¢ƒæ¨¡å¼ï¼ˆæ³¨å…¥ç¯å¢ƒå˜é‡ï¼‰');
                    return false;
                }
                if (window.__APP_ENV__.IS_DEVELOPMENT) {
                    console.log('ğŸ”§ å¼€å‘æ¨¡å¼ï¼ˆæ³¨å…¥ç¯å¢ƒå˜é‡ï¼‰');
                    return true;
                }
            }
            
            // 1. å°è¯•ç›´æ¥è®¿é—® process.env
            let nodeEnv = null;
            try {
                if (typeof process !== 'undefined' && process.env) {
                    nodeEnv = process.env.NODE_ENV;
                    if (nodeEnv === 'production') {
                        console.log('ğŸ“¦ ç”Ÿäº§ç¯å¢ƒæ¨¡å¼ï¼ˆprocess.envï¼‰');
                        return false;
                    }
                }
            } catch (e) {
                console.log('â„¹ï¸ æ— æ³•ç›´æ¥è®¿é—® process.env');
            }
            
            // 2. æ£€æŸ¥ localStorage ä¸­çš„å¼€å‘æ¨¡å¼è®¾ç½®
            const devMode = localStorage.getItem('DEV_MODE');
            if (devMode === 'true') {
                console.log('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨ï¼ˆé€šè¿‡ localStorageï¼‰');
                return true;
            }
            
            // 3. æ£€æŸ¥ URL å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('dev') === 'true') {
                console.log('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨ï¼ˆé€šè¿‡ URL å‚æ•°ï¼‰');
                return true;
            }
            
            // 4. æ£€æŸ¥æ˜¯å¦ä¸ºçœŸæ­£çš„æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆä»… localhost/127.0.0.1ï¼Œä¸åŒ…æ‹¬ file://ï¼‰
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            if (isLocalhost) {
                console.log('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨ï¼ˆæœ¬åœ°ç¯å¢ƒï¼‰');
                return true;
            }
            
            // 5. å…¶ä»–æƒ…å†µï¼ˆåŒ…æ‹¬ file:// åè®®çš„ç”Ÿäº§æ‰“åŒ…ï¼‰é»˜è®¤ä¸ºéå¼€å‘æ¨¡å¼
            console.log('ğŸŒ ç”Ÿäº§ç¯å¢ƒæ¨¡å¼');
            return false;
        } catch (error) {
            console.error('æ£€æŸ¥å¼€å‘æ¨¡å¼å¤±è´¥:', error);
            return false;
        }
    }

    // è·å–é…ç½®
    getConfig() {
        // å°è¯•ä»localStorageè·å–é…ç½®
        try {
            const config = localStorage.getItem('appConfig');
            return config ? JSON.parse(config) : {};
        } catch (error) {
            console.warn('è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
            return {};
        }
    }

    // è®¾ç½®é…ç½®
    setConfig(config) {
        try {
            localStorage.setItem('appConfig', JSON.stringify(config));
            this.configCache = config;
        } catch (error) {
            console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
        }
    }

    // å¤„ç†çª—å£å¤§å°å˜åŒ–
    handleWindowResize() {
        // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è°ƒæ•´
        if (this.resizeTimer) {
            clearTimeout(this.resizeTimer);
        }
        
        this.resizeTimer = setTimeout(() => {
            if (this.currentPage === 'results-page' && this.resultImageUrl) {
                this.adjustImageContainer();
            }
        }, 300);
    }

    async setPage(pageId) {
        console.log(`ğŸ“„ åˆ‡æ¢é¡µé¢: ${this.currentPage} -> ${pageId}`);
        
        // å…ˆç§»é™¤æ‰€æœ‰é¡µé¢çš„ activeï¼Œé¿å…å¤šä¸ªé¡µé¢åŒæ—¶æ˜¾ç¤º
        try {
            const activePages = document.querySelectorAll('.page.active');
            console.log(`ğŸ” æ‰¾åˆ° ${activePages.length} ä¸ªæ´»åŠ¨é¡µé¢:`, Array.from(activePages).map(el => el.id));
            activePages.forEach((el) => el.classList.remove('active'));
        } catch (e) {
            console.error('âŒ ç§»é™¤activeç±»å¤±è´¥:', e);
        }

        // å…œåº•å†æ¬¡ç§»é™¤å½“å‰è®°å½•é¡µé¢çš„ active
        const currentPageEl = document.getElementById(this.currentPage);
        if (currentPageEl) {
            currentPageEl.classList.remove('active');
            console.log(`âœ… ç§»é™¤äº†å½“å‰é¡µé¢çš„activeç±»: ${this.currentPage}`);
        }

        // å¦‚æœç¦»å¼€æ‹ç…§é¡µé¢ï¼Œåˆ™è§£ç»‘å¹¶å…³é—­æ‘„åƒå¤´æµï¼Œé¿å…é•¿æœŸå ç”¨
        try {
            if (this.currentPage === 'profile-page' && pageId !== 'profile-page') {
                const v = document.getElementById('camera-video');
                if (v) {
                    try { v.pause && v.pause(); } catch {}
                    try { v.srcObject = null; } catch {}
                }
                await deinitializeCamera();
            }
        } catch (e) {
            console.warn('âš ï¸ ç¦»å¼€æ‹ç…§é¡µé¢æ—¶å…³é—­æ‘„åƒå¤´å¤±è´¥:', e && e.message);
        }

        // å¦‚æœç¦»å¼€ç»“æœé¡µé¢ï¼Œæ¸…ç†äº‹ä»¶ç›‘å¬å™¨
        if (this.currentPage === 'results-page') {
            window.removeEventListener('resize', this.handleWindowResize.bind(this));
            if (this.resizeTimer) {
                clearTimeout(this.resizeTimer);
                this.resizeTimer = null;
            }
        }

        // æ˜¾ç¤ºæ–°é¡µé¢
        const newPageEl = document.getElementById(pageId);
        if (newPageEl) {
            newPageEl.classList.add('active');
            this.currentPage = pageId;
            console.log(`âœ… é¡µé¢åˆ‡æ¢æˆåŠŸï¼Œæ–°é¡µé¢: ${pageId}`);
            console.log(`ğŸ” æ–°é¡µé¢çš„displayæ ·å¼:`, window.getComputedStyle(newPageEl).display);
        } else {
            console.error(`âŒ æ‰¾ä¸åˆ°é¡µé¢å…ƒç´ : ${pageId}`);
        }
        
        // æ›´æ–°åˆ†é¡µå™¨çŠ¶æ€
        this.updatePaginator(pageId);

        // é¡µé¢åˆ‡æ¢æ—¶çš„ç‰¹æ®Šå¤„ç†
        await this.onPageChange(pageId);
        
        console.log(`ğŸ“„ é¡µé¢åˆ‡æ¢æµç¨‹å®Œæˆ: ${pageId}`);
    }
    
    // æ›´æ–°åˆ†é¡µå™¨çŠ¶æ€
    updatePaginator(pageId) {
        // å®šä¹‰é¡µé¢åˆ°åˆ†é¡µå™¨ç´¢å¼•çš„æ˜ å°„
        const pageIndexMap = {
            'welcome-page': 0,
            'profile-page': 1,  // æ‹ç…§é¡µé¢ä¸æ˜¾ç¤ºåˆ†é¡µå™¨ï¼Œä½†ä¿ç•™ç´¢å¼•
            'clothing-page': 2,
            'results-page': 3,
            'scan-to-get-page': 3  // æ‰«ç è·å–å›¾ç‰‡é¡µé¢ä½¿ç”¨ç¬¬4ä¸ªç‚¹
        };
        
        // è·å–å½“å‰é¡µé¢çš„åˆ†é¡µå™¨ç´¢å¼•
        const currentIndex = pageIndexMap[pageId];
        if (currentIndex === undefined) return;
        
        // æ›´æ–°æ‰€æœ‰é¡µé¢çš„åˆ†é¡µå™¨
        const pagesWithPaginator = ['welcome-page', 'clothing-page', 'results-page', 'scan-to-get-page'];
        
        pagesWithPaginator.forEach(pageId => {
            const pageEl = document.getElementById(pageId);
            if (pageEl) {
                const paginator = pageEl.querySelector('.paginator');
                if (paginator) {
                    const dots = paginator.querySelectorAll('.page-dot');
                    dots.forEach((dot, index) => {
                        if (index === currentIndex) {
                            dot.classList.add('active');
                        } else {
                            dot.classList.remove('active');
                        }
                    });
                }
            }
        });
    }

    async onPageChange(pageId) {
        // ç¦»å¼€é¦–é¡µåˆ™æš‚åœäºŒç»´ç 5åˆ†é’Ÿå®šæ—¶åˆ·æ–°
        if (pageId !== 'welcome-page') {
            this.stopWechatQRRefreshTimer();
        }
        switch(pageId) {
            case 'profile-page':
                // æ‹ç…§é¡µï¼šåˆå§‹åŒ–æ‘„åƒå¤´å¹¶ç»‘å®šé¢„è§ˆ
                // ä½¿ç”¨ try-catch åŒ…è£¹ï¼Œé¿å…æ‘„åƒå¤´é”™è¯¯é˜»æ–­æµç¨‹
                try {
                    console.log('ğŸ“¸ å‡†å¤‡åˆå§‹åŒ–æ‘„åƒå¤´...');
                    
                    // å…ˆé‡Šæ”¾ç°æœ‰çš„æ‘„åƒå¤´æµï¼Œé¿å…å ç”¨å†²çª
                    if (typeof deinitializeCamera === 'function') {
                        console.log('ğŸ§½ æ¸…ç†ç°æœ‰æ‘„åƒå¤´æµ...');
                        deinitializeCamera();
                    }
                    
                    // å¦‚æœæ˜¯å¼€å‘æ¨¡å¼è·³è¿‡ç™»å½•ï¼Œç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œè®©è®¾å¤‡å®Œå…¨å°±ç»ª
                    if (this.devModeSkippedLogin) {
                        console.log('â±ï¸ å¼€å‘æ¨¡å¼ï¼šç­‰å¾…500msè®©æ‘„åƒå¤´è®¾å¤‡å°±ç»ª...');
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    await initializeCamera();
                    await enableCameraUI();
                    // æˆåŠŸæ—¥å¿—ç”± initializeCamera() å†…éƒ¨è¾“å‡ºï¼Œé¿å…é‡å¤
                } catch (cameraError) {
                    console.error('âŒ æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', cameraError.name, cameraError.message);
                    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
                    this.showCameraErrorNotification(cameraError);
                    // æ‘„åƒå¤´å¤±è´¥ä¸é˜»æ–­æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
                }
                // å¼€å§‹æ–°ä¼šè¯ - å·²å¼ƒç”¨
                // await this.startNewSession();
                break;
            case 'welcome-page':
                // åªåœ¨é¦–æ¬¡åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
                if (!this.welcomePageInitialized) {
                    console.log('ğŸ”„ é¦–æ¬¡åˆ‡æ¢åˆ°æ¬¢è¿é¡µï¼Œå¼€å§‹åˆå§‹åŒ–...');
                    await this.initializeWelcomePage();
                    this.welcomePageInitialized = true;
                } else {
                    console.log('â„¹ï¸ æ¬¢è¿é¡µå·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                }
                break;
            case 'config-page':
                // å…¼å®¹æ—§è°ƒç”¨ï¼šæ”¹ä¸ºä»¥å¯¹è¯æ¡†å½¢å¼æ‰“å¼€é…ç½®
                openConfig();
                break;
            case 'clothing-page':
                await this.initializeClothingPage();
                break;
            case 'results-page':
        // ç»“æœé¡µä»…è´Ÿè´£å±•ç¤ºç»“æœä¸äº¤äº’ï¼Œä¸åœ¨è¿›å…¥æ—¶è‡ªåŠ¨å€’è®¡æ—¶
        // å€’è®¡æ—¶åœ¨å›¾ç‰‡æˆåŠŸå±•ç¤ºåç”± showResult çš„ onload å›è°ƒè§¦å‘
                window.addEventListener('resize', this.handleWindowResize.bind(this));
                break;
            case 'photo-confirm-page':
                // æ‹ç…§ç¡®è®¤é¡µï¼šç¡®ä¿ç…§ç‰‡å·²è®¾ç½®
                console.log('ğŸ“¸ åˆ‡æ¢åˆ°æ‹ç…§ç¡®è®¤é¡µ');
                const capturedPhoto = document.getElementById('captured-photo');
                if (capturedPhoto && this.capturedPhotoData) {
                    capturedPhoto.src = this.capturedPhotoData;
                    console.log('âœ… å·²è®¾ç½®ç…§ç‰‡æ•°æ®');
                } else {
                    console.warn('âš ï¸ ç…§ç‰‡æ•°æ®æœªæ‰¾åˆ°');
                }
                break;
            case 'download-page':
                // ä¸å†ç”Ÿæˆä¸‹è½½äºŒç»´ç ï¼Œåªéœ€è¦æ¨é€ç»“æœåˆ°å¾®ä¿¡å…¬ä¼—å·
                // this.generateDownloadQR();
                this.startCountdown();
                // ç»“æŸä¼šè¯ - å·²å¼ƒç”¨
                // await this.endCurrentSession();
                break;
        }
    }

    // ç”Ÿæˆå¾®ä¿¡äºŒç»´ç  - ä¿®æ”¹ä¸ºä½¿ç”¨æ–°çš„æ¥å£è§„èŒƒ
    async generateWechatQRCode() {
        try {
            // åªæœ‰åœ¨æ¬¢è¿é¡µé¢å±•ç¤ºäºŒç»´ç æ—¶æ‰ç”ŸæˆäºŒç»´ç 
            if (this.currentPage !== 'welcome-page') {
                console.log('â„¹ï¸ å½“å‰ä¸åœ¨æ¬¢è¿é¡µé¢ï¼Œè·³è¿‡äºŒç»´ç ç”Ÿæˆ');
                return;
            }
            
            console.log('ğŸ” æ£€æŸ¥APIå®¢æˆ·ç«¯çŠ¶æ€:', {
                hasApiClient: !!window.apiClient,
                initialized: window.apiClient ? window.apiClient.initialized : false
            });
            
            // ç¡®ä¿APIå®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!window.apiClient) {
                console.log('âš ï¸ APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆ›å»ºå®ä¾‹...');
                if (typeof window.ApiClient === 'function') {
                    window.apiClient = new window.ApiClient();
                } else {
                    console.warn('âŒ æ— æ³•åˆ›å»º API å®¢æˆ·ç«¯å®ä¾‹ï¼ˆç¼ºå°‘æ„é€ å‡½æ•°ï¼‰ï¼Œè·³è¿‡äºŒç»´ç ç”Ÿæˆ');
                    return;
                }
            }
            
            if (!window.apiClient.initialized) {
                console.log('ğŸ”„ APIå®¢æˆ·ç«¯å°šæœªåˆå§‹åŒ–ï¼Œæ‰§è¡Œåˆå§‹åŒ–...');
                if (typeof window.apiClient.initialize === 'function') {
                await window.apiClient.initialize();
                console.log('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ');
                } else {
                    console.warn('âŒ APIå®¢æˆ·ç«¯ç¼ºå°‘ initialize æ–¹æ³•ï¼Œè·³è¿‡äºŒç»´ç ç”Ÿæˆ');
                    return;
                }
            }
            
            // å¤„ç†MACåœ°å€ï¼šå»æ‰å†’å·ä½œä¸ºè®¾å¤‡å”¯ä¸€æ ‡è¯†
            const deviceId = this.macAddress ? this.macAddress.replace(/:/g, '') : this.macAddress;
            console.log('ğŸ“± ç”Ÿæˆå¾®ä¿¡å…³æ³¨äºŒç»´ç ï¼Œä½¿ç”¨å¤„ç†åçš„MACåœ°å€:', deviceId);
            
            // è°ƒç”¨APIç”ŸæˆäºŒç»´ç 
            const response = await window.apiClient.generateWechatQRCode(deviceId);
            
            if (response.success) {
                this.wechatQRCode = response.qrCode;
                // ä¿å­˜åœºæ™¯å€¼
                this.qrSceneStr = response.qrCode.sceneStr;
                
                // æ›´æ–°é¡µé¢ä¸Šçš„äºŒç»´ç æ˜¾ç¤º
                const qrImg = document.getElementById('wechat-qr-image');
                if (qrImg) {
                    qrImg.src = response.qrCode.dataURL;
                    console.log('âœ… å¾®ä¿¡äºŒç»´ç ç”ŸæˆæˆåŠŸ');
                }
            } else {
                throw new Error(response.error || 'ç”ŸæˆäºŒç»´ç å¤±è´¥');
            }
        } catch (error) {
            console.error('âŒ ç”Ÿæˆå¾®ä¿¡äºŒç»´ç å¤±è´¥:', error);
            
            // å¦‚æœæ˜¯ç¦»çº¿æ¨¡å¼æˆ–ç½‘ç»œé”™è¯¯ï¼Œæ˜¾ç¤ºå ä½ç¬¦äºŒç»´ç 
            if (window.apiClient && window.apiClient.isOfflineMode()) {
                console.log('ğŸŒ ç¦»çº¿æ¨¡å¼ï¼šæ˜¾ç¤ºå ä½ç¬¦äºŒç»´ç ');
                this.showOfflineQRCode();
            } else if (error.message.includes('Failed to fetch') || 
                       error.message.includes('ERR_NETWORK_CHANGED') ||
                       error.message.includes('ERR_INTERNET_DISCONNECTED')) {
                console.log('ğŸŒ ç½‘ç»œé”™è¯¯ï¼šæ˜¾ç¤ºå ä½ç¬¦äºŒç»´ç ');
                this.showOfflineQRCode();
            }
            
            // äºŒç»´ç ç”Ÿæˆå¤±è´¥æ—¶ä¸å†å¼¹å‡ºé”™è¯¯æç¤ºæ¡†ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯
            // this.showError('ç”Ÿæˆå¾®ä¿¡äºŒç»´ç å¤±è´¥: ' + error.message);
        }
    }

    // æ‰‹åŠ¨åˆ·æ–°å¾®ä¿¡äºŒç»´ç 
    async refreshWechatQRCode() {
        console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°å¾®ä¿¡äºŒç»´ç ...');
        
        // åªæœ‰åœ¨æ¬¢è¿é¡µé¢æ‰å…è®¸æ‰‹åŠ¨åˆ·æ–°äºŒç»´ç 
        if (this.currentPage !== 'welcome-page') {
            console.log('â„¹ï¸ å½“å‰ä¸åœ¨æ¬¢è¿é¡µé¢ï¼Œä¸å…è®¸æ‰‹åŠ¨åˆ·æ–°äºŒç»´ç ');
            return;
        }
        
        // é˜²æ­¢é¢‘ç¹åˆ·æ–°ï¼ˆé˜²æŠ–æœºåˆ¶ï¼‰
        const now = Date.now();
        if (this.lastQRRefreshTime && (now - this.lastQRRefreshTime) < 5000) {
            console.log('âš ï¸ åˆ·æ–°è¿‡äºé¢‘ç¹ï¼Œå¿½ç•¥æœ¬æ¬¡è¯·æ±‚');
            return;
        }
        this.lastQRRefreshTime = now;
        
        // ç¦ç”¨åˆ·æ–°æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
        const refreshBtn = document.getElementById('refresh-qr-btn');
        if (refreshBtn) {
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
        }
        
        try {
            await this.generateWechatQRCode();
            console.log('âœ… å¾®ä¿¡äºŒç»´ç æ‰‹åŠ¨åˆ·æ–°å®Œæˆ');
        } catch (error) {
            console.error('âŒ å¾®ä¿¡äºŒç»´ç æ‰‹åŠ¨åˆ·æ–°å¤±è´¥:', error);
            // æ‰‹åŠ¨åˆ·æ–°å¤±è´¥æ—¶ä¸å†å¼¹å‡ºé”™è¯¯æç¤ºæ¡†ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯
            // this.showError('äºŒç»´ç åˆ·æ–°å¤±è´¥: ' + error.message);
        } finally {
            // æ¢å¤åˆ·æ–°æŒ‰é’®çŠ¶æ€
            if (refreshBtn) {
                // å»¶è¿Ÿæ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œé˜²æ­¢ç”¨æˆ·è¿ç»­ç‚¹å‡»
                setTimeout(() => {
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°äºŒç»´ç ';
                    }
                }, 2000);
            }
        }
    }

    // å¯åŠ¨5åˆ†é’Ÿå®šæ—¶åˆ·æ–°æœºåˆ¶
    startWechatQRRefreshTimer() {
        console.log('ğŸ”„ å¯åŠ¨å¾®ä¿¡äºŒç»´ç 5åˆ†é’Ÿå®šæ—¶åˆ·æ–°æœºåˆ¶...');
        
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (this.wechatRefreshInterval) {
            console.log('ğŸ”„ æ¸…é™¤æ—§çš„å¾®ä¿¡äºŒç»´ç åˆ·æ–°å®šæ—¶å™¨');
            clearInterval(this.wechatRefreshInterval);
        }
        
        // æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡äºŒç»´ç  (5åˆ†é’Ÿ = 300000æ¯«ç§’)
        this.wechatRefreshInterval = setInterval(async () => {
            try {
                console.log('â° 5åˆ†é’Ÿå®šæ—¶åˆ·æ–°å¾®ä¿¡äºŒç»´ç ...');
                // é˜²æ­¢é¢‘ç¹åˆ·æ–°ï¼ˆé˜²æŠ–æœºåˆ¶ï¼‰
                const now = Date.now();
                if (this.lastQRRefreshTime && (now - this.lastQRRefreshTime) < 5000) {
                    console.log('âš ï¸ å®šæ—¶åˆ·æ–°è¿‡äºé¢‘ç¹ï¼Œå¿½ç•¥æœ¬æ¬¡è¯·æ±‚');
                    return;
                }
                this.lastQRRefreshTime = now;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨æ¬¢è¿é¡µé¢ï¼Œåªæœ‰åœ¨æ¬¢è¿é¡µé¢æ‰åˆ·æ–°äºŒç»´ç 
                if (this.currentPage !== 'welcome-page') {
                    console.log('â„¹ï¸ å½“å‰ä¸åœ¨æ¬¢è¿é¡µé¢ï¼Œè·³è¿‡äºŒç»´ç åˆ·æ–°');
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨å…¬ä¼—å·ï¼Œå¦‚æœå·²å…³æ³¨åˆ™åœæ­¢åˆ·æ–°
                if (this.qrSceneStr && window.apiClient) {
                    try {
                        const response = await window.apiClient.checkWechatStatus(this.qrSceneStr);
                        const isSubscribed = response.isSubscribed || response.isVerified;
                        
                        if (response.success && isSubscribed) {
                            console.log('âœ… ç”¨æˆ·å·²å…³æ³¨å…¬ä¼—å·ï¼Œåœæ­¢äºŒç»´ç å®šæ—¶åˆ·æ–°');
                            this.stopWechatQRRefreshTimer();
                            return;
                        }
                    } catch (error) {
                        console.error('æ£€æŸ¥ç”¨æˆ·å…³æ³¨çŠ¶æ€å¤±è´¥:', error);
                    }
                }
                
                await this.generateWechatQRCode();
                console.log('âœ… å¾®ä¿¡äºŒç»´ç 5åˆ†é’Ÿå®šæ—¶åˆ·æ–°å®Œæˆ');
            } catch (error) {
                console.error('âŒ å¾®ä¿¡äºŒç»´ç 5åˆ†é’Ÿå®šæ—¶åˆ·æ–°å¤±è´¥:', error);
                // å®šæ—¶åˆ·æ–°å¤±è´¥æ—¶ä¸å†å¼¹å‡ºé”™è¯¯æç¤ºæ¡†ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯
            }
        }, 300000); // 5åˆ†é’Ÿ = 300000æ¯«ç§’
        
        console.log('âœ… å¾®ä¿¡äºŒç»´ç 5åˆ†é’Ÿå®šæ—¶åˆ·æ–°æœºåˆ¶å·²å¯åŠ¨');
    }

    // åœæ­¢5åˆ†é’Ÿå®šæ—¶åˆ·æ–°æœºåˆ¶
    stopWechatQRRefreshTimer() {
        if (this.wechatRefreshInterval) {
            clearInterval(this.wechatRefreshInterval);
            this.wechatRefreshInterval = null;
            console.log('ğŸ›‘ å¾®ä¿¡äºŒç»´ç 5åˆ†é’Ÿå®šæ—¶åˆ·æ–°æœºåˆ¶å·²åœæ­¢');
        }
    }
    // åˆå§‹åŒ–æ¬¢è¿é¡µé¢
    async initializeWelcomePage() {
        console.log('ğŸ“± åˆå§‹åŒ–æ¬¢è¿é¡µé¢...');
        
        // å¦‚æœæ˜¯å¼€å‘æ¨¡å¼è·³è¿‡ç™»å½•ï¼Œä¸åˆå§‹åŒ–å¾®ä¿¡ç›¸å…³åŠŸèƒ½
        if (this.devModeSkippedLogin) {
            console.log('â„¹ï¸ å¼€å‘æ¨¡å¼å·²è·³è¿‡ç™»å½•ï¼Œè·³è¿‡æ¬¢è¿é¡µé¢åˆå§‹åŒ–');
            return;
        }
        
        // åˆå§‹åŒ–è¿ç»­ç‚¹å‡»æ£€æµ‹
        this.initializeClickDetection();
        
        // åˆå§‹åŒ–å¼€å‘æ¨¡å¼å¿«æ·é”®å’ŒæŒ‰é’®
        this.initializeDevelopmentMode();
        
        // è·å–è®¾å¤‡MACåœ°å€
        console.log('ğŸ” å¼€å§‹è·å–è®¾å¤‡MACåœ°å€...');
        await this.getMacAddress();
        console.log('âœ… MACåœ°å€è·å–å®Œæˆ:', this.macAddress);
        
        // ç¡®ä¿è®¾å¤‡å·²è®¤è¯ï¼ˆå¤±è´¥ä¸é˜»æ–­åç»­äºŒç»´ç ç”Ÿæˆï¼‰
        try {
            await this.ensureDeviceAuthenticated();
        } catch (e) {
            console.warn('è®¾å¤‡è®¤è¯å¤±è´¥ï¼Œç»§ç»­å°è¯•ç”ŸæˆäºŒç»´ç :', e && e.message ? e.message : e);
            
            // å¦‚æœæ˜¯ç¦»çº¿æ¨¡å¼ï¼Œæ˜¾ç¤ºç¦»çº¿æç¤º
            if (window.apiClient && window.apiClient.isOfflineMode()) {
                this.showOfflineNotification();
            }
        }
        
        // æ£€æŸ¥è®¾å¤‡çŠ¶æ€ï¼ˆä»…åœ¨éç¦»çº¿æ¨¡å¼ä¸‹ï¼‰
        if (!window.apiClient.isOfflineMode()) {
            console.log('ğŸ” å¼€å§‹æ£€æŸ¥è®¾å¤‡çŠ¶æ€...');
            try {
                const deviceStatusResponse = await window.apiClient.getDeviceStatus();
            console.log('ğŸ” è®¾å¤‡çŠ¶æ€æ£€æŸ¥å“åº”å®Œæ•´æ•°æ®:', JSON.stringify(deviceStatusResponse, null, 2));
            
            // æ£€æŸ¥å“åº”ç»“æ„å¹¶æ­£ç¡®æå–è®¾å¤‡çŠ¶æ€
            if (deviceStatusResponse.success && deviceStatusResponse.device) {
                // å…¼å®¹ä¸åŒçš„å“åº”ç»“æ„
                let deviceStatus = deviceStatusResponse.device.status;
                
                // å¦‚æœstatuså­—æ®µä¸å­˜åœ¨ï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„å­—æ®µå
                if (deviceStatus === undefined) {
                    deviceStatus = deviceStatusResponse.device.deviceStatus;
                }
                
                // å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°çŠ¶æ€å­—æ®µï¼Œè®¾ç½®é»˜è®¤å€¼ä¸º'IDLE'
                if (deviceStatus === undefined) {
                    deviceStatus = 'IDLE';
                    console.log('âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡çŠ¶æ€å­—æ®µï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€: IDLE');
                }
                
                console.log('ğŸ“± è®¾å¤‡çŠ¶æ€:', deviceStatus);
                
                // åªæœ‰å½“è®¾å¤‡çŠ¶æ€ä¸ºç©ºé—²(IDLE)æ—¶æ‰æ˜¾ç¤ºäºŒç»´ç 
                if (deviceStatus === 'IDLE') {
                    console.log('âœ… è®¾å¤‡çŠ¶æ€ä¸ºç©ºé—²ï¼Œå¯ä»¥æ˜¾ç¤ºäºŒç»´ç ');
                    
                    // ç”Ÿæˆå¾®ä¿¡äºŒç»´ç 
                    console.log('ğŸ” å¼€å§‹ç”Ÿæˆå¾®ä¿¡äºŒç»´ç ...');
                    await this.generateWechatQRCode();
                    console.log('âœ… å¾®ä¿¡äºŒç»´ç ç”Ÿæˆå®Œæˆ');
                    
                    // å¯åŠ¨5åˆ†é’Ÿå®šæ—¶åˆ·æ–°æœºåˆ¶
                    console.log('ğŸ” å¯åŠ¨5åˆ†é’Ÿå®šæ—¶åˆ·æ–°æœºåˆ¶...');
                    this.startWechatQRRefreshTimer();
                    console.log('âœ… 5åˆ†é’Ÿå®šæ—¶åˆ·æ–°æœºåˆ¶å¯åŠ¨å®Œæˆ');
                    
                    // å¼€å§‹æ£€æŸ¥å¾®ä¿¡å…³æ³¨çŠ¶æ€
                    console.log('ğŸ” å¼€å§‹è®¾ç½®å¾®ä¿¡çŠ¶æ€æ£€æŸ¥...');
                    this.startWechatStatusCheck();
                    console.log('âœ… å¾®ä¿¡çŠ¶æ€æ£€æŸ¥è®¾ç½®å®Œæˆ');
                } else {
                    console.log('âš ï¸ è®¾å¤‡çŠ¶æ€ä¸ä¸ºç©ºé—²ï¼Œå½“å‰çŠ¶æ€:', deviceStatus);
                    // æ ¹æ®è®¾å¤‡çŠ¶æ€æ˜¾ç¤ºç›¸åº”çš„æç¤ºä¿¡æ¯
                    this.showDeviceStatusMessage(deviceStatus);
                }
            } else {
                console.error('âŒ è®¾å¤‡çŠ¶æ€æ£€æŸ¥å¤±è´¥:', deviceStatusResponse.error || 'æœªçŸ¥é”™è¯¯');
                // å³ä½¿è®¾å¤‡çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ˜¾ç¤ºäºŒç»´ç 
                await this.generateWechatQRCode();
                this.startWechatQRRefreshTimer();
                this.startWechatStatusCheck();
            }
            } catch (error) {
                console.error('âŒ è®¾å¤‡çŠ¶æ€æ£€æŸ¥å¼‚å¸¸:', error);
                // å³ä½¿è®¾å¤‡çŠ¶æ€æ£€æŸ¥å¼‚å¸¸ï¼Œä¹Ÿç»§ç»­æ˜¾ç¤ºäºŒç»´ç 
                await this.generateWechatQRCode();
                this.startWechatQRRefreshTimer();
                this.startWechatStatusCheck();
            }
        } else {
            console.log('ğŸŒ ç¦»çº¿æ¨¡å¼ï¼šè·³è¿‡è®¾å¤‡çŠ¶æ€æ£€æŸ¥ï¼Œç›´æ¥ç”ŸæˆäºŒç»´ç ');
            // ç¦»çº¿æ¨¡å¼ä¸‹ç›´æ¥ç”ŸæˆäºŒç»´ç 
            await this.generateWechatQRCode();
            this.startWechatQRRefreshTimer();
            this.startWechatStatusCheck();
        }
    }

    // æ˜¾ç¤ºè®¾å¤‡çŠ¶æ€æ¶ˆæ¯
    showDeviceStatusMessage(status) {
        const qrContainer = document.getElementById('wechat-qr');
        if (qrContainer) {
            let message = '';
            switch (status) {
                case 'IN_USE':
                    message = 'è®¾å¤‡æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œè¯·ç¨åå†è¯•';
                    break;
                case 'MAINTENANCE':
                    message = 'è®¾å¤‡ç»´æŠ¤ä¸­ï¼Œè¯·ç¨åå†è¯•';
                    break;
                default:
                    message = `è®¾å¤‡çŠ¶æ€: ${status}`;
            }
            
            qrContainer.innerHTML = `
                <div class="device-status-message">
                    <p>${message}</p>
                    <button onclick="appState.refreshDeviceStatus()">åˆ·æ–°çŠ¶æ€</button>
                </div>
            `;
        }
    }

    // åˆ·æ–°è®¾å¤‡çŠ¶æ€
    async refreshDeviceStatus() {
        console.log('ğŸ”„ åˆ·æ–°è®¾å¤‡çŠ¶æ€...');
        await this.initializeWelcomePage();
    }

    // åˆå§‹åŒ–å¼€å‘æ¨¡å¼åŠŸèƒ½
    initializeDevelopmentMode() {
        if (!this.isDevelopment) {
            console.log('â„¹ï¸ éå¼€å‘æ¨¡å¼ï¼Œè·³è¿‡å¼€å‘åŠŸèƒ½åˆå§‹åŒ–');
            return;
        }
        
        console.log('ğŸ”§ åˆå§‹åŒ–å¼€å‘æ¨¡å¼åŠŸèƒ½...');
        
        // æ˜¾ç¤ºå¼€å‘æ¨¡å¼æŒ‰é’®
        this.showDevelopmentModeButton();
        
        // ç›‘å¬å¿«æ·é”® Ctrl+Shift+D
        this.initializeDevelopmentShortcuts();
        
        console.log('âœ… å¼€å‘æ¨¡å¼åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    }

    // æ˜¾ç¤ºå¼€å‘æ¨¡å¼æŒ‰é’®
    showDevelopmentModeButton() {
        // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å·²å­˜åœ¨
        let devButton = document.getElementById('dev-skip-login-btn');
        if (devButton) {
            devButton.style.display = 'block';
            return;
        }
        
        // åˆ›å»ºå¼€å‘æ¨¡å¼è·³è¿‡ç™»å½•æŒ‰é’®
        devButton = document.createElement('button');
        devButton.id = 'dev-skip-login-btn';
        devButton.className = 'dev-skip-button';
        devButton.innerHTML = 'ğŸš€ è·³è¿‡ç™»å½• (å¼€å‘æ¨¡å¼)';
        devButton.onclick = () => this.skipLoginForDevelopment();
        
        // æ·»åŠ åˆ°æ¬¢è¿é¡µé¢åº•éƒ¨
        const welcomePage = document.getElementById('welcome-page');
        if (welcomePage) {
            welcomePage.appendChild(devButton);
            console.log('âœ… å¼€å‘æ¨¡å¼è·³è¿‡æŒ‰é’®å·²æ·»åŠ ');
        }
    }

    // éšè—å¼€å‘æ¨¡å¼æŒ‰é’®
    hideDevelopmentModeButton() {
        const devButton = document.getElementById('dev-skip-login-btn');
        if (devButton) {
            devButton.style.display = 'none';
        }
    }

    // åˆå§‹åŒ–å¼€å‘æ¨¡å¼å¿«æ·é”®
    initializeDevelopmentShortcuts() {
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
        if (this.devShortcutHandler) {
            document.removeEventListener('keydown', this.devShortcutHandler);
        }
        
        // åˆ›å»ºå¿«æ·é”®å¤„ç†å‡½æ•°
        this.devShortcutHandler = (event) => {
            // Ctrl+Shift+D è·³è¿‡ç™»å½•
            if (event.ctrlKey && event.shiftKey && event.key === 'D') {
                event.preventDefault();
                console.log('ğŸ”§ æ£€æµ‹åˆ°å¿«æ·é”® Ctrl+Shift+Dï¼Œè·³è¿‡ç™»å½•');
                this.skipLoginForDevelopment();
            }
        };
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('keydown', this.devShortcutHandler);
        
        console.log('âœ… å¼€å‘æ¨¡å¼å¿«æ·é”®å·²å¯ç”¨ï¼ˆCtrl+Shift+D è·³è¿‡ç™»å½•ï¼‰');
    }

    // å¼€å‘æ¨¡å¼è·³è¿‡ç™»å½•
    async skipLoginForDevelopment() {
        // ç”Ÿäº§ç¯å¢ƒä¸‹ç»å¯¹ç¦æ­¢è·³è¿‡ç™»å½•
        if (typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'production') {
            console.error('âŒ ç”Ÿäº§ç¯å¢ƒä¸‹ä¸å…è®¸è·³è¿‡ç™»å½•ï¼');
            this.showError('ç”Ÿäº§ç¯å¢ƒä¸‹ä¸å…è®¸è·³è¿‡ç™»å½•ï¼Œè¯·æ‰«ç å¾®ä¿¡å…¬ä¼—å·è¿›è¡Œç™»å½•');
            return;
        }
        
        if (!this.isDevelopment) {
            console.warn('âš ï¸ éå¼€å‘æ¨¡å¼ï¼Œæ— æ³•è·³è¿‡ç™»å½•');
            return;
        }
        
        console.log('ğŸš€ å¼€å‘æ¨¡å¼ï¼šè·³è¿‡å¾®ä¿¡æ‰«ç ç™»å½•');
        
        try {
            // è®¾ç½®å¼€å‘æ¨¡å¼è·³è¿‡ç™»å½•æ ‡å¿—
            this.devModeSkippedLogin = true;
            
            // åœæ­¢å¾®ä¿¡çŠ¶æ€æ£€æŸ¥å’ŒäºŒç»´ç åˆ·æ–°
            this.stopWechatStatusCheck();
            this.stopWechatQRRefreshTimer();
            
            // å¼€å‘æ¨¡å¼ä¸‹ï¼šè°ƒç”¨ä¸€é”®è®¾ç½®æ¥å£
            try {
                if (window.apiClient && this.macAddress) {
                    console.log('ğŸ“¡ å¼€å‘æ¨¡å¼ï¼šè°ƒç”¨å¿«é€Ÿè®¾ç½®æ¥å£...');
                    const deviceName = 'DEV_DEVICE_' + this.macAddress.replace(/:/g, '');
                    const nickname = 'Dev_User_' + Date.now();
                    
                    const quickSetupResponse = await window.apiClient.quickSetup(this.macAddress, deviceName, nickname);
                    
                    if (quickSetupResponse && quickSetupResponse.success) {
                        // ä¿å­˜ä»æœåŠ¡å™¨è¿”å›çš„ tokenï¼ˆå·²åœ¨ apiClient ä¸­è‡ªåŠ¨ä¿å­˜ï¼‰
                        // ä¿å­˜ä»æœåŠ¡å™¨è¿”å›çš„ sceneStr å’Œç”¨æˆ·ä¿¡æ¯
                        this.qrSceneStr = quickSetupResponse.sceneStr;
                        this.userProfile.openid = quickSetupResponse.wechatUser.openid;
                        
                        console.log('âœ… å¼€å‘æ¨¡å¼å¿«é€Ÿè®¾ç½®æˆåŠŸ:', {
                            sceneStr: this.qrSceneStr,
                            openid: this.userProfile.openid,
                            deviceId: quickSetupResponse.device.id
                        });
                        
                        console.log('ğŸ’¡ ä½¿ç”¨è¯´æ˜:');
                        console.log('  - Tokenå·²è‡ªåŠ¨ä¿å­˜ï¼Œåç»­è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦');
                        console.log('  - sceneStr:', this.qrSceneStr);
                        console.log('  - ç°åœ¨å¯ä»¥ç›´æ¥æµ‹è¯•ä¸Šä¼ ç…§ç‰‡ã€é€‰æ‹©æœè£…ç­‰åŠŸèƒ½');
                    } else {
                        throw new Error('å¿«é€Ÿè®¾ç½®å¤±è´¥: ' + (quickSetupResponse?.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } else {
                    console.warn('âš ï¸ APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–æˆ–MACåœ°å€æœªè·å–');
                    throw new Error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–æˆ–MACåœ°å€æœªè·å–');
                }
            } catch (setupError) {
                console.error('âŒ å¼€å‘æ¨¡å¼å¿«é€Ÿè®¾ç½®å¤±è´¥:', setupError.message);
                throw setupError;
            }
            
            // ç›´æ¥è·³è½¬åˆ°æ‹ç…§é¡µé¢
            await this.setPage('profile-page');
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            this.showDevModeNotification('å·²è·³è¿‡ç™»å½•ï¼Œç›´æ¥è¿›å…¥æ‹ç…§é¡µé¢ï¼ˆå¼€å‘æ¨¡å¼ï¼‰');
            
        } catch (error) {
            console.error('âŒ å¼€å‘æ¨¡å¼è·³è¿‡ç™»å½•å¤±è´¥:', error);
            this.showError('è·³è¿‡ç™»å½•å¤±è´¥: ' + error.message);
        }
    }

    // æ˜¾ç¤ºå¼€å‘æ¨¡å¼é€šçŸ¥
    showDevModeNotification(message) {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = 'dev-mode-notification';
        notification.innerHTML = `
            <div class="dev-notification-content">
                <span class="dev-icon">ğŸ”§</span>
                <span class="dev-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // æ˜¾ç¤ºæ‘„åƒå¤´é”™è¯¯é€šçŸ¥
    showCameraErrorNotification(error) {
        let message = 'æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥';
        let tips = '';
        let solutions = [];
        
        if (error.name === 'NotReadableError') {
            message = 'æ‘„åƒå¤´æ— æ³•è®¿é—®ï¼ˆè®¾å¤‡è¢«å ç”¨æˆ–é©±åŠ¨é—®é¢˜ï¼‰';
            tips = 'æ‘„åƒå¤´æ­£è¢«å…¶ä»–åº”ç”¨ä½¿ç”¨ï¼Œæˆ–è€…ç³»ç»Ÿé©±åŠ¨å¼‚å¸¸ã€‚';
            solutions = [
                'å…³é—­å ç”¨æ‘„åƒå¤´çš„åº”ç”¨ï¼šZoomã€Teamsã€Skypeã€æµè§ˆå™¨æ ‡ç­¾é¡µ',
                'æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨ï¼Œç»“æŸå ç”¨æ‘„åƒå¤´çš„è¿›ç¨‹',
                'æ£€æŸ¥è®¾å¤‡ç®¡ç†å™¨ä¸­æ‘„åƒå¤´è®¾å¤‡çŠ¶æ€ï¼Œæ›´æ–°é©±åŠ¨',
                'é‡å¯è®¡ç®—æœºåå†è¯•'
            ];
        } else if (error.name === 'NotAllowedError') {
            message = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»';
            tips = 'åº”ç”¨æ²¡æœ‰è·å¾—è®¿é—®æ‘„åƒå¤´çš„æƒé™ã€‚';
            solutions = [
                'Windowsè®¾ç½® â†’ éšç§å’Œå®‰å…¨æ€§ â†’ æ‘„åƒå¤´',
                'å¯ç”¨â€œå…è®¸è®¿é—®æ­¤è®¾å¤‡ä¸Šçš„æ‘„åƒå¤´â€',
                'å¯ç”¨â€œå…è®¸åº”ç”¨è®¿é—®æ‘„åƒå¤´â€',
                'å¯ç”¨â€œå…è®¸æ¡Œé¢åº”ç”¨è®¿é—®æ‘„åƒå¤´â€',
                'é‡å¯åº”ç”¨åå†è¯•'
            ];
        } else if (error.name === 'NotFoundError') {
            message = 'æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡';
            tips = 'ç³»ç»Ÿæ‰¾ä¸åˆ°å¯ç”¨çš„æ‘„åƒå¤´è®¾å¤‡ã€‚';
            solutions = [
                'æ£€æŸ¥æ‘„åƒå¤´æ˜¯å¦æ­£ç¡®è¿æ¥åˆ°ç”µè„‘',
                'æ‰“å¼€è®¾å¤‡ç®¡ç†å™¨ï¼ŒæŸ¥çœ‹â€œç…§ç›¸æœºâ€æˆ–â€œå›¾åƒè®¾å¤‡â€',
                'å°è¯•é‡æ–°æ’æ‹”USBæ‘„åƒå¤´',
                'å¦‚ä½¿ç”¨ç¬”è®°æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦ç¦ç”¨äº†å†…ç½®æ‘„åƒå¤´'
            ];
        } else if (error.name === 'OverconstrainedError') {
            message = 'æ‘„åƒå¤´ä¸æ”¯æŒè¯·æ±‚çš„åˆ†è¾¨ç‡æˆ–å¸§ç‡';
            tips = 'æ‘„åƒå¤´ç¡¬ä»¶ä¸æ”¯æŒå½“å‰è®¾ç½®çš„è§†é¢‘å‚æ•°ã€‚';
            solutions = [
                'åœ¨é…ç½®é¡µé¢ä¸­é€‰æ‹©å…¶ä»–æ‘„åƒå¤´',
                'é™ä½åˆ†è¾¨ç‡è¦æ±‚ï¼ˆå¦‚720pè€Œé1080pï¼‰',
                'æ›´æ–°æ‘„åƒå¤´é©±åŠ¨ç¨‹åº',
                'å°è¯•ä½¿ç”¨å…¶ä»–USBç«¯å£'
            ];
        } else {
            tips = error.message || 'æœªçŸ¥é”™è¯¯';
            solutions = [
                'å°è¯•é‡å¯åº”ç”¨',
                'æ£€æŸ¥ç³»ç»Ÿæ‘„åƒå¤´è®¾ç½®',
                'æ›´æ–°ç³»ç»Ÿå’Œé©±åŠ¨ç¨‹åº'
            ];
        }
        
        // æ„å»ºè§£å†³æ–¹æ¡ˆHTML
        const solutionsList = solutions.map((s, i) => `<li>${i + 1}. ${s}</li>`).join('');
        
        const notification = document.createElement('div');
        notification.className = 'dev-mode-notification camera-error';
        notification.innerHTML = `
            <div class="dev-notification-content">
                <span class="dev-icon">âš ï¸</span>
                <div class="dev-message">
                    <strong>${message}</strong>
                    ${tips ? '<br><small style="opacity: 0.9;">âš¡ ' + tips + '</small>' : ''}
                    ${solutions.length > 0 ? '<br><br><strong style="font-size: 14px;">ğŸ› ï¸ è§£å†³æ–¹æ¡ˆï¼š</strong><ul style="margin: 8px 0; padding-left: 20px; text-align: left;">' + solutionsList + '</ul>' : ''}
                    <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
                        <button onclick="appState.retryCamera()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 600;">
                            ğŸ”„ é‡è¯•åˆå§‹åŒ–æ‘„åƒå¤´
                        </button>
                    </div>
                    <div style="margin-top: 12px; text-align: center;">
                        <small style="opacity: 0.85; font-size: 12px;">âš ï¸ æ‘„åƒå¤´å¿…é¡»æˆåŠŸåˆå§‹åŒ–åæ‰èƒ½ç»§ç»­ä½¿ç”¨</small>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // é”™è¯¯é€šçŸ¥ä¸ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼Œåªèƒ½é€šè¿‡é‡è¯•æˆåŠŸåæ‰æ¶ˆå¤±
    }

    // é‡è¯•æ‘„åƒå¤´åˆå§‹åŒ–
    async retryCamera() {
        console.log('ğŸ”„ é‡è¯•æ‘„åƒå¤´åˆå§‹åŒ–...');
        // ç§»é™¤é”™è¯¯é€šçŸ¥
        const errorNotifs = document.querySelectorAll('.camera-error');
        errorNotifs.forEach(notif => {
            notif.style.opacity = '0';
            setTimeout(() => {
                if (notif.parentNode) {
                    document.body.removeChild(notif);
                }
            }, 300);
        });
        
        // é‡æ–°åˆå§‹åŒ–æ‘„åƒå¤´
        try {
            console.log('ğŸ“¸ å‡†å¤‡é‡æ–°åˆå§‹åŒ–æ‘„åƒå¤´...');
            await initializeCamera();
            await enableCameraUI();
            console.log('âœ… æ‘„åƒå¤´åˆå§‹åŒ–æˆåŠŸï¼');
            this.showDevModeNotification('âœ… æ‘„åƒå¤´åˆå§‹åŒ–æˆåŠŸï¼');
        } catch (error) {
            console.error('âŒ é‡è¯•å¤±è´¥:', error.name, error.message);
            this.showCameraErrorNotification(error);
        }
    }

    // è¿ç»­ç‚¹å‡»æ£€æµ‹åˆå§‹åŒ–
    initializeClickDetection() {
        console.log('ğŸ”„ åˆå§‹åŒ–è¿ç»­ç‚¹å‡»æ£€æµ‹...');
        
        // åœ¨å³ä¸Šè§’æ·»åŠ é€æ˜çš„ç‚¹å‡»åŒºåŸŸ
        let clickArea = document.getElementById('config-click-area');
        if (!clickArea) {
            clickArea = document.createElement('div');
            clickArea.id = 'config-click-area';
            clickArea.style.cssText = `
                position: fixed;
                top: 0;
                right: 0;
                width: 100px;
                height: 100px;
                z-index: 9999;
                background: transparent;
                cursor: pointer;
            `;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            clickArea.addEventListener('click', (e) => {
                this.handleConfigClick(e);
            });
            
            // æ·»åŠ åˆ°æ¬¢è¿é¡µé¢
            const welcomePage = document.getElementById('welcome-page');
            if (welcomePage) {
                welcomePage.appendChild(clickArea);
            }
        }
        
        console.log('âœ… è¿ç»­ç‚¹å‡»æ£€æµ‹åˆå§‹åŒ–å®Œæˆ');
    }
    
    // å¤„ç†é…ç½®ç‚¹å‡»äº‹ä»¶
    handleConfigClick(event) {
        console.log('ğŸ’† æ£€æµ‹åˆ°å³ä¸Šè§’ç‚¹å‡»ï¼Œå½“å‰è®¡æ•°:', this.clickCount + 1);
        
        // å¢åŠ ç‚¹å‡»è®¡æ•°
        this.clickCount++;
        
        // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
        if (this.clickTimer) {
            clearTimeout(this.clickTimer);
        }
        
        // è®¾ç½®æ–°çš„è®¡æ—¶å™¨
        this.clickTimer = setTimeout(() => {
            console.log('ğŸ”„ è¿ç»­ç‚¹å‡»è¶…æ—¶ï¼Œé‡ç½®è®¡æ•°å™¨');
            this.clickCount = 0;
        }, this.clickTimeWindow);
        
        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°4æ¬¡ç‚¹å‡»
        if (this.clickCount >= 4) {
            console.log('âœ… è¿ç»­ç‚¹å‡»4æ¬¡ï¼Œæ‰“å¼€é…ç½®é¡µé¢');
            
            // æ¸…é™¤è®¡æ—¶å™¨å’Œè®¡æ•°å™¨
            if (this.clickTimer) {
                clearTimeout(this.clickTimer);
                this.clickTimer = null;
            }
            this.clickCount = 0;
            
            // æ‰“å¼€é…ç½®é¡µé¢
            this.setPage('config-page');
            
            // å¯é€‰ï¼šæ˜¾ç¤ºæç¤º
            // this.showError('å·²æ‰“å¼€é…ç½®é¡µé¢');
        }
    }

    // è·å–è®¾å¤‡MACåœ°å€
    async getMacAddress() {
        try {
            // åœ¨Electronç¯å¢ƒä¸­è·å–MACåœ°å€
            if (typeof require !== 'undefined') {
                const os = require('os');
                const interfaces = os.networkInterfaces();
                
                // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„MACåœ°å€
                for (const name of Object.keys(interfaces)) {
                    for (const iface of interfaces[name]) {
                        if (!iface.internal && iface.mac && iface.mac !== '00:00:00:00:00:00') {
                            this.macAddress = iface.mac;
                            console.log('ğŸ“± è·å–åˆ°è®¾å¤‡MACåœ°å€:', this.macAddress);
                            return;
                        }
                    }
                }
            }
            
            // å¦‚æœæ— æ³•è·å–çœŸå®MACåœ°å€ï¼Œç”Ÿæˆä¸€ä¸ªæ¨¡æ‹Ÿçš„
            this.macAddress = '00:11:22:33:44:55';
            console.log('ğŸ“± ä½¿ç”¨æ¨¡æ‹ŸMACåœ°å€:', this.macAddress);
        } catch (error) {
            console.error('âŒ è·å–MACåœ°å€å¤±è´¥:', error);
            this.macAddress = '00:11:22:33:44:55'; // é»˜è®¤å€¼
        }
    }

    // å¼€å§‹ä½“éªŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä¿®æ”¹ä¸ºå¿…é¡»æ‰«ç å…³æ³¨åæ‰èƒ½ä½“éªŒ
    async startExperience() {
        try {
            console.log('ğŸš€ ç”¨æˆ·ç‚¹å‡»å¼€å§‹ä½“éªŒæŒ‰é’®');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å…³æ³¨äº†å…¬ä¼—å·
            if (this.qrSceneStr && window.apiClient) {
                // ä½¿ç”¨äºŒç»´ç åœºæ™¯å€¼æ£€æŸ¥ç”¨æˆ·å…³æ³¨çŠ¶æ€
                const response = await window.apiClient.checkWechatStatus(this.qrSceneStr);
                
                // æ£€æŸ¥æ˜¯å¦å·²å…³æ³¨ï¼ˆå…¼å®¹isSubscribedå’ŒisVerifiedä¸¤ç§å­—æ®µï¼‰
                const isSubscribed = response.isSubscribed || response.isVerified;
                
                if (response.success && isSubscribed) {
                    console.log('âœ… ç”¨æˆ·å·²å…³æ³¨å…¬ä¼—å·ï¼Œç›´æ¥è·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µé¢');
                    await appState.setPage('profile-page');
                    return;
                }
            }
            
            // å¦‚æœæœªå…³æ³¨ï¼Œæç¤ºç”¨æˆ·å…ˆå…³æ³¨å…¬ä¼—å·
            appState.showError('è¯·å…ˆå¾®ä¿¡æ‰«ç å…³æ³¨å…¬ä¼—å·åå†å¼€å§‹ä½“éªŒ');
        } catch (error) {
            console.error('æ£€æŸ¥å¾®ä¿¡å…³æ³¨çŠ¶æ€å¤±è´¥:', error);
            appState.showError('æ£€æŸ¥å¾®ä¿¡å…³æ³¨çŠ¶æ€å¤±è´¥: ' + error.message);
        }
    }

    // æ‰“å¼€é…ç½®é¡µé¢
    openConfigPage() {
        openConfig();
    }

    // å¼€å§‹æ£€æŸ¥å¾®ä¿¡å…³æ³¨çŠ¶æ€
    startWechatStatusCheck() {
        console.log('ğŸ”„ å¼€å§‹è®¾ç½®å¾®ä¿¡çŠ¶æ€æ£€æŸ¥å®šæ—¶å™¨...');
        
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (this.wechatCheckInterval) {
            console.log('ğŸ”„ æ¸…é™¤æ—§çš„å¾®ä¿¡çŠ¶æ€æ£€æŸ¥å®šæ—¶å™¨');
            clearInterval(this.wechatCheckInterval);
        }
        
        // æ£€æŸ¥å¿…è¦æ¡ä»¶
        if (!this.qrSceneStr) {
            console.warn('âš ï¸ äºŒç»´ç åœºæ™¯å€¼æœªè®¾ç½®ï¼Œæ— æ³•å¼€å§‹å¾®ä¿¡çŠ¶æ€æ£€æŸ¥');
            return;
        }
        
        if (!window.apiClient) {
            console.warn('âš ï¸ APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•å¼€å§‹å¾®ä¿¡çŠ¶æ€æ£€æŸ¥');
            return;
        }
        
        console.log('âœ… å¼€å§‹æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡å¾®ä¿¡å…³æ³¨çŠ¶æ€...');
        
        // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡å…³æ³¨çŠ¶æ€
        this.wechatCheckInterval = setInterval(async () => {
            try {
                console.log('ğŸ” æ‰§è¡Œå¾®ä¿¡çŠ¶æ€æ£€æŸ¥...');
                if (this.qrSceneStr && window.apiClient) {
                    // ä½¿ç”¨äºŒç»´ç åœºæ™¯å€¼æ£€æŸ¥ç”¨æˆ·å…³æ³¨çŠ¶æ€
                    const response = await window.apiClient.checkWechatStatus(this.qrSceneStr);
                    
                    console.log('ğŸ” å¾®ä¿¡çŠ¶æ€æ£€æŸ¥å“åº”:', response);
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å…³æ³¨ï¼ˆå…¼å®¹isSubscribedå’ŒisVerifiedä¸¤ç§å­—æ®µï¼‰
                    const isSubscribed = response.isSubscribed || response.isVerified;
                    
                    if (response.success && isSubscribed) {
                        console.log('âœ… ç”¨æˆ·å·²å…³æ³¨å…¬ä¼—å·');
                        
                        // ä¸å†ä¸»åŠ¨åˆ·æ–°äºŒç»´ç ï¼Œå› ä¸ºè¿™ä¼šå¯¼è‡´sceneStrå˜åŒ–
                        // ç›´æ¥æ¸…é™¤å®šæ—¶å™¨å¹¶è·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µé¢
                        console.log('ğŸ”„ ç”¨æˆ·å·²å…³æ³¨å…¬ä¼—å·ï¼Œå‡†å¤‡è·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µé¢...');
                        
                        // æ¸…é™¤å®šæ—¶å™¨
                        if (this.wechatCheckInterval) {
                            clearInterval(this.wechatCheckInterval);
                            this.wechatCheckInterval = null;
                        }
                        
                        // è‡ªåŠ¨è·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µé¢
                        console.log('ğŸš€ è·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µé¢...');
                        await this.setPage('profile-page');
                    } else {
                        console.log('â³ ç”¨æˆ·å°šæœªå…³æ³¨å…¬ä¼—å·ï¼Œç»§ç»­æ£€æŸ¥...');
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥å¾®ä¿¡å…³æ³¨çŠ¶æ€å¤±è´¥:', error);
                // å…³æ³¨çŠ¶æ€æ£€æŸ¥å¤±è´¥æ—¶ä¸å†å¼¹å‡ºé”™è¯¯æç¤ºæ¡†ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•é”™è¯¯
            }
        }, 3000);
    }

    // åœæ­¢æ£€æŸ¥å¾®ä¿¡å…³æ³¨çŠ¶æ€
    stopWechatStatusCheck() {
        if (this.wechatCheckInterval) {
            clearInterval(this.wechatCheckInterval);
            this.wechatCheckInterval = null;
        }
    }

    // å¯åŠ¨ä¼šè¯è¶…æ—¶å®šæ—¶å™¨
    startSessionTimeout() {
        /*
        // ä¼šè¯ç®¡ç†å·²å¼ƒç”¨
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (this.sessionTimeoutTimer) {
            clearTimeout(this.sessionTimeoutTimer);
        }
        
        // è®¾ç½®5åˆ†é’Ÿè¶…æ—¶
        this.sessionTimeoutTimer = setTimeout(async () => {
            console.log('â° ä¼šè¯è¶…æ—¶ï¼Œç»“æŸå½“å‰ä¼šè¯');
            await this.endCurrentSession();
        }, 300000); // 5åˆ†é’Ÿ = 300000æ¯«ç§’
        
        console.log('âœ… ä¼šè¯è¶…æ—¶å®šæ—¶å™¨å·²å¯åŠ¨ï¼ˆ5åˆ†é’Ÿï¼‰');
        */
    }

    // åœæ­¢ä¼šè¯è¶…æ—¶å®šæ—¶å™¨
    stopSessionTimeout() {
        /*
        // ä¼šè¯ç®¡ç†å·²å¼ƒç”¨
        if (this.sessionTimeoutTimer) {
            clearTimeout(this.sessionTimeoutTimer);
            this.sessionTimeoutTimer = null;
            console.log('ğŸ›‘ ä¼šè¯è¶…æ—¶å®šæ—¶å™¨å·²åœæ­¢');
        }
        */
    }

    // ç»“æŸå½“å‰ä¼šè¯
    async endCurrentSession() {
        /*
        // ä¼šè¯ç®¡ç†å·²å¼ƒç”¨
        try {
            if (this.deviceId && this.currentSessionId && window.apiClient) {
                console.log('ğŸ”„ ç»“æŸå½“å‰ä¼šè¯:', this.currentSessionId);
                const response = await window.apiClient.endDeviceSession(this.deviceId, this.currentSessionId);
                
                if (response.success) {
                    console.log('âœ… ä¼šè¯å·²ç»“æŸï¼Œè®¾å¤‡çŠ¶æ€å·²æ›´æ–°:', response.device.status);
                    this.currentSessionId = null;
                    
                    // å¦‚æœåœ¨è¯•è¡£æµç¨‹ä¸­ï¼Œè¿”å›æ¬¢è¿é¡µé¢
                    if (this.currentPage !== 'welcome-page') {
                        await this.setPage('welcome-page');
                    }
                } else {
                    throw new Error(response.error || 'ç»“æŸä¼šè¯å¤±è´¥');
                }
            }
        } catch (error) {
            console.error('âŒ ç»“æŸä¼šè¯å¤±è´¥:', error);
        }
        */
    }

    // å¼€å§‹æ–°ä¼šè¯
    async startNewSession() {
        /*
        // ä¼šè¯ç®¡ç†å·²å¼ƒç”¨
        try {
            // è·å–è®¾å¤‡ID
            if (!this.deviceId) {
                const deviceStatusResponse = await window.apiClient.getDeviceStatus();
                if (deviceStatusResponse.success && deviceStatusResponse.device) {
                    this.deviceId = deviceStatusResponse.device.id;
                    console.log('ğŸ“± è·å–åˆ°è®¾å¤‡ID:', this.deviceId);
                }
            }
            
            if (this.deviceId) {
                // è·å–æœ€æ–°çš„ä¼šè¯ä¿¡æ¯
                const sessionsResponse = await window.apiClient.getDeviceSessions(this.deviceId, { status: 'ACTIVE', limit: 1 });
                if (sessionsResponse.success && sessionsResponse.sessions && sessionsResponse.sessions.length > 0) {
                    this.currentSessionId = sessionsResponse.sessions[0].id;
                    console.log('âœ… è·å–åˆ°å½“å‰ä¼šè¯ID:', this.currentSessionId);
                    
                    // å¯åŠ¨ä¼šè¯è¶…æ—¶å®šæ—¶å™¨
                    this.startSessionTimeout();
                }
            }
        } catch (error) {
            console.error('âŒ å¼€å§‹æ–°ä¼šè¯å¤±è´¥:', error);
        }
        */
    }

    async initializeProfilePage() {
        // ä¿ç•™å‡½æ•°ä»¥å…¼å®¹æ—§è°ƒç”¨ï¼Œä½†å†…éƒ¨åªå§”æ‰˜åˆ° onPageChange çš„é€»è¾‘
        this.stopWechatStatusCheck();
        console.log('ğŸ“¸ è¿›å…¥æ‹ç…§é¡µé¢ï¼Œæ£€æŸ¥æ‘„åƒå¤´çŠ¶æ€...');
        const ok = await ensureCameraReadyAndShowUI();
        if (!ok) { showCameraError(); }
    }

    async initializeClothingPage() {
        console.log('ğŸ‘• åˆå§‹åŒ–æœè£…é¡µé¢...');
        
        // â­ æ¸…ç†ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€å’ŒUIæ ·å¼ï¼ˆä¿®å¤ç¬¬äºŒæ¬¡ä½¿ç”¨æ—¶çš„ç¼“å­˜é—®é¢˜ï¼‰
        this.selectedClothing = null;
        this.selectedTopBottom = null;
        this.selectedDress = null;
        this.lastSelectionType = null;
        this.isDressSelected = false;
        
        // æ¸…ç†æ‰€æœ‰æœè£…é¡¹çš„é€‰ä¸­æ ·å¼
        document.querySelectorAll('.clothing-item.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // é‡ç½®é€‰æ‹©æ‘˜è¦UI
        const selectedClothingEl = document.getElementById('selected-clothing');
        const proceedBtn = document.getElementById('proceed-btn');
        if (selectedClothingEl) {
            selectedClothingEl.innerHTML = '<span>å°šæœªé€‰æ‹©æœè£…</span>';
        }
        if (proceedBtn) {
            proceedBtn.disabled = true;
        }
        
        // æ£€æŸ¥å¹¶ç­‰å¾…APIå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ
        if (!window.apiClient) {
            console.log('âš ï¸ APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œç­‰å¾…åˆå§‹åŒ–å®Œæˆ...');
            
            // ç­‰å¾…APIå®¢æˆ·ç«¯åˆå§‹åŒ–ï¼Œæœ€å¤šç­‰å¾…10ç§’
            let attempts = 0;
            const maxAttempts = 100; // 10ç§’ï¼Œæ¯100msæ£€æŸ¥ä¸€æ¬¡
            
            while (!window.apiClient && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.apiClient) {
                console.error('âŒ APIå®¢æˆ·ç«¯åˆå§‹åŒ–è¶…æ—¶');
                appState.showError('APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                return;
            }
        }
        
        // ç¡®ä¿APIå®¢æˆ·ç«¯å·²åˆå§‹åŒ–
        if (!window.apiClient.initialized) {
            console.log('ğŸ”„ APIå®¢æˆ·ç«¯å°šæœªåˆå§‹åŒ–ï¼Œæ‰§è¡Œåˆå§‹åŒ–...');
            try {
                await window.apiClient.initialize();
                console.log('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // æ£€æŸ¥è®¾å¤‡è®¤è¯çŠ¶æ€
        if (!window.apiClient.token) {
            console.log('âš ï¸ è®¾å¤‡æœªè®¤è¯ï¼Œå°è¯•è¿›è¡Œè®¤è¯...');
            try {
                // åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨è®¤è¯é€»è¾‘ï¼Œä½†ç”±äºéœ€è¦MACåœ°å€ï¼Œæˆ‘ä»¬å…ˆè·³è¿‡
                console.log('è®¾å¤‡è®¤è¯éœ€è¦åœ¨åº”ç”¨å¯åŠ¨æ—¶å®Œæˆï¼Œè¯·æ£€æŸ¥åˆå§‹åŒ–æµç¨‹');
            } catch (error) {
                console.error('è®¾å¤‡è®¤è¯å¤±è´¥:', error);
            }
        }
        
        // æ ¹æ®ç”¨æˆ·æ¡£æ¡ˆè®¾ç½®å½“å‰æ€§åˆ«
        this.currentGender = this.userProfile.gender;
        
        // è®¾ç½®æ€§åˆ«tabçš„åˆå§‹çŠ¶æ€
        this.setupGenderTabs();
        this.updateGenderTabState();
        
        this.setupCategoryTabs();
        
        // åœ¨è°ƒç”¨åŠ è½½å‰æ˜¾ç¤ºåŠ è½½æç¤º
        try {
            const topsGrid = document.getElementById('tops-grid');
            const bottomsGrid = document.getElementById('bottoms-grid');
            if (topsGrid) topsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">âš™ï¸ æ­£åœ¨åŠ è½½ä¸Šè¡£...</div>';
            if (bottomsGrid) bottomsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">âš™ï¸ æ­£åœ¨åŠ è½½ä¸‹è¡£...</div>';
        } catch (error) {}
        
        // åŠ è½½æœè£…æ•°æ®ï¼ˆåŒæ—¶åŠ è½½ä¸Šè¡£ä¸ä¸‹è¡£ï¼‰
        await this.loadClothingItems();
        this.updateCategoryNotice();
        
        // åˆå§‹åŒ–é»˜è®¤æœè£…é¢„è§ˆ
        this.initializeDefaultClothingPreviews();
    }
    
    // åˆå§‹åŒ–é»˜è®¤æœè£…é¢„è§ˆ
    initializeDefaultClothingPreviews() {
        // åˆå§‹åŒ–é»˜è®¤çš„ä¸Šè¡£é¢„è§ˆ
        this.initializeClothingPreview('tops');
        
        // åˆå§‹åŒ–é»˜è®¤çš„ä¸‹è¡£é¢„è§ˆ
        this.initializeClothingPreview('bottoms');
    }
    
    // åˆå§‹åŒ–ç‰¹å®šç±»åˆ«çš„æœè£…é¢„è§ˆ
    initializeClothingPreview(category) {
        // ç¡®ä¿defaultClothingå¯¹è±¡å­˜åœ¨
        if (!this.defaultClothing) {
            this.defaultClothing = {
                tops: [
                    { id: 'top1', name: 'ç™½è‰²è¡¬è¡«', image: 'public/coats/1.jpg' },
                    { id: 'top2', name: 'ç²‰è‰²Tæ¤', image: 'public/coats/2.jpg' },
                    { id: 'top3', name: 'è“è‰²é’ˆç»‡è¡«', image: 'public/coats/3.jpg' }
                ],
                bottoms: [
                    { id: 'bottom1', name: 'ç‰›ä»”è£¤', image: 'public/pants/9.jpg' },
                    { id: 'bottom2', name: 'æ—¶å°šé•¿è£¤', image: 'public/pants/10.jpg' },
                    { id: 'bottom3', name: 'ä¼‘é—²è£¤', image: 'public/pants/11.jpg' }
                ]
            };
        }
        
        // è·å–é»˜è®¤æœè£…æ•°æ®
        const defaultItems = this.defaultClothing[category] || [];
        
        // è·å–é¢„è§ˆå®¹å™¨
        const previewContainer = document.querySelector(`.clothing-section.${category} .clothing-preview-container`);
        
        if (previewContainer && defaultItems.length > 0) {
            // è·å–ç°æœ‰çš„é¢„è§ˆé¡¹ï¼ˆæ’é™¤é€‰æ‹©è¦†ç›–å±‚ï¼‰
            const previewItems = Array.from(previewContainer.children).filter(el => el.classList.contains('clothing-item-preview'));
            
            // æ›´æ–°ç°æœ‰çš„é¢„è§ˆé¡¹
            previewItems.forEach((previewItem, index) => {
                if (index < defaultItems.length) {
                    const item = defaultItems[index];
                    const imagePlaceholder = previewItem.querySelector('.clothing-item-image-placeholder');
                    const nameElement = previewItem.querySelector('.clothing-item-name');
                    
                    // æ›´æ–°å›¾ç‰‡ï¼Œä½¿ç”¨getImageUrlæ–¹æ³•è½¬æ¢URL
                    if (imagePlaceholder) {
                        const imageUrl = this.getImageUrl(item.image);
                        imagePlaceholder.innerHTML = `<img src="${imageUrl}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 15px;">`;
                    }
                    
                    // æ›´æ–°åç§°
                    if (nameElement) {
                        nameElement.textContent = item.name;
                    }
                    
                    // ç‚¹å‡»äº‹ä»¶å·²åœ¨HTMLä¸­è®¾ç½®
                }
            });
        }
    }

    setupGenderTabs() {
        const genderTabs = document.querySelectorAll('.gender-tab');
        genderTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
                genderTabs.forEach(t => t.classList.remove('active'));
                // è®¾ç½®å½“å‰tabä¸ºactive
                tab.classList.add('active');
                this.currentGender = tab.dataset.gender;
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                this.selectedClothing = null;
                this.selectedTopBottom = null;
                this.selectedDress = null;
                this.isDressSelected = false;
                this.currentCategory = 'tops-bottoms';
                this.currentSubCategory = 'tops';
                this.updateSelectionSummary();
                this.updateCategoryNotice();
                this.updateCategoryTabsState();
                this.updateSubCategoryTabs();
                
                // é‡æ–°åŠ è½½æœè£…æ•°æ®
                this.loadClothingItems();
            });
        });
    }

    setupCategoryTabs() {
        const categoryTabs = document.querySelectorAll('.tab');
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.classList.contains('disabled')) {
                    return; // å¦‚æœè¢«ç¦ç”¨ï¼Œä¸å“åº”ç‚¹å‡»
                }
                
                // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
                categoryTabs.forEach(t => t.classList.remove('active'));
                // è®¾ç½®å½“å‰tabä¸ºactive
                tab.classList.add('active');
                this.currentCategory = tab.dataset.category;
                
                // æ˜¾ç¤º/éšè—å­åˆ†ç±»tab
                this.updateSubCategoryTabs();
                
                // é‡æ–°åŠ è½½æœè£…æ•°æ®
                this.loadClothingItems();
            });
        });
    }

    setupSubCategoryTabs() {
        const subCategoryTabs = document.querySelectorAll('.sub-tab');
        subCategoryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.classList.contains('disabled')) {
                    return; // å¦‚æœè¢«ç¦ç”¨ï¼Œä¸å“åº”ç‚¹å‡»
                }
                
                // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
                subCategoryTabs.forEach(t => t.classList.remove('active'));
                // è®¾ç½®å½“å‰tabä¸ºactive
                tab.classList.add('active');
                this.currentSubCategory = tab.dataset.subcategory;
                
                // é‡æ–°åŠ è½½æœè£…æ•°æ®
                this.loadClothingItems();
            });
        });
    }

    loadClothingItems() {
        const category = this.currentCategory;
        const subCategory = this.currentSubCategory;
        const gender = this.currentGender;
        const url = `/api/clothing/${gender}/${category}/${subCategory}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                this.updateClothingPreview(data);
            })
            .catch(error => {
                console.error('Error loading clothing items:', error);
            });
    }

    updateClothingPreview(items) {
        const previewContainer = document.querySelector(`.clothing-section.${this.currentSubCategory} .clothing-preview-container`);
        if (previewContainer) {
            previewContainer.innerHTML = '';
            items.forEach(item => {
                const previewItem = document.createElement('div');
                previewItem.classList.add('clothing-item-preview');
                previewItem.innerHTML = `
                    <div class="clothing-item-image-placeholder"></div>
                    <div class="clothing-item-name">${item.name}</div>
                `;
                previewItem.addEventListener('click', () => {
                    this.selectClothingItem(item);
                });
                previewContainer.appendChild(previewItem);
            });
        }
    }

    selectClothingItem(item) {
        this.selectedClothing = item;
        this.updateSelectionSummary();
    }

    updateSelectionSummary() {
        const summaryElement = document.querySelector('.selection-summary');
        if (summaryElement) {
            if (this.selectedClothing) {
                summaryElement.textContent = `å·²é€‰æ‹©: ${this.selectedClothing.name}`;
            } else {
                summaryElement.textContent = 'è¯·é€‰æ‹©æœè£…';
            }
        }
    }

    updateCategoryNotice() {
        const noticeElement = document.querySelector('.category-notice');
        if (noticeElement) {
            noticeElement.textContent = `å½“å‰ç±»åˆ«: ${this.currentCategory}`;
        }
    }

    updateCategoryTabsState() {
        const categoryTabs = document.querySelectorAll('.tab');
        categoryTabs.forEach(tab => {
            if (tab.dataset.category === this.currentCategory) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
    }

    updateSubCategoryTabs() {
        const subCategoryTabs = document.querySelectorAll('.sub-tab');
        subCategoryTabs.forEach(tab => {
            if (tab.dataset.category === this.currentCategory) {
                tab.classList.remove('disabled');
            } else {
                tab.classList.add('disabled');
            }
            if (tab.dataset.subcategory === this.currentSubCategory) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
    }

    getImageUrl(imagePath) {
        return new URL(imagePath, window.location.origin).href;
    }
            });
        });
        
        // è®¾ç½®å­åˆ†ç±»tabäº‹ä»¶
        this.setupSubCategoryTabs();
    }

    setupSubCategoryTabs() {
        const subCategoryTabs = document.querySelectorAll('.sub-tab');
        subCategoryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
                subCategoryTabs.forEach(t => t.classList.remove('active'));
                // è®¾ç½®å½“å‰tabä¸ºactive
                tab.classList.add('active');
                this.currentSubCategory = tab.dataset.subcategory;
                
                // é‡æ–°åŠ è½½æœè£…æ•°æ®
                this.loadClothingItems();
            });
        });
    }

    updateSubCategoryTabs() {
        const subCategoryTabs = document.getElementById('sub-category-tabs');
        if (subCategoryTabs) {
        if (this.currentCategory === 'tops-bottoms') {
            subCategoryTabs.style.display = 'block';
            // è®¾ç½®é»˜è®¤å­åˆ†ç±»
            if (!this.currentSubCategory) {
                this.currentSubCategory = 'tops';
            }
        } else {
            subCategoryTabs.style.display = 'none';
            this.currentSubCategory = null;
            }
        }
    }

    updateCategoryNotice() {
        const notice = document.getElementById('category-notice');
        if (notice) {
        if (this.isDressSelected) {
            notice.style.display = 'block';
        } else {
            notice.style.display = 'none';
            }
        }
    }

    // æ·»åŠ æ€§åˆ«åˆ‡æ¢åŠŸèƒ½
    switchGender(gender) {
        // æ›´æ–°å½“å‰æ€§åˆ«
        this.currentGender = gender;
        
        // æ›´æ–°tabæ ·å¼
        const genderTabs = document.querySelectorAll('.gender-tab');
        genderTabs.forEach(tab => {
            if (tab.dataset.gender === gender) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        // é‡ç½®é€‰æ‹©çŠ¶æ€
        this.selectedClothing = null;
        this.selectedTopBottom = null;
        this.selectedDress = null;
        this.isDressSelected = false;
        this.currentCategory = 'tops-bottoms';
        this.currentSubCategory = 'tops';
        this.updateSelectionSummary();
        this.updateCategoryNotice();
        this.updateCategoryTabsState();
        this.updateSubCategoryTabs();
        
        // é‡æ–°åŠ è½½æœè£…æ•°æ®
        this.loadClothingItems();
        
        // æ›´æ–°é»˜è®¤æœè£…é¢„è§ˆ
        this.initializeDefaultClothingPreviews();
        
        console.log(`åˆ‡æ¢åˆ°${gender === 'male' ? 'ç”·è£…' : 'å¥³è£…'}`);
    }

    updateCategoryTabsState() {
        const topsBottomsTab = document.querySelector('.tab[data-category="tops-bottoms"]');
        const dressesTab = document.querySelector('.tab[data-category="dresses"]');
        
        // ä¸å†ç¦ç”¨ä»»ä¸€tabï¼Œå§‹ç»ˆå¯åˆ‡æ¢ï¼›ä»…å±•ç¤ºä¸Šåº”ç”¨æ–‡æ¡ˆ
        if (topsBottomsTab) {
        topsBottomsTab.classList.remove('disabled');
        }
        if (dressesTab) {
        dressesTab.classList.remove('disabled');
        }
    }

    updateGenderTabState() {
        // æ›´æ–°æ€§åˆ«tabçš„activeçŠ¶æ€
        document.querySelectorAll('.gender-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.gender === this.currentGender) {
                tab.classList.add('active');
            }
        });
    }

    // è·å–å½“å‰åº”è¯¥ä½¿ç”¨çš„ç½‘æ ¼å…ƒç´ 
    getCurrentGrid() {
        const activeCategory = this.currentCategory;
        
        // æ ¹æ®å½“å‰åˆ†ç±»é€‰æ‹©æ­£ç¡®çš„ç½‘æ ¼å…ƒç´ 
        let gridId = 'tops-grid';
        if (activeCategory === 'dresses') {
            gridId = 'tops-grid'; // è£™å­ä¹Ÿä½¿ç”¨ä¸Šè¡£ç½‘æ ¼
        } else if (activeCategory === 'tops-bottoms') {
            gridId = this.currentSubCategory === 'tops' ? 'tops-grid' : 'bottoms-grid';
        }
        
        const grid = document.getElementById(gridId);
        if (!grid) {
            console.error('âŒ æ‰¾ä¸åˆ°ç½‘æ ¼å…ƒç´ :', gridId);
            throw new Error(`æ‰¾ä¸åˆ°ç½‘æ ¼å…ƒç´ : ${gridId}`);
        }
        return grid;
    }

    async loadClothingItems() {
        const activeCategory = this.currentCategory;
        const activeGender = this.currentGender;
        
        // å¦‚æœæ˜¯ä¸Šè¡£+ä¸‹è¡£ç±»åˆ«ï¼Œåˆ™åŒæ—¶åŠ è½½ä¸¤ä¸ªç½‘æ ¼
        if (activeCategory === 'tops-bottoms') {
            return await this.loadTopAndBottoms(activeGender);
        }
        
        const grid = this.getCurrentGrid();
        grid.innerHTML = '';

        try {
            console.log('ğŸ‘• å¼€å§‹ä»APIæœåŠ¡å™¨åŠ è½½æœè£…æ•°æ®:', {
                category: activeCategory,
                gender: activeGender,
                subCategory: this.currentSubCategory,
                hasApiClient: !!window.apiClient,
                hasToken: window.apiClient?.token ? 'æœ‰token' : 'æ— token'
            });
            
            // æ£€æŸ¥APIå®¢æˆ·ç«¯çŠ¶æ€
            if (!window.apiClient) {
                throw new Error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ api-client.js æ˜¯å¦æ­£ç¡®åŠ è½½');
            }
            
            if (!window.apiClient.token) {
                throw new Error('è®¾å¤‡è®¤è¯å¤±è´¥ï¼Œæ— æ³•è·å–æœè£…æ•°æ®ã€‚è¯·æ£€æŸ¥APIæœåŠ¡å™¨è¿æ¥çŠ¶æ€');
            }
            
            // ä» API Server è·å–æ•°æ®
            let itemsToShow = [];
            
            try {
                console.log('ğŸ” å°è¯•ä»APIæœåŠ¡å™¨è·å–åˆ†ç±»æ•°æ®...');
                const categories = await window.apiClient.getClothingCategories();
                console.log('ğŸ“‚ è·å–åˆ°åˆ†ç±»æ•°æ®:', categories);
                
                const genderCategory = categories.data.find(cat => 
                    cat.name === (activeGender === 'male' ? 'ç”·è£…' : 'å¥³è£…')
                );
                console.log('ğŸ‘¤ æŸ¥æ‰¾æ€§åˆ«åˆ†ç±»:', {
                    looking: activeGender === 'male' ? 'ç”·è£…' : 'å¥³è£…',
                    found: !!genderCategory,
                    available: categories.data.map(cat => cat.name)
                });
                
                if (!genderCategory) {
                    throw new Error(`æœªæ‰¾åˆ°å¯¹åº”çš„æ€§åˆ«åˆ†ç±»: ${activeGender === 'male' ? 'ç”·è£…' : 'å¥³è£…'}`);
                }
                
                let subCategoryId = null;
                
                if (activeCategory === 'tops-bottoms' && this.currentSubCategory) {
                    // æŸ¥æ‰¾å¯¹åº”çš„å­åˆ†ç±»
                    const subCategoryName = this.currentSubCategory === 'tops' ? 'å¤–å¥—' : 'è£¤å­';
                    const subCategory = genderCategory.children.find(child => 
                        child.name === subCategoryName
                    );
                    subCategoryId = subCategory ? subCategory.id : null;
                    console.log('ğŸ” æŸ¥æ‰¾å­åˆ†ç±»:', {
                        looking: subCategoryName,
                        found: !!subCategory,
                        available: genderCategory.children.map(child => child.name),
                        subCategoryId
                    });
                } else if (activeCategory === 'dresses') {
                    // æŸ¥æ‰¾è£™å­å­åˆ†ç±»
                    const subCategory = genderCategory.children.find(child => 
                        child.name === 'è¿è¡£è£™' || child.name === 'è£™å­'
                    );
                    subCategoryId = subCategory ? subCategory.id : null;
                    console.log('ğŸ‘— æŸ¥æ‰¾è£™å­åˆ†ç±»:', {
                        looking: ['è¿è¡£è£™', 'è£™å­'],
                        found: !!subCategory,
                        available: genderCategory.children.map(child => child.name),
                        subCategoryId
                    });
                }
                
                if (!subCategoryId) {
                    throw new Error(`æœªæ‰¾åˆ°å¯¹åº”çš„å­åˆ†ç±»ID`);
                }
                
                console.log('ğŸ‘” è·å–åˆ†ç±»æœè£…æ•°æ®:', subCategoryId);
                const clothesResponse = await window.apiClient.getClothingByCategory(subCategoryId);
                console.log('ğŸ“¦ è·å–åˆ°æœè£…æ•°æ®:', clothesResponse);
                
                if (!clothesResponse.success || !clothesResponse.data.clothes) {
                    throw new Error('APIæœåŠ¡å™¨è¿”å›çš„æœè£…æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                itemsToShow = clothesResponse.data.clothes.map(item => ({
                    id: item.id,
                    name: item.name,
                    image: this.getImageUrl(item.imageUrl), // ä½¿ç”¨è¾…åŠ©æ–¹æ³•è½¬æ¢å›¾ç‰‡URL
                    description: item.description,
                    prompt: item.prompt,
                    purchaseUrl: item.purchaseUrl
                }));
                console.log('âœ… æ˜ å°„åçš„æœè£…æ•°æ®:', itemsToShow.length, 'ä»¶');
                
            } catch (apiError) {
                console.error('âŒ APIæœåŠ¡å™¨æ•°æ®è·å–å¤±è´¥:', apiError);
                throw new Error(`APIæœåŠ¡å™¨æ•°æ®è·å–å¤±è´¥: ${apiError.message}`);
            }
            
            // æ˜¾ç¤ºæœè£…æ•°æ®
            if (itemsToShow.length === 0) {
                this.showNoDataMessage();
            } else {
                itemsToShow.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'clothing-item';
                    itemEl.dataset.id = item.id;
                    itemEl.innerHTML = `
                        <img src="${item.image}" alt="${item.name}">
                        <div class="label">${item.name}</div>
                    `;
                    itemEl.onclick = () => this.selectClothing(item);
                    
                    // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­
                    if (this.isItemSelected(item)) {
                        itemEl.classList.add('selected');
                    }
                    
                    grid.appendChild(itemEl);
                });
                console.log('âœ… æœè£…æ•°æ®æ¸²æŸ“å®Œæˆ');
            }
            
        } catch (error) {
            console.error('âŒ åŠ è½½æœè£…æ•°æ®å¤±è´¥:', error);
            this.showApiErrorMessage(error.message);
        }
    }

    // åŒæ—¶åŠ è½½ä¸Šè¡£å’Œä¸‹è¡£ä¸¤ä¸ªç½‘æ ¼ï¼Œæ ¹æ®å½“å‰æ€§åˆ«
    async loadTopAndBottoms(activeGender) {
        try {
            // æ£€æŸ¥APIå®¢æˆ·ç«¯çŠ¶æ€
            if (!window.apiClient) {
                throw new Error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ api-client.js æ˜¯å¦æ­£ç¡®åŠ è½½');
            }
            if (!window.apiClient.token) {
                throw new Error('è®¾å¤‡è®¤è¯å¤±è´¥ï¼Œæ— æ³•è·å–æœè£…æ•°æ®ã€‚è¯·æ£€æŸ¥APIæœåŠ¡å™¨è¿æ¥çŠ¶æ€');
            }
            const topsGrid = document.getElementById('tops-grid');
            const bottomsGrid = document.getElementById('bottoms-grid');
            if (topsGrid) topsGrid.innerHTML = '';
            if (bottomsGrid) bottomsGrid.innerHTML = '';

            // è·å–åˆ†ç±»æ ‘
            const categories = await window.apiClient.getClothingCategories();
            const genderCategory = categories.data.find(cat => cat.name === (activeGender === 'male' ? 'ç”·è£…' : 'å¥³è£…'));
            if (!genderCategory) throw new Error('æœªæ‰¾åˆ°æ€§åˆ«åˆ†ç±»');
            
            // æ ¹æ®æ€§åˆ«æŸ¥æ‰¾ä¸åŒçš„åˆ†ç±»
            let topsIds = [], bottomsId = null;
            if (activeGender === 'female') {
                // å¥³æ€§ï¼šä¸Šè¡£åŒ…æ‹¬å¤–å¥—å’Œè£™å­ï¼Œä¸‹è¡£åŒ…æ‹¬è£¤å­
                const jacketCat = genderCategory.children.find(child => child.name === 'å¤–å¥—');
                const dressCat = genderCategory.children.find(child => child.name === 'è£™å­');
                const pantsCat = genderCategory.children.find(child => child.name === 'è£¤å­');
                
                console.log('ğŸ” å¥³æ€§åˆ†ç±»æŸ¥æ‰¾ç»“æœ:', {
                    jacketCat: jacketCat ? { id: jacketCat.id, name: jacketCat.name } : null,
                    dressCat: dressCat ? { id: dressCat.id, name: dressCat.name } : null,
                    pantsCat: pantsCat ? { id: pantsCat.id, name: pantsCat.name } : null,
                    allChildren: genderCategory.children.map(child => ({ id: child.id, name: child.name }))
                });
                
                if (jacketCat) topsIds.push(jacketCat.id);
                if (dressCat) topsIds.push(dressCat.id);
                bottomsId = pantsCat ? pantsCat.id : null;
            } else {
                // ç”·æ€§ï¼šä¸Šè¡£æ˜¯å¤–å¥—ï¼Œä¸‹è¡£æ˜¯è£¤å­
                const jacketCat = genderCategory.children.find(child => child.name === 'å¤–å¥—');
                const pantsCat = genderCategory.children.find(child => child.name === 'è£¤å­');
                
                if (jacketCat) topsIds.push(jacketCat.id);
                bottomsId = pantsCat ? pantsCat.id : null;
            }

            // å¹¶è¡Œè·å–ä¸Šè¡£åˆ—è¡¨ï¼ˆå¯èƒ½åŒ…å«å¤šä¸ªåˆ†ç±»ï¼‰å’Œä¸‹è¡£åˆ—è¡¨
            const topsPromises = topsIds.map(id => window.apiClient.getClothingByCategory(id));
            const bottomsPromise = bottomsId ? window.apiClient.getClothingByCategory(bottomsId) : Promise.resolve({ success: true, data: { clothes: [] } });
            
            const [topsResponses, bottomsResp] = await Promise.all([
                Promise.all(topsPromises),
                bottomsPromise
            ]);

            // åˆå¹¶æ‰€æœ‰ä¸Šè¡£åˆ†ç±»çš„æœè£…
            const allTopsItems = [];
            console.log('ğŸ” å¼€å§‹åˆå¹¶ä¸Šè¡£æ•°æ®ï¼Œå“åº”æ•°é‡:', topsResponses.length);
            topsResponses.forEach((response, index) => {
                console.log(`ğŸ“¦ å¤„ç†ç¬¬${index + 1}ä¸ªå“åº”:`, {
                    success: response.success,
                    hasData: !!response.data,
                    clothesCount: response.data?.clothes?.length || 0,
                    categoryId: topsIds[index]
                });
                if (response.success && response.data?.clothes) {
                    console.log(`âœ… æ·»åŠ ${response.data.clothes.length}ä»¶æœè£…åˆ°ä¸Šè¡£åˆ—è¡¨`);
                    allTopsItems.push(...response.data.clothes);
                } else {
                    console.log(`âŒ è·³è¿‡æ— æ•ˆå“åº”:`, response);
                }
            });
            console.log('ğŸ“Š åˆå¹¶åçš„ä¸Šè¡£æ€»æ•°:', allTopsItems.length);
            
            const topsItems = allTopsItems.map(item => ({
                id: item.id,
                name: item.name,
                image: this.getImageUrl(item.imageUrl),
                description: item.description,
                prompt: item.prompt,
                purchaseUrl: item.purchaseUrl
            }));
            const bottomsItems = (bottomsResp.success && bottomsResp.data?.clothes ? bottomsResp.data.clothes : []).map(item => ({
                id: item.id,
                name: item.name,
                image: this.getImageUrl(item.imageUrl),
                description: item.description,
                prompt: item.prompt,
                purchaseUrl: item.purchaseUrl
            }));

            // æ¸²æŸ“ä¸¤ä¸ªç½‘æ ¼
            const renderGrid = (items, gridEl, subcategory) => {
                if (!gridEl) return;
                if (items.length === 0) {
                    gridEl.innerHTML = '<div style="text-align:center; padding: 20px; color:#666;">æš‚æ— æ•°æ®</div>';
                    return;
                }
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'clothing-item';
                    el.dataset.id = item.id;
                    el.innerHTML = `
                        <img src="${item.image}" alt="${item.name}">
                        <div class="label">${item.name}</div>
                    `;
                    el.onclick = () => { this.currentSubCategory = subcategory; this.selectClothing(item); };
                    if (this.isItemSelected(item)) el.classList.add('selected');
                    gridEl.appendChild(el);
                });
            };

            renderGrid(topsItems, topsGrid, 'tops');
            renderGrid(bottomsItems, bottomsGrid, 'bottoms');

            console.log('âœ… ä¸Šè¡£ä¸ä¸‹è¡£æ•°æ®æ¸²æŸ“å®Œæˆ', { tops: topsItems.length, bottoms: bottomsItems.length });
        } catch (error) {
            console.error('âŒ åŒæ—¶åŠ è½½ä¸Šè¡£/ä¸‹è¡£å¤±è´¥:', error);
            // å¤±è´¥æ—¶å•ç‹¬åœ¨ä¸¤ä¸ªgridè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const topsGrid = document.getElementById('tops-grid');
            const bottomsGrid = document.getElementById('bottoms-grid');
            const errorHtml = `<div style="text-align:center; padding: 20px; color:#b00;">åŠ è½½å¤±è´¥ï¼š${error.message}</div>`;
            if (topsGrid) topsGrid.innerHTML = errorHtml;
            if (bottomsGrid) bottomsGrid.innerHTML = errorHtml;
        }
    }

    isItemSelected(item) {
        if (this.selectedDress && this.selectedDress.item.id === item.id) {
            return true;
        }
        if (this.selectedTopBottom) {
            if (this.selectedTopBottom.tops && this.selectedTopBottom.tops.id === item.id) {
                return true;
            }
            if (this.selectedTopBottom.bottoms && this.selectedTopBottom.bottoms.id === item.id) {
                return true;
            }
        }
        return false;
    }

    // è·å–é€‰ä¸­çš„æœè£…ä¿¡æ¯
    getSelectedClothingInfo() {
        if (this.selectedDress) {
            return {
                name: this.selectedDress.item.name,
                category: 'è¿è¡£è£™',
                imageUrl: this.selectedDress.item.imageUrl,
                purchaseUrl: this.selectedDress.item.purchaseUrl
            };
        } else if (this.selectedTopBottom) {
            const tops = this.selectedTopBottom.tops;
            const bottoms = this.selectedTopBottom.bottoms;
            
            if (tops && bottoms) {
                return {
                    name: `${tops.name} + ${bottoms.name}`,
                    category: 'ä¸Šè¡£+ä¸‹è¡£',
                    imageUrl: tops.imageUrl, // ä½¿ç”¨ä¸Šè¡£å›¾ç‰‡
                    purchaseUrl: tops.purchaseUrl || bottoms.purchaseUrl
                };
            } else if (tops) {
                return {
                    name: tops.name,
                    category: 'ä¸Šè¡£',
                    imageUrl: tops.imageUrl,
                    purchaseUrl: tops.purchaseUrl
                };
            } else if (bottoms) {
                return {
                    name: bottoms.name,
                    category: 'ä¸‹è¡£',
                    imageUrl: bottoms.imageUrl,
                    purchaseUrl: bottoms.purchaseUrl
                };
            }
        }
        
        return {
            name: 'æœªé€‰æ‹©æœè£…',
            category: '',
            imageUrl: '',
            purchaseUrl: ''
        };
    }

    showApiErrorMessage(errorMessage = 'APIæœåŠ¡å™¨è¿æ¥å¤±è´¥') {
        // åœ¨æœè£…ç½‘æ ¼ä¸­æ˜¾ç¤ºé”™è¯¯æç¤º
        try {
            const grid = this.getCurrentGrid();
            const errorHtml = `
                <div class="api-error-message" style="
                    grid-column: 1 / -1;
                    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
                    border: 1px solid #dc3545;
                    border-radius: 8px;
                    padding: 20px;
                    margin: 10px;
                    text-align: center;
                    color: #721c24;
                    box-shadow: 0 2px 8px rgba(220,53,69,0.2);
                ">
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                        ğŸš« æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨
                    </div>
                    <div style="margin-bottom: 15px; line-height: 1.5;">
                        ${errorMessage}<br>
                        è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIæœåŠ¡å™¨çŠ¶æ€åé‡è¯•ã€‚
                    </div>
                    <div style="font-size: 0.9em; color: #6c757d;">
                        è§£å†³æ–¹æ¡ˆï¼š1. æ£€æŸ¥é…ç½®é¡µé¢ä¸­çš„æœåŠ¡å™¨åœ°å€ | 2. ç¡®ä¿APIæœåŠ¡å™¨æ­£åœ¨è¿è¡Œ | 3. é‡å¯åº”ç”¨
                    </div>
                </div>
            `;
            grid.innerHTML = errorHtml;
        } catch (error) {
            console.warn('âš ï¸ æ— æ³•æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯:', error.message);
        }
    }

    showNoDataMessage() {
        // æ˜¾ç¤ºæ— æ•°æ®æç¤º
        try {
            const grid = this.getCurrentGrid();
            const noDataHtml = `
                <div class="no-data-message" style="
                    grid-column: 1 / -1;
                    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
                    border: 1px solid #ffc107;
                    border-radius: 8px;
                    padding: 20px;
                    margin: 10px;
                    text-align: center;
                    color: #856404;
                    box-shadow: 0 2px 8px rgba(255,193,7,0.2);
                ">
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                        ğŸ“¦ æš‚æ— æœè£…æ•°æ®
                    </div>
                    <div style="margin-bottom: 15px; line-height: 1.5;">
                        å½“å‰åˆ†ç±»ä¸‹æš‚æ— å¯ç”¨çš„æœè£…æ•°æ®ã€‚<br>
                        è¯·å°è¯•åˆ‡æ¢å…¶ä»–åˆ†ç±»æˆ–è”ç³»ç®¡ç†å‘˜æ·»åŠ æœè£…æ•°æ®ã€‚
                    </div>
                </div>
            `;
            grid.innerHTML = noDataHtml;
        } catch (error) {
            console.warn('âš ï¸ æ— æ³•æ˜¾ç¤ºæ— æ•°æ®æ¶ˆæ¯:', error.message);
        }
    }

    // æœ¬åœ°æ•°æ®æ–¹æ³•å·²ç§»é™¤ - å®¢æˆ·ç«¯åªä»APIæœåŠ¡å™¨åŠ è½½æ•°æ®

    // è¾…åŠ©æ–¹æ³•ï¼šå°†ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºå®Œæ•´çš„HTTP URL
    getImageUrl(relativePath) {
        if (!relativePath) {
            return '';
        }
        
        // å¦‚æœå·²ç»æ˜¯å®Œæ•´çš„URLï¼ˆä»¥httpæˆ–httpså¼€å¤´ï¼‰ï¼Œç›´æ¥è¿”å›
        if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
            return relativePath;
        }
        
        // å¦‚æœä»¥æ–œæ å¼€å¤´ï¼Œå»æ‰æ–œæ 
        const cleanPath = relativePath.startsWith('/') ? relativePath.substring(1) : relativePath;
        
        // æ ¹æ®é¡¹ç›®è®°å¿†ä¸­çš„è§„èŒƒï¼Œä¸ºç›¸å¯¹è·¯å¾„æ·»åŠ COS_FOLDERå‰ç¼€
        // COS_FOLDERçš„å®é™…å€¼æ˜¯ 'clothinges/'
        const COS_FOLDER = 'clothinges/';
        // ä½¿ç”¨CDNåŸŸåï¼ˆclothing.0086studios.xyzï¼‰æ„å»ºå®Œæ•´çš„URL
        // æ³¨æ„ï¼šAPIæœåŠ¡å™¨åŸŸåæ˜¯ clothing-api.0086studios.xyzï¼Œä¸è¦æ··æ·†
        return `https://clothing.0086studios.xyz/${COS_FOLDER}${cleanPath}`;
    }

    selectClothing(item) {
        // é€‰æ‹©æ¥æºï¼šæ ¹æ®å½“å‰åˆ†ç±»åˆ¤æ–­
        const isDress = this.currentCategory === 'dresses';
        const isTopBottom = this.currentCategory === 'tops-bottoms';
        
        if (isDress) {
            // ç‚¹å‡»åŒä¸€æ¡ç›®åˆ‡æ¢é€‰ä¸­/å–æ¶ˆ
            if (this.selectedDress && this.selectedDress.item.id === item.id) {
                this.selectedDress = null;
                this.isDressSelected = false;
                this.lastSelectionType = null;
            } else {
            // é€‰æ‹©è£™å­æ—¶ï¼Œæ¸…é™¤æ‰€æœ‰ä¸Šè¡£/ä¸‹è¡£é€‰æ‹©
            this.selectedDress = { item };
            this.selectedTopBottom = null;
            this.lastSelectionType = 'dress';
            this.isDressSelected = true;
            }
        } else if (isTopBottom) {
            // é€‰æ‹©ä¸Šè¡£/ä¸‹è¡£æ—¶ï¼Œæ¸…é™¤è£™å­é€‰æ‹©
            this.selectedDress = null;
            this.isDressSelected = false;
            
            // åˆå§‹åŒ–selectedTopBottomå¯¹è±¡
            if (!this.selectedTopBottom) {
                this.selectedTopBottom = { tops: null, bottoms: null };
            }
            
            // æ ¹æ®å­åˆ†ç±»è®¾ç½®å¯¹åº”çš„é€‰æ‹©ï¼Œè‹¥å†æ¬¡ç‚¹å‡»åŒä¸€æ¡ç›®åˆ™å–æ¶ˆé€‰ä¸­
            if (this.currentSubCategory === 'tops') {
                if (this.selectedTopBottom.tops && this.selectedTopBottom.tops.id === item.id) {
                    this.selectedTopBottom.tops = null;
                    this.lastSelectionType = null;
                } else {
                this.selectedTopBottom.tops = item;
                    this.lastSelectionType = 'topBottom';
                }
            } else if (this.currentSubCategory === 'bottoms') {
                if (this.selectedTopBottom.bottoms && this.selectedTopBottom.bottoms.id === item.id) {
                    this.selectedTopBottom.bottoms = null;
                    this.lastSelectionType = null;
                } else {
                this.selectedTopBottom.bottoms = item;
            this.lastSelectionType = 'topBottom';
                }
            }
        }

        // æ›´æ–° UI é€‰ä¸­æ ·å¼ï¼ˆæ ¹æ®å½“å‰å¯è§åˆ—è¡¨ï¼‰
        document.querySelectorAll('.clothing-item').forEach(el => el.classList.remove('selected'));
        // æ ¹æ®å½“å‰çŠ¶æ€ï¼Œç»™ä»ç„¶é€‰ä¸­çš„æ¡ç›®åŠ ä¸Šselectedæ ·å¼
        if (this.selectedDress) {
            const el = document.querySelector(`.clothing-item[data-id="${this.selectedDress.item.id}"]`);
            if (el) el.classList.add('selected');
        }
        if (this.selectedTopBottom) {
            if (this.selectedTopBottom.tops) {
                const elTop = document.querySelector(`.clothing-item[data-id="${this.selectedTopBottom.tops.id}"]`);
                if (elTop) elTop.classList.add('selected');
            }
            if (this.selectedTopBottom.bottoms) {
                const elBottom = document.querySelector(`.clothing-item[data-id="${this.selectedTopBottom.bottoms.id}"]`);
                if (elBottom) elBottom.classList.add('selected');
            }
        }

        // æ›´æ–°æç¤ºä¸æ‘˜è¦
        this.updateCategoryTabsState();
        this.updateCategoryNotice();
        this.updateSelectionSummary();
    }

    updateSelectionSummary() {
        const selectedClothingEl = document.getElementById('selected-clothing');
        const proceedBtn = document.getElementById('proceed-btn');
        // å®¹å™¨æˆ–æŒ‰é’®åœ¨æŸäº›æ—©æœŸæ—¶æœºå¯èƒ½å°šæœªæ¸²æŸ“ï¼Œåšç©ºå€¼ä¿æŠ¤
        if (!selectedClothingEl && !proceedBtn) {
            return;
        }
        
        let hasSelection = false;
        let summaryHTML = '';
        
        if (this.selectedDress) {
            // æ˜¾ç¤ºè£™å­é€‰æ‹©
            hasSelection = true;
            summaryHTML += `
                <div class="selected-item-display">
                    <img src="${this.getImageUrl(this.selectedDress.item.image)}" alt="${this.selectedDress.item.name}" />
                    <span>${this.selectedDress.item.name}</span>
                    <span class="item-type">è£™å­</span>
                </div>
            `;
        } else if (this.selectedTopBottom) {
            // æ˜¾ç¤ºä¸Šè¡£/ä¸‹è¡£é€‰æ‹©
            if (this.selectedTopBottom.tops) {
                hasSelection = true;
                summaryHTML += `
                    <div class="selected-item-display">
                        <img src="${this.getImageUrl(this.selectedTopBottom.tops.image)}" alt="${this.selectedTopBottom.tops.name}" />
                        <span>${this.selectedTopBottom.tops.name}</span>
                        <span class="item-type">ä¸Šè¡£</span>
                    </div>
                `;
            }
            if (this.selectedTopBottom.bottoms) {
                hasSelection = true;
                summaryHTML += `
                    <div class="selected-item-display">
                        <img src="${this.getImageUrl(this.selectedTopBottom.bottoms.image)}" alt="${this.selectedTopBottom.bottoms.name}" />
                        <span>${this.selectedTopBottom.bottoms.name}</span>
                        <span class="item-type">ä¸‹è¡£</span>
                    </div>
                `;
            }
        }
        
        if (selectedClothingEl) {
        if (hasSelection) {
            selectedClothingEl.innerHTML = `
                <div class="selected-items-container">
                    <div class="selected-items-title">å·²é€‰æ‹©çš„æœè£…ï¼š</div>
                    <div class="selected-items-list">
                        ${summaryHTML}
                    </div>
                </div>
            `;
        } else {
            selectedClothingEl.innerHTML = '<span>å°šæœªé€‰æ‹©æœè£…</span>';
            }
        }
        if (proceedBtn) {
            proceedBtn.disabled = !hasSelection;
        }
    }

    async startFittingProcess() {
        return new Promise(async (resolve, reject) => {
        // æ£€æŸ¥æ˜¯å¦æœ‰ç…§ç‰‡å’Œæœè£…é€‰æ‹©
        if (!this.selectedDress && !this.selectedTopBottom) {
            this.showError('è¯·ç¡®ä¿å·²ä¸Šä¼ ç…§ç‰‡å¹¶é€‰æ‹©æœè£…');
                reject(new Error('æœªé€‰æ‹©æœè£…'));
            return;
        }

        this.showLoading('æ­£åœ¨ç”Ÿæˆè¯•è¡£æ•ˆæœ...', 'è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…');

        try {
            // ç¡®ä¿APIå®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!window.apiClient || !window.apiClient.token) {
                throw new Error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–æˆ–æœªè®¤è¯ï¼Œè¯·å…ˆå®Œæˆè®¾å¤‡è®¤è¯');
            }
            
            console.log('ğŸŒ ä½¿ç”¨ API-server è¿›è¡Œè¯•ç©¿ä»»åŠ¡ç®¡ç†');
            
            // è·å–é€‰ä¸­çš„è¡£æœ ID
            let topClothesId = null;
            let bottomClothesId = null;
            
            if (this.selectedDress) {
                // é€‰æ‹©äº†è£™å­ï¼Œä½œä¸ºä¸Šè¡£å¤„ç†
                topClothesId = this.selectedDress.item.id;
            } else if (this.selectedTopBottom) {
                if (this.selectedTopBottom.tops) {
                    topClothesId = this.selectedTopBottom.tops.id;
                }
                if (this.selectedTopBottom.bottoms) {
                    bottomClothesId = this.selectedTopBottom.bottoms.id;
                }
            }

            if (!topClothesId) {
                throw new Error('æœªé€‰æ‹©æœ‰æ•ˆçš„ä¸Šè¡£æˆ–è£™å­');
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡IDï¼ˆåœ¨ä¸Šä¼ ç…§ç‰‡æ—¶å·²åˆ›å»ºä»»åŠ¡ï¼‰
            if (!this.currentTaskId) {
                throw new Error('æœªæ‰¾åˆ°ä»»åŠ¡IDï¼Œè¯·é‡æ–°ä¸Šä¼ ç…§ç‰‡');
            }

            console.log('ğŸš€ å¯åŠ¨è¯•ç©¿ä»»åŠ¡:', {
                taskId: this.currentTaskId,
                sceneStr: this.qrSceneStr,
                topClothesId: topClothesId,
                bottomClothesId: bottomClothesId
            });

            // å¯åŠ¨è¯•ç©¿ä»»åŠ¡ - é€šè¿‡API-serverï¼Œä¼ é€’sceneStrå‚æ•°
            const taskResponse = await window.apiClient.startTryonTask(
                this.currentTaskId,
                topClothesId,
                bottomClothesId,
                this.qrSceneStr
            );

            if (!taskResponse.success) {
                throw new Error(taskResponse.error || 'å¯åŠ¨è¯•ç©¿ä»»åŠ¡å¤±è´¥');
            }

            this.currentTask = {
                taskId: this.currentTaskId,
                status: taskResponse.data.status
            };

            console.log('âœ… API Server è¯•ç©¿ä»»åŠ¡å¯åŠ¨æˆåŠŸ:', this.currentTask);

                // è®¾ç½®ä»»åŠ¡å®Œæˆå›è°ƒ
                this.onTaskComplete = (success, resultUrl) => {
                    if (success) {
                        console.log('âœ… è¯•è¡£ä»»åŠ¡å®Œæˆï¼Œresolve Promise');
                        resolve(resultUrl);
                    } else {
                        console.log('âŒ è¯•è¡£ä»»åŠ¡å¤±è´¥ï¼Œreject Promise');
                        reject(new Error('è¯•è¡£ä»»åŠ¡å¤±è´¥'));
                    }
                };

                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆå¯åŠ¨å‰æ¸…ç†æ—§å®šæ—¶å™¨ï¼‰
                this.stopTaskPolling();
            this.pollApiServerTaskStatus();

        } catch (error) {
            console.error('è¯•è¡£æµç¨‹é”™è¯¯:', error);
            this.hideLoading();
            this.showError('è¯•è¡£ç”Ÿæˆå¤±è´¥: ' + error.message);
                reject(error);
        }
        });
    }

    // ä½¿ç”¨æ–°çš„ API Server ä»»åŠ¡ç®¡ç†
    async startApiServerTask() {
        // æ­¤æ–¹æ³•å·²åˆå¹¶åˆ°startFittingProcessä¸­
        return await this.startFittingProcess();
    }

    // ã€å·²å¼ƒç”¨ã€‘åŸæœ‰çš„ RunningHub ç›´æ¥è°ƒç”¨æµç¨‹
    // ç°åœ¨å¼ºåˆ¶ä½¿ç”¨ API-serverï¼Œä¸å†æ”¯æŒç›´æ¥è°ƒç”¨ RunningHub
    async startLegacyRunningHubTask() {
        throw new Error('ç›´æ¥è°ƒç”¨ RunningHub çš„æ¨¡å¼å·²è¢«ç¦ç”¨ï¼Œè¯·ä½¿ç”¨ API-server æ¨¡å¼');
    }

    // è½®è¯¢ API Server ä»»åŠ¡çŠ¶æ€
    async pollApiServerTaskStatus() {
        const maxAttempts = 60; // æœ€å¤šæ£€æŸ¥5åˆ†é’Ÿï¼ˆæ¯5ç§’ä¸€æ¬¡ï¼‰
        let attempts = 0;

        console.log('ğŸ”„ å¼€å§‹è½®è¯¢ API Server ä»»åŠ¡çŠ¶æ€ï¼Œä»»åŠ¡ID:', this.currentTask.taskId);

        // ä½¿ç”¨ setInterval è€Œä¸æ˜¯é€’å½’
        this.taskPollTimer = setInterval(async () => {
            attempts++;
            console.log(`ğŸ”„ ç¬¬ ${attempts} æ¬¡è½®è¯¢ä»»åŠ¡çŠ¶æ€...`, {
                currentPage: this.currentPage,
                taskId: this.currentTask?.taskId,
                attempts: attempts,
                maxAttempts: maxAttempts
            });
            
            // å¦‚æœå·²ç»ç¦»å¼€ç»“æœæµç¨‹ï¼Œåœæ­¢è½®è¯¢
            if (this.currentPage === 'welcome-page' || this.currentPage === 'scan-to-get-page') {
                console.log('ğŸš« å·²ç¦»å¼€ç»“æœæµç¨‹ï¼Œåœæ­¢ä»»åŠ¡è½®è¯¢', {
                    currentPage: this.currentPage,
                    attempts: attempts
                });
                this.stopTaskPolling();
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°
            if (attempts >= maxAttempts) {
                console.error('â° è½®è¯¢è¶…æ—¶ï¼Œå·²è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°');
                this.stopTaskPolling();
                this.hideLoading();
                this.showError('ä»»åŠ¡è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                return;
            }
            
            try {
                const statusResponse = await window.apiClient.getTaskStatus(this.currentTask.taskId);
                
                if (statusResponse.success) {
                    const taskData = statusResponse.data;
                    this.currentTask.status = taskData.status;
                    console.log(`ğŸ“Š ä»»åŠ¡çŠ¶æ€æ›´æ–°: ${taskData.status}`);

                    // æ›´æ–°è¿›åº¦æ–‡æœ¬
                    const progressText = document.getElementById('progress-text');
                    if (progressText) {
                        switch(taskData.status) {
                            case 'QUEUED':
                            case 'PENDING':
                                progressText.textContent = 'ä»»åŠ¡æ’é˜Ÿä¸­...';
                                console.log('â³ ä»»åŠ¡æ’é˜Ÿä¸­ï¼Œç­‰å¾…æ‰§è¡Œ...');
                                break;
                            case 'PROCESSING':
                                progressText.textContent = 'æ­£åœ¨ç”Ÿæˆè¯•è¡£æ•ˆæœ...';
                                console.log('ğŸš€ ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­...');
                                break;
                            case 'COMPLETED':
                                progressText.textContent = 'ç”Ÿæˆå®Œæˆï¼';
                                console.log('âœ… ä»»åŠ¡æ‰§è¡Œå®Œæˆ');
                                
                                // æ£€æŸ¥æ˜¯å¦æœ‰ç»“æœURLï¼Œå°è¯•å¤šç§å¯èƒ½çš„å­—æ®µå
                                const resultUrl = taskData.resultUrl || taskData.imageUrl || taskData.image || taskData.result;
                                console.log('ğŸ” æ£€æŸ¥ç»“æœURL:', { 
                                    resultUrl, 
                                    hasResultUrl: !!taskData.resultUrl,
                                    hasImageUrl: !!taskData.imageUrl,
                                    hasImage: !!taskData.image,
                                    hasResult: !!taskData.result,
                                    taskData: taskData
                                });
                                
                                if (resultUrl) {
                                    this.hideLoading();
                                    // ä»…å½“å½“å‰ä»åœ¨ç»“æœæµç¨‹æ—¶æ‰å±•ç¤ºç»“æœï¼Œé¿å…å·²è¿”å›é¦–é¡µè¿˜åŠ è½½å›¾ç‰‡
                                    console.log('ğŸ” è½®è¯¢ä¸­æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºç»“æœ:', {
                                        resultUrl: resultUrl,
                                        currentPage: this.currentPage,
                                        shouldShow: this.currentPage !== 'welcome-page' && this.currentPage !== 'scan-to-get-page'
                                    });
                                    
                                    if (this.currentPage !== 'welcome-page' && this.currentPage !== 'scan-to-get-page') {
                                        console.log('âœ… è½®è¯¢ä¸­è°ƒç”¨ showResult');
                                    this.showResult(resultUrl);
                                    } else {
                                        console.log('ğŸš« å·²ç¦»å¼€ç»“æœæµç¨‹ï¼Œè·³è¿‡ç»“æœå±•ç¤º');
                                    }
                                    
                                    // è°ƒç”¨ä»»åŠ¡å®Œæˆå›è°ƒ
                                    if (this.onTaskComplete) {
                                        this.onTaskComplete(true, resultUrl);
                                    }
                                    
                                    // ä»»åŠ¡å·²ç»“æŸï¼Œåœæ­¢è½®è¯¢
                                    this.stopTaskPolling();
                                    return;
                                } else {
                                    console.warn('âš ï¸ ä»»åŠ¡å·²å®Œæˆä½†æ²¡æœ‰è¿”å›ç»“æœURL');
                                    // å³ä½¿æ²¡æœ‰ç»“æœURLï¼Œä¹Ÿéšè—åŠ è½½ç•Œé¢å¹¶æ˜¾ç¤ºç»“æœé¡µé¢
                                    this.hideLoading();
                                    
                                    console.log('ğŸ” è½®è¯¢ä¸­æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºç©ºç»“æœ:', {
                                        currentPage: this.currentPage,
                                        shouldShow: this.currentPage !== 'welcome-page' && this.currentPage !== 'scan-to-get-page'
                                    });
                                    
                                    if (this.currentPage !== 'welcome-page' && this.currentPage !== 'scan-to-get-page') {
                                    // å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªé»˜è®¤çš„æç¤ºä¿¡æ¯
                                        console.log('âœ… è½®è¯¢ä¸­è°ƒç”¨ showResult (ç©ºå­—ç¬¦ä¸²)');
                                    this.showResult(''); // ä¼ å…¥ç©ºå­—ç¬¦ä¸²
                                    } else {
                                        console.log('ğŸš« å·²ç¦»å¼€ç»“æœæµç¨‹ï¼Œè·³è¿‡ç»“æœå±•ç¤º');
                                    }
                                    
                                    // è°ƒç”¨ä»»åŠ¡å®Œæˆå›è°ƒ
                                    if (this.onTaskComplete) {
                                        this.onTaskComplete(true, '');
                                    }
                                    
                                    this.stopTaskPolling();
                                    return;
                                }
                                break;
                            case 'FAILED':
                                console.error('âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥');
                                this.stopTaskPolling();
                                this.hideLoading();
                                this.showError(taskData.errorMessage || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥');
                                
                                // è°ƒç”¨ä»»åŠ¡å®Œæˆå›è°ƒ
                                if (this.onTaskComplete) {
                                    this.onTaskComplete(false, null);
                                }
                                return;
                            default:
                                console.log(`âš ï¸ æœªçŸ¥ä»»åŠ¡çŠ¶æ€: ${taskData.status}`);
                                progressText.textContent = `ä»»åŠ¡çŠ¶æ€: ${taskData.status}`;
                        }
                    }

                    console.log(`ğŸ“ˆ è½®è¯¢è¿›åº¦: ${attempts}/${maxAttempts}`);
                } else {
                    console.error('âŒ çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', statusResponse.error);
                }

            } catch (error) {
                console.error('âŒ è½®è¯¢ä»»åŠ¡çŠ¶æ€é”™è¯¯:', error);
                this.stopTaskPolling();
                this.hideLoading();
                this.showError('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    }
    
    // åœæ­¢ä»»åŠ¡è½®è¯¢
    stopTaskPolling() {
        if (this.taskPollTimer) {
            clearInterval(this.taskPollTimer);
            this.taskPollTimer = null;
            console.log('ğŸ›‘ ä»»åŠ¡è½®è¯¢å·²åœæ­¢');
        }
    }

    showResult(imageUrl) {
        console.log('ğŸ” showResult è¢«è°ƒç”¨:', {
            imageUrl: imageUrl,
            currentPage: this.currentPage
        });
        
        // å¦‚æœå½“å‰å·²å›åˆ°é¦–é¡µï¼Œåˆ™ä¸å†åˆ‡æ¢åˆ°ç»“æœé¡µï¼Œé¿å…å›æµ
        if (this.currentPage === 'welcome-page') {
            console.log('ğŸš« showResult è¢«é˜»æ­¢æ‰§è¡Œ: å½“å‰åœ¨é¦–é¡µ');
            return;
        }
        
        console.log('âœ… showResult ç»§ç»­æ‰§è¡Œï¼Œåˆ‡æ¢åˆ°ç»“æœé¡µé¢');
        this.resultImageUrl = imageUrl;
        this.setPage('results-page');
        
        const resultImg = document.getElementById('result-image');
        const loadingIndicator = document.getElementById('loading-indicator');
        const saveBtn = document.getElementById('save-btn');
        
        if (resultImg) {
            resultImg.src = imageUrl;
            // éšè—åŠ è½½æŒ‡ç¤ºå™¨
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            // æ˜¾ç¤ºå›¾ç‰‡å…ƒç´ 
            resultImg.style.display = 'block';
            resultImg.onload = () => {
                this.adjustImageContainer();
                // æ·»åŠ æ·¡å…¥æ•ˆæœ
                resultImg.classList.add('fade-in');
                // å›¾ç‰‡æˆåŠŸå±•ç¤ºåå†å¯åŠ¨å€’è®¡æ—¶ï¼ˆ60sï¼‰
                this.startCountdown();
                // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
                if (saveBtn) {
                    saveBtn.classList.add('show');
                }
            };
            // æ·»åŠ é”™è¯¯å¤„ç†
            resultImg.onerror = () => {
                console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', {
                    imageUrl: imageUrl,
                    currentPage: this.currentPage,
                    resultImageUrl: this.resultImageUrl,
                    stackTrace: new Error().stack
                });
                // é‡æ–°æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'flex';
                    const progressText = document.getElementById('progress-text');
                    if (progressText) {
                        progressText.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                    }
                }
                this.showError('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
        }
        
        // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
        const resultActions = document.getElementById('result-actions');
        if (resultActions) {
            resultActions.style.display = 'flex';
        }
        
        // æ˜¾ç¤ºé£æ ¼ä¿¡æ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        const styleInfo = document.getElementById('style-info');
        if (styleInfo) {
            styleInfo.style.display = 'flex';
        }
        
        // ç§»é™¤è‡ªåŠ¨æ¨é€è¯•è£…ç»“æœåˆ°ç”¨æˆ·çš„è°ƒç”¨
        // this.pushTryonResultToUser(imageUrl);
    }

    adjustImageContainer() {
        const container = document.querySelector('.result-image-container');
        const img = document.getElementById('result-image');
        
        if (container && img && img.complete) {
            const imgRatio = img.naturalWidth / img.naturalHeight;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const containerRatio = containerWidth / containerHeight;
            
            if (imgRatio > containerRatio) {
                // å›¾ç‰‡æ›´å®½ï¼Œä»¥å®½åº¦ä¸ºå‡†
                img.style.width = '100%';
                img.style.height = 'auto';
            } else {
                // å›¾ç‰‡æ›´é«˜ï¼Œä»¥é«˜åº¦ä¸ºå‡†
                img.style.width = 'auto';
                img.style.height = '100%';
            }
        }
    }

    async generateDownloadQR() {
        try {
            // ç¡®ä¿APIå®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!window.apiClient) {
                console.error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰sceneStr
            if (!this.qrSceneStr) {
                throw new Error('ç¼ºå°‘äºŒç»´ç åœºæ™¯å€¼');
            }
            
            // è·å–è®¾å¤‡MACåœ°å€
            let macAddress = this.macAddress;
            if (!macAddress) {
                // å¦‚æœåº”ç”¨çŠ¶æ€ä¸­æ²¡æœ‰MACåœ°å€ï¼Œå°è¯•ä»ç³»ç»Ÿè·å–
                try {
                    const { ipcRenderer } = require('electron');
                    macAddress = await ipcRenderer.invoke('get-mac-address');
                } catch (error) {
                    console.error('è·å–MACåœ°å€å¤±è´¥:', error);
                    macAddress = '00:11:22:33:44:55'; // é»˜è®¤å€¼
                }
            }
            
            // å¤„ç†MACåœ°å€ï¼šå»æ‰å†’å·ä½œä¸ºè®¾å¤‡å”¯ä¸€æ ‡è¯†
            const deviceId = macAddress ? macAddress.replace(/:/g, '') : macAddress;
            
            // è·å–å½“å‰é€‰æ‹©çš„æœè£…ä¿¡æ¯
            const clothingInfo = this.getSelectedClothingInfo();
            
            // è·å–ç»“æœå›¾ç‰‡URL
            const imageUrl = this.resultImageUrl;
            
            if (!imageUrl) {
                throw new Error('æ²¡æœ‰å¯ç”¨çš„è¯•è¡£ç»“æœå›¾ç‰‡');
            }
            
            // è·å–æœè£…è´­ä¹°é“¾æ¥
            let purchaseUrl = '';
            if (this.selectedDress) {
                purchaseUrl = this.selectedDress.item.purchaseUrl || '';
            } else if (this.selectedTopBottom) {
                const topItem = this.selectedTopBottom.tops;
                const bottomItem = this.selectedTopBottom.bottoms;
                // ä¼˜å…ˆä½¿ç”¨ä¸Šè¡£çš„è´­ä¹°é“¾æ¥
                purchaseUrl = (topItem && topItem.purchaseUrl) || (bottomItem && bottomItem.purchaseUrl) || '';
            }
            
            // è°ƒç”¨APIç”ŸæˆäºŒç»´ç ï¼Œä¼ é€’sceneStrå’ŒMACåœ°å€
            const response = await window.apiClient.generateDownloadQR({
                sceneStr: this.qrSceneStr,  // ä½¿ç”¨äºŒç»´ç åœºæ™¯å€¼
                macAddress: deviceId,  // ä½¿ç”¨å¤„ç†åçš„MACåœ°å€
                imageUrl: imageUrl,
                purchaseUrl: purchaseUrl,
                clothesName: clothingInfo.name || 'è¯•è£…ç»“æœ'
            });
            
            if (response.success) {
                // æ˜¾ç¤ºäºŒç»´ç 
                const qrImg = document.getElementById('download-qr-img');
                if (qrImg) {
                    qrImg.src = response.qrCode.dataURL;
                }
                console.log('âœ… ä¸‹è½½äºŒç»´ç ç”ŸæˆæˆåŠŸ');
            } else {
                throw new Error(response.error || 'ç”ŸæˆäºŒç»´ç å¤±è´¥');
            }
        } catch (error) {
            console.error('âŒ ç”Ÿæˆä¸‹è½½äºŒç»´ç å¤±è´¥:', error);
            this.showError('ç”Ÿæˆä¸‹è½½äºŒç»´ç å¤±è´¥: ' + error.message);
        }
    }

    // æ¨é€è¯•è£…ç»“æœåˆ°ç”¨æˆ·
    async pushTryonResultToUser(imageUrl) {
        try {
            // ç¡®ä¿APIå®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!window.apiClient) {
                console.error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                return;
            }
            
            // æ£€æŸ¥å¿…è¦å‚æ•°
            if (!this.qrSceneStr || !imageUrl) {
                console.warn('ç¼ºå°‘å¿…è¦å‚æ•°ï¼Œæ— æ³•æ¨é€è¯•è£…ç»“æœ');
                return;
            }
            
            // è·å–å½“å‰é€‰æ‹©çš„æœè£…ä¿¡æ¯
            const clothingInfo = this.getSelectedClothingInfo();
            
            // è·å–æœè£…è´­ä¹°é“¾æ¥
            let purchaseUrl = '';
            if (this.selectedDress) {
                purchaseUrl = this.selectedDress.item.purchaseUrl || '';
            } else if (this.selectedTopBottom) {
                const topItem = this.selectedTopBottom.tops;
                const bottomItem = this.selectedTopBottom.bottoms;
                // ä¼˜å…ˆä½¿ç”¨ä¸Šè¡£çš„è´­ä¹°é“¾æ¥
                purchaseUrl = (topItem && topItem.purchaseUrl) || (bottomItem && bottomItem.purchaseUrl) || '';
            }
            
            // è°ƒç”¨APIæ¨é€è¯•è£…ç»“æœ
            const response = await window.apiClient.pushTryonResult({
                sceneStr: this.qrSceneStr,  // ä½¿ç”¨äºŒç»´ç åœºæ™¯å€¼
                imageUrl: imageUrl,
                purchaseUrl: purchaseUrl,
                clothesName: clothingInfo.name || 'è¯•è£…ç»“æœ'
            });
            
            if (response.success) {
                console.log('âœ… è¯•è£…ç»“æœæ¨é€æˆåŠŸ');
            } else {
                throw new Error(response.error || 'æ¨é€è¯•è£…ç»“æœå¤±è´¥');
            }
        } catch (error) {
            console.error('âŒ æ¨é€è¯•è£…ç»“æœå¤±è´¥:', error);
            // ä¸å‘ç”¨æˆ·æ˜¾ç¤ºé”™è¯¯ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
        }
    }

    startCountdown() {
        const countdownEl = document.getElementById('countdown');
        if (!countdownEl) return;
        
        let timeLeft = 60; // 60ç§’å€’è®¡æ—¶
        countdownEl.textContent = timeLeft;
        
        const timer = setInterval(() => {
            timeLeft--;
            countdownEl.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                // å€’è®¡æ—¶ç»“æŸåè‡ªåŠ¨è¿”å›æ¬¢è¿é¡µé¢å¹¶è‡ªåŠ¨åˆ·æ–°äºŒç»´ç 
                this.setPage('welcome-page').then(() => {
                    // æ¸…ç†æœ¬æ¬¡ä»»åŠ¡å…³è”çš„sceneStrï¼Œæ ‡è¯†å•æ¬¡ä»»åŠ¡ç»“æŸ
                    this.qrSceneStr = null;
                    this.resetForNextUser();
                    this.stopTaskPolling();
                    // è¿”å›é¦–é¡µåè‡ªåŠ¨ç”Ÿæˆï¼ˆæˆ–åˆ·æ–°ï¼‰äºŒç»´ç ï¼Œç¡®ä¿å¯ç»§ç»­æ‰«ç è¯•è£…
                    this.generateWechatQRCode();
                });
            }
        }, 1000);
    }

    // æ¸…ç†æœ¬æ¬¡ä½¿ç”¨è¿‡ç¨‹ä¸­çš„ç¼“å­˜æ•°æ®ä¸UIçŠ¶æ€ï¼Œå‡†å¤‡ä¸‹ä¸€ä½ç”¨æˆ·
    resetForNextUser() {
        try {
            console.log('ğŸ”„ é‡ç½®çŠ¶æ€ï¼Œå‡†å¤‡ä¸‹ä¸€ä½ç”¨æˆ·...');
            
            // æ¸…ç†é€‰æ‹©ä¸ç»“æœ
            this.selectedClothing = null;
            this.selectedTopBottom = null;
            this.selectedDress = null;
            this.lastSelectionType = null;
            this.selectedStyle = null;
            this.isDressSelected = false;
            this.currentTask = null;
            this.currentTaskId = null;
            this.resultImageUrl = null;

            // æ¸…ç†æ‰«ç è·å–é¡µé¢çŠ¶æ€
            this.scanQrCodeData = null;
            this.scanCountdown = 300;
            this.scanPushStatus = 'pending';
            this.scanPollTimer = null;
            this.scanCountdownTimer = null;
            
            // åœæ­¢ä»»åŠ¡è½®è¯¢å®šæ—¶å™¨
            this.stopTaskPolling();

            // é‡ç½®æµç¨‹ä½ç½®
            this.currentCategory = 'tops-bottoms';
            this.currentSubCategory = 'tops';
            this.currentGender = 'female';

            // æ¸…ç†ç”¨æˆ·å›¾ç‰‡ç¼“å­˜
            if (this.userProfile) {
                this.userProfile.photo = null;
                this.userProfile.photoFileName = null;
                this.userProfile.fullBodyShotNameInRH = null;
            }

            // æ¸…ç†ç»“æœé¡µUIï¼ˆä»…åœ¨ç»“æœé¡µé¢å­˜åœ¨æ—¶æ¸…ç†ï¼‰
            if (this.currentPage === 'results-page') {
                const resultImg = document.getElementById('result-image');
                const loadingIndicator = document.getElementById('loading-indicator');
                const saveBtn = document.getElementById('save-btn');
                if (resultImg) {
                    resultImg.src = '';
                    resultImg.style.display = 'none';
                    resultImg.classList.remove('fade-in');
                }
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'flex';
                    const progressText = document.getElementById('progress-text');
                    if (progressText) progressText.textContent = 'æ­£åœ¨ç”Ÿæˆä¸­...';
                }
                if (saveBtn) {
                    saveBtn.classList.remove('show');
                }
            }

            // â­ æ¸…ç†æœè£…é€‰æ‹©é¡µUIï¼ˆå¢å¼ºæ¸…ç†é€»è¾‘ï¼‰
            const topsGrid = document.getElementById('tops-grid');
            const bottomsGrid = document.getElementById('bottoms-grid');
            if (topsGrid) topsGrid.innerHTML = '';
            if (bottomsGrid) bottomsGrid.innerHTML = '';
            
            // æ¸…ç†æ‰€æœ‰å·²é€‰æ‹©çš„æœè£…é¡¹æ ·å¼
            document.querySelectorAll('.clothing-item.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // é‡ç½®é€‰æ‹©æ‘˜è¦å’Œç»§ç»­æŒ‰é’®
            const selectedClothingEl = document.getElementById('selected-clothing');
            const proceedBtn = document.getElementById('proceed-btn');
            if (selectedClothingEl) selectedClothingEl.innerHTML = '<span>å°šæœªé€‰æ‹©æœè£…</span>';
            if (proceedBtn) proceedBtn.disabled = true;
            
            console.log('âœ… çŠ¶æ€é‡ç½®å®Œæˆ');
        } catch (e) {
            console.warn('é‡ç½®ä¸‹ä¸€ä½ç”¨æˆ·çŠ¶æ€æ—¶å‡ºç°é—®é¢˜:', e);
        }
    }

    // ä¿å­˜å›¾ç‰‡å‡½æ•°ï¼Œåœ¨ç”¨æˆ·ç‚¹å‡»ä¿å­˜å›¾ç‰‡æŒ‰é’®æ—¶è°ƒç”¨
    async saveImage() {
        try {
            console.log('ğŸ“¥ ç”¨æˆ·ç‚¹å‡»ä¿å­˜å›¾ç‰‡æŒ‰é’®');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç»“æœå›¾ç‰‡URL
            if (!this.resultImageUrl) {
                throw new Error('æ²¡æœ‰å¯ä¿å­˜çš„è¯•è¡£ç»“æœå›¾ç‰‡');
            }
            
            // è·³è½¬åˆ°æ‰«ç è·å–å›¾ç‰‡é¡µé¢
            console.log('ğŸ”„ è·³è½¬åˆ°æ‰«ç è·å–å›¾ç‰‡é¡µé¢');
            
            // åœæ­¢ä»»åŠ¡è½®è¯¢ï¼Œå› ä¸ºç”¨æˆ·å·²ç»ç¦»å¼€ç»“æœæµç¨‹
            this.stopTaskPolling();
            console.log('ğŸ›‘ å·²åœæ­¢ä»»åŠ¡è½®è¯¢ï¼Œç”¨æˆ·ç¦»å¼€ç»“æœæµç¨‹');
            
            await this.setPage('scan-to-get-page');
            await this.initializeScanToGetPage();
        } catch (error) {
            console.error('âŒ ä¿å­˜å›¾ç‰‡å¤±è´¥:', error);
            // å¤±è´¥ä¹Ÿè·³å›é¦–é¡µï¼Œé¿å…é˜»å¡ç°åœº
            await this.setPage('welcome-page');
            this.qrSceneStr = null;
            this.resetForNextUser();
            this.stopTaskPolling();
            await this.generateWechatQRCode();
        }
    }

    showLoading(title, message) {
        const modal = document.getElementById('global-loading');
        const titleEl = document.getElementById('loading-title');
        const messageEl = document.getElementById('loading-message');
        
        // å¦‚æœæœ‰æ ‡é¢˜ï¼Œæ›´æ–°æ ‡é¢˜ï¼›å¦åˆ™åªæ›´æ–°æ¶ˆæ¯
        if (titleEl && title) {
            titleEl.textContent = title;
        } else if (messageEl) {
            // å¦‚æœæ²¡æœ‰æ ‡é¢˜ï¼Œå°†æ ‡é¢˜å’Œæ¶ˆæ¯éƒ½æ˜¾ç¤ºåœ¨æ¶ˆæ¯å…ƒç´ ä¸­
            messageEl.textContent = title || message;
            if (title && message && title !== message) {
                messageEl.textContent += ' ' + message;
            }
        }
        
        if (modal) modal.style.display = 'flex';
    }

    hideLoading() {
        const modal = document.getElementById('global-loading');
        if (modal) modal.style.display = 'none';
    }

    // ================= æ‰«ç è·å–å›¾ç‰‡é¡µé¢åŠŸèƒ½ =================
    
    // åˆå§‹åŒ–æ‰«ç è·å–å›¾ç‰‡é¡µé¢
    async initializeScanToGetPage() {
        console.log('ğŸ“± åˆå§‹åŒ–æ‰«ç è·å–å›¾ç‰‡é¡µé¢...');
        
        try {
            // æ£€æŸ¥å¿…è¦çš„æ•°æ®
            if (!this.qrSceneStr || !this.currentTaskId) {
                throw new Error('ç¼ºå°‘å¿…è¦çš„ä»»åŠ¡ä¿¡æ¯');
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            this.showScanLoading();
            
            // æ¿€æ´»æ¨é€äºŒç»´ç 
            await this.activatePushQrCode();
            
            // å¼€å§‹å€’è®¡æ—¶
            this.startScanCountdown();
            
            console.log('âœ… æ‰«ç è·å–å›¾ç‰‡é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            
        } catch (error) {
            console.error('âŒ åˆå§‹åŒ–æ‰«ç è·å–å›¾ç‰‡é¡µé¢å¤±è´¥:', error);
            this.showScanError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        }
    }
    
    // æ¿€æ´»æ¨é€äºŒç»´ç 
    async activatePushQrCode() {
        console.log('ğŸ”„ æ¿€æ´»æ¨é€äºŒç»´ç ...');
        
        try {
            // æ£€æŸ¥APIå®¢æˆ·ç«¯çŠ¶æ€
            if (!window.apiClient) {
                throw new Error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
            }
            
            if (!window.apiClient.token) {
                throw new Error('è®¾å¤‡æœªè®¤è¯');
            }
            
            // æ£€æŸ¥å¿…è¦å‚æ•°
            if (!this.currentTaskId) {
                throw new Error('ä»»åŠ¡IDä¸å­˜åœ¨');
            }
            
            // ä½¿ç”¨APIå®¢æˆ·ç«¯è°ƒç”¨æ¿€æ´»æ¨é€äºŒç»´ç æ¥å£
            const response = await window.apiClient.activatePushQrCode({
                taskId: this.currentTaskId,
                originalSceneStr: this.qrSceneStr // å¯é€‰å‚æ•°
            });
            
            if (response.success) {
                // æ ¹æ®æ–°æ¥å£å“åº”æ ¼å¼å¤„ç†æ•°æ®
                this.scanQrCodeData = response.activation.qrCode;
                this.scanCountdown = response.activation.qrCode.expiresIn || 60; // é»˜è®¤1åˆ†é’Ÿ
                this.activationSceneStr = response.activation.activationSceneStr;
                this.originalSceneStr = response.activation.originalSceneStr;
                this.taskInfo = response.activation.taskInfo;
                this.userInfo = response.activation.userInfo;
                
                this.showScanQrCode();
                console.log('âœ… æ¨é€äºŒç»´ç æ¿€æ´»æˆåŠŸ', {
                    taskId: this.currentTaskId,
                    activationSceneStr: this.activationSceneStr,
                    expiresIn: this.scanCountdown
                });
            } else {
                throw new Error(response.error || 'æ¿€æ´»å¤±è´¥');
            }
            
        } catch (error) {
            console.error('âŒ æ¿€æ´»æ¨é€äºŒç»´ç å¤±è´¥:', error);
            throw error;
        }
    }
    
    // æ˜¾ç¤ºæ‰«ç åŠ è½½çŠ¶æ€
    showScanLoading() {
        const loadingEl = document.getElementById('scan-loading');
        const qrImageEl = document.getElementById('scan-qr-image');
        const countdownEl = document.getElementById('countdown-timer');
        
        if (loadingEl) loadingEl.style.display = 'flex';
        if (qrImageEl) qrImageEl.style.display = 'none';
        if (countdownEl) countdownEl.style.display = 'none';
        
        this.updateScanStatus('pending', 'â³', 'æ­£åœ¨ç”ŸæˆäºŒç»´ç ...');
    }
    
    // æ˜¾ç¤ºæ‰«ç äºŒç»´ç 
    showScanQrCode() {
        const loadingEl = document.getElementById('scan-loading');
        const qrImageEl = document.getElementById('scan-qr-image');
        const countdownEl = document.getElementById('countdown-timer');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (qrImageEl) {
            qrImageEl.src = this.scanQrCodeData.dataURL;
            qrImageEl.style.display = 'block';
        }
        if (countdownEl) countdownEl.style.display = 'block';
        
        this.updateScanStatus('pending', 'ğŸ“±', 'è¯·æ‰«æäºŒç»´ç ');
    }
    
    // æ˜¾ç¤ºæ‰«ç é”™è¯¯
    showScanError(message) {
        const loadingEl = document.getElementById('scan-loading');
        const qrImageEl = document.getElementById('scan-qr-image');
        const countdownEl = document.getElementById('countdown-timer');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (qrImageEl) qrImageEl.style.display = 'none';
        if (countdownEl) countdownEl.style.display = 'none';
        
        this.updateScanStatus('failed', 'âŒ', message);
    }
    
    // æ›´æ–°æ‰«ç çŠ¶æ€
    updateScanStatus(status, icon, text) {
        this.scanPushStatus = status;
        
        const statusItem = document.getElementById('status-item');
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        
        if (statusItem) {
            statusItem.className = `status-item ${status}`;
        }
        if (statusIcon) {
            statusIcon.textContent = icon;
        }
        if (statusText) {
            statusText.textContent = text;
        }
    }
    
    // å¼€å§‹æ‰«ç å€’è®¡æ—¶
    startScanCountdown() {
        this.scanCountdownTimer = setInterval(() => {
            this.scanCountdown--;
            this.updateScanCountdown();
            
            if (this.scanCountdown <= 0) {
                clearInterval(this.scanCountdownTimer);
                this.scanCountdownTimer = null;
                this.handleScanTimeout();
            }
        }, 1000);
    }
    
    // æ›´æ–°æ‰«ç å€’è®¡æ—¶æ˜¾ç¤º
    updateScanCountdown() {
        const countdownText = document.getElementById('countdown-text');
        if (countdownText) {
            const minutes = Math.floor(this.scanCountdown / 60);
            const seconds = this.scanCountdown % 60;
            countdownText.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    // å¤„ç†æ‰«ç è¶…æ—¶
    handleScanTimeout() {
        console.log('â° æ‰«ç è¶…æ—¶ï¼Œè¿”å›é¦–é¡µ');
        this.returnToHomeFromScan();
    }
    
    
    
    
    // åˆ·æ–°æ‰«ç äºŒç»´ç 
    async refreshScanQrCode() {
        console.log('ğŸ”„ åˆ·æ–°æ‰«ç äºŒç»´ç ...');
        
        try {
            // åœæ­¢å½“å‰å€’è®¡æ—¶
            if (this.scanCountdownTimer) {
                clearInterval(this.scanCountdownTimer);
                this.scanCountdownTimer = null;
            }
            
            // é‡æ–°æ¿€æ´»äºŒç»´ç 
            await this.activatePushQrCode();
            
            // é‡æ–°å¼€å§‹å€’è®¡æ—¶
            this.startScanCountdown();
            
            console.log('âœ… æ‰«ç äºŒç»´ç åˆ·æ–°æˆåŠŸ');
            
        } catch (error) {
            console.error('âŒ åˆ·æ–°æ‰«ç äºŒç»´ç å¤±è´¥:', error);
            this.showScanError('åˆ·æ–°å¤±è´¥: ' + error.message);
        }
    }
    
    // ä»æ‰«ç é¡µé¢è¿”å›é¦–é¡µ
    async returnToHomeFromScan() {
        console.log('ğŸ  ä»æ‰«ç é¡µé¢è¿”å›é¦–é¡µ...');
        
        // æ¸…ç†æ‰«ç é¡µé¢çŠ¶æ€
        this.scanQrCodeData = null;
        this.scanCountdown = 60; // æ”¹ä¸º1åˆ†é’Ÿ
        this.scanPushStatus = 'pending';
        this.activationSceneStr = null;
        this.originalSceneStr = null;
        this.taskInfo = null;
        this.userInfo = null;
        
        // åœæ­¢å€’è®¡æ—¶
        if (this.scanCountdownTimer) {
            clearInterval(this.scanCountdownTimer);
            this.scanCountdownTimer = null;
        }
        
        // åœæ­¢ä»»åŠ¡è½®è¯¢å®šæ—¶å™¨
        this.stopTaskPolling();
        
        // æ¸…ç†æ‰«ç é¡µé¢UI
        this.clearScanToGetPage();
        
        // æ¸…ç†ä»»åŠ¡çŠ¶æ€
        this.qrSceneStr = null;
        this.currentTaskId = null;
        this.resultImageUrl = null;
        
        
        // é‡ç½®æ‘„åƒå¤´çŠ¶æ€ï¼Œç¡®ä¿ä¸‹æ¬¡è¿›å…¥æ‹ç…§é¡µé¢æ—¶èƒ½æ­£ç¡®åˆå§‹åŒ–
        console.log('ğŸ“¸ é‡ç½®æ‘„åƒå¤´çŠ¶æ€ï¼Œå‡†å¤‡ä¸‹ä¸€ä½ç”¨æˆ·...');
        if (cameraInitialized) {
            // ä¸ååˆå§‹åŒ–æ‘„åƒå¤´ï¼Œåªé‡ç½®çŠ¶æ€æ ‡å¿—ï¼Œä¿æŒæ‘„åƒå¤´æµæ´»è·ƒ
            // è¿™æ ·ä¸‹æ¬¡è¿›å…¥æ‹ç…§é¡µé¢æ—¶èƒ½æ›´å¿«å“åº”
            console.log('ğŸ“¸ ä¿æŒæ‘„åƒå¤´æµæ´»è·ƒï¼Œé‡ç½®çŠ¶æ€æ ‡å¿—');
        }
        
        // é‡ç½®ç”¨æˆ·çŠ¶æ€
        this.resetForNextUser();
        
        // è¿”å›é¦–é¡µ
        await this.setPage('welcome-page');
        await this.generateWechatQRCode();
        
        console.log('âœ… å·²è¿”å›é¦–é¡µï¼Œå‡†å¤‡ä¸‹ä¸€ä½ç”¨æˆ·');
    }
    
    // æ¸…ç†æ‰«ç è·å–é¡µé¢UI
    clearScanToGetPage() {
        const loadingEl = document.getElementById('scan-loading');
        const qrImageEl = document.getElementById('scan-qr-image');
        const countdownEl = document.getElementById('countdown-timer');
        const statusItem = document.getElementById('status-item');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (qrImageEl) {
            qrImageEl.src = '';
            qrImageEl.style.display = 'none';
        }
        if (countdownEl) countdownEl.style.display = 'none';
        if (statusItem) {
            statusItem.className = 'status-item pending';
        }
        
        this.updateScanStatus('pending', 'â³', 'ç­‰å¾…æ‰«ç ä¸­...');
    }
    

    showError(message) {
        const modal = document.getElementById('error-modal');
        const messageEl = document.getElementById('error-message');
        
        if (messageEl) messageEl.textContent = message;
        if (modal) modal.style.display = 'flex';
    }

    // å…³é—­é”™è¯¯æç¤ºæ¡†
    closeErrorModal() {
        const modal = document.getElementById('error-modal');
        if (modal) modal.style.display = 'none';
    }

    async backToCamera() {
        // è·³è½¬åˆ°æ‹ç…§é¡µé¢ï¼Œæ‘„åƒå¤´å·²ç»åœ¨é¦–é¡µåˆå§‹åŒ–äº†
        await this.setPage('profile-page');
    }

    // ç¡®ä¿è®¾å¤‡å·²è®¤è¯
    async ensureDeviceAuthenticated() {
        try {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è®¤è¯ä»¤ç‰Œ
            if (window.apiClient && window.apiClient.token) {
                console.log('âœ… è®¾å¤‡å·²è®¤è¯');
                return;
            }
            
            console.log('âš ï¸ è®¾å¤‡æœªè®¤è¯ï¼Œå¼€å§‹è®¤è¯æµç¨‹...');
            
            // è·å–MACåœ°å€ç”¨äºè®¾å¤‡è®¤è¯
            if (!this.macAddress) {
                await this.getMacAddress();
            }
            
            if (this.macAddress) {
                // å¤„ç†MACåœ°å€ï¼šå»æ‰å†’å·ï¼Œä½œä¸ºè®¾å¤‡å”¯ä¸€æ ‡è¯†
                const deviceId = this.macAddress.replace(/:/g, '');
                console.log('ğŸ“± ä½¿ç”¨å¤„ç†åçš„MACåœ°å€è¿›è¡Œè®¾å¤‡è®¤è¯:', this.macAddress, '->', deviceId);
                
                // æ‰§è¡Œè®¾å¤‡è®¤è¯
                const authResponse = await window.apiClient.authenticateDevice(deviceId, 'è¡£ç­‰èˆ±å®¢æˆ·ç«¯');
                
                if (authResponse.success) {
                    console.log('âœ… è®¾å¤‡è®¤è¯æˆåŠŸ');
                    // è®¤è¯æˆåŠŸåï¼ŒAPIå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è®¾ç½®tokenå’ŒdeviceId
                    // ä»è¿”å›çš„è®¾å¤‡ä¿¡æ¯ä¸­è·å–distributionIdå­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (authResponse.device && authResponse.device.distributionId) {
                        console.log('ğŸ†” è·å–åˆ°åˆ†é”€ID:', authResponse.device.distributionId);
                        // å¯ä»¥åœ¨è¿™é‡Œå­˜å‚¨åˆ†é”€IDåˆ°åº”ç”¨çŠ¶æ€ä¸­
                        this.distributionId = authResponse.device.distributionId;
                    }
                    
                    // åŒæ—¶ä¿å­˜è®¾å¤‡ID
                    if (authResponse.device && authResponse.device.id) {
                        this.deviceId = authResponse.device.id;
                    }
                } else {
                    throw new Error(authResponse.error || 'è®¾å¤‡è®¤è¯å¤±è´¥');
                }
            } else {
                throw new Error('æ— æ³•è·å–è®¾å¤‡MACåœ°å€è¿›è¡Œè®¤è¯');
            }
        } catch (error) {
            console.error('âŒ è®¾å¤‡è®¤è¯å¤±è´¥:', error);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯ï¼Œå¦‚æœæ˜¯åˆ™å¯ç”¨ç¦»çº¿æ¨¡å¼
            if (error.message.includes('Failed to fetch') || 
                error.message.includes('ERR_NETWORK_CHANGED') ||
                error.message.includes('ERR_INTERNET_DISCONNECTED')) {
                console.warn('ğŸŒ æ£€æµ‹åˆ°ç½‘ç»œé”™è¯¯ï¼Œå¯ç”¨ç¦»çº¿æ¨¡å¼');
                if (window.apiClient) {
                    window.apiClient.setOfflineMode(true);
                }
                return {
                    success: false,
                    offline: true,
                    error: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå·²å¯ç”¨ç¦»çº¿æ¨¡å¼'
                };
            }
            
            throw error;
        }
    }

    // æ˜¾ç¤ºç¦»çº¿æ¨¡å¼é€šçŸ¥
    showOfflineNotification() {
        console.log('ğŸŒ æ˜¾ç¤ºç¦»çº¿æ¨¡å¼é€šçŸ¥');
        
        // åˆ›å»ºç¦»çº¿é€šçŸ¥å…ƒç´ 
        const offlineNotification = document.createElement('div');
        offlineNotification.id = 'offline-notification';
        offlineNotification.className = 'offline-notification';
        offlineNotification.innerHTML = `
            <div class="offline-content">
                <div class="offline-icon">ğŸŒ</div>
                <div class="offline-text">
                    <h3>ç¦»çº¿æ¨¡å¼</h3>
                    <p>ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™</p>
                </div>
                <button class="offline-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
            </div>
        `;
        
        // æ·»åŠ æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .offline-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                color: white;
                padding: 16px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 300px;
                animation: slideInRight 0.5s ease-out;
            }
            
            .offline-content {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .offline-icon {
                font-size: 24px;
                flex-shrink: 0;
            }
            
            .offline-text h3 {
                margin: 0 0 4px 0;
                font-size: 16px;
                font-weight: 600;
            }
            
            .offline-text p {
                margin: 0;
                font-size: 14px;
                opacity: 0.9;
            }
            
            .offline-close {
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 0;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background-color 0.2s;
                flex-shrink: 0;
            }
            
            .offline-close:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }
            
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        
        document.head.appendChild(style);
        document.body.appendChild(offlineNotification);
        
        // 5ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            if (offlineNotification.parentElement) {
                offlineNotification.style.animation = 'slideInRight 0.5s ease-out reverse';
                setTimeout(() => {
                    if (offlineNotification.parentElement) {
                        offlineNotification.remove();
                    }
                }, 500);
            }
        }, 5000);
    }

    // æ˜¾ç¤ºç¦»çº¿æ¨¡å¼å ä½ç¬¦äºŒç»´ç 
    showOfflineQRCode() {
        console.log('ğŸŒ æ˜¾ç¤ºç¦»çº¿æ¨¡å¼å ä½ç¬¦äºŒç»´ç ');
        
        const qrImg = document.getElementById('wechat-qr-image');
        if (qrImg) {
            // åˆ›å»ºä¸€ä¸ªSVGå ä½ç¬¦äºŒç»´ç 
            const svgQRCode = `
                <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="200" fill="#ffffff"/>
                    <rect x="20" y="20" width="160" height="160" fill="#000000" rx="8"/>
                    <rect x="40" y="40" width="120" height="120" fill="#ffffff" rx="4"/>
                    <rect x="60" y="60" width="80" height="80" fill="#000000" rx="2"/>
                    <rect x="80" y="80" width="40" height="40" fill="#ffffff" rx="1"/>
                    <text x="100" y="180" font-family="Arial, sans-serif" font-size="12" fill="#666666" text-anchor="middle">ç¦»çº¿æ¨¡å¼</text>
                </svg>
            `;
            
            const dataURL = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgQRCode)));
            qrImg.src = dataURL;
            
            // æ›´æ–°äºŒç»´ç æ ‡ç­¾
            const qrLabel = document.querySelector('.qr-label');
            if (qrLabel) {
                qrLabel.textContent = 'ç¦»çº¿æ¨¡å¼ - è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                qrLabel.style.color = '#ff6b6b';
            }
            
            console.log('âœ… ç¦»çº¿æ¨¡å¼å ä½ç¬¦äºŒç»´ç å·²æ˜¾ç¤º');
        }
    }
}

// å…¨å±€åº”ç”¨çŠ¶æ€å®ä¾‹
const appState = new AppState();

// æ‘„åƒå¤´ç›¸å…³å˜é‡
let cameraVideo = null;
let cameraCanvas = null;
let cameraStream = null;
let cameraInitialized = false;
let cameraRotationDeg = -90;

// DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
    console.log('ğŸš€ è¡£ç­‰èˆ±åº”ç”¨å¼€å§‹åˆå§‹åŒ–...');
    
    try {
        // åˆå§‹åŒ–åŠ¨æ€ç¼©æ”¾
        initializeResponsiveLayout();
        
        // 1. å…ˆåŠ è½½é…ç½®æ–‡ä»¶
        console.log('ğŸ“‹ åŠ è½½é…ç½®æ–‡ä»¶...');
        const cfg = appState.getConfig();
        console.log('ğŸ“‹ é…ç½®æ–‡ä»¶å·²åŠ è½½:', cfg);
        
        // éªŒè¯é…ç½®åŠ è½½æ˜¯å¦æˆåŠŸ
        if (cfg && typeof cfg === 'object') {
            console.log('âœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ');
            if (cfg.camera && cfg.camera.deviceId) {
                console.log('ğŸ“¸ é…ç½®ä¸­æŒ‡å®šçš„æ‘„åƒå¤´è®¾å¤‡:', cfg.camera.deviceId);
            } else {
                console.log('ğŸ“¸ é…ç½®ä¸­æœªæŒ‡å®šæ‘„åƒå¤´è®¾å¤‡ï¼Œå°†ä½¿ç”¨é»˜è®¤è®¾å¤‡');
            }
        } else {
            console.warn('âš ï¸ é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥æˆ–æ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
        }
        
        // 2. åˆå§‹åŒ–APIå®¢æˆ·ç«¯
        if (window.apiClient && typeof window.apiClient.initialize === 'function') {
            await window.apiClient.initialize();
        } else {
            console.error('âŒ APIå®¢æˆ·ç«¯æœªæ­£ç¡®åˆå§‹åŒ–æˆ–ç¼ºå°‘initializeæ–¹æ³•');
        }
        
        // 3. æ˜¾ç¤ºæ¬¢è¿é¡µé¢ï¼ˆç«‹å³æ˜¾ç¤ºï¼Œä¸ç­‰å¾…å¼‚æ­¥åˆå§‹åŒ–ï¼‰
        appState.setPage('welcome-page');
        
        // 4. å¼‚æ­¥åˆå§‹åŒ–æ¬¢è¿é¡µé¢åŠŸèƒ½ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
        setTimeout(async () => {
            try {
                console.log('ğŸ”„ å¼€å§‹å¼‚æ­¥åˆå§‹åŒ–æ¬¢è¿é¡µé¢åŠŸèƒ½...');
                await appState.initializeWelcomePage();
                appState.welcomePageInitialized = true; // æ ‡è®°åˆå§‹åŒ–å®Œæˆ
                console.log('âœ… æ¬¢è¿é¡µé¢åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ æ¬¢è¿é¡µé¢åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }, 100); // å»¶è¿Ÿ100msç¡®ä¿é¡µé¢å·²æ˜¾ç¤º
        
        console.log('â„¹ï¸ æ‹ç…§é¡µå†åˆå§‹åŒ–æ‘„åƒå¤´ï¼Œé¦–é¡µä¸å†åˆå§‹åŒ–');
        
        console.log('âœ… è¡£ç­‰èˆ±åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
        console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
        appState.showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
    }
});

// åº”ç”¨é€€å‡ºæ—¶ååˆå§‹åŒ–æ‘„åƒå¤´
window.addEventListener('beforeunload', () => {
    console.log('ğŸšª åº”ç”¨å³å°†é€€å‡ºï¼Œååˆå§‹åŒ–æ‘„åƒå¤´...');
    deinitializeCamera();
});

// åˆå§‹åŒ–å“åº”å¼å¸ƒå±€
function initializeResponsiveLayout() {
    console.log('ğŸ“ åˆå§‹åŒ–å“åº”å¼å¸ƒå±€...');
    
    // è®¡ç®—å’Œåº”ç”¨å¸ƒå±€
    function applyLayout() {
        const windowHeight = window.innerHeight;
        const windowWidth = window.innerWidth;
        const app = document.getElementById('app');
        
        if (app) {
            // é«˜åº¦100%ï¼Œå®½åº¦æ ¹æ®1080*1920æ¯”ä¾‹è®¡ç®—
            const calculatedWidth = windowHeight * 1080 / 1920;
            
            app.style.width = calculatedWidth + 'px';
            app.style.height = windowHeight + 'px';
            
            console.log('ğŸ“ çª—å£å°ºå¯¸:', windowWidth, 'x', windowHeight);
            console.log('ğŸ“ åº”ç”¨å°ºå¯¸:', calculatedWidth, 'x', windowHeight);
            
            // è®¾ç½®CSSå˜é‡
            document.documentElement.style.setProperty('--scale-factor', 1);
        }
    }
    
    // åˆå§‹åº”ç”¨
    applyLayout();
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
        applyLayout();
    });
    
    console.log('âœ… å“åº”å¼å¸ƒå±€åˆå§‹åŒ–å®Œæˆ');
}

// æ‘„åƒå¤´åˆå§‹åŒ–
async function initializeCamera() {
    console.log('ğŸ“¸ åˆå§‹åŒ–æ‘„åƒå¤´...');
    
    try {
        cameraVideo = document.getElementById('camera-video');
        cameraCanvas = document.getElementById('camera-canvas');
        
        // è‹¥è§†é¢‘/ç”»å¸ƒå…ƒç´ æœªå°±ç»ªï¼Œå…ˆå¯ç”¨UIå†è·å–å¼•ç”¨ï¼ˆé¿å…æ—¶åºé—®é¢˜ï¼‰
        if (!cameraVideo || !cameraCanvas) {
            console.warn('âš ï¸ æœªæ‰¾åˆ°æ‘„åƒå¤´å…ƒç´ ï¼Œå°è¯•å¯ç”¨æ‘„åƒå¤´UI...');
            enableCameraUI();
            cameraVideo = document.getElementById('camera-video');
            cameraCanvas = document.getElementById('camera-canvas');
            if (!cameraVideo || !cameraCanvas) {
                throw new Error('æ— æ³•æ‰¾åˆ°æ‘„åƒå¤´å…ƒç´ ');
            }
        }
        
        // ä½¿ç”¨å·²åŠ è½½çš„é…ç½®ä¸­çš„æ‘„åƒå¤´è®¾å¤‡ID
        let preferredDeviceId = null;
        try {
            // é‡æ–°è·å–é…ç½®ä»¥ç¡®ä¿ä½¿ç”¨æœ€æ–°é…ç½®
            const cfg = appState.getConfig();
            preferredDeviceId = cfg && cfg.camera && cfg.camera.deviceId ? cfg.camera.deviceId : null;
            console.log('ğŸ“¸ ä»é…ç½®ä¸­è¯»å–æ‘„åƒå¤´è®¾å¤‡ID:', preferredDeviceId || 'æœªé…ç½®');
        } catch (e) {
            console.log('ğŸ“¸ è¯»å–æ‘„åƒå¤´é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾å¤‡:', e);
        }

        // ç›®æ ‡åˆ†è¾¨ç‡ï¼š1280x720
        // æ³¨æ„ï¼šç›¸æœºä¸æ”¯æŒæ—¶ç”±æµè§ˆå™¨åå•†åˆ°å¯ç”¨å€¼
        let videoConstraints = {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            aspectRatio: { ideal: 16/9 },
            frameRate: { ideal: 30, max: 30 }
        };
        
        // å¦‚æœé…ç½®äº†ç‰¹å®šè®¾å¤‡IDï¼Œä½¿ç”¨ exact çº¦æŸå¼ºåˆ¶ä½¿ç”¨è¯¥è®¾å¤‡
        const hasSpecificDevice = preferredDeviceId && preferredDeviceId.trim() !== '';
        if (hasSpecificDevice) {
            videoConstraints = { ...videoConstraints, deviceId: { exact: preferredDeviceId } };
            console.log('ğŸ“¸ å¼ºåˆ¶ä½¿ç”¨é…ç½®çš„æ‘„åƒå¤´è®¾å¤‡ (exact):', preferredDeviceId);
        } else {
            videoConstraints = { ...videoConstraints, facingMode: 'user' };
            console.log('ğŸ“¸ ä½¿ç”¨é»˜è®¤æ‘„åƒå¤´è®¾å¤‡');
        }

		try {
			const requestedConstraints = {
				video: {
					...videoConstraints
				}
			};
			console.log('ğŸ“¤ è¯·æ±‚æ‘„åƒå¤´çº¦æŸ:', requestedConstraints);
			cameraStream = await navigator.mediaDevices.getUserMedia(requestedConstraints);
			console.log('âœ… å·²è·å–æ‘„åƒå¤´æµï¼ˆè®¾å¤‡åŸå§‹æ¯”ä¾‹/é»˜è®¤åˆ†è¾¨ç‡ï¼‰');
			// åˆå§‹åŒ–æˆåŠŸåç«‹å³å°è¯•æå‡åˆ°æœ€å¤§åˆ†è¾¨ç‡ï¼Œä»¥é¿å…ç»‘å®šåç”»é¢è·³å˜
			try { const t = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0]; await upgradeVideoTrackToMax(t); } catch {}
		} catch (e1) {
			// å¦‚æœæ˜¯ NotReadableErrorï¼Œè¯´æ˜è®¾å¤‡è¢«å ç”¨æˆ–ç¡¬ä»¶é—®é¢˜
			if (e1.name === 'NotReadableError') {
				console.error('âŒ æ‘„åƒå¤´è®¾å¤‡æ— æ³•å¯åŠ¨ (NotReadableError):', e1.message);
				throw new Error('æ‘„åƒå¤´æ— æ³•å¯åŠ¨ã€‚å¯èƒ½åŸå› ï¼š\n1. æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨\n2. æ‘„åƒå¤´é©±åŠ¨é—®é¢˜\n3. è¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨åé‡è¯•');
			}
			
			// å¦‚æœæ˜¯ OverconstrainedErrorï¼Œå°è¯•æ”¾å®½çº¦æŸ
			if (e1.name === 'OverconstrainedError') {
				console.warn('âš ï¸ çº¦æŸè¿‡äºä¸¥æ ¼ï¼Œå°è¯•ä½¿ç”¨å¼±çº¦æŸå›é€€:', e1.message);
				// å¦‚æœé…ç½®äº†ç‰¹å®šè®¾å¤‡ï¼Œåœ¨å›é€€æ—¶ç§»é™¤ deviceId
				try {
					const fallbackConstraints = {
						video: {
							width: { min: 1280 },
							height: { min: 720 },
							aspectRatio: { ideal: 16/9 },
							frameRate: { ideal: 30, max: 30 }
						}
					};
					console.log('ğŸ“¤ å›é€€è¯·æ±‚æ‘„åƒå¤´çº¦æŸï¼ˆç¬¬ä¸€å±‚ï¼‰:', fallbackConstraints);
					cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
					console.log('âœ… ç¬¬ä¸€å±‚å›é€€æˆåŠŸ');
				} catch (e2) {
					console.warn('âš ï¸ ç¬¬ä¸€å±‚å›é€€å¤±è´¥ï¼Œå°è¯•ç¬¬äºŒå±‚å›é€€ï¼ˆä»…åˆ†è¾¨ç‡è¦æ±‚ï¼‰:', e2.message);
					// ç¬¬äºŒå±‚å›é€€ï¼šç§»é™¤ aspectRatio çº¦æŸ
					try {
						const fallbackConstraints2 = {
							video: {
								width: { min: 1280 },
								height: { min: 720 },
								frameRate: { ideal: 30, max: 30 }
							}
						};
						console.log('ğŸ“¤ å›é€€è¯·æ±‚æ‘„åƒå¤´çº¦æŸï¼ˆç¬¬äºŒå±‚ï¼‰:', fallbackConstraints2);
						cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints2);
						console.log('âœ… ç¬¬äºŒå±‚å›é€€æˆåŠŸ');
					} catch (e3) {
						console.warn('âš ï¸ ç¬¬äºŒå±‚å›é€€å¤±è´¥ï¼Œå°è¯•ç¬¬ä¸‰å±‚å›é€€ï¼ˆä»…å¸§ç‡è¦æ±‚ï¼‰:', e3.message);
						// ç¬¬ä¸‰å±‚å›é€€ï¼šç§»é™¤æ‰€æœ‰åˆ†è¾¨ç‡çº¦æŸï¼Œä»…ä¿ç•™å¸§ç‡
						try {
							const fallbackConstraints3 = {
								video: {
									frameRate: { ideal: 30, max: 30 }
								}
							};
							console.log('ğŸ“¤ å›é€€è¯·æ±‚æ‘„åƒå¤´çº¦æŸï¼ˆç¬¬ä¸‰å±‚ï¼‰:', fallbackConstraints3);
							cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints3);
							console.log('âœ… ç¬¬ä¸‰å±‚å›é€€æˆåŠŸ');
						} catch (e4) {
							console.warn('âš ï¸ ç¬¬ä¸‰å±‚å›é€€å¤±è´¥ï¼Œå°è¯•æœ€åå›é€€ï¼ˆæ— çº¦æŸï¼‰:', e4.message);
							// æœ€åå›é€€ï¼šå®Œå…¨ä¸è®¾ç½®çº¦æŸï¼Œä½¿ç”¨ä»»ä½•å¯ç”¨æ‘„åƒå¤´
							const fallbackConstraints4 = {
								video: true
							};
							console.log('ğŸ“¤ å›é€€è¯·æ±‚æ‘„åƒå¤´çº¦æŸï¼ˆæœ€åå›é€€ï¼‰:', fallbackConstraints4);
							cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints4);
							console.log('âœ… æœ€åå›é€€æˆåŠŸ');
						}
					}
				}
			} else {
				// å…¶ä»–é”™è¯¯ç±»å‹ç›´æ¥æŠ›å‡º
				throw e1;
			}
		}
        
        await bindStreamAndPlay(cameraVideo, cameraStream);
        cameraInitialized = true;
        // åº”ç”¨é¢„è§ˆæ—‹è½¬
        applyCameraPreviewRotation();
        
        // ç­‰å¾…è§†é¢‘å…ƒç´ å°±ç»ª
        await waitForVideoReady();
        try {
            console.log('ğŸ“º é¢„è§ˆå®é™…å°ºå¯¸ videoWidth x videoHeight:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
            try {
                const track = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0];
                const sets = track && track.getSettings ? track.getSettings() : {};
                console.log('ğŸ“ é¦–æ¬¡åˆå§‹åŒ–åçš„ track settings:', sets);
            } catch {}
        } catch {}

        // ä¸å¯¹æ‘„åƒå¤´æ·»åŠ ä»»ä½•åˆ†è¾¨ç‡çº¦æŸï¼Œä½¿ç”¨è®¾å¤‡é»˜è®¤æœ€å¤§å¯ç”¨åˆ†è¾¨ç‡
        try {
            const track = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0];
            const getSafe = (fn) => { try { return fn(); } catch { return undefined; } };
            console.log('ğŸ›ï¸ capabilities:', getSafe(() => track && track.getCapabilities && track.getCapabilities()));
            console.log('ğŸ“ settings:', getSafe(() => track && track.getSettings && track.getSettings()));
        } catch {}
        
        console.log('âœ… æ‘„åƒå¤´åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
        console.error('âŒ æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', error);
        // ä¼ é€’é”™è¯¯æ¶ˆæ¯ç»™ç”¨æˆ·ç•Œé¢
        const errorMsg = error.message || error.toString();
        showCameraError(errorMsg);
    }
}

// ç»‘å®šè§†é¢‘æµå¹¶æ’­æ”¾ï¼Œé¿å…å¹¶å‘æ‰“æ–­æ’­æ”¾
async function bindStreamAndPlay(videoEl, stream) {
    if (!videoEl) throw new Error('video element missing');
    // å¢åŠ ç‰ˆæœ¬å·ï¼Œé˜²æ­¢å¹¶å‘é‡å…¥
    if (typeof window.__cameraBindVersion !== 'number') window.__cameraBindVersion = 0;
    const myVersion = ++window.__cameraBindVersion;
    try { videoEl.pause && videoEl.pause(); } catch {}
    try { videoEl.srcObject = null; } catch {}
    videoEl.srcObject = stream;
    try {
        const track = stream && stream.getVideoTracks ? stream.getVideoTracks()[0] : null;
        const sets = track && track.getSettings ? track.getSettings() : {};
        console.log('ğŸ”— ç»‘å®šæµåˆ°è§†é¢‘å…ƒç´ ', {
            version: myVersion,
            hasStream: !!stream,
            hasTrack: !!track,
            trackState: track ? track.readyState : 'no-track',
            trackSettings: sets
        });
    } catch {}
    // ç­‰å¾…ä¸‹ä¸€å¸§ï¼Œç¡®ä¿åŠ è½½è¯·æ±‚æäº¤
    await new Promise(r => setTimeout(r, 0));
    // ä»…å½“æ²¡æœ‰æ–°çš„ç»‘å®šå‘ç”Ÿæ—¶å†æ’­æ”¾
    if (myVersion === window.__cameraBindVersion) {
        try {
            await (videoEl.play && videoEl.play());
            console.log('â–¶ï¸ play() æˆåŠŸ');
        } catch (e) {
            console.warn('âš ï¸ play() å¤±è´¥:', e && e.message);
        }
    }
}

// å°†è§†é¢‘è½¨é“æå‡åˆ°è®¾å¤‡æ”¯æŒçš„æœ€å¤§åˆ†è¾¨ç‡ï¼ˆä»…åœ¨é¦–æ¬¡ç»‘å®šæˆåŠŸåæ‰§è¡Œä¸€æ¬¡ï¼‰
async function upgradeVideoTrackToMax(track) {
    try {
        if (!track || !track.getCapabilities || !track.applyConstraints) return;
        // ä½¿ç”¨å…¨å±€ WeakSet è®°å½•å·²å‡çº§çš„è½¨é“ï¼Œé¿å…é‡å¤æå‡
        if (!window.__upgradedTracks) window.__upgradedTracks = new WeakSet();
        if (window.__upgradedTracks.has(track)) return;
        const caps = track.getCapabilities();
        const targetHD = { width: 1280, height: 720 };
        const targetFHD = { width: 1920, height: 1080 };

        // 1) ä¼˜å…ˆ exact 1280x720ï¼ˆè‹¥è®¾å¤‡å…è®¸ï¼‰
        if (
            caps.width && typeof caps.width.max === 'number' && caps.width.max >= targetHD.width &&
            caps.height && typeof caps.height.max === 'number' && caps.height.max >= targetHD.height
        ) {
            try {
                const consHdExact = { width: { exact: targetHD.width }, height: { exact: targetHD.height } };
                if (caps.frameRate && typeof caps.frameRate.max === 'number') consHdExact.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
                await track.applyConstraints(consHdExact);
                const setsHd = track.getSettings ? track.getSettings() : {};
                console.log('ğŸ”§ æå‡åˆ†è¾¨ç‡ï¼ˆexact 1280x720ï¼‰:', { applied: setsHd });
                window.__upgradedTracks.add(track);
                return;
            } catch (exQhd) {
                console.warn('âš ï¸ exact 1280x720 å¤±è´¥ï¼Œå°è¯• ideal 1280x720 + min 720p:', exQhd && exQhd.message);
            }
        }

        // 2) ideal 1280x720ï¼Œæœ€ä½ä¿è¯ 1280x720
        try {
            const consHdIdeal = {
                width: { ideal: Math.min(caps.width?.max || targetHD.width, targetHD.width), min: targetHD.width },
                height: { ideal: Math.min(caps.height?.max || targetHD.height, targetHD.height), min: targetHD.height }
            };
            if (caps.frameRate && typeof caps.frameRate.max === 'number') consHdIdeal.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
            await track.applyConstraints(consHdIdeal);
            const setsHdIdeal = track.getSettings ? track.getSettings() : {};
            console.log('ğŸ”§ æå‡åˆ†è¾¨ç‡ï¼ˆideal 1280x720 + min 720pï¼‰:', { requested: consHdIdeal, applied: setsHdIdeal });
            window.__upgradedTracks.add(track);
            return;
        } catch (exQhdIdeal) {
            console.warn('âš ï¸ ideal 1280x720 å¤±è´¥ï¼Œå°è¯• 720p:', exQhdIdeal && exQhdIdeal.message);
        }

        // 3) exact 1080pï¼ˆå¦‚å…è®¸ï¼‰
        if (
            caps.width && typeof caps.width.max === 'number' && caps.width.max >= targetFHD.width &&
            caps.height && typeof caps.height.max === 'number' && caps.height.max >= targetFHD.height
        ) {
            try {
                const consFhdExact = { width: { exact: targetFHD.width }, height: { exact: targetFHD.height } };
                if (caps.frameRate && typeof caps.frameRate.max === 'number') consFhdExact.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
                await track.applyConstraints(consFhdExact);
                const setsExact1080 = track.getSettings ? track.getSettings() : {};
                console.log('ğŸ”§ æå‡åˆ†è¾¨ç‡ï¼ˆexact 1080pï¼‰:', { applied: setsExact1080 });
                window.__upgradedTracks.add(track);
                return;
            } catch (ex1080) {
                console.warn('âš ï¸ exact 1080p å¤±è´¥ï¼Œå°è¯• ideal 1080p:', ex1080 && ex1080.message);
            }
        }

        // 4) ideal 720p
        try {
            const idealCons = {
                width: { ideal: Math.min(caps.width?.max || targetHD.width, targetHD.width), min: targetHD.width },
                height: { ideal: Math.min(caps.height?.max || targetHD.height, targetHD.height), min: targetHD.height }
            };
            if (caps.frameRate && typeof caps.frameRate.max === 'number') idealCons.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
            await track.applyConstraints(idealCons);
            const setsIdeal720 = track.getSettings ? track.getSettings() : {};
            console.log('ğŸ”§ æå‡åˆ†è¾¨ç‡ï¼ˆideal 720pï¼‰:', { requested: idealCons, applied: setsIdeal720 });
            window.__upgradedTracks.add(track);
            return;
        } catch (exIdeal) {
            console.warn('âš ï¸ ideal 720p å¤±è´¥:', exIdeal && exIdeal.message);
        }

        // æœ€åï¼šæŒ‰è®¾å¤‡æœ€å¤§èƒ½åŠ›æå‡ï¼ˆbest effortï¼‰
        const consMax = {};
        if (caps.width && typeof caps.width.max === 'number') consMax.width = { ideal: caps.width.max };
        if (caps.height && typeof caps.height.max === 'number') consMax.height = { ideal: caps.height.max };
        if (caps.frameRate && typeof caps.frameRate.max === 'number') consMax.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
        if (Object.keys(consMax).length > 0) {
            await track.applyConstraints(consMax);
            const setsMax = track.getSettings ? track.getSettings() : {};
            console.log('ğŸ”§ æå‡åˆ†è¾¨ç‡ï¼ˆè®¾å¤‡maxï¼‰:', { requested: consMax, applied: setsMax });
        }
        try { window.__upgradedTracks.add(track); } catch {}
    } catch (e) {
        console.warn('âš ï¸ æå‡åˆ°æœ€å¤§åˆ†è¾¨ç‡å¤±è´¥ï¼ˆå¿½ç•¥ï¼‰:', e && e.message);
    }
}

// ç¡®ä¿æ‘„åƒå¤´å·²å°±ç»ªå¹¶å±•ç¤ºUIï¼ˆä¾›æ‹ç…§é¡µå¤ç”¨ï¼‰
async function ensureCameraReadyAndShowUI() {
    try {
        // å·²åˆå§‹åŒ–ä¸”è½¨é“å­˜æ´»åˆ™ç›´æ¥å±•ç¤ºUI
        if (cameraInitialized && cameraStream && cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0] && cameraStream.getVideoTracks()[0].readyState === 'live') {
            console.log('âœ… æ‘„åƒå¤´å·²åˆå§‹åŒ–ä¸”å­˜æ´»ï¼Œç›´æ¥å¯ç”¨UI');
            await enableCameraUI();
            cameraVideo = document.getElementById('camera-video') || cameraVideo;
            if (cameraVideo) {
                await bindStreamAndPlay(cameraVideo, cameraStream);
                // ä»…åœ¨ç»‘å®šæˆåŠŸåæ‰§è¡Œä¸€æ¬¡æœ€å¤§åˆ†è¾¨ç‡æå‡
                // ç»‘å®šåä¸å†é‡å¤æå‡ï¼Œé¿å…å¤šæ¬¡å˜åŒ–ï¼ˆupgradeVideoTrackToMax å†…éƒ¨å·²åšä¸€æ¬¡æ€§ä¿æŠ¤ï¼‰
                try { const t = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0]; await upgradeVideoTrackToMax(t); } catch {}
                applyCameraPreviewRotation();
                // é‡è¯•ç­‰å¾…å°±ç»ªï¼Œæœ€å¤š3æ¬¡
                for (let i = 0; i < 3; i++) {
                    try {
                        await waitForVideoReady();
                        console.log('ğŸ“º æ‹ç…§é¡µé¢„è§ˆå°ºå¯¸:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
                        break;
                    } catch (e) {
                        console.warn('âš ï¸ æ‹ç…§é¡µç­‰å¾…è§†é¢‘å°±ç»ªé‡è¯•', i + 1, e && e.message);
                        await new Promise(r => setTimeout(r, 200));
                    }
                }
            }
            return true;
        }
        // å¦åˆ™æ‰§è¡Œåˆå§‹åŒ–
        console.log('âš ï¸ æ‘„åƒå¤´æœªå°±ç»ªï¼Œå¼€å§‹åˆå§‹åŒ–...');
        await initializeCamera();
        if (cameraInitialized && cameraStream) {
            await enableCameraUI();
            cameraVideo = document.getElementById('camera-video') || cameraVideo;
            if (cameraVideo) {
                await bindStreamAndPlay(cameraVideo, cameraStream);
                try { const t = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0]; await upgradeVideoTrackToMax(t); } catch {}
                applyCameraPreviewRotation();
                for (let i = 0; i < 3; i++) {
                    try {
                        await waitForVideoReady();
                        console.log('ğŸ“º æ‹ç…§é¡µåˆå§‹åŒ–åé¢„è§ˆå°ºå¯¸:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
                        break;
                    } catch (e) {
                        console.warn('âš ï¸ æ‹ç…§é¡µåˆå§‹åŒ–åç­‰å¾…å°±ç»ªé‡è¯•', i + 1, e && e.message);
                        await new Promise(r => setTimeout(r, 200));
                    }
                }
            }
            return true;
        }
        return false;
    } catch (e) {
        console.error('âŒ ensureCameraReadyAndShowUI å¤±è´¥:', e);
        return false;
    }
}

// ç­‰å¾…è§†é¢‘å…ƒç´ å°±ç»ª
function waitForVideoReady() {
    return new Promise((resolve, reject) => {
        if (!cameraVideo) {
            console.error('âŒ waitForVideoReady: è§†é¢‘å…ƒç´ ä¸å­˜åœ¨');
            reject(new Error('è§†é¢‘å…ƒç´ ä¸å­˜åœ¨'));
            return;
        }
        
        // å¦‚æœå·²ç»å°±ç»ªï¼Œç›´æ¥è¿”å›
        if (cameraVideo.readyState >= 2) {
            console.log('ğŸ“¸ è§†é¢‘å…ƒç´ å·²å°±ç»ªï¼ŒreadyState:', cameraVideo.readyState);
            resolve();
            return;
        }
        
        console.log('ğŸ“¸ ç­‰å¾…è§†é¢‘å…ƒç´ å°±ç»ªï¼Œå½“å‰readyState:', cameraVideo.readyState);
        
        // è®¾ç½®è¶…æ—¶
        const timeout = setTimeout(() => {
            try {
                const srcObj = cameraVideo.srcObject;
                const track = srcObj && srcObj.getVideoTracks ? srcObj.getVideoTracks()[0] : null;
                const trackSettings = track && track.getSettings ? track.getSettings() : {};
                const trackState = track ? track.readyState : 'no-track';
                console.warn('âš ï¸ ç­‰å¾…è§†é¢‘å…ƒç´ å°±ç»ªè¶…æ—¶', {
                    videoExists: !!cameraVideo,
                    readyState: cameraVideo.readyState,
                    videoSize: { w: cameraVideo.videoWidth, h: cameraVideo.videoHeight },
                    hasSrcObject: !!srcObj,
                    trackState,
                    trackSettings
                });
            } catch {}
            reject(new Error('è§†é¢‘å…ƒç´ å°±ç»ªè¶…æ—¶'));
        }, 5000); // 5ç§’è¶…æ—¶
        
        // ç›‘å¬è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ
        const onLoadedMetadata = () => {
            clearTimeout(timeout);
            cameraVideo.removeEventListener('loadedmetadata', onLoadedMetadata);
            console.log('âœ… è§†é¢‘å…ƒç´ å°±ç»ªï¼ŒreadyState:', cameraVideo.readyState);
            resolve();
        };
        
        cameraVideo.addEventListener('loadedmetadata', onLoadedMetadata);
    });
}

// å¯ç”¨æ‘„åƒå¤´UI
async function enableCameraUI() {
    const cameraContainer = document.querySelector('.camera-container');
    if (cameraContainer) {
        // è‹¥å·²æœ‰videoå…ƒç´ ï¼Œé¿å…é‡å»ºé€ æˆå¼•ç”¨ä¸¢å¤±ï¼›å¦åˆ™æ‰æ’å…¥UIç»“æ„
        let existingVideo = document.getElementById('camera-video');
        if (!existingVideo) {
            cameraContainer.innerHTML = `
                <video id="camera-video" autoplay playsinline muted></video>
                <canvas id="camera-canvas" style="display: none;"></canvas>
                <div class="camera-overlay">
                    <div class="camera-instructions">
                        <h3>è¯·ç«™åœ¨æ‘„åƒå¤´å‰æ‹æ‘„å…¨èº«ç…§</h3>
                        <p>ç¡®ä¿å…¨èº«éƒ½åœ¨ç”»é¢ä¸­</p>
                    </div>
                    <button class="generate-button floating" onclick="generateTryOn()" id="generate-btn">
                        æ‹ç…§
                    </button>
                </div>`;
        }

        // ç»‘å®š/æ›´æ–°å¼•ç”¨å¹¶ç¡®ä¿æµç»‘å®šä¸å°±ç»ª
        cameraVideo = document.getElementById('camera-video');
        cameraCanvas = document.getElementById('camera-canvas');
        if (cameraVideo && cameraStream) {
            await bindStreamAndPlay(cameraVideo, cameraStream);
            applyCameraPreviewRotation();
            console.log('âœ… æ‘„åƒå¤´UIå·²å¯ç”¨å¹¶æ¢å¤');
            // ç­‰å¾…å°±ç»ªå¹¶æ‰“å°å°ºå¯¸ï¼Œè‹¥å¼‚å¸¸å°ºå¯¸åˆ™çŸ­å»¶è¿Ÿé‡è¯•ä¸€æ¬¡
            (async () => {
                let ok = false;
                for (let i = 0; i < 3; i++) {
                    try { await waitForVideoReady(); ok = true; break; } catch { await new Promise(r => setTimeout(r, 150)); }
                }
                try {
                    console.log('ğŸ“º æ‹ç…§é¡µé¢„è§ˆå°ºå¯¸:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
                    if (ok && (cameraVideo.videoWidth < 100 || cameraVideo.videoHeight < 100)) {
                        console.warn('âš ï¸ é¢„è§ˆå°ºå¯¸å¼‚å¸¸ï¼Œå°è¯•é‡æ–°ç»‘å®šæµ');
                        await bindStreamAndPlay(cameraVideo, cameraStream);
                        applyCameraPreviewRotation();
                        await waitForVideoReady().catch(() => {});
                        console.log('ğŸ“º é‡æ–°ç»‘å®šåé¢„è§ˆå°ºå¯¸:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
                    }
                } catch {}
            })();
        } else {
            console.error('âŒ æ‘„åƒå¤´UIæ¢å¤å¤±è´¥:', {
                cameraVideo: !!cameraVideo,
                cameraStream: !!cameraStream
            });
        }
    }
}

// é¢„è§ˆæ—‹è½¬ï¼šå°†è§†é¢‘å…ƒç´ æŒ‰ cameraRotationDeg æ—‹è½¬ï¼ˆCSSï¼Œä¸å½±å“æ‹ç…§æ¸²æŸ“ï¼‰
function applyCameraPreviewRotation() {
    try {
        const video = document.getElementById('camera-video');
        if (!video) return;
        // é€†æ—¶é’ˆ 90Â°ï¼šè®¾ç½® cameraRotationDeg = -90 æˆ–æŒ‰éœ€è®¾ç½®
        video.style.transformOrigin = 'center center';
        // é¢„è§ˆä¿æŒé•œåƒï¼ˆè‡ªæ‹ä½“éªŒæ›´è‡ªç„¶ï¼‰+ æ—‹è½¬è§’åº¦
        video.style.transform = 'scaleX(-1) rotate(' + cameraRotationDeg + 'deg)';
        // è‹¥éœ€è¦åœ¨æ—‹è½¬åé“ºæ»¡å¯è§†åŒºåŸŸï¼Œå¯æŒ‰å®¹å™¨å°ºå¯¸é¢å¤–è°ƒæ•´ scaleï¼Œè¿™é‡Œä¿ç•™é»˜è®¤
    } catch (e) { console.error('åº”ç”¨é¢„è§ˆæ—‹è½¬å¤±è´¥:', e); }
}

// æä¾›å…¨å±€å‡½æ•°ä»¥ä¾¿å¤–éƒ¨å¿«é€Ÿè®¾ç½®æ—‹è½¬è§’åº¦ï¼Œå¹¶ç«‹å³ä½œç”¨äºé¢„è§ˆ
window.setCameraRotation = function(deg) {
    try {
        cameraRotationDeg = Number(deg) || 0;
        applyCameraPreviewRotation();
    } catch (e) { console.error('è®¾ç½®é¢„è§ˆæ—‹è½¬å¤±è´¥:', e); }
};

function showCameraError(errorMessage) {
    const cameraContainer = document.querySelector('.camera-container');
    if (cameraContainer) {
        const message = errorMessage || 'è¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™æˆ–åˆ·æ–°é¡µé¢é‡è¯•';
        // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br> æ ‡ç­¾
        const formattedMessage = message.replace(/\n/g, '<br>');
        cameraContainer.innerHTML = `<div class="camera-error"><h3>æ‘„åƒå¤´æ— æ³•å¯åŠ¨</h3><p>${formattedMessage}</p><button onclick="location.reload()">åˆ·æ–°é¡µé¢</button></div>`;
    }
}

// æ£€æŸ¥æ‘„åƒå¤´æµçŠ¶æ€
function checkCameraStreamStatus() {
    if (!cameraStream) {
        console.log('âŒ æ‘„åƒå¤´æµä¸å­˜åœ¨');
        return false;
    }
    
    const tracks = cameraStream.getTracks();
    if (tracks.length === 0) {
        console.log('âŒ æ‘„åƒå¤´æµæ²¡æœ‰è½¨é“');
        return false;
    }
    
    const videoTrack = tracks.find(track => track.kind === 'video');
    if (!videoTrack) {
        console.log('âŒ æ‘„åƒå¤´æµæ²¡æœ‰è§†é¢‘è½¨é“');
        return false;
    }
    
    if (videoTrack.readyState !== 'live') {
        console.log('âŒ æ‘„åƒå¤´è§†é¢‘è½¨é“çŠ¶æ€ä¸æ˜¯live:', videoTrack.readyState);
        return false;
    }
    
    // æ£€æŸ¥è§†é¢‘å…ƒç´ æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
    if (cameraVideo && cameraVideo.readyState < 2) {
        console.log('âŒ è§†é¢‘å…ƒç´ æœªå°±ç»ªï¼ŒreadyState:', cameraVideo.readyState);
        return false;
    }
    
    // æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„æ‘„åƒå¤´è®¾å¤‡ä¿¡æ¯
    const settings = videoTrack.getSettings();
    console.log('âœ… æ‘„åƒå¤´æµçŠ¶æ€æ­£å¸¸ï¼Œå½“å‰ä½¿ç”¨è®¾å¤‡:', {
        deviceId: settings.deviceId,
        label: videoTrack.label,
        width: settings.width,
        height: settings.height,
        videoReadyState: cameraVideo ? cameraVideo.readyState : 'N/A'
    });
    
    return true;
}

// éªŒè¯å½“å‰æ‘„åƒå¤´æ˜¯å¦ä¸é…ç½®ä¸€è‡´
function verifyCameraConfig() {
    try {
        const cfg = appState.getConfig();
        const configuredDeviceId = cfg?.camera?.deviceId;
        
        if (!configuredDeviceId) {
            console.log('ğŸ“¸ é…ç½®ä¸­æœªæŒ‡å®šæ‘„åƒå¤´è®¾å¤‡ï¼Œä½¿ç”¨é»˜è®¤è®¾å¤‡');
            return true;
        }
        
        if (!cameraStream) {
            console.log('âŒ æ‘„åƒå¤´æµä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯é…ç½®');
            return false;
        }
        
        const videoTrack = cameraStream.getTracks().find(track => track.kind === 'video');
        if (!videoTrack) {
            console.log('âŒ æ²¡æœ‰è§†é¢‘è½¨é“ï¼Œæ— æ³•éªŒè¯é…ç½®');
            return false;
        }
        
        const settings = videoTrack.getSettings();
        const currentDeviceId = settings.deviceId;
        
        if (currentDeviceId === configuredDeviceId) {
            console.log('âœ… æ‘„åƒå¤´é…ç½®éªŒè¯é€šè¿‡ï¼Œä½¿ç”¨é…ç½®çš„è®¾å¤‡:', configuredDeviceId);
            return true;
        } else {
            console.warn('âš ï¸ æ‘„åƒå¤´é…ç½®ä¸åŒ¹é…:', {
                configured: configuredDeviceId,
                current: currentDeviceId
            });
            return false;
        }
    } catch (error) {
        console.error('âŒ éªŒè¯æ‘„åƒå¤´é…ç½®å¤±è´¥:', error);
        return false;
    }
}

// ååˆå§‹åŒ–æ‘„åƒå¤´
function deinitializeCamera() {
    console.log('ğŸ“¸ ååˆå§‹åŒ–æ‘„åƒå¤´...');
    
    try {
        // åœæ­¢æ‘„åƒå¤´æµ
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => {
                track.stop();
                console.log('ğŸ›‘ åœæ­¢æ‘„åƒå¤´è½¨é“:', track.kind);
            });
            cameraStream = null;
        }
        
        // æ¸…ç†è§†é¢‘å…ƒç´ 
        if (cameraVideo) {
            cameraVideo.srcObject = null;
        }
        
        // é‡ç½®çŠ¶æ€
        cameraInitialized = false;
        
        console.log('âœ… æ‘„åƒå¤´ååˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
        console.error('âŒ æ‘„åƒå¤´ååˆå§‹åŒ–å¤±è´¥:', error);
    }
}

// æ‹ç…§åŠŸèƒ½ - ä¸ä¸Šä¼ ï¼Œåªä¿å­˜åˆ°æœ¬åœ°
async function capturePhoto() {
    if (!cameraVideo || !cameraCanvas) {
        console.error('æ‘„åƒå¤´æœªåˆå§‹åŒ–');
        return;
    }

    try {
        // åŸå§‹è§†é¢‘å°ºå¯¸ï¼ˆæ¨ªå±ï¼‰
        const videoWidth = cameraVideo.videoWidth;
        const videoHeight = cameraVideo.videoHeight;

        const rot = ((cameraRotationDeg % 360) + 360) % 360; // å½’ä¸€åŒ–åˆ° [0,360)
        const isQuarterTurn = rot === 90 || rot === 270; // ä»…Â±90Â°æ—¶äº¤æ¢å®½é«˜

        // ç”»å¸ƒå°ºå¯¸ï¼šå½“æ—‹è½¬Â±90Â°æ—¶ï¼Œäº¤æ¢å®½é«˜å¾—åˆ°ç«–å±ï¼›å…¶å®ƒè§’åº¦æŒ‰åŸå°ºå¯¸
        cameraCanvas.width = isQuarterTurn ? videoHeight : videoWidth;
        cameraCanvas.height = isQuarterTurn ? videoWidth : videoHeight;

        const ctx = cameraCanvas.getContext('2d');
        ctx.save();

        // å°†åæ ‡ç³»ç§»åŠ¨åˆ°ç”»å¸ƒä¸­å¿ƒï¼ŒæŒ‰æ—‹è½¬è§’åº¦æ—‹è½¬ï¼ˆä¸é¢„è§ˆä¸€è‡´ï¼Œä½¿ç”¨ cameraRotationDegï¼‰
        ctx.translate(cameraCanvas.width / 2, cameraCanvas.height / 2);
        ctx.rotate((cameraRotationDeg * Math.PI) / 180);

        // æŠŠåŸå§‹è§†é¢‘å¸§ç»˜åˆ¶åˆ°ä»¥ä¸­å¿ƒä¸ºåŸç‚¹çš„åæ ‡ç³»ä¸­ï¼Œç¡®ä¿å®Œæ•´ç”»é¢
        ctx.drawImage(
            cameraVideo,
            -videoWidth / 2,
            -videoHeight / 2,
            videoWidth,
            videoHeight
        );

        ctx.restore();

        // è·å–å®Œæ•´ç…§ç‰‡æ•°æ®
        const fullPhotoData = cameraCanvas.toDataURL('image/jpeg', 0.8);

        // ç»Ÿä¸€æ—¶é—´æˆ³ï¼Œå‘½ååŸå›¾ä¸è£å‰ªå›¾
        const timestamp = Date.now();
        const originalPhotoFileName = 'photo_' + timestamp + '_original.jpg';
        const croppedPhotoFileName = 'photo_' + timestamp + '.jpg';

        // åˆ›å»ºè£å‰ªåçš„ç…§ç‰‡ï¼ˆ720x1024ï¼‰
        const croppedPhotoData = await cropPhotoTo720x1024(fullPhotoData);

        // ä¿å­˜åˆ°åº”ç”¨çŠ¶æ€
        appState.userProfile.photo = croppedPhotoData; // ä½¿ç”¨è£å‰ªåçš„ç…§ç‰‡
        appState.userProfile.photoFileName = croppedPhotoFileName;
        appState.userProfile.originalPhotoFileName = originalPhotoFileName;

        // ä¿å­˜åŸå§‹ç…§ç‰‡åˆ°æœ¬åœ°uploadsæ–‡ä»¶å¤¹
        try {
            await savePhotoToUploads(fullPhotoData, originalPhotoFileName);
            console.log('âœ… åŸå§‹ç…§ç‰‡å·²ä¿å­˜åˆ°uploadsæ–‡ä»¶å¤¹:', originalPhotoFileName);
        } catch (saveOriginalError) {
            console.warn('âš ï¸ ä¿å­˜åŸå§‹ç…§ç‰‡åˆ°uploadsæ–‡ä»¶å¤¹å¤±è´¥:', saveOriginalError);
        }

        // ä¿å­˜è£å‰ªåçš„ç…§ç‰‡åˆ°æœ¬åœ°uploadsæ–‡ä»¶å¤¹
        try {
            await savePhotoToUploads(croppedPhotoData, croppedPhotoFileName);
            console.log('âœ… è£å‰ªç…§ç‰‡å·²ä¿å­˜åˆ°uploadsæ–‡ä»¶å¤¹:', croppedPhotoFileName);
        } catch (saveCroppedError) {
            console.warn('âš ï¸ ä¿å­˜è£å‰ªç…§ç‰‡åˆ°uploadsæ–‡ä»¶å¤¹å¤±è´¥:', saveCroppedError);
        }
        
        console.log('ç…§ç‰‡æ‹æ‘„å’Œè£å‰ªæˆåŠŸï¼Œå°ºå¯¸ï¼š720x1024');
        return croppedPhotoData;
    } catch (error) {
        console.error('æ‹ç…§å¤±è´¥:', error);
        return null;
    }
}

// æ–°çš„æ‹ç…§æµç¨‹ï¼šå¸¦å€’è®¡æ—¶ï¼Œæ‹ç…§åè·³è½¬åˆ°ç¡®è®¤é¡µé¢
async function capturePhotoWithCountdown() {
    const captureBtn = document.getElementById('capture-btn');
    if (!captureBtn) {
        console.error('æœªæ‰¾åˆ°æ‹ç…§æŒ‰é’®');
        return;
    }

    // ç¦ç”¨æŒ‰é’®
    captureBtn.disabled = true;
    captureBtn.style.pointerEvents = 'none';
    captureBtn.classList.add('countdown');
    
    let countdown = 5;
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    const updateButtonText = () => {
        captureBtn.textContent = 'æ‹æ‘„å€’è®¡æ—¶ ' + countdown + ' ç§’';
    };
    
    // åˆå§‹æ˜¾ç¤º
    updateButtonText();
    
    // å€’è®¡æ—¶åŠ¨ç”»æ•ˆæœ
    const countdownInterval = setInterval(() => {
        countdown--;
        
        if (countdown > 0) {
            updateButtonText();
            
            // æ·»åŠ è„‰å†²åŠ¨ç”»æ•ˆæœ
            captureBtn.style.transform = 'translateX(-50%) scale(1.1)';
            setTimeout(() => {
                captureBtn.style.transform = 'translateX(-50%) scale(1)';
            }, 150);
        } else {
            // å€’è®¡æ—¶ç»“æŸï¼Œå¼€å§‹æ‹ç…§
            clearInterval(countdownInterval);
            captureBtn.classList.remove('countdown');
            captureBtn.textContent = 'æ­£åœ¨æ‹æ‘„...';
            
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´è®©ç”¨æˆ·çœ‹åˆ°"æ­£åœ¨æ‹æ‘„"çš„æç¤º
            setTimeout(async () => {
                try {
                    // æ‹ç…§ï¼ˆä¸ä¸Šä¼ ï¼‰
                    const photoData = await capturePhoto();
                    if (!photoData) {
                        appState.showError('æ‹ç…§å¤±è´¥ï¼Œè¯·é‡è¯•');
                        resetCaptureButton();
                        return;
                    }

                    // ä¿å­˜ç…§ç‰‡æ•°æ®åˆ°çŠ¶æ€
                    appState.capturedPhotoData = photoData;
                    
                    // æ˜¾ç¤ºæ‹ç…§ç¡®è®¤é¡µé¢
                    const capturedPhoto = document.getElementById('captured-photo');
                    if (capturedPhoto) {
                        capturedPhoto.src = photoData;
                    }
                    
                    // åˆ‡æ¢åˆ°æ‹ç…§ç¡®è®¤é¡µé¢
                    await appState.setPage('photo-confirm-page');
                    
                    // é‡ç½®æŒ‰é’®çŠ¶æ€
                    resetCaptureButton();
                } catch (error) {
                    console.error('æ‹ç…§æµç¨‹é”™è¯¯:', error);
                    appState.showError('æ‹ç…§å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™');
                    resetCaptureButton();
                }
            }, 300);
        }
    }, 1000);
}

// é‡ç½®æ‹ç…§æŒ‰é’®çŠ¶æ€
function resetCaptureButton() {
    const captureBtn = document.getElementById('capture-btn');
    if (captureBtn) {
        captureBtn.disabled = false;
        captureBtn.style.pointerEvents = 'auto';
        captureBtn.textContent = 'æ‹ç…§';
        captureBtn.style.transform = 'translateX(-50%)';
        captureBtn.classList.remove('countdown');
    }
}

// è£å‰ªç…§ç‰‡ä¸º720x1024å°ºå¯¸
function cropPhotoTo720x1024(photoDataUrl) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
            // åˆ›å»ºè£å‰ªç”»å¸ƒ
            const cropCanvas = document.createElement('canvas');
            const cropCtx = cropCanvas.getContext('2d');
            
            // è®¾ç½®ç›®æ ‡å°ºå¯¸
            const targetWidth = 720;
            const targetHeight = 1024;
            cropCanvas.width = targetWidth;
            cropCanvas.height = targetHeight;
            
            // è·å–åŸå§‹å›¾ç‰‡å°ºå¯¸
            const srcWidth = img.width;
            const srcHeight = img.height;
            
            console.log('åŸå§‹å›¾ç‰‡å°ºå¯¸: ' + srcWidth + 'x' + srcHeight);
            console.log('ç›®æ ‡å°ºå¯¸: ' + targetWidth + 'x' + targetHeight);
            
            // ç­–ç•¥ï¼šä¿è¯è¾“å‡ºé«˜åº¦ä¸€è‡´ä¸º 1024ã€‚
            // 1) ä»¥é«˜åº¦ä¸ºåŸºå‡†è¿›è¡Œç­‰æ¯”ç¼©æ”¾ï¼Œå¾—åˆ° scaledWidthã€‚
            // 2) è‹¥ scaledWidth >= 720ï¼šæ°´å¹³å±…ä¸­è£å‰ªåˆ° 720 å®½ï¼ˆä¸ä¼šå‡ºç°é»‘è¾¹ï¼‰ã€‚
            // 3) è‹¥ scaledWidth < 720ï¼šå…è®¸å·¦å³ç•™é»‘è¾¹ï¼Œå°†ç¼©æ”¾åçš„å›¾åƒå±…ä¸­æ”¾ç½®åœ¨ 720x1024 ç”»å¸ƒä¸Šã€‚

            // å¡«å……é»‘è‰²èƒŒæ™¯ï¼Œç¡®ä¿ä¸è¶³æ—¶å‡ºç°é»‘è¾¹
            cropCtx.fillStyle = '#000';
            cropCtx.fillRect(0, 0, targetWidth, targetHeight);

            const scale = targetHeight / srcHeight;
            const scaledWidth = srcWidth * scale;

            if (scaledWidth >= targetWidth) {
                // å®½åº¦è¶³å¤Ÿï¼šæ”¾å¤§åˆ°ä»¥é«˜åº¦ä¸ºå‡†ï¼Œè¶…å‡ºçš„éƒ¨åˆ†è£æ‰ï¼ˆæ°´å¹³ä¸­å¿ƒè£å‰ªï¼‰
                const drawX = (targetWidth - scaledWidth) / 2; // è´Ÿå€¼ï¼Œè¶…å‡ºä¼šè¢«ç”»å¸ƒè£å‰ª
                cropCtx.drawImage(
                    img,
                    0, 0, srcWidth, srcHeight,
                    drawX, 0, scaledWidth, targetHeight
                );
            } else {
                // å®½åº¦ä¸è¶³ï¼šå…è®¸é»‘è¾¹ï¼Œæ°´å¹³å±…ä¸­æ”¾ç½®ç¼©æ”¾åçš„å›¾åƒ
                const offsetX = (targetWidth - scaledWidth) / 2;
                cropCtx.drawImage(
                    img,
                    0, 0, srcWidth, srcHeight,
                    offsetX, 0, scaledWidth, targetHeight
                );
            }
            
            // è½¬æ¢ä¸º base64
            const croppedDataUrl = cropCanvas.toDataURL('image/jpeg', 0.8);
            console.log('ç…§ç‰‡è£å‰ªå®Œæˆï¼Œæ–°å°ºå¯¸: 720x1024');
            
            resolve(croppedDataUrl);
        };
        
        img.onerror = function() {
            console.error('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¿”å›åŸå§‹æ•°æ®');
            resolve(photoDataUrl); // å¦‚æœå¤±è´¥ï¼Œè¿”å›åŸå§‹æ•°æ®
        };
        
        img.src = photoDataUrl;
    });
}

// ä¿®æ”¹generateTryOnå‡½æ•°ï¼Œä½¿ç”¨æ‘„åƒå¤´æ‹ç…§
function generateTryOn() {
    // æ£€æŸ¥æ‘„åƒå¤´æ˜¯å¦å°±ç»ª
    try {
        if (!cameraVideo || !cameraCanvas) {
            // æ‡’åŠ è½½è·å–ä¸€æ¬¡ï¼Œé¿å…é¦–æ¬¡ä¸º null
            cameraVideo = document.getElementById('camera-video');
            cameraCanvas = document.getElementById('camera-canvas');
        }

        if (!cameraInitialized || !cameraVideo || !cameraVideo.srcObject) {
            appState.showError('æ‘„åƒå¤´æœªå°±ç»ªï¼Œè¯·å…è®¸æ‘„åƒå¤´æƒé™æˆ–ç¨åé‡è¯•');
            return;
        }

        // å¼€å§‹5ç§’å€’è®¡æ—¶
        startCountdown();
    } catch (e) {
        console.error('generateTryOn æ‰§è¡Œé”™è¯¯:', e);
        appState.showError('æ‹ç…§å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™');
    }
}

// å¼€å§‹å€’è®¡æ—¶
function startCountdown() {
    const generateBtn = document.getElementById('generate-btn');
    if (!generateBtn) return;

    // ç¦ç”¨æŒ‰é’®å¹¶æ·»åŠ å€’è®¡æ—¶æ ·å¼
    generateBtn.disabled = true;
    generateBtn.style.pointerEvents = 'none';
    generateBtn.classList.add('countdown');
    
    let countdown = 5;
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    const updateButtonText = () => {
        generateBtn.textContent = 'æ‹æ‘„å€’è®¡æ—¶ ' + countdown + ' ç§’';
    };
    
    // åˆå§‹æ˜¾ç¤º
    updateButtonText();
    
    // å€’è®¡æ—¶åŠ¨ç”»æ•ˆæœ
    const countdownInterval = setInterval(() => {
        countdown--;
        
        if (countdown > 0) {
            updateButtonText();
            
            // æ·»åŠ è„‰å†²åŠ¨ç”»æ•ˆæœ
            generateBtn.style.transform = 'translateX(-50%) scale(1.1)';
            setTimeout(() => {
                generateBtn.style.transform = 'translateX(-50%) scale(1)';
            }, 150);
        } else {
            // å€’è®¡æ—¶ç»“æŸï¼Œå¼€å§‹æ‹ç…§
            clearInterval(countdownInterval);
            generateBtn.classList.remove('countdown');
            generateBtn.textContent = 'æ­£åœ¨æ‹æ‘„...';
            
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´è®©ç”¨æˆ·çœ‹åˆ°"æ­£åœ¨æ‹æ‘„"çš„æç¤º
            setTimeout(() => {
                takePhoto();
            }, 300);
        }
    }, 1000);
}

// æ‰§è¡Œæ‹ç…§
async function takePhoto() {
    try {
        const photoData = await capturePhoto();
        if (!photoData) {
            appState.showError('æ‹ç…§å¤±è´¥ï¼Œè¯·é‡è¯•');
            resetGenerateButton();
            return;
        }

        uploadPhotoToServer(photoData);
    } catch (e) {
        console.error('æ‹ç…§æ‰§è¡Œé”™è¯¯:', e);
        appState.showError('æ‹ç…§å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™');
        resetGenerateButton();
    }
}

// é‡ç½®æŒ‰é’®çŠ¶æ€
function resetGenerateButton() {
    const generateBtn = document.getElementById('generate-btn');
    if (generateBtn) {
        generateBtn.disabled = false;
        generateBtn.style.pointerEvents = 'auto';
        generateBtn.textContent = 'æ‹ç…§';
        generateBtn.style.transform = 'translateX(-50%)';
        generateBtn.classList.remove('countdown');
    }
}

// ä¸Šä¼ ç…§ç‰‡åˆ°æœåŠ¡å™¨å’ŒRunningHub
async function uploadPhotoToServer(photoData) {
    try {
        appState.showLoading('æ­£åœ¨ä¸Šä¼ ç…§ç‰‡ï¼ˆ720x1024å°ºå¯¸ï¼‰...');
        
        // å°†base64è½¬æ¢ä¸ºBlob
        const response = await fetch(photoData);
        const blob = await response.blob();
        
        console.log('ä¸Šä¼ ç…§ç‰‡ä¿¡æ¯: å°ºå¯¸ 720x1024, æ–‡ä»¶å¤§å°: ' + blob.size + ' bytes');
        
        // ç¡®ä¿APIå®¢æˆ·ç«¯å­˜åœ¨
        if (!window.apiClient) {
            console.log('âŒ window.apiClient ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„APIå®¢æˆ·ç«¯å®ä¾‹...');
            if (typeof window.ApiClient === 'function') {
                window.apiClient = new window.ApiClient();
                console.log('âœ… æ–°çš„APIå®¢æˆ·ç«¯å®ä¾‹åˆ›å»ºæˆåŠŸ');
            } else {
                console.error('âŒ æ— æ³•åˆ›å»ºæ–°çš„APIå®¢æˆ·ç«¯å®ä¾‹ï¼Œwindow.ApiClientç±»å‹:', typeof window.ApiClient);
                throw new Error('æ— æ³•åˆ›å»ºAPIå®¢æˆ·ç«¯å®ä¾‹');
            }
        }
        
        // ç¡®ä¿APIå®¢æˆ·ç«¯å·²åˆå§‹åŒ–
        if (!window.apiClient.initialized) {
            console.log('ğŸ”„ APIå®¢æˆ·ç«¯å°šæœªåˆå§‹åŒ–ï¼Œæ‰§è¡Œåˆå§‹åŒ–...');
            try {
                if (typeof window.apiClient.initialize === 'function') {
                    await window.apiClient.initialize();
                    console.log('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ');
                } else {
                    console.error('âŒ APIå®¢æˆ·ç«¯ç¼ºå°‘initializeæ–¹æ³•');
                    throw new Error('APIå®¢æˆ·ç«¯åˆå§‹åŒ–æ–¹æ³•ç¼ºå¤±');
                }
            } catch (initError) {
                console.error('âŒ APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', initError);
                throw new Error('APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ' + initError.message);
            }
        }
        
        // // å¼ºåˆ¶è®¾ç½®æ­£ç¡®çš„APIæœåŠ¡å™¨åœ°å€ï¼ˆä¿®å¤ç«¯å£é…ç½®é—®é¢˜ï¼‰
        // const expectedBaseUrl = 'https://clothing-api.0086studios.xyz';
        // if (window.apiClient && window.apiClient.baseUrl !== expectedBaseUrl) {
        //     console.log('ğŸ”§ ä¿®å¤APIå®¢æˆ·ç«¯åœ°å€é…ç½®:', window.apiClient.baseUrl, '->', expectedBaseUrl);
        //     window.apiClient.baseUrl = expectedBaseUrl;
        // }
        
        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²è®¤è¯ï¼Œå¦‚æœæœªè®¤è¯åˆ™å°è¯•è®¤è¯
        if (!window.apiClient.token) {
            console.log('âš ï¸ è®¾å¤‡æœªè®¤è¯ï¼Œå°è¯•è¿›è¡Œè®¾å¤‡è®¤è¯...');
            try {
                // è·å–MACåœ°å€ç”¨äºè®¾å¤‡è®¤è¯
                let macAddress = appState.macAddress;
                if (!macAddress) {
                    console.log('ğŸ” å°è¯•è·å–è®¾å¤‡MACåœ°å€...');
                    await appState.getMacAddress();
                    macAddress = appState.macAddress;
                }
                
                if (macAddress) {
                    // å¤„ç†MACåœ°å€ï¼šå»æ‰å†’å·ä½œä¸ºè®¾å¤‡å”¯ä¸€æ ‡è¯†
                    const deviceId = macAddress.replace(/:/g, '');
                    console.log('ğŸ“± ä½¿ç”¨å¤„ç†åçš„MACåœ°å€è¿›è¡Œè®¾å¤‡è®¤è¯:', macAddress, '->', deviceId);
                    const authResponse = await window.apiClient.authenticateDevice(deviceId, 'è¡£ç­‰èˆ±å®¢æˆ·ç«¯');
                    if (authResponse.success) {
                        console.log('âœ… è®¾å¤‡è®¤è¯æˆåŠŸï¼Œè·å¾—token:', authResponse.token ? '***' : 'æ— ');
                    } else {
                        throw new Error(authResponse.error || 'è®¾å¤‡è®¤è¯å¤±è´¥');
                    }
                } else {
                    throw new Error('æ— æ³•è·å–è®¾å¤‡MACåœ°å€è¿›è¡Œè®¤è¯');
                }
            } catch (authError) {
                console.error('âŒ è®¾å¤‡è®¤è¯å¤±è´¥:', authError);
                throw new Error('è®¾å¤‡è®¤è¯å¤±è´¥: ' + authError.message);
            }
        }
        
        // æœ€ç»ˆæ£€æŸ¥APIå®¢æˆ·ç«¯çŠ¶æ€
        if (!window.apiClient || !window.apiClient.token) {
            const errorMsg = !window.apiClient ? 'APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–' : 'è®¾å¤‡æœªè®¤è¯';
            console.error('âŒ APIå®¢æˆ·ç«¯çŠ¶æ€æ£€æŸ¥å¤±è´¥:', errorMsg);
            throw new Error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–æˆ–æœªè®¤è¯ï¼Œè¯·å…ˆå®Œæˆè®¾å¤‡è®¤è¯');
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨å¾®ä¿¡å…¬ä¼—å·
        console.log('ğŸ” æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨å¾®ä¿¡å…¬ä¼—å·...');
        let isSubscribed = false;
        
        // å¼€å‘æ¨¡å¼è·³è¿‡ç™»å½•æ—¶ï¼Œä¸æ£€æŸ¥å¾®ä¿¡å…³æ³¨çŠ¶æ€
        if (appState.devModeSkippedLogin) {
            console.log('âœ… å¼€å‘æ¨¡å¼ï¼šè·³è¿‡å¾®ä¿¡å…³æ³¨çŠ¶æ€æ£€æŸ¥');
            isSubscribed = true;
        } else {
            try {
                // ä½¿ç”¨äºŒç»´ç åœºæ™¯å€¼æ£€æŸ¥ç”¨æˆ·å…³æ³¨çŠ¶æ€
                if (appState.qrSceneStr && window.apiClient) {
                    const response = await window.apiClient.checkWechatStatus(appState.qrSceneStr);
                    console.log('ğŸ” å¾®ä¿¡çŠ¶æ€æ£€æŸ¥å“åº”:', response);
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å…³æ³¨ï¼ˆå…¼å®¹isSubscribedå’ŒisVerifiedä¸¤ç§å­—æ®µï¼‰
                    isSubscribed = response.isSubscribed || response.isVerified;
                    
                    if (response.success && isSubscribed) {
                        console.log('âœ… ç”¨æˆ·å·²å…³æ³¨å¾®ä¿¡å…¬ä¼—å·');
                    } else {
                        console.log('âš ï¸ ç”¨æˆ·å°šæœªå…³æ³¨å¾®ä¿¡å…¬ä¼—å·');
                    }
                }
            } catch (wechatError) {
                console.error('âŒ æ£€æŸ¥å¾®ä¿¡å…³æ³¨çŠ¶æ€å¤±è´¥:', wechatError);
            }
            
            // å¦‚æœç”¨æˆ·æœªå…³æ³¨å…¬ä¼—å·ï¼Œæç¤ºç”¨æˆ·å…ˆå…³æ³¨
            if (!isSubscribed) {
                throw new Error('è¯·å…ˆå¾®ä¿¡æ‰«ç å…³æ³¨å…¬ä¼—å·å®ŒæˆéªŒè¯');
            }
        }
        
        console.log('å¼€å§‹ä¸Šä¼ è£å‰ªåçš„ç…§ç‰‡åˆ° API Server...');
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        console.log('è°ƒè¯•ä¿¡æ¯ - appState.qrSceneStr:', appState.qrSceneStr);
        console.log('è°ƒè¯•ä¿¡æ¯ - appState:', appState);
        
        // ä¸Šä¼ ç”¨æˆ·ç…§ç‰‡ï¼Œæ–°æ¥å£ä¼šç›´æ¥åˆ›å»ºä»»åŠ¡å¹¶è¿”å›ä»»åŠ¡ID
        // ä¼ é€’sceneStrå‚æ•°ä»¥å…³è”å¾®ä¿¡ç”¨æˆ·å’Œä»»åŠ¡
        const uploadResponse = await window.apiClient.uploadPhoto(blob, appState.qrSceneStr);
        console.log('ç…§ç‰‡ä¸Šä¼ ç»“æœ:', uploadResponse);
        
        if (!uploadResponse.success) {
            throw new Error(uploadResponse.error || 'ç…§ç‰‡ä¸Šä¼ å¤±è´¥');
        }
        
        // ä¿å­˜ä»»åŠ¡IDï¼ˆæ–°æ¥å£ç›´æ¥è¿”å›ä»»åŠ¡IDï¼‰
        appState.currentTaskId = uploadResponse.data.taskId;
        console.log('âœ… ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼Œä»»åŠ¡ID:', appState.currentTaskId);
        
        appState.hideLoading();
        
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        resetGenerateButton();
        
        // ååˆå§‹åŒ–æ‘„åƒå¤´ï¼Œé‡Šæ”¾èµ„æº
        deinitializeCamera();
        
        // è·³è½¬åˆ°æœè£…é€‰æ‹©é¡µé¢
        await appState.setPage('clothing-page');
        
    } catch (error) {
        console.error('ä¸Šä¼ ç…§ç‰‡é”™è¯¯:', error);
        appState.hideLoading();
        appState.showError('ç…§ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message);
        
        // å‡ºé”™æ—¶ä¹Ÿè¦é‡ç½®æŒ‰é’®çŠ¶æ€
        resetGenerateButton();
        
        // å‡ºé”™æ—¶ä¹Ÿè¦ååˆå§‹åŒ–æ‘„åƒå¤´
        deinitializeCamera();
    }
}

function backToCamera() {
    appState.backToCamera();
}

// æ·»åŠ goBackå‡½æ•°ï¼Œç”¨äºè¿”å›ä¸Šä¸€é¡µ
function goBack() {
    // æ ¹æ®å½“å‰é¡µé¢å†³å®šè¿”å›åˆ°å“ªä¸ªé¡µé¢
    switch(appState.currentPage) {
        case 'clothing-page':
            // ä»æœè£…é€‰æ‹©é¡µè¿”å›åˆ°ä¸ªäººä¿¡æ¯é¡µ
            appState.setPage('profile-page');
            break;
        case 'results-page':
            // ä»ç»“æœé¡µè¿”å›åˆ°æœè£…é€‰æ‹©é¡µ
            appState.setPage('clothing-page');
            break;
        case 'style-page':
            // ä»é£æ ¼é¡µè¿”å›åˆ°ç»“æœé¡µ
            appState.setPage('results-page');
            break;
        case 'config-page':
            // ä»é…ç½®é¡µè¿”å›åˆ°æ¬¢è¿é¡µ
            appState.setPage('welcome-page');
            break;
        default:
            // é»˜è®¤è¿”å›åˆ°æ¬¢è¿é¡µ
            appState.setPage('welcome-page');
            break;
    }
}

// æ·»åŠ proceedToFittingå‡½æ•°
function proceedToFitting() {
    appState.startFittingProcess();
}

// åˆ›å»ºå…¨å±€å‡½æ•°ï¼Œä¾›HTMLä¸­ç›´æ¥è°ƒç”¨
window.startExperience = function() {
    appState.startExperience();
};

window.openConfigPage = function() {
    appState.openConfigPage();
};

// æ·»åŠ æ‰‹åŠ¨åˆ·æ–°äºŒç»´ç çš„å…¨å±€å‡½æ•°
window.refreshWechatQRCode = function() {
    appState.refreshWechatQRCode();
};

// æ–°å¢ï¼šä»¥å¯¹è¯æ¡†å½¢å¼æ‰“å¼€/å…³é—­é…ç½®
window.openConfig = function() {
    try {
        const modal = document.getElementById('config-modal');
        if (modal) {
            modal.style.display = 'flex';
            if (typeof loadConfigIntoForm === 'function') loadConfigIntoForm();
            if (typeof initializeDeviceInfo === 'function') initializeDeviceInfo();
            if (typeof refreshCameraList === 'function') refreshCameraList();
        }
    } catch (e) { console.error(e); }
};

window.closeConfig = function() {
    const modal = document.getElementById('config-modal');
    if (modal) modal.style.display = 'none';
    // å…³é—­é…ç½®åå›åˆ°é¦–é¡µ
    if (window.appState && typeof window.appState.setPage === 'function') {
        window.appState.setPage('welcome-page');
    }
};

// æ·»åŠ å…³é—­é”™è¯¯æç¤ºæ¡†çš„å…¨å±€å‡½æ•°
window.closeErrorModal = function() {
    const modal = document.getElementById('error-modal');
    if (modal) modal.style.display = 'none';
};

// æ·»åŠ åˆ·æ–°è®¾å¤‡çŠ¶æ€çš„å…¨å±€å‡½æ•°
window.refreshDeviceStatus = function() {
    appState.refreshDeviceStatus();
};

// æ·»åŠ goBackå’ŒproceedToFittingçš„å…¨å±€å‡½æ•°
window.goBack = goBack;
window.proceedToFitting = async function() {
    try {
        console.log('ğŸš€ å¼€å§‹è¯•è¡£æµç¨‹...');
        const resultUrl = await appState.startFittingProcess();
        console.log('âœ… è¯•è¡£æµç¨‹å®Œæˆ:', resultUrl);
    } catch (error) {
        console.error('âŒ è¯•è¡£æµç¨‹å¤±è´¥:', error);
    }
};

// æ·»åŠ ä¿å­˜å›¾ç‰‡çš„å…¨å±€å‡½æ•°
window.saveImage = function() {
    appState.saveImage();
};

// æ·»åŠ æ‰«ç è·å–å›¾ç‰‡é¡µé¢çš„å…¨å±€å‡½æ•°
window.goBackToResult = function() {
    appState.setPage('results-page');
};

window.refreshScanQrCode = function() {
    appState.refreshScanQrCode();
};

window.goBackToHome = function() {
    appState.returnToHomeFromScan();
};

// æ·»åŠ æµ‹è¯•APIæœåŠ¡å™¨è¿æ¥çš„å…¨å±€å‡½æ•°
window.testApiServerConnection = async function() {
    try {
        console.log('ğŸ” å¼€å§‹æµ‹è¯•APIæœåŠ¡å™¨è¿æ¥...');
        
        // è·å–è¾“å…¥çš„APIæœåŠ¡å™¨åœ°å€
        const input = document.getElementById('cfg-api-server-url');
        let testUrl = input ? input.value.trim() : '';
        
        // å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œä½¿ç”¨å½“å‰çš„baseUrl
        if (!testUrl) {
            testUrl = window.apiClient ? window.apiClient.baseUrl : 'https://clothing-api.0086studios.xyz';
        }
        
        console.log('ğŸ¯ æµ‹è¯•ç›®æ ‡:', testUrl);
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'æµ‹è¯•ä¸­...';
        button.disabled = true;
        
        // å‘é€æµ‹è¯•è¯·æ±‚
        const response = await fetch(`${testUrl}/health`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.textContent = originalText;
        button.disabled = false;
        
        if (response.ok) {
            console.log('âœ… è¿æ¥æˆåŠŸ:', data);
            alert(`âœ… è¿æ¥æˆåŠŸï¼

æœåŠ¡å™¨: ${testUrl}
çŠ¶æ€: ${data.status}
æ—¶é—´: ${data.timestamp || 'æœªçŸ¥'}`);
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('âŒ è¿æ¥å¤±è´¥:', error);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if (event && event.target) {
            event.target.textContent = 'æµ‹è¯•APIæœåŠ¡å™¨è¿æ¥';
            event.target.disabled = false;
        }
        
        let errorMessage = 'âŒ è¿æ¥å¤±è´¥ï¼\n\n';
        
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            errorMessage += 'é”™è¯¯: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨\n\nå¯èƒ½åŸå› ï¼š\n';
            errorMessage += '1. æœåŠ¡å™¨æœªå¯åŠ¨\n';
            errorMessage += '2. åœ°å€é”™è¯¯\n';
            errorMessage += '3. ç½‘ç»œé—®é¢˜\n';
            errorMessage += '4. é˜²ç«å¢™é˜»æ­¢';
        } else {
            errorMessage += `é”™è¯¯: ${error.message}`;
        }
        
        alert(errorMessage);
    }
};

// ================= é…ç½®è¡¨å• & è®¾å¤‡ä¿¡æ¯ =================
function loadConfigIntoForm() {
    try {
        const cfg = appState.getConfig();
        const get = (id) => document.getElementById(id);
        // APIæœåŠ¡å™¨
        if (get('cfg-api-server-url')) get('cfg-api-server-url').value = cfg.apiServerUrl || appState.apiServerUrl || '';
        // è®¾å¤‡
        if (get('cfg-device-mac')) get('cfg-device-mac').value = appState.macAddress || cfg.device?.mac || '';
        if (get('cfg-camera-device') && cfg.camera?.deviceId) get('cfg-camera-device').value = cfg.camera.deviceId;
    } catch (e) { console.error('åŠ è½½é…ç½®åˆ°è¡¨å•å¤±è´¥:', e); }
}

async function initializeDeviceInfo() {
    try {
        await appState.getMacAddress();
        const macInput = document.getElementById('cfg-device-mac');
        if (macInput) macInput.value = appState.macAddress || '';
        await refreshCameraList();
    } catch (e) { console.error('åˆå§‹åŒ–è®¾å¤‡ä¿¡æ¯å¤±è´¥:', e); }
}

async function refreshMacAddress() {
    try {
        await appState.getMacAddress();
        const macInput = document.getElementById('cfg-device-mac');
        if (macInput) macInput.value = appState.macAddress || '';
    } catch (e) { console.error('åˆ·æ–°MACå¤±è´¥:', e); }
}

async function refreshCameraList() {
    try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
            throw new Error('å½“å‰ç¯å¢ƒä¸æ”¯æŒæšä¸¾åª’ä½“è®¾å¤‡');
        }
        const select = document.getElementById('cfg-camera-device');
        if (!select) return;
        select.innerHTML = '<option value="">æ­£åœ¨åŠ è½½æ‘„åƒå¤´è®¾å¤‡...</option>';
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoInputs = devices.filter(d => d.kind === 'videoinput');
        select.innerHTML = '';
        const cfg = appState.getConfig();
        const savedId = cfg.camera?.deviceId;
        console.log('ğŸ“¸ é…ç½®ä¸­ä¿å­˜çš„æ‘„åƒå¤´è®¾å¤‡ID:', savedId || 'æœªé…ç½®');
        
        videoInputs.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.textContent = d.label || ('æ‘„åƒå¤´ ' + (select.options.length + 1));
            if (savedId && d.deviceId === savedId) {
                opt.selected = true;
                console.log('ğŸ“¸ é€‰ä¸­é…ç½®çš„æ‘„åƒå¤´:', d.label || d.deviceId);
            }
            select.appendChild(opt);
        });
        
        // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„æ‘„åƒå¤´ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„
        if (!select.value && videoInputs[0]) {
            select.value = videoInputs[0].deviceId;
            console.log('ğŸ“¸ è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ‘„åƒå¤´:', videoInputs[0].label || videoInputs[0].deviceId);
        }
    } catch (e) { console.error('åˆ·æ–°æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥:', e); }
}

async function switchCamera() {
    try {
        const select = document.getElementById('cfg-camera-device');
        if (!select || !select.value) return;
        // åœæ­¢æ—§æµ
        if (cameraStream) {
            cameraStream.getTracks().forEach(t => t.stop());
            cameraStream = null;
        }
        // ç”³è¯·æ–°æµï¼Œä½¿ç”¨æ›´å®½æ¾çš„çº¦æŸ
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    deviceId: { ideal: select.value }
                }
            });
            // ä¸æ·»åŠ åˆ†è¾¨ç‡çº¦æŸï¼Œä»…æ‰“å°èƒ½åŠ›ä¸å½“å‰è®¾ç½®
            try {
                const track = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0];
                const getSafe = (fn) => { try { return fn(); } catch { return undefined; } };
                console.log('ğŸ›ï¸ åˆ‡æ¢å capabilities:', getSafe(() => track && track.getCapabilities && track.getCapabilities()));
                console.log('ğŸ“ åˆ‡æ¢å settings:', getSafe(() => track && track.getSettings && track.getSettings()));
            } catch {}
        } catch (constraintError) {
            console.warn('âš ï¸ ä½¿ç”¨æŒ‡å®šè®¾å¤‡å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤è®¾å¤‡:', constraintError);
            // å¦‚æœæŒ‡å®šè®¾å¤‡å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤è®¾å¤‡
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
        }
        cameraVideo = document.getElementById('camera-video') || cameraVideo;
        if (cameraVideo) {
            cameraVideo.srcObject = cameraStream;
            applyCameraPreviewRotation();
        }
        cameraInitialized = true;
        // ç«‹å³ä¿å­˜é…ç½®ï¼ˆé€‰ä¸­æ‘„åƒå¤´ï¼‰
        const cfg = appState.getConfig();
        const newCfg = {
            ...cfg,
            camera: { ...(cfg.camera || {}), deviceId: select.value }
        };
        appState.setConfig(newCfg);
        console.log('âœ… å·²åˆ‡æ¢å¹¶ä¿å­˜æ‘„åƒå¤´è®¾å¤‡:', select.value);
    } catch (e) { console.error('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', e); }
}

function collectConfigFromForm() {
    const get = (id) => document.getElementById(id);
    const cfg = appState.getConfig();
    return {
        ...cfg,
        apiServerUrl: get('cfg-api-server-url')?.value || cfg.apiServerUrl || '',
        device: {
            ...(cfg.device || {}),
            mac: get('cfg-device-mac')?.value || appState.macAddress || ''
        },
        camera: {
            ...(cfg.camera || {}),
            deviceId: get('cfg-camera-device')?.value || cfg.camera?.deviceId || ''
        }
    };
}

window.saveConfig = async function() {
    try {
        const newCfg = collectConfigFromForm();
        appState.setConfig(newCfg);
        console.log('âœ… é…ç½®å·²ä¿å­˜åˆ°æœ¬æœº');
        // ä¿å­˜åå›åˆ°é¦–é¡µ
        closeConfig();
        if (window.apiClient) {
            // è‹¥APIæœåŠ¡å™¨åœ°å€å˜æ›´ï¼Œæ›´æ–°å®¢æˆ·ç«¯
            if (newCfg.apiServerUrl && window.apiClient.baseUrl !== newCfg.apiServerUrl) {
                window.apiClient.baseUrl = newCfg.apiServerUrl;
            }
        }
        // å¦‚æœé€‰æ‹©äº†æ‘„åƒå¤´ï¼Œé‡æ–°åˆå§‹åŒ–æ‘„åƒå¤´ä»¥ä½¿ç”¨æ–°é…ç½®
        if (newCfg.camera?.deviceId) {
            console.log('ğŸ”„ æ‘„åƒå¤´é…ç½®å·²æ›´æ”¹ï¼Œé‡æ–°åˆå§‹åŒ–æ‘„åƒå¤´...');
            // ååˆå§‹åŒ–å½“å‰æ‘„åƒå¤´
            deinitializeCamera();
            // é‡æ–°åˆå§‹åŒ–æ‘„åƒå¤´ä»¥ä½¿ç”¨æ–°é…ç½®
            await initializeCamera();
            console.log('âœ… æ‘„åƒå¤´å·²ä½¿ç”¨æ–°é…ç½®é‡æ–°åˆå§‹åŒ–');
        }
    } catch (e) {
        console.error('ä¿å­˜é…ç½®å¤±è´¥:', e);
        appState.showError('ä¿å­˜é…ç½®å¤±è´¥: ' + e.message);
    }
};

// ä¿å­˜ç…§ç‰‡åˆ°uploadsæ–‡ä»¶å¤¹ï¼ˆæµ‹è¯•åŠŸèƒ½ï¼‰
async function savePhotoToUploads(photoDataUrl, fileName) {
    try {
        // å°†base64æ•°æ®è½¬æ¢ä¸ºBuffer
        const base64Data = photoDataUrl.replace(/^data:image\/jpeg;base64,/, '');
        const buffer = Buffer.from(base64Data, 'base64');
        
        // é€šè¿‡IPCè°ƒç”¨ä¸»è¿›ç¨‹ä¿å­˜æ–‡ä»¶
        const { ipcRenderer } = require('electron');
        const result = await ipcRenderer.invoke('save-photo-to-uploads', buffer, fileName);
        
        if (result.success) {
            console.log('âœ… ç…§ç‰‡ä¿å­˜æˆåŠŸ:', result.filePath);
            return result;
        } else {
            throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
        }
    } catch (error) {
        console.error('âŒ ä¿å­˜ç…§ç‰‡åˆ°uploadsæ–‡ä»¶å¤¹å¤±è´¥:', error);
        throw error;
    }
}

// å°†AppStateç±»å’Œå®ä¾‹æŒ‚è½½åˆ°windowå¯¹è±¡ä¸Šï¼Œä¾›å…¶ä»–è„šæœ¬è®¿é—®
window.AppState = AppState;
window.appState = appState;

// æ·»åŠ æ‹ç…§ç›¸å…³çš„å…¨å±€å‡½æ•°
// æ³¨æ„ï¼šç›´æ¥å°†å‡½æ•°å¼•ç”¨èµ‹å€¼ç»™ windowï¼Œè€Œä¸æ˜¯åŒ…è£…æˆæ–°å‡½æ•°
window.capturePhotoWithCountdown = capturePhotoWithCountdown;

window.retakePhoto = function() {
    if (appState && typeof appState.retakePhoto === 'function') {
        appState.retakePhoto();
    } else {
        console.error('retakePhotoæ–¹æ³•æœªå®šä¹‰');
    }
};

window.confirmPhoto = function() {
    if (appState && typeof appState.confirmPhoto === 'function') {
        appState.confirmPhoto();
    } else {
        console.error('confirmPhotoæ–¹æ³•æœªå®šä¹‰');
    }
};

// æ·»åŠ æ—¶å°šåå¥½é€‰æ‹©é¡µé¢çš„å…¨å±€å‡½æ•°
window.selectCustomStyle = function() {
    if (appState && typeof appState.selectCustomStyle === 'function') {
        appState.selectCustomStyle();
    } else {
        console.error('selectCustomStyleæ–¹æ³•æœªå®šä¹‰');
    }
};

window.selectRecommendedStyle = function() {
    if (appState && typeof appState.selectRecommendedStyle === 'function') {
        appState.selectRecommendedStyle();
    } else {
        console.error('selectRecommendedStyleæ–¹æ³•æœªå®šä¹‰');
    }
};

window.endSession = function() {
    if (appState && typeof appState.endSession === 'function') {
        appState.endSession();
    } else {
        console.error('endSessionæ–¹æ³•æœªå®šä¹‰');
    }
};

window.goBackToPhotoConfirm = function() {
    if (appState && typeof appState.goBackToPhotoConfirm === 'function') {
        appState.goBackToPhotoConfirm();
    } else {
        console.error('goBackToPhotoConfirmæ–¹æ³•æœªå®šä¹‰');
    }
};

// æ·»åŠ æœè£…é€‰æ‹©å¼¹çª—çš„å…¨å±€å‡½æ•°
window.openClothingModal = function(category) {
    if (appState && typeof appState.openClothingModal === 'function') {
        appState.openClothingModal(category);
    } else {
        console.error('openClothingModalæ–¹æ³•æœªå®šä¹‰');
    }
};

window.closeClothingModal = function() {
    if (appState && typeof appState.closeClothingModal === 'function') {
        appState.closeClothingModal();
    } else {
        console.error('closeClothingModalæ–¹æ³•æœªå®šä¹‰');
    }
};

window.selectClothingInModal = function(item, category, element) {
    if (appState && typeof appState.selectClothingInModal === 'function') {
        appState.selectClothingInModal(item, category, element);
    } else {
        console.error('selectClothingInModalæ–¹æ³•æœªå®šä¹‰');
    }
};

// æ·»åŠ ç»“æœå›¾ç‰‡ä¿æŒé¡µé¢çš„å…¨å±€å‡½æ•°
window.retakeFitting = function() {
    if (appState && typeof appState.retakeFitting === 'function') {
        appState.retakeFitting();
    } else {
        console.error('retakeFittingæ–¹æ³•æœªå®šä¹‰');
    }
};

// æ·»åŠ æ‰«ç ä¸‹è½½å›¾ç‰‡é¡µé¢çš„å…¨å±€å‡½æ•°
window.continueFitting = function() {
    if (appState && typeof appState.continueFitting === 'function') {
        appState.continueFitting();
    } else {
        console.error('continueFittingæ–¹æ³•æœªå®šä¹‰');
    }
};

window.goBackToPreference = function() {
    if (appState && typeof appState.goBackToPreference === 'function') {
        appState.goBackToPreference();
    } else {
        console.error('goBackToPreferenceæ–¹æ³•æœªå®šä¹‰');
    }
};

window.goBackToClothing = function() {
    if (appState && typeof appState.goBackToClothing === 'function') {
        appState.goBackToClothing();
    } else {
        console.error('goBackToClothingæ–¹æ³•æœªå®šä¹‰');
    }
};

window.saveImage = function() {
    if (appState && typeof appState.saveImage === 'function') {
        appState.saveImage();
    } else {
        console.error('saveImageæ–¹æ³•æœªå®šä¹‰');
    }
};

console.log('è¡£ç­‰èˆ±åº”ç”¨å·²åˆå§‹åŒ–');