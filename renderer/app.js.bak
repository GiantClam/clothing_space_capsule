// 应用状态管理
class AppState {
    constructor() {
        this.currentPage = 'welcome-page';
        this.welcomePageInitialized = false; // 欢迎页初始化标志
        this.userProfile = {
            openid: null,
            photo: null,
            photoFileName: null,
            fullBodyShotNameInRH: null, // RunningHub中的全身照文件名（去除api/前缀）
            gender: 'female'
        };
        this.selectedClothing = null; // 当前生效的选择（与 lastSelectionType 同步）
        this.selectedTopBottom = null; // { tops: item, bottoms: item }
        this.selectedDress = null; // { item }
        this.lastSelectionType = null; // 'topBottom' | 'dress'
        this.selectedStyle = null;
        this.currentTask = null;
        this.currentTaskId = null; // API Server中的任务ID
        this.apiBaseUrl = 'https://clothing-api.0086studios.xyz'; // 生产环境云端API服务器
        this.apiServerUrl = 'https://clothing-api.0086studios.xyz'; // 生产环境云端API服务器
        this.currentGender = 'female';
        this.currentCategory = 'tops-bottoms';
        this.currentSubCategory = 'tops';
        this.isDressSelected = false;
        this.configCache = null;
        this.resultImageUrl = null; // 添加结果图片URL存储
        this.resizeTimer = null; // 添加窗口大小调整防抖定时器
        this.macAddress = null; // 设备MAC地址
        // 任务状态轮询定时器
        this.taskPollTimer = null;
        
        // 开发模式标志
        this.isDevelopment = this.checkDevelopmentMode();
        // 开发模式跳过登录标志
        this.devModeSkippedLogin = false;
        
        // 添加默认服装数据
        this.defaultClothing = {
            tops: [
                { id: 'top1', name: '白色衬衫', image: 'public/coats/1.jpg' },
                { id: 'top2', name: '粉色T恤', image: 'public/coats/2.jpg' },
                { id: 'top3', name: '蓝色针织衫', image: 'public/coats/3.jpg' }
            ],
            bottoms: [
                { id: 'bottom1', name: '牛仔裤', image: 'public/pants/9.jpg' },
                { id: 'bottom2', name: '时尚长裤', image: 'public/pants/10.jpg' },
                { id: 'bottom3', name: '休闲裤', image: 'public/pants/11.jpg' }
            ]
        };
    }

    // 检查是否为开发模式
    checkDevelopmentMode() {
        try {
            // 0. 优先检查主进程注入的环境变量（最可靠）
            if (typeof window !== 'undefined' && window.__APP_ENV__) {
                if (window.__APP_ENV__.IS_PRODUCTION) {
                    console.log('📦 生产环境模式（注入环境变量）');
                    return false;
                }
                if (window.__APP_ENV__.IS_DEVELOPMENT) {
                    console.log('🔧 开发模式（注入环境变量）');
                    return true;
                }
            }
            
            // 1. 尝试直接访问 process.env
            let nodeEnv = null;
            try {
                if (typeof process !== 'undefined' && process.env) {
                    nodeEnv = process.env.NODE_ENV;
                    if (nodeEnv === 'production') {
                        console.log('📦 生产环境模式（process.env）');
                        return false;
                    }
                }
            } catch (e) {
                console.log('ℹ️ 无法直接访问 process.env');
            }
            
            // 2. 检查 localStorage 中的开发模式设置
            const devMode = localStorage.getItem('DEV_MODE');
            if (devMode === 'true') {
                console.log('🔧 开发模式已启用（通过 localStorage）');
                return true;
            }
            
            // 3. 检查 URL 参数
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('dev') === 'true') {
                console.log('🔧 开发模式已启用（通过 URL 参数）');
                return true;
            }
            
            // 4. 检查是否为真正的本地开发环境（仅 localhost/127.0.0.1，不包括 file://）
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            if (isLocalhost) {
                console.log('🔧 开发模式已启用（本地环境）');
                return true;
            }
            
            // 5. 其他情况（包括 file:// 协议的生产打包）默认为非开发模式
            console.log('🌐 生产环境模式');
            return false;
        } catch (error) {
            console.error('检查开发模式失败:', error);
            return false;
        }
    }

    // 拍照功能
    async capturePhoto() {
        try {
            // 获取当前视频流并拍照
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');
            
            // 设置canvas尺寸与视频相同
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // 绘制当前视频帧到canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // 将canvas转换为图片数据URL
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            
            // 显示拍照确认页面
            const capturedPhoto = document.getElementById('captured-photo');
            if (capturedPhoto) {
                capturedPhoto.src = imageDataUrl;
            }
            
            // 保存照片数据到状态
            this.capturedPhotoData = imageDataUrl;
            
            // 切换到拍照确认页面
            await this.setPage('photo-confirm-page');
        } catch (error) {
            console.error('拍照失败:', error);
            this.showError('拍照失败，请重试');
        }
    }
    
    // 重新拍摄
    async retakePhoto() {
        // 重置按钮状态
        if (typeof resetCaptureButton === 'function') {
            resetCaptureButton();
        }
        
        // 返回拍照页面
        await this.setPage('profile-page');
    }
    
    // 确认照片
    async confirmPhoto() {
        try {
            // 上传人物照片到服务器
            if (this.capturedPhotoData) {
                this.showLoading('正在上传照片...');
                
                // 将base64转换为Blob
                const response = await fetch(this.capturedPhotoData);
                const blob = await response.blob();
                
                console.log('上传照片信息: 尺寸 720x1024, 文件大小: ' + blob.size + ' bytes');
                
                // 确保API客户端存在
                if (!window.apiClient) {
                    console.log('❌ window.apiClient 不存在，创建新的API客户端实例...');
                    if (typeof window.ApiClient === 'function') {
                        window.apiClient = new window.ApiClient();
                        console.log('✅ 新的API客户端实例创建成功');
                    } else {
                        console.error('❌ 无法创建新的API客户端实例');
                        throw new Error('无法创建API客户端实例');
                    }
                }
                
                // 确保API客户端已初始化
                if (!window.apiClient.initialized) {
                    console.log('🔄 API客户端尚未初始化，执行初始化...');
                    await window.apiClient.initialize();
                    console.log('✅ API客户端初始化完成');
                }
                
                // 检查设备是否已认证
                if (!window.apiClient.token) {
                    console.log('⚠️ 设备未认证，尝试进行设备认证...');
                    let macAddress = this.macAddress;
                    if (!macAddress) {
                        await this.getMacAddress();
                        macAddress = this.macAddress;
                    }
                    
                    if (macAddress) {
                        const deviceId = macAddress.replace(/:/g, '');
                        const authResponse = await window.apiClient.authenticateDevice(deviceId, '衣等舱客户端');
                        if (authResponse.success) {
                            console.log('✅ 设备认证成功');
                        }
                    }
                }
                
                // 上传照片到云端
                const uploadResponse = await window.apiClient.uploadPhoto(blob, this.qrSceneStr);
                console.log('照片上传结果:', uploadResponse);
                
                if (!uploadResponse.success) {
                    throw new Error(uploadResponse.error || '照片上传失败');
                }
                
                // 保存任务ID
                this.currentTaskId = uploadResponse.data.taskId;
                console.log('✅ 照片上传成功，任务ID:', this.currentTaskId);
                
                this.hideLoading();
            }
            
            // 反初始化摄像头，释放资源
            if (typeof deinitializeCamera === 'function') {
                deinitializeCamera();
            }
            
            // 跳转到时尚偏好选择页面
            await this.setPage('preference-page');
        } catch (error) {
            console.error('确认照片失败:', error);
            this.hideLoading();
            this.showError('处理照片失败: ' + error.message);
        }
    }
    
    // 数据URL转换为Blob
    dataURLToBlob(dataURL) {
        const parts = dataURL.split(';base64,');
        const contentType = parts[0].split(':')[1];
        const raw = atob(parts[1]);
        const rawLength = raw.length;
        const uInt8Array = new Uint8Array(rawLength);
        
        for (let i = 0; i < rawLength; ++i) {
            uInt8Array[i] = raw.charCodeAt(i);
        }
        
        return new Blob([uInt8Array], { type: contentType });
    }
    
    // 上传照片到服务器
    async uploadPhotoToServer(photoBlob) {
        try {
            if (!window.apiClient) {
                throw new Error('API客户端未初始化');
            }
            
            // 调用API客户端上传照片
            const response = await window.apiClient.uploadPhoto(photoBlob, this.qrSceneStr);
            
            if (response.success) {
                // 保存照片信息
                this.userProfile.photo = response.photoUrl;
                this.userProfile.photoFileName = response.fileName;
                console.log('照片上传成功:', response);
            } else {
                throw new Error(response.error || '照片上传失败');
            }
        } catch (error) {
            console.error('照片上传失败:', error);
            throw error;
        }
    }
    
    // 选择自定义风格
    async selectCustomStyle() {
        // 跳转到服装选择页面
        await this.setPage('clothing-page');
    }
    
    // 选择推荐风格
    async selectRecommendedStyle() {
        // 弹出提示框
        this.showInfo('敬请期待');
    }
    
    // 打开服装选择弹窗
    async openClothingModal(category) {
        try {
            // 保存当前类别
            this.currentModalCategory = category;
            
            // 设置弹窗标题
            const modalTitle = document.getElementById('modal-title');
            if (modalTitle) {
                modalTitle.textContent = category === 'tops' ? '选择上衣' : '选择下衣';
            }
            
            // 清空现有内容
            const clothingGrid = document.getElementById('clothing-grid-modal');
            if (clothingGrid) {
                clothingGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">正在加载...</div>';
            }
            
            // 显示弹窗
            const modal = document.getElementById('clothing-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
            
            // 加载服装数据
            await this.loadClothingForModal(category);
        } catch (error) {
            console.error('打开服装选择弹窗失败:', error);
            this.showError('加载服装数据失败');
        }
    }
    
    // 关闭服装选择弹窗
    closeClothingModal() {
        const modal = document.getElementById('clothing-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // 为弹窗加载服装数据
    async loadClothingForModal(category) {
        try {
            if (!window.apiClient) {
                throw new Error('API客户端未初始化');
            }
            
            // 获取分类数据
            const categories = await window.apiClient.getClothingCategories();
            const genderCategory = categories.data.find(cat => 
                cat.name === (this.currentGender === 'male' ? '男装' : '女装')
            );
            
            if (!genderCategory) {
                throw new Error('未找到性别分类');
            }
            
            // 查找对应的子分类
            let subCategoryName = '';
            if (category === 'tops') {
                subCategoryName = this.currentGender === 'male' ? '外套' : '外套';
            } else {
                subCategoryName = this.currentGender === 'male' ? '裤子' : '裤子';
            }
            
            const subCategory = genderCategory.children.find(child => 
                child.name === subCategoryName
            );
            
            if (!subCategory) {
                throw new Error(`未找到${subCategoryName}分类`);
            }
            
            // 获取服装列表
            const clothesResponse = await window.apiClient.getClothingByCategory(subCategory.id);
            
            if (!clothesResponse.success || !clothesResponse.data.clothes) {
                throw new Error('获取服装数据失败');
            }
            
            // 渲染服装列表
            const clothingGrid = document.getElementById('clothing-grid-modal');
            if (clothingGrid) {
                if (clothesResponse.data.clothes.length === 0) {
                    clothingGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无数据</div>';
                    return;
                }
                
                // 清空现有内容
                clothingGrid.innerHTML = '';
                
                // 添加服装项
                clothesResponse.data.clothes.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'clothing-item-modal';
                    itemEl.dataset.id = item.id;
                    itemEl.innerHTML = `
                        <img src="${this.getImageUrl(item.imageUrl)}" alt="${item.name}">
                        <div class="label">${item.name}</div>
                    `;
                    
                    // 检查是否已选中
                    if (this.isItemInSelection(item, category)) {
                        itemEl.classList.add('selected');
                    }
                    
                    // 添加点击事件
                    itemEl.onclick = () => this.selectClothingInModal(item, category, itemEl);
                    
                    clothingGrid.appendChild(itemEl);
                });
            }
        } catch (error) {
            console.error('加载服装数据失败:', error);
            const clothingGrid = document.getElementById('clothing-grid-modal');
            if (clothingGrid) {
                clothingGrid.innerHTML = `<div style="text-align: center; padding: 20px; color: #b00;">加载失败：${error.message}</div>`;
            }
        }
    }
    
    // 检查服装项是否在当前选择中
    isItemInSelection(item, category) {
        if (category === 'tops' && this.selectedTopBottom && this.selectedTopBottom.tops) {
            return this.selectedTopBottom.tops.id === item.id;
        }
        
        if (category === 'bottoms' && this.selectedTopBottom && this.selectedTopBottom.bottoms) {
            return this.selectedTopBottom.bottoms.id === item.id;
        }
        
        return false;
    }
    
    // 在弹窗中选择服装
    async selectClothingInModal(item, category, element) {
        try {
            // 更新选择状态
            if (category === 'tops') {
                if (!this.selectedTopBottom) {
                    this.selectedTopBottom = { tops: item, bottoms: null };
                } else {
                    this.selectedTopBottom.tops = item;
                }
            } else if (category === 'bottoms') {
                if (!this.selectedTopBottom) {
                    this.selectedTopBottom = { tops: null, bottoms: item };
                } else {
                    this.selectedTopBottom.bottoms = item;
                }
            }
            
            // 更新预览区域
            this.updateClothingPreview(category, item);
            
            // 关闭弹窗
            this.closeClothingModal();
            
            console.log('选择的服装:', this.selectedTopBottom);
        } catch (error) {
            console.error('选择服装失败:', error);
            this.showError('选择服装失败');
        }
    }
    
    // 更新服装预览区域
    updateClothingPreview(category, item) {
        const previewElement = document.getElementById(
            category === 'tops' ? 'tops-preview' : 'bottoms-preview'
        );
        
        if (previewElement) {
            previewElement.innerHTML = `
                <img src="${this.getImageUrl(item.imageUrl)}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;">
            `;
        }
    }
    
    // 添加结果图片保持页面的函数实现
    async retakeFitting() {
        try {
            // 返回到服装选择页面
            await this.setPage('clothing-page');
        } catch (error) {
            console.error('重新选择试衣失败:', error);
            this.showError('操作失败，请重试');
        }
    }

    async saveImage() {
        try {
            // 跳转到扫码下载图片页面
            await this.setPage('scan-to-get-page');
            
            // 生成二维码
            await this.generateWechatQRCode();
        } catch (error) {
            console.error('保存图片失败:', error);
            this.showError('操作失败，请重试');
        }
    }

    // 添加扫码下载图片页面的函数实现
    async continueFitting() {
        try {
            // 返回到服装选择页面
            await this.setPage('clothing-page');
        } catch (error) {
            console.error('继续试衣失败:', error);
            this.showError('操作失败，请重试');
        }
    }

    async goBackToPreference() {
        try {
            // 返回到时尚偏好选择页面
            await this.setPage('preference-page');
        } catch (error) {
            console.error('返回时尚偏好选择页面失败:', error);
            this.showError('操作失败，请重试');
        }
    }

    async goBackToClothing() {
        try {
            // 返回到服装选择页面
            await this.setPage('clothing-page');
        } catch (error) {
            console.error('返回服装选择页面失败:', error);
            this.showError('操作失败，请重试');
        }
    }

    // 结束会话
    async endSession() {
        try {
            // 重置选择状态
            this.selectedTopBottom = null;
            this.selectedDress = null;
            this.selectedClothing = null;
            this.currentTask = null;
            this.currentTaskId = null;
            this.resultImageUrl = null;
            
            // 更新预览区域
            this.resetClothingPreviews();
            
            // 返回首页
            await this.setPage('welcome-page');
        } catch (error) {
            console.error('结束会话失败:', error);
            this.showError('结束会话失败');
        }
    }
    
    // 重置服装预览区域
    resetClothingPreviews() {
        const topsPreview = document.getElementById('tops-preview');
        const bottomsPreview = document.getElementById('bottoms-preview');
        
        if (topsPreview) {
            topsPreview.innerHTML = '<div class="preview-placeholder">点击选择上衣</div>';
        }
        
        if (bottomsPreview) {
            bottomsPreview.innerHTML = '<div class="preview-placeholder">点击选择下衣</div>';
        }
    }
    
    // 返回到拍照确认页面
    async goBackToPhotoConfirm() {
        await this.setPage('photo-confirm-page');
    }

    // 返回到首页
    async goBackToHome() {
        await this.setPage('welcome-page');
    }
    
    // 显示信息提示
    showInfo(message) {
        // 创建提示元素
        const notification = document.createElement('div');
        notification.className = 'info-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3秒后自动消失
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    // 显示错误提示
    showError(message) {
        // 创建错误提示元素
        const notification = document.createElement('div');
        notification.className = 'error-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 5秒后自动消失
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }

    // 检查是否为开发模式
    checkDevelopmentMode() {
        try {
            // 0. 优先检查主进程注入的环境变量（最可靠）
            if (typeof window !== 'undefined' && window.__APP_ENV__) {
                if (window.__APP_ENV__.IS_PRODUCTION) {
                    console.log('📦 生产环境模式（注入环境变量）');
                    return false;
                }
                if (window.__APP_ENV__.IS_DEVELOPMENT) {
                    console.log('🔧 开发模式（注入环境变量）');
                    return true;
                }
            }
            
            // 1. 尝试直接访问 process.env
            let nodeEnv = null;
            try {
                if (typeof process !== 'undefined' && process.env) {
                    nodeEnv = process.env.NODE_ENV;
                    if (nodeEnv === 'production') {
                        console.log('📦 生产环境模式（process.env）');
                        return false;
                    }
                }
            } catch (e) {
                console.log('ℹ️ 无法直接访问 process.env');
            }
            
            // 2. 检查 localStorage 中的开发模式设置
            const devMode = localStorage.getItem('DEV_MODE');
            if (devMode === 'true') {
                console.log('🔧 开发模式已启用（通过 localStorage）');
                return true;
            }
            
            // 3. 检查 URL 参数
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('dev') === 'true') {
                console.log('🔧 开发模式已启用（通过 URL 参数）');
                return true;
            }
            
            // 4. 检查是否为真正的本地开发环境（仅 localhost/127.0.0.1，不包括 file://）
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            if (isLocalhost) {
                console.log('🔧 开发模式已启用（本地环境）');
                return true;
            }
            
            // 5. 其他情况（包括 file:// 协议的生产打包）默认为非开发模式
            console.log('🌐 生产环境模式');
            return false;
        } catch (error) {
            console.error('检查开发模式失败:', error);
            return false;
        }
    }

    // 获取配置
    getConfig() {
        // 尝试从localStorage获取配置
        try {
            const config = localStorage.getItem('appConfig');
            return config ? JSON.parse(config) : {};
        } catch (error) {
            console.warn('获取配置失败，使用默认配置:', error);
            return {};
        }
    }

    // 设置配置
    setConfig(config) {
        try {
            localStorage.setItem('appConfig', JSON.stringify(config));
            this.configCache = config;
        } catch (error) {
            console.error('保存配置失败:', error);
        }
    }

    // 处理窗口大小变化
    handleWindowResize() {
        // 防抖处理，避免频繁调整
        if (this.resizeTimer) {
            clearTimeout(this.resizeTimer);
        }
        
        this.resizeTimer = setTimeout(() => {
            if (this.currentPage === 'results-page' && this.resultImageUrl) {
                this.adjustImageContainer();
            }
        }, 300);
    }

    async setPage(pageId) {
        console.log(`📄 切换页面: ${this.currentPage} -> ${pageId}`);
        
        // 先移除所有页面的 active，避免多个页面同时显示
        try {
            const activePages = document.querySelectorAll('.page.active');
            console.log(`🔍 找到 ${activePages.length} 个活动页面:`, Array.from(activePages).map(el => el.id));
            activePages.forEach((el) => el.classList.remove('active'));
        } catch (e) {
            console.error('❌ 移除active类失败:', e);
        }

        // 兜底再次移除当前记录页面的 active
        const currentPageEl = document.getElementById(this.currentPage);
        if (currentPageEl) {
            currentPageEl.classList.remove('active');
            console.log(`✅ 移除了当前页面的active类: ${this.currentPage}`);
        }

        // 如果离开拍照页面，则解绑并关闭摄像头流，避免长期占用
        try {
            if (this.currentPage === 'profile-page' && pageId !== 'profile-page') {
                const v = document.getElementById('camera-video');
                if (v) {
                    try { v.pause && v.pause(); } catch {}
                    try { v.srcObject = null; } catch {}
                }
                await deinitializeCamera();
            }
        } catch (e) {
            console.warn('⚠️ 离开拍照页面时关闭摄像头失败:', e && e.message);
        }

        // 如果离开结果页面，清理事件监听器
        if (this.currentPage === 'results-page') {
            window.removeEventListener('resize', this.handleWindowResize.bind(this));
            if (this.resizeTimer) {
                clearTimeout(this.resizeTimer);
                this.resizeTimer = null;
            }
        }

        // 显示新页面
        const newPageEl = document.getElementById(pageId);
        if (newPageEl) {
            newPageEl.classList.add('active');
            this.currentPage = pageId;
            console.log(`✅ 页面切换成功，新页面: ${pageId}`);
            console.log(`🔍 新页面的display样式:`, window.getComputedStyle(newPageEl).display);
        } else {
            console.error(`❌ 找不到页面元素: ${pageId}`);
        }
        
        // 更新分页器状态
        this.updatePaginator(pageId);

        // 页面切换时的特殊处理
        await this.onPageChange(pageId);
        
        console.log(`📄 页面切换流程完成: ${pageId}`);
    }
    
    // 更新分页器状态
    updatePaginator(pageId) {
        // 定义页面到分页器索引的映射
        const pageIndexMap = {
            'welcome-page': 0,
            'profile-page': 1,  // 拍照页面不显示分页器，但保留索引
            'clothing-page': 2,
            'results-page': 3,
            'scan-to-get-page': 3  // 扫码获取图片页面使用第4个点
        };
        
        // 获取当前页面的分页器索引
        const currentIndex = pageIndexMap[pageId];
        if (currentIndex === undefined) return;
        
        // 更新所有页面的分页器
        const pagesWithPaginator = ['welcome-page', 'clothing-page', 'results-page', 'scan-to-get-page'];
        
        pagesWithPaginator.forEach(pageId => {
            const pageEl = document.getElementById(pageId);
            if (pageEl) {
                const paginator = pageEl.querySelector('.paginator');
                if (paginator) {
                    const dots = paginator.querySelectorAll('.page-dot');
                    dots.forEach((dot, index) => {
                        if (index === currentIndex) {
                            dot.classList.add('active');
                        } else {
                            dot.classList.remove('active');
                        }
                    });
                }
            }
        });
    }

    async onPageChange(pageId) {
        // 离开首页则暂停二维码5分钟定时刷新
        if (pageId !== 'welcome-page') {
            this.stopWechatQRRefreshTimer();
        }
        switch(pageId) {
            case 'profile-page':
                // 拍照页：初始化摄像头并绑定预览
                // 使用 try-catch 包裹，避免摄像头错误阻断流程
                try {
                    console.log('📸 准备初始化摄像头...');
                    
                    // 先释放现有的摄像头流，避免占用冲突
                    if (typeof deinitializeCamera === 'function') {
                        console.log('🧽 清理现有摄像头流...');
                        deinitializeCamera();
                    }
                    
                    // 如果是开发模式跳过登录，稍微延迟一下，让设备完全就绪
                    if (this.devModeSkippedLogin) {
                        console.log('⏱️ 开发模式：等待500ms让摄像头设备就绪...');
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    await initializeCamera();
                    await enableCameraUI();
                    // 成功日志由 initializeCamera() 内部输出，避免重复
                } catch (cameraError) {
                    console.error('❌ 摄像头初始化失败:', cameraError.name, cameraError.message);
                    // 显示友好的错误提示
                    this.showCameraErrorNotification(cameraError);
                    // 摄像头失败不阻断流程，继续执行
                }
                // 开始新会话 - 已弃用
                // await this.startNewSession();
                break;
            case 'welcome-page':
                // 只在首次初始化时调用，避免重复初始化
                if (!this.welcomePageInitialized) {
                    console.log('🔄 首次切换到欢迎页，开始初始化...');
                    await this.initializeWelcomePage();
                    this.welcomePageInitialized = true;
                } else {
                    console.log('ℹ️ 欢迎页已初始化，跳过重复初始化');
                }
                break;
            case 'config-page':
                // 兼容旧调用：改为以对话框形式打开配置
                openConfig();
                break;
            case 'clothing-page':
                await this.initializeClothingPage();
                break;
            case 'results-page':
        // 结果页仅负责展示结果与交互，不在进入时自动倒计时
        // 倒计时在图片成功展示后由 showResult 的 onload 回调触发
                window.addEventListener('resize', this.handleWindowResize.bind(this));
                break;
            case 'photo-confirm-page':
                // 拍照确认页：确保照片已设置
                console.log('📸 切换到拍照确认页');
                const capturedPhoto = document.getElementById('captured-photo');
                if (capturedPhoto && this.capturedPhotoData) {
                    capturedPhoto.src = this.capturedPhotoData;
                    console.log('✅ 已设置照片数据');
                } else {
                    console.warn('⚠️ 照片数据未找到');
                }
                break;
            case 'download-page':
                // 不再生成下载二维码，只需要推送结果到微信公众号
                // this.generateDownloadQR();
                this.startCountdown();
                // 结束会话 - 已弃用
                // await this.endCurrentSession();
                break;
        }
    }

    // 生成微信二维码 - 修改为使用新的接口规范
    async generateWechatQRCode() {
        try {
            // 只有在欢迎页面展示二维码时才生成二维码
            if (this.currentPage !== 'welcome-page') {
                console.log('ℹ️ 当前不在欢迎页面，跳过二维码生成');
                return;
            }
            
            console.log('🔍 检查API客户端状态:', {
                hasApiClient: !!window.apiClient,
                initialized: window.apiClient ? window.apiClient.initialized : false
            });
            
            // 确保API客户端已初始化
            if (!window.apiClient) {
                console.log('⚠️ API客户端未初始化，尝试创建实例...');
                if (typeof window.ApiClient === 'function') {
                    window.apiClient = new window.ApiClient();
                } else {
                    console.warn('❌ 无法创建 API 客户端实例（缺少构造函数），跳过二维码生成');
                    return;
                }
            }
            
            if (!window.apiClient.initialized) {
                console.log('🔄 API客户端尚未初始化，执行初始化...');
                if (typeof window.apiClient.initialize === 'function') {
                await window.apiClient.initialize();
                console.log('✅ API客户端初始化完成');
                } else {
                    console.warn('❌ API客户端缺少 initialize 方法，跳过二维码生成');
                    return;
                }
            }
            
            // 处理MAC地址：去掉冒号作为设备唯一标识
            const deviceId = this.macAddress ? this.macAddress.replace(/:/g, '') : this.macAddress;
            console.log('📱 生成微信关注二维码，使用处理后的MAC地址:', deviceId);
            
            // 调用API生成二维码
            const response = await window.apiClient.generateWechatQRCode(deviceId);
            
            if (response.success) {
                this.wechatQRCode = response.qrCode;
                // 保存场景值
                this.qrSceneStr = response.qrCode.sceneStr;
                
                // 更新页面上的二维码显示
                const qrImg = document.getElementById('wechat-qr-image');
                if (qrImg) {
                    qrImg.src = response.qrCode.dataURL;
                    console.log('✅ 微信二维码生成成功');
                }
            } else {
                throw new Error(response.error || '生成二维码失败');
            }
        } catch (error) {
            console.error('❌ 生成微信二维码失败:', error);
            
            // 如果是离线模式或网络错误，显示占位符二维码
            if (window.apiClient && window.apiClient.isOfflineMode()) {
                console.log('🌐 离线模式：显示占位符二维码');
                this.showOfflineQRCode();
            } else if (error.message.includes('Failed to fetch') || 
                       error.message.includes('ERR_NETWORK_CHANGED') ||
                       error.message.includes('ERR_INTERNET_DISCONNECTED')) {
                console.log('🌐 网络错误：显示占位符二维码');
                this.showOfflineQRCode();
            }
            
            // 二维码生成失败时不再弹出错误提示框，只在控制台记录错误
            // this.showError('生成微信二维码失败: ' + error.message);
        }
    }

    // 手动刷新微信二维码
    async refreshWechatQRCode() {
        console.log('🔄 手动刷新微信二维码...');
        
        // 只有在欢迎页面才允许手动刷新二维码
        if (this.currentPage !== 'welcome-page') {
            console.log('ℹ️ 当前不在欢迎页面，不允许手动刷新二维码');
            return;
        }
        
        // 防止频繁刷新（防抖机制）
        const now = Date.now();
        if (this.lastQRRefreshTime && (now - this.lastQRRefreshTime) < 5000) {
            console.log('⚠️ 刷新过于频繁，忽略本次请求');
            return;
        }
        this.lastQRRefreshTime = now;
        
        // 禁用刷新按钮防止重复点击
        const refreshBtn = document.getElementById('refresh-qr-btn');
        if (refreshBtn) {
            refreshBtn.disabled = true;
            refreshBtn.textContent = '刷新中...';
        }
        
        try {
            await this.generateWechatQRCode();
            console.log('✅ 微信二维码手动刷新完成');
        } catch (error) {
            console.error('❌ 微信二维码手动刷新失败:', error);
            // 手动刷新失败时不再弹出错误提示框，只在控制台记录错误
            // this.showError('二维码刷新失败: ' + error.message);
        } finally {
            // 恢复刷新按钮状态
            if (refreshBtn) {
                // 延迟恢复按钮状态，防止用户连续点击
                setTimeout(() => {
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.textContent = '🔄 刷新二维码';
                    }
                }, 2000);
            }
        }
    }

    // 启动5分钟定时刷新机制
    startWechatQRRefreshTimer() {
        console.log('🔄 启动微信二维码5分钟定时刷新机制...');
        
        // 清除之前的定时器
        if (this.wechatRefreshInterval) {
            console.log('🔄 清除旧的微信二维码刷新定时器');
            clearInterval(this.wechatRefreshInterval);
        }
        
        // 每5分钟刷新一次二维码 (5分钟 = 300000毫秒)
        this.wechatRefreshInterval = setInterval(async () => {
            try {
                console.log('⏰ 5分钟定时刷新微信二维码...');
                // 防止频繁刷新（防抖机制）
                const now = Date.now();
                if (this.lastQRRefreshTime && (now - this.lastQRRefreshTime) < 5000) {
                    console.log('⚠️ 定时刷新过于频繁，忽略本次请求');
                    return;
                }
                this.lastQRRefreshTime = now;
                
                // 检查是否在欢迎页面，只有在欢迎页面才刷新二维码
                if (this.currentPage !== 'welcome-page') {
                    console.log('ℹ️ 当前不在欢迎页面，跳过二维码刷新');
                    return;
                }
                
                // 检查用户是否已关注公众号，如果已关注则停止刷新
                if (this.qrSceneStr && window.apiClient) {
                    try {
                        const response = await window.apiClient.checkWechatStatus(this.qrSceneStr);
                        const isSubscribed = response.isSubscribed || response.isVerified;
                        
                        if (response.success && isSubscribed) {
                            console.log('✅ 用户已关注公众号，停止二维码定时刷新');
                            this.stopWechatQRRefreshTimer();
                            return;
                        }
                    } catch (error) {
                        console.error('检查用户关注状态失败:', error);
                    }
                }
                
                await this.generateWechatQRCode();
                console.log('✅ 微信二维码5分钟定时刷新完成');
            } catch (error) {
                console.error('❌ 微信二维码5分钟定时刷新失败:', error);
                // 定时刷新失败时不再弹出错误提示框，只在控制台记录错误
            }
        }, 300000); // 5分钟 = 300000毫秒
        
        console.log('✅ 微信二维码5分钟定时刷新机制已启动');
    }

    // 停止5分钟定时刷新机制
    stopWechatQRRefreshTimer() {
        if (this.wechatRefreshInterval) {
            clearInterval(this.wechatRefreshInterval);
            this.wechatRefreshInterval = null;
            console.log('🛑 微信二维码5分钟定时刷新机制已停止');
        }
    }
    // 初始化欢迎页面
    async initializeWelcomePage() {
        console.log('📱 初始化欢迎页面...');
        
        // 如果是开发模式跳过登录，不初始化微信相关功能
        if (this.devModeSkippedLogin) {
            console.log('ℹ️ 开发模式已跳过登录，跳过欢迎页面初始化');
            return;
        }
        
        // 初始化连续点击检测
        this.initializeClickDetection();
        
        // 初始化开发模式快捷键和按钮
        this.initializeDevelopmentMode();
        
        // 获取设备MAC地址
        console.log('🔍 开始获取设备MAC地址...');
        await this.getMacAddress();
        console.log('✅ MAC地址获取完成:', this.macAddress);
        
        // 确保设备已认证（失败不阻断后续二维码生成）
        try {
            await this.ensureDeviceAuthenticated();
        } catch (e) {
            console.warn('设备认证失败，继续尝试生成二维码:', e && e.message ? e.message : e);
            
            // 如果是离线模式，显示离线提示
            if (window.apiClient && window.apiClient.isOfflineMode()) {
                this.showOfflineNotification();
            }
        }
        
        // 检查设备状态（仅在非离线模式下）
        if (!window.apiClient.isOfflineMode()) {
            console.log('🔍 开始检查设备状态...');
            try {
                const deviceStatusResponse = await window.apiClient.getDeviceStatus();
            console.log('🔍 设备状态检查响应完整数据:', JSON.stringify(deviceStatusResponse, null, 2));
            
            // 检查响应结构并正确提取设备状态
            if (deviceStatusResponse.success && deviceStatusResponse.device) {
                // 兼容不同的响应结构
                let deviceStatus = deviceStatusResponse.device.status;
                
                // 如果status字段不存在，尝试其他可能的字段名
                if (deviceStatus === undefined) {
                    deviceStatus = deviceStatusResponse.device.deviceStatus;
                }
                
                // 如果仍然没有找到状态字段，设置默认值为'IDLE'
                if (deviceStatus === undefined) {
                    deviceStatus = 'IDLE';
                    console.log('⚠️ 未找到设备状态字段，使用默认状态: IDLE');
                }
                
                console.log('📱 设备状态:', deviceStatus);
                
                // 只有当设备状态为空闲(IDLE)时才显示二维码
                if (deviceStatus === 'IDLE') {
                    console.log('✅ 设备状态为空闲，可以显示二维码');
                    
                    // 生成微信二维码
                    console.log('🔍 开始生成微信二维码...');
                    await this.generateWechatQRCode();
                    console.log('✅ 微信二维码生成完成');
                    
                    // 启动5分钟定时刷新机制
                    console.log('🔍 启动5分钟定时刷新机制...');
                    this.startWechatQRRefreshTimer();
                    console.log('✅ 5分钟定时刷新机制启动完成');
                    
                    // 开始检查微信关注状态
                    console.log('🔍 开始设置微信状态检查...');
                    this.startWechatStatusCheck();
                    console.log('✅ 微信状态检查设置完成');
                } else {
                    console.log('⚠️ 设备状态不为空闲，当前状态:', deviceStatus);
                    // 根据设备状态显示相应的提示信息
                    this.showDeviceStatusMessage(deviceStatus);
                }
            } else {
                console.error('❌ 设备状态检查失败:', deviceStatusResponse.error || '未知错误');
                // 即使设备状态检查失败，也继续显示二维码
                await this.generateWechatQRCode();
                this.startWechatQRRefreshTimer();
                this.startWechatStatusCheck();
            }
            } catch (error) {
                console.error('❌ 设备状态检查异常:', error);
                // 即使设备状态检查异常，也继续显示二维码
                await this.generateWechatQRCode();
                this.startWechatQRRefreshTimer();
                this.startWechatStatusCheck();
            }
        } else {
            console.log('🌐 离线模式：跳过设备状态检查，直接生成二维码');
            // 离线模式下直接生成二维码
            await this.generateWechatQRCode();
            this.startWechatQRRefreshTimer();
            this.startWechatStatusCheck();
        }
    }

    // 显示设备状态消息
    showDeviceStatusMessage(status) {
        const qrContainer = document.getElementById('wechat-qr');
        if (qrContainer) {
            let message = '';
            switch (status) {
                case 'IN_USE':
                    message = '设备正在使用中，请稍后再试';
                    break;
                case 'MAINTENANCE':
                    message = '设备维护中，请稍后再试';
                    break;
                default:
                    message = `设备状态: ${status}`;
            }
            
            qrContainer.innerHTML = `
                <div class="device-status-message">
                    <p>${message}</p>
                    <button onclick="appState.refreshDeviceStatus()">刷新状态</button>
                </div>
            `;
        }
    }

    // 刷新设备状态
    async refreshDeviceStatus() {
        console.log('🔄 刷新设备状态...');
        await this.initializeWelcomePage();
    }

    // 初始化开发模式功能
    initializeDevelopmentMode() {
        if (!this.isDevelopment) {
            console.log('ℹ️ 非开发模式，跳过开发功能初始化');
            return;
        }
        
        console.log('🔧 初始化开发模式功能...');
        
        // 显示开发模式按钮
        this.showDevelopmentModeButton();
        
        // 监听快捷键 Ctrl+Shift+D
        this.initializeDevelopmentShortcuts();
        
        console.log('✅ 开发模式功能初始化完成');
    }

    // 显示开发模式按钮
    showDevelopmentModeButton() {
        // 检查按钮是否已存在
        let devButton = document.getElementById('dev-skip-login-btn');
        if (devButton) {
            devButton.style.display = 'block';
            return;
        }
        
        // 创建开发模式跳过登录按钮
        devButton = document.createElement('button');
        devButton.id = 'dev-skip-login-btn';
        devButton.className = 'dev-skip-button';
        devButton.innerHTML = '🚀 跳过登录 (开发模式)';
        devButton.onclick = () => this.skipLoginForDevelopment();
        
        // 添加到欢迎页面底部
        const welcomePage = document.getElementById('welcome-page');
        if (welcomePage) {
            welcomePage.appendChild(devButton);
            console.log('✅ 开发模式跳过按钮已添加');
        }
    }

    // 隐藏开发模式按钮
    hideDevelopmentModeButton() {
        const devButton = document.getElementById('dev-skip-login-btn');
        if (devButton) {
            devButton.style.display = 'none';
        }
    }

    // 初始化开发模式快捷键
    initializeDevelopmentShortcuts() {
        // 移除旧的事件监听器（如果有）
        if (this.devShortcutHandler) {
            document.removeEventListener('keydown', this.devShortcutHandler);
        }
        
        // 创建快捷键处理函数
        this.devShortcutHandler = (event) => {
            // Ctrl+Shift+D 跳过登录
            if (event.ctrlKey && event.shiftKey && event.key === 'D') {
                event.preventDefault();
                console.log('🔧 检测到快捷键 Ctrl+Shift+D，跳过登录');
                this.skipLoginForDevelopment();
            }
        };
        
        // 添加事件监听器
        document.addEventListener('keydown', this.devShortcutHandler);
        
        console.log('✅ 开发模式快捷键已启用（Ctrl+Shift+D 跳过登录）');
    }

    // 开发模式跳过登录
    async skipLoginForDevelopment() {
        // 生产环境下绝对禁止跳过登录
        if (typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'production') {
            console.error('❌ 生产环境下不允许跳过登录！');
            this.showError('生产环境下不允许跳过登录，请扫码微信公众号进行登录');
            return;
        }
        
        if (!this.isDevelopment) {
            console.warn('⚠️ 非开发模式，无法跳过登录');
            return;
        }
        
        console.log('🚀 开发模式：跳过微信扫码登录');
        
        try {
            // 设置开发模式跳过登录标志
            this.devModeSkippedLogin = true;
            
            // 停止微信状态检查和二维码刷新
            this.stopWechatStatusCheck();
            this.stopWechatQRRefreshTimer();
            
            // 开发模式下：调用一键设置接口
            try {
                if (window.apiClient && this.macAddress) {
                    console.log('📡 开发模式：调用快速设置接口...');
                    const deviceName = 'DEV_DEVICE_' + this.macAddress.replace(/:/g, '');
                    const nickname = 'Dev_User_' + Date.now();
                    
                    const quickSetupResponse = await window.apiClient.quickSetup(this.macAddress, deviceName, nickname);
                    
                    if (quickSetupResponse && quickSetupResponse.success) {
                        // 保存从服务器返回的 token（已在 apiClient 中自动保存）
                        // 保存从服务器返回的 sceneStr 和用户信息
                        this.qrSceneStr = quickSetupResponse.sceneStr;
                        this.userProfile.openid = quickSetupResponse.wechatUser.openid;
                        
                        console.log('✅ 开发模式快速设置成功:', {
                            sceneStr: this.qrSceneStr,
                            openid: this.userProfile.openid,
                            deviceId: quickSetupResponse.device.id
                        });
                        
                        console.log('💡 使用说明:');
                        console.log('  - Token已自动保存，后续请求会自动携带');
                        console.log('  - sceneStr:', this.qrSceneStr);
                        console.log('  - 现在可以直接测试上传照片、选择服装等功能');
                    } else {
                        throw new Error('快速设置失败: ' + (quickSetupResponse?.error || '未知错误'));
                    }
                } else {
                    console.warn('⚠️ API客户端未初始化或MAC地址未获取');
                    throw new Error('API客户端未初始化或MAC地址未获取');
                }
            } catch (setupError) {
                console.error('❌ 开发模式快速设置失败:', setupError.message);
                throw setupError;
            }
            
            // 直接跳转到拍照页面
            await this.setPage('profile-page');
            
            // 显示提示信息
            this.showDevModeNotification('已跳过登录，直接进入拍照页面（开发模式）');
            
        } catch (error) {
            console.error('❌ 开发模式跳过登录失败:', error);
            this.showError('跳过登录失败: ' + error.message);
        }
    }

    // 显示开发模式通知
    showDevModeNotification(message) {
        // 创建通知元素
        const notification = document.createElement('div');
        notification.className = 'dev-mode-notification';
        notification.innerHTML = `
            <div class="dev-notification-content">
                <span class="dev-icon">🔧</span>
                <span class="dev-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 3秒后自动消失
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // 显示摄像头错误通知
    showCameraErrorNotification(error) {
        let message = '摄像头初始化失败';
        let tips = '';
        let solutions = [];
        
        if (error.name === 'NotReadableError') {
            message = '摄像头无法访问（设备被占用或驱动问题）';
            tips = '摄像头正被其他应用使用，或者系统驱动异常。';
            solutions = [
                '关闭占用摄像头的应用：Zoom、Teams、Skype、浏览器标签页',
                '打开任务管理器，结束占用摄像头的进程',
                '检查设备管理器中摄像头设备状态，更新驱动',
                '重启计算机后再试'
            ];
        } else if (error.name === 'NotAllowedError') {
            message = '摄像头权限被拒绝';
            tips = '应用没有获得访问摄像头的权限。';
            solutions = [
                'Windows设置 → 隐私和安全性 → 摄像头',
                '启用“允许访问此设备上的摄像头”',
                '启用“允许应用访问摄像头”',
                '启用“允许桌面应用访问摄像头”',
                '重启应用后再试'
            ];
        } else if (error.name === 'NotFoundError') {
            message = '未检测到摄像头设备';
            tips = '系统找不到可用的摄像头设备。';
            solutions = [
                '检查摄像头是否正确连接到电脑',
                '打开设备管理器，查看“照相机”或“图像设备”',
                '尝试重新插拔USB摄像头',
                '如使用笔记本，检查是否禁用了内置摄像头'
            ];
        } else if (error.name === 'OverconstrainedError') {
            message = '摄像头不支持请求的分辨率或帧率';
            tips = '摄像头硬件不支持当前设置的视频参数。';
            solutions = [
                '在配置页面中选择其他摄像头',
                '降低分辨率要求（如720p而非1080p）',
                '更新摄像头驱动程序',
                '尝试使用其他USB端口'
            ];
        } else {
            tips = error.message || '未知错误';
            solutions = [
                '尝试重启应用',
                '检查系统摄像头设置',
                '更新系统和驱动程序'
            ];
        }
        
        // 构建解决方案HTML
        const solutionsList = solutions.map((s, i) => `<li>${i + 1}. ${s}</li>`).join('');
        
        const notification = document.createElement('div');
        notification.className = 'dev-mode-notification camera-error';
        notification.innerHTML = `
            <div class="dev-notification-content">
                <span class="dev-icon">⚠️</span>
                <div class="dev-message">
                    <strong>${message}</strong>
                    ${tips ? '<br><small style="opacity: 0.9;">⚡ ' + tips + '</small>' : ''}
                    ${solutions.length > 0 ? '<br><br><strong style="font-size: 14px;">🛠️ 解决方案：</strong><ul style="margin: 8px 0; padding-left: 20px; text-align: left;">' + solutionsList + '</ul>' : ''}
                    <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
                        <button onclick="appState.retryCamera()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 600;">
                            🔄 重试初始化摄像头
                        </button>
                    </div>
                    <div style="margin-top: 12px; text-align: center;">
                        <small style="opacity: 0.85; font-size: 12px;">⚠️ 摄像头必须成功初始化后才能继续使用</small>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 错误通知不会自动消失，只能通过重试成功后才消失
    }

    // 重试摄像头初始化
    async retryCamera() {
        console.log('🔄 重试摄像头初始化...');
        // 移除错误通知
        const errorNotifs = document.querySelectorAll('.camera-error');
        errorNotifs.forEach(notif => {
            notif.style.opacity = '0';
            setTimeout(() => {
                if (notif.parentNode) {
                    document.body.removeChild(notif);
                }
            }, 300);
        });
        
        // 重新初始化摄像头
        try {
            console.log('📸 准备重新初始化摄像头...');
            await initializeCamera();
            await enableCameraUI();
            console.log('✅ 摄像头初始化成功！');
            this.showDevModeNotification('✅ 摄像头初始化成功！');
        } catch (error) {
            console.error('❌ 重试失败:', error.name, error.message);
            this.showCameraErrorNotification(error);
        }
    }

    // 连续点击检测初始化
    initializeClickDetection() {
        console.log('🔄 初始化连续点击检测...');
        
        // 在右上角添加透明的点击区域
        let clickArea = document.getElementById('config-click-area');
        if (!clickArea) {
            clickArea = document.createElement('div');
            clickArea.id = 'config-click-area';
            clickArea.style.cssText = `
                position: fixed;
                top: 0;
                right: 0;
                width: 100px;
                height: 100px;
                z-index: 9999;
                background: transparent;
                cursor: pointer;
            `;
            
            // 添加点击事件
            clickArea.addEventListener('click', (e) => {
                this.handleConfigClick(e);
            });
            
            // 添加到欢迎页面
            const welcomePage = document.getElementById('welcome-page');
            if (welcomePage) {
                welcomePage.appendChild(clickArea);
            }
        }
        
        console.log('✅ 连续点击检测初始化完成');
    }
    
    // 处理配置点击事件
    handleConfigClick(event) {
        console.log('💆 检测到右上角点击，当前计数:', this.clickCount + 1);
        
        // 增加点击计数
        this.clickCount++;
        
        // 清除之前的计时器
        if (this.clickTimer) {
            clearTimeout(this.clickTimer);
        }
        
        // 设置新的计时器
        this.clickTimer = setTimeout(() => {
            console.log('🔄 连续点击超时，重置计数器');
            this.clickCount = 0;
        }, this.clickTimeWindow);
        
        // 检查是否达到4次点击
        if (this.clickCount >= 4) {
            console.log('✅ 连续点击4次，打开配置页面');
            
            // 清除计时器和计数器
            if (this.clickTimer) {
                clearTimeout(this.clickTimer);
                this.clickTimer = null;
            }
            this.clickCount = 0;
            
            // 打开配置页面
            this.setPage('config-page');
            
            // 可选：显示提示
            // this.showError('已打开配置页面');
        }
    }

    // 获取设备MAC地址
    async getMacAddress() {
        try {
            // 在Electron环境中获取MAC地址
            if (typeof require !== 'undefined') {
                const os = require('os');
                const interfaces = os.networkInterfaces();
                
                // 查找第一个有效的MAC地址
                for (const name of Object.keys(interfaces)) {
                    for (const iface of interfaces[name]) {
                        if (!iface.internal && iface.mac && iface.mac !== '00:00:00:00:00:00') {
                            this.macAddress = iface.mac;
                            console.log('📱 获取到设备MAC地址:', this.macAddress);
                            return;
                        }
                    }
                }
            }
            
            // 如果无法获取真实MAC地址，生成一个模拟的
            this.macAddress = '00:11:22:33:44:55';
            console.log('📱 使用模拟MAC地址:', this.macAddress);
        } catch (error) {
            console.error('❌ 获取MAC地址失败:', error);
            this.macAddress = '00:11:22:33:44:55'; // 默认值
        }
    }

    // 开始体验按钮点击事件 - 修改为必须扫码关注后才能体验
    async startExperience() {
        try {
            console.log('🚀 用户点击开始体验按钮');
            
            // 检查是否已经关注了公众号
            if (this.qrSceneStr && window.apiClient) {
                // 使用二维码场景值检查用户关注状态
                const response = await window.apiClient.checkWechatStatus(this.qrSceneStr);
                
                // 检查是否已关注（兼容isSubscribed和isVerified两种字段）
                const isSubscribed = response.isSubscribed || response.isVerified;
                
                if (response.success && isSubscribed) {
                    console.log('✅ 用户已关注公众号，直接跳转到个人信息页面');
                    await appState.setPage('profile-page');
                    return;
                }
            }
            
            // 如果未关注，提示用户先关注公众号
            appState.showError('请先微信扫码关注公众号后再开始体验');
        } catch (error) {
            console.error('检查微信关注状态失败:', error);
            appState.showError('检查微信关注状态失败: ' + error.message);
        }
    }

    // 打开配置页面
    openConfigPage() {
        openConfig();
    }

    // 开始检查微信关注状态
    startWechatStatusCheck() {
        console.log('🔄 开始设置微信状态检查定时器...');
        
        // 清除之前的定时器
        if (this.wechatCheckInterval) {
            console.log('🔄 清除旧的微信状态检查定时器');
            clearInterval(this.wechatCheckInterval);
        }
        
        // 检查必要条件
        if (!this.qrSceneStr) {
            console.warn('⚠️ 二维码场景值未设置，无法开始微信状态检查');
            return;
        }
        
        if (!window.apiClient) {
            console.warn('⚠️ API客户端未初始化，无法开始微信状态检查');
            return;
        }
        
        console.log('✅ 开始每3秒检查一次微信关注状态...');
        
        // 每3秒检查一次关注状态
        this.wechatCheckInterval = setInterval(async () => {
            try {
                console.log('🔍 执行微信状态检查...');
                if (this.qrSceneStr && window.apiClient) {
                    // 使用二维码场景值检查用户关注状态
                    const response = await window.apiClient.checkWechatStatus(this.qrSceneStr);
                    
                    console.log('🔍 微信状态检查响应:', response);
                    
                    // 检查是否已关注（兼容isSubscribed和isVerified两种字段）
                    const isSubscribed = response.isSubscribed || response.isVerified;
                    
                    if (response.success && isSubscribed) {
                        console.log('✅ 用户已关注公众号');
                        
                        // 不再主动刷新二维码，因为这会导致sceneStr变化
                        // 直接清除定时器并跳转到个人信息页面
                        console.log('🔄 用户已关注公众号，准备跳转到个人信息页面...');
                        
                        // 清除定时器
                        if (this.wechatCheckInterval) {
                            clearInterval(this.wechatCheckInterval);
                            this.wechatCheckInterval = null;
                        }
                        
                        // 自动跳转到个人信息页面
                        console.log('🚀 跳转到个人信息页面...');
                        await this.setPage('profile-page');
                    } else {
                        console.log('⏳ 用户尚未关注公众号，继续检查...');
                    }
                }
            } catch (error) {
                console.error('检查微信关注状态失败:', error);
                // 关注状态检查失败时不再弹出错误提示框，只在控制台记录错误
            }
        }, 3000);
    }

    // 停止检查微信关注状态
    stopWechatStatusCheck() {
        if (this.wechatCheckInterval) {
            clearInterval(this.wechatCheckInterval);
            this.wechatCheckInterval = null;
        }
    }

    // 启动会话超时定时器
    startSessionTimeout() {
        /*
        // 会话管理已弃用
        // 清除之前的定时器
        if (this.sessionTimeoutTimer) {
            clearTimeout(this.sessionTimeoutTimer);
        }
        
        // 设置5分钟超时
        this.sessionTimeoutTimer = setTimeout(async () => {
            console.log('⏰ 会话超时，结束当前会话');
            await this.endCurrentSession();
        }, 300000); // 5分钟 = 300000毫秒
        
        console.log('✅ 会话超时定时器已启动（5分钟）');
        */
    }

    // 停止会话超时定时器
    stopSessionTimeout() {
        /*
        // 会话管理已弃用
        if (this.sessionTimeoutTimer) {
            clearTimeout(this.sessionTimeoutTimer);
            this.sessionTimeoutTimer = null;
            console.log('🛑 会话超时定时器已停止');
        }
        */
    }

    // 结束当前会话
    async endCurrentSession() {
        /*
        // 会话管理已弃用
        try {
            if (this.deviceId && this.currentSessionId && window.apiClient) {
                console.log('🔄 结束当前会话:', this.currentSessionId);
                const response = await window.apiClient.endDeviceSession(this.deviceId, this.currentSessionId);
                
                if (response.success) {
                    console.log('✅ 会话已结束，设备状态已更新:', response.device.status);
                    this.currentSessionId = null;
                    
                    // 如果在试衣流程中，返回欢迎页面
                    if (this.currentPage !== 'welcome-page') {
                        await this.setPage('welcome-page');
                    }
                } else {
                    throw new Error(response.error || '结束会话失败');
                }
            }
        } catch (error) {
            console.error('❌ 结束会话失败:', error);
        }
        */
    }

    // 开始新会话
    async startNewSession() {
        /*
        // 会话管理已弃用
        try {
            // 获取设备ID
            if (!this.deviceId) {
                const deviceStatusResponse = await window.apiClient.getDeviceStatus();
                if (deviceStatusResponse.success && deviceStatusResponse.device) {
                    this.deviceId = deviceStatusResponse.device.id;
                    console.log('📱 获取到设备ID:', this.deviceId);
                }
            }
            
            if (this.deviceId) {
                // 获取最新的会话信息
                const sessionsResponse = await window.apiClient.getDeviceSessions(this.deviceId, { status: 'ACTIVE', limit: 1 });
                if (sessionsResponse.success && sessionsResponse.sessions && sessionsResponse.sessions.length > 0) {
                    this.currentSessionId = sessionsResponse.sessions[0].id;
                    console.log('✅ 获取到当前会话ID:', this.currentSessionId);
                    
                    // 启动会话超时定时器
                    this.startSessionTimeout();
                }
            }
        } catch (error) {
            console.error('❌ 开始新会话失败:', error);
        }
        */
    }

    async initializeProfilePage() {
        // 保留函数以兼容旧调用，但内部只委托到 onPageChange 的逻辑
        this.stopWechatStatusCheck();
        console.log('📸 进入拍照页面，检查摄像头状态...');
        const ok = await ensureCameraReadyAndShowUI();
        if (!ok) { showCameraError(); }
    }

    async initializeClothingPage() {
        console.log('👕 初始化服装页面...');
        
        // ⭐ 清理之前的选择状态和UI样式（修复第二次使用时的缓存问题）
        this.selectedClothing = null;
        this.selectedTopBottom = null;
        this.selectedDress = null;
        this.lastSelectionType = null;
        this.isDressSelected = false;
        
        // 清理所有服装项的选中样式
        document.querySelectorAll('.clothing-item.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // 重置选择摘要UI
        const selectedClothingEl = document.getElementById('selected-clothing');
        const proceedBtn = document.getElementById('proceed-btn');
        if (selectedClothingEl) {
            selectedClothingEl.innerHTML = '<span>尚未选择服装</span>';
        }
        if (proceedBtn) {
            proceedBtn.disabled = true;
        }
        
        // 检查并等待API客户端初始化完成
        if (!window.apiClient) {
            console.log('⚠️ API客户端未初始化，等待初始化完成...');
            
            // 等待API客户端初始化，最多等待10秒
            let attempts = 0;
            const maxAttempts = 100; // 10秒，每100ms检查一次
            
            while (!window.apiClient && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.apiClient) {
                console.error('❌ API客户端初始化超时');
                appState.showError('API客户端初始化失败，请刷新页面重试。');
                return;
            }
        }
        
        // 确保API客户端已初始化
        if (!window.apiClient.initialized) {
            console.log('🔄 API客户端尚未初始化，执行初始化...');
            try {
                await window.apiClient.initialize();
                console.log('✅ API客户端初始化完成');
            } catch (error) {
                console.error('❌ API客户端初始化失败:', error);
            }
        }
        
        // 检查设备认证状态
        if (!window.apiClient.token) {
            console.log('⚠️ 设备未认证，尝试进行认证...');
            try {
                // 在这里我们可以调用认证逻辑，但由于需要MAC地址，我们先跳过
                console.log('设备认证需要在应用启动时完成，请检查初始化流程');
            } catch (error) {
                console.error('设备认证失败:', error);
            }
        }
        
        // 根据用户档案设置当前性别
        this.currentGender = this.userProfile.gender;
        
        // 设置性别tab的初始状态
        this.setupGenderTabs();
        this.updateGenderTabState();
        
        this.setupCategoryTabs();
        
        // 在调用加载前显示加载提示
        try {
            const topsGrid = document.getElementById('tops-grid');
            const bottomsGrid = document.getElementById('bottoms-grid');
            if (topsGrid) topsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">⚙️ 正在加载上衣...</div>';
            if (bottomsGrid) bottomsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">⚙️ 正在加载下衣...</div>';
        } catch (error) {}
        
        // 加载服装数据（同时加载上衣与下衣）
        await this.loadClothingItems();
        this.updateCategoryNotice();
        
        // 初始化默认服装预览
        this.initializeDefaultClothingPreviews();
    }
    
    // 初始化默认服装预览
    initializeDefaultClothingPreviews() {
        // 初始化默认的上衣预览
        this.initializeClothingPreview('tops');
        
        // 初始化默认的下衣预览
        this.initializeClothingPreview('bottoms');
    }
    
    // 初始化特定类别的服装预览
    initializeClothingPreview(category) {
        // 确保defaultClothing对象存在
        if (!this.defaultClothing) {
            this.defaultClothing = {
                tops: [
                    { id: 'top1', name: '白色衬衫', image: 'public/coats/1.jpg' },
                    { id: 'top2', name: '粉色T恤', image: 'public/coats/2.jpg' },
                    { id: 'top3', name: '蓝色针织衫', image: 'public/coats/3.jpg' }
                ],
                bottoms: [
                    { id: 'bottom1', name: '牛仔裤', image: 'public/pants/9.jpg' },
                    { id: 'bottom2', name: '时尚长裤', image: 'public/pants/10.jpg' },
                    { id: 'bottom3', name: '休闲裤', image: 'public/pants/11.jpg' }
                ]
            };
        }
        
        // 获取默认服装数据
        const defaultItems = this.defaultClothing[category] || [];
        
        // 获取预览容器
        const previewContainer = document.querySelector(`.clothing-section.${category} .clothing-preview-container`);
        
        if (previewContainer && defaultItems.length > 0) {
            // 获取现有的预览项（排除选择覆盖层）
            const previewItems = Array.from(previewContainer.children).filter(el => el.classList.contains('clothing-item-preview'));
            
            // 更新现有的预览项
            previewItems.forEach((previewItem, index) => {
                if (index < defaultItems.length) {
                    const item = defaultItems[index];
                    const imagePlaceholder = previewItem.querySelector('.clothing-item-image-placeholder');
                    const nameElement = previewItem.querySelector('.clothing-item-name');
                    
                    // 更新图片，使用getImageUrl方法转换URL
                    if (imagePlaceholder) {
                        const imageUrl = this.getImageUrl(item.image);
                        imagePlaceholder.innerHTML = `<img src="${imageUrl}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 15px;">`;
                    }
                    
                    // 更新名称
                    if (nameElement) {
                        nameElement.textContent = item.name;
                    }
                    
                    // 点击事件已在HTML中设置
                }
            });
        }
    }

    setupGenderTabs() {
        const genderTabs = document.querySelectorAll('.gender-tab');
        genderTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // 移除所有active状态
                genderTabs.forEach(t => t.classList.remove('active'));
                // 设置当前tab为active
                tab.classList.add('active');
                this.currentGender = tab.dataset.gender;
                
                // 重置选择状态
                this.selectedClothing = null;
                this.selectedTopBottom = null;
                this.selectedDress = null;
                this.isDressSelected = false;
                this.currentCategory = 'tops-bottoms';
                this.currentSubCategory = 'tops';
                this.updateSelectionSummary();
                this.updateCategoryNotice();
                this.updateCategoryTabsState();
                this.updateSubCategoryTabs();
                
                // 重新加载服装数据
                this.loadClothingItems();
            });
        });
    }

    setupCategoryTabs() {
        const categoryTabs = document.querySelectorAll('.tab');
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.classList.contains('disabled')) {
                    return; // 如果被禁用，不响应点击
                }
                
                // 移除所有active状态
                categoryTabs.forEach(t => t.classList.remove('active'));
                // 设置当前tab为active
                tab.classList.add('active');
                this.currentCategory = tab.dataset.category;
                
                // 显示/隐藏子分类tab
                this.updateSubCategoryTabs();
                
                // 重新加载服装数据
                this.loadClothingItems();
            });
        });
    }

    setupSubCategoryTabs() {
        const subCategoryTabs = document.querySelectorAll('.sub-tab');
        subCategoryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.classList.contains('disabled')) {
                    return; // 如果被禁用，不响应点击
                }
                
                // 移除所有active状态
                subCategoryTabs.forEach(t => t.classList.remove('active'));
                // 设置当前tab为active
                tab.classList.add('active');
                this.currentSubCategory = tab.dataset.subcategory;
                
                // 重新加载服装数据
                this.loadClothingItems();
            });
        });
    }

    loadClothingItems() {
        const category = this.currentCategory;
        const subCategory = this.currentSubCategory;
        const gender = this.currentGender;
        const url = `/api/clothing/${gender}/${category}/${subCategory}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                this.updateClothingPreview(data);
            })
            .catch(error => {
                console.error('Error loading clothing items:', error);
            });
    }

    updateClothingPreview(items) {
        const previewContainer = document.querySelector(`.clothing-section.${this.currentSubCategory} .clothing-preview-container`);
        if (previewContainer) {
            previewContainer.innerHTML = '';
            items.forEach(item => {
                const previewItem = document.createElement('div');
                previewItem.classList.add('clothing-item-preview');
                previewItem.innerHTML = `
                    <div class="clothing-item-image-placeholder"></div>
                    <div class="clothing-item-name">${item.name}</div>
                `;
                previewItem.addEventListener('click', () => {
                    this.selectClothingItem(item);
                });
                previewContainer.appendChild(previewItem);
            });
        }
    }

    selectClothingItem(item) {
        this.selectedClothing = item;
        this.updateSelectionSummary();
    }

    updateSelectionSummary() {
        const summaryElement = document.querySelector('.selection-summary');
        if (summaryElement) {
            if (this.selectedClothing) {
                summaryElement.textContent = `已选择: ${this.selectedClothing.name}`;
            } else {
                summaryElement.textContent = '请选择服装';
            }
        }
    }

    updateCategoryNotice() {
        const noticeElement = document.querySelector('.category-notice');
        if (noticeElement) {
            noticeElement.textContent = `当前类别: ${this.currentCategory}`;
        }
    }

    updateCategoryTabsState() {
        const categoryTabs = document.querySelectorAll('.tab');
        categoryTabs.forEach(tab => {
            if (tab.dataset.category === this.currentCategory) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
    }

    updateSubCategoryTabs() {
        const subCategoryTabs = document.querySelectorAll('.sub-tab');
        subCategoryTabs.forEach(tab => {
            if (tab.dataset.category === this.currentCategory) {
                tab.classList.remove('disabled');
            } else {
                tab.classList.add('disabled');
            }
            if (tab.dataset.subcategory === this.currentSubCategory) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
    }

    getImageUrl(imagePath) {
        return new URL(imagePath, window.location.origin).href;
    }
            });
        });
        
        // 设置子分类tab事件
        this.setupSubCategoryTabs();
    }

    setupSubCategoryTabs() {
        const subCategoryTabs = document.querySelectorAll('.sub-tab');
        subCategoryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // 移除所有active状态
                subCategoryTabs.forEach(t => t.classList.remove('active'));
                // 设置当前tab为active
                tab.classList.add('active');
                this.currentSubCategory = tab.dataset.subcategory;
                
                // 重新加载服装数据
                this.loadClothingItems();
            });
        });
    }

    updateSubCategoryTabs() {
        const subCategoryTabs = document.getElementById('sub-category-tabs');
        if (subCategoryTabs) {
        if (this.currentCategory === 'tops-bottoms') {
            subCategoryTabs.style.display = 'block';
            // 设置默认子分类
            if (!this.currentSubCategory) {
                this.currentSubCategory = 'tops';
            }
        } else {
            subCategoryTabs.style.display = 'none';
            this.currentSubCategory = null;
            }
        }
    }

    updateCategoryNotice() {
        const notice = document.getElementById('category-notice');
        if (notice) {
        if (this.isDressSelected) {
            notice.style.display = 'block';
        } else {
            notice.style.display = 'none';
            }
        }
    }

    // 添加性别切换功能
    switchGender(gender) {
        // 更新当前性别
        this.currentGender = gender;
        
        // 更新tab样式
        const genderTabs = document.querySelectorAll('.gender-tab');
        genderTabs.forEach(tab => {
            if (tab.dataset.gender === gender) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        // 重置选择状态
        this.selectedClothing = null;
        this.selectedTopBottom = null;
        this.selectedDress = null;
        this.isDressSelected = false;
        this.currentCategory = 'tops-bottoms';
        this.currentSubCategory = 'tops';
        this.updateSelectionSummary();
        this.updateCategoryNotice();
        this.updateCategoryTabsState();
        this.updateSubCategoryTabs();
        
        // 重新加载服装数据
        this.loadClothingItems();
        
        // 更新默认服装预览
        this.initializeDefaultClothingPreviews();
        
        console.log(`切换到${gender === 'male' ? '男装' : '女装'}`);
    }

    updateCategoryTabsState() {
        const topsBottomsTab = document.querySelector('.tab[data-category="tops-bottoms"]');
        const dressesTab = document.querySelector('.tab[data-category="dresses"]');
        
        // 不再禁用任一tab，始终可切换；仅展示上应用文案
        if (topsBottomsTab) {
        topsBottomsTab.classList.remove('disabled');
        }
        if (dressesTab) {
        dressesTab.classList.remove('disabled');
        }
    }

    updateGenderTabState() {
        // 更新性别tab的active状态
        document.querySelectorAll('.gender-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.gender === this.currentGender) {
                tab.classList.add('active');
            }
        });
    }

    // 获取当前应该使用的网格元素
    getCurrentGrid() {
        const activeCategory = this.currentCategory;
        
        // 根据当前分类选择正确的网格元素
        let gridId = 'tops-grid';
        if (activeCategory === 'dresses') {
            gridId = 'tops-grid'; // 裙子也使用上衣网格
        } else if (activeCategory === 'tops-bottoms') {
            gridId = this.currentSubCategory === 'tops' ? 'tops-grid' : 'bottoms-grid';
        }
        
        const grid = document.getElementById(gridId);
        if (!grid) {
            console.error('❌ 找不到网格元素:', gridId);
            throw new Error(`找不到网格元素: ${gridId}`);
        }
        return grid;
    }

    async loadClothingItems() {
        const activeCategory = this.currentCategory;
        const activeGender = this.currentGender;
        
        // 如果是上衣+下衣类别，则同时加载两个网格
        if (activeCategory === 'tops-bottoms') {
            return await this.loadTopAndBottoms(activeGender);
        }
        
        const grid = this.getCurrentGrid();
        grid.innerHTML = '';

        try {
            console.log('👕 开始从API服务器加载服装数据:', {
                category: activeCategory,
                gender: activeGender,
                subCategory: this.currentSubCategory,
                hasApiClient: !!window.apiClient,
                hasToken: window.apiClient?.token ? '有token' : '无token'
            });
            
            // 检查API客户端状态
            if (!window.apiClient) {
                throw new Error('API客户端未初始化，请检查 api-client.js 是否正确加载');
            }
            
            if (!window.apiClient.token) {
                throw new Error('设备认证失败，无法获取服装数据。请检查API服务器连接状态');
            }
            
            // 从 API Server 获取数据
            let itemsToShow = [];
            
            try {
                console.log('🔍 尝试从API服务器获取分类数据...');
                const categories = await window.apiClient.getClothingCategories();
                console.log('📂 获取到分类数据:', categories);
                
                const genderCategory = categories.data.find(cat => 
                    cat.name === (activeGender === 'male' ? '男装' : '女装')
                );
                console.log('👤 查找性别分类:', {
                    looking: activeGender === 'male' ? '男装' : '女装',
                    found: !!genderCategory,
                    available: categories.data.map(cat => cat.name)
                });
                
                if (!genderCategory) {
                    throw new Error(`未找到对应的性别分类: ${activeGender === 'male' ? '男装' : '女装'}`);
                }
                
                let subCategoryId = null;
                
                if (activeCategory === 'tops-bottoms' && this.currentSubCategory) {
                    // 查找对应的子分类
                    const subCategoryName = this.currentSubCategory === 'tops' ? '外套' : '裤子';
                    const subCategory = genderCategory.children.find(child => 
                        child.name === subCategoryName
                    );
                    subCategoryId = subCategory ? subCategory.id : null;
                    console.log('🔍 查找子分类:', {
                        looking: subCategoryName,
                        found: !!subCategory,
                        available: genderCategory.children.map(child => child.name),
                        subCategoryId
                    });
                } else if (activeCategory === 'dresses') {
                    // 查找裙子子分类
                    const subCategory = genderCategory.children.find(child => 
                        child.name === '连衣裙' || child.name === '裙子'
                    );
                    subCategoryId = subCategory ? subCategory.id : null;
                    console.log('👗 查找裙子分类:', {
                        looking: ['连衣裙', '裙子'],
                        found: !!subCategory,
                        available: genderCategory.children.map(child => child.name),
                        subCategoryId
                    });
                }
                
                if (!subCategoryId) {
                    throw new Error(`未找到对应的子分类ID`);
                }
                
                console.log('👔 获取分类服装数据:', subCategoryId);
                const clothesResponse = await window.apiClient.getClothingByCategory(subCategoryId);
                console.log('📦 获取到服装数据:', clothesResponse);
                
                if (!clothesResponse.success || !clothesResponse.data.clothes) {
                    throw new Error('API服务器返回的服装数据格式错误');
                }
                
                itemsToShow = clothesResponse.data.clothes.map(item => ({
                    id: item.id,
                    name: item.name,
                    image: this.getImageUrl(item.imageUrl), // 使用辅助方法转换图片URL
                    description: item.description,
                    prompt: item.prompt,
                    purchaseUrl: item.purchaseUrl
                }));
                console.log('✅ 映射后的服装数据:', itemsToShow.length, '件');
                
            } catch (apiError) {
                console.error('❌ API服务器数据获取失败:', apiError);
                throw new Error(`API服务器数据获取失败: ${apiError.message}`);
            }
            
            // 显示服装数据
            if (itemsToShow.length === 0) {
                this.showNoDataMessage();
            } else {
                itemsToShow.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'clothing-item';
                    itemEl.dataset.id = item.id;
                    itemEl.innerHTML = `
                        <img src="${item.image}" alt="${item.name}">
                        <div class="label">${item.name}</div>
                    `;
                    itemEl.onclick = () => this.selectClothing(item);
                    
                    // 检查是否已选中
                    if (this.isItemSelected(item)) {
                        itemEl.classList.add('selected');
                    }
                    
                    grid.appendChild(itemEl);
                });
                console.log('✅ 服装数据渲染完成');
            }
            
        } catch (error) {
            console.error('❌ 加载服装数据失败:', error);
            this.showApiErrorMessage(error.message);
        }
    }

    // 同时加载上衣和下衣两个网格，根据当前性别
    async loadTopAndBottoms(activeGender) {
        try {
            // 检查API客户端状态
            if (!window.apiClient) {
                throw new Error('API客户端未初始化，请检查 api-client.js 是否正确加载');
            }
            if (!window.apiClient.token) {
                throw new Error('设备认证失败，无法获取服装数据。请检查API服务器连接状态');
            }
            const topsGrid = document.getElementById('tops-grid');
            const bottomsGrid = document.getElementById('bottoms-grid');
            if (topsGrid) topsGrid.innerHTML = '';
            if (bottomsGrid) bottomsGrid.innerHTML = '';

            // 获取分类树
            const categories = await window.apiClient.getClothingCategories();
            const genderCategory = categories.data.find(cat => cat.name === (activeGender === 'male' ? '男装' : '女装'));
            if (!genderCategory) throw new Error('未找到性别分类');
            
            // 根据性别查找不同的分类
            let topsIds = [], bottomsId = null;
            if (activeGender === 'female') {
                // 女性：上衣包括外套和裙子，下衣包括裤子
                const jacketCat = genderCategory.children.find(child => child.name === '外套');
                const dressCat = genderCategory.children.find(child => child.name === '裙子');
                const pantsCat = genderCategory.children.find(child => child.name === '裤子');
                
                console.log('🔍 女性分类查找结果:', {
                    jacketCat: jacketCat ? { id: jacketCat.id, name: jacketCat.name } : null,
                    dressCat: dressCat ? { id: dressCat.id, name: dressCat.name } : null,
                    pantsCat: pantsCat ? { id: pantsCat.id, name: pantsCat.name } : null,
                    allChildren: genderCategory.children.map(child => ({ id: child.id, name: child.name }))
                });
                
                if (jacketCat) topsIds.push(jacketCat.id);
                if (dressCat) topsIds.push(dressCat.id);
                bottomsId = pantsCat ? pantsCat.id : null;
            } else {
                // 男性：上衣是外套，下衣是裤子
                const jacketCat = genderCategory.children.find(child => child.name === '外套');
                const pantsCat = genderCategory.children.find(child => child.name === '裤子');
                
                if (jacketCat) topsIds.push(jacketCat.id);
                bottomsId = pantsCat ? pantsCat.id : null;
            }

            // 并行获取上衣列表（可能包含多个分类）和下衣列表
            const topsPromises = topsIds.map(id => window.apiClient.getClothingByCategory(id));
            const bottomsPromise = bottomsId ? window.apiClient.getClothingByCategory(bottomsId) : Promise.resolve({ success: true, data: { clothes: [] } });
            
            const [topsResponses, bottomsResp] = await Promise.all([
                Promise.all(topsPromises),
                bottomsPromise
            ]);

            // 合并所有上衣分类的服装
            const allTopsItems = [];
            console.log('🔍 开始合并上衣数据，响应数量:', topsResponses.length);
            topsResponses.forEach((response, index) => {
                console.log(`📦 处理第${index + 1}个响应:`, {
                    success: response.success,
                    hasData: !!response.data,
                    clothesCount: response.data?.clothes?.length || 0,
                    categoryId: topsIds[index]
                });
                if (response.success && response.data?.clothes) {
                    console.log(`✅ 添加${response.data.clothes.length}件服装到上衣列表`);
                    allTopsItems.push(...response.data.clothes);
                } else {
                    console.log(`❌ 跳过无效响应:`, response);
                }
            });
            console.log('📊 合并后的上衣总数:', allTopsItems.length);
            
            const topsItems = allTopsItems.map(item => ({
                id: item.id,
                name: item.name,
                image: this.getImageUrl(item.imageUrl),
                description: item.description,
                prompt: item.prompt,
                purchaseUrl: item.purchaseUrl
            }));
            const bottomsItems = (bottomsResp.success && bottomsResp.data?.clothes ? bottomsResp.data.clothes : []).map(item => ({
                id: item.id,
                name: item.name,
                image: this.getImageUrl(item.imageUrl),
                description: item.description,
                prompt: item.prompt,
                purchaseUrl: item.purchaseUrl
            }));

            // 渲染两个网格
            const renderGrid = (items, gridEl, subcategory) => {
                if (!gridEl) return;
                if (items.length === 0) {
                    gridEl.innerHTML = '<div style="text-align:center; padding: 20px; color:#666;">暂无数据</div>';
                    return;
                }
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'clothing-item';
                    el.dataset.id = item.id;
                    el.innerHTML = `
                        <img src="${item.image}" alt="${item.name}">
                        <div class="label">${item.name}</div>
                    `;
                    el.onclick = () => { this.currentSubCategory = subcategory; this.selectClothing(item); };
                    if (this.isItemSelected(item)) el.classList.add('selected');
                    gridEl.appendChild(el);
                });
            };

            renderGrid(topsItems, topsGrid, 'tops');
            renderGrid(bottomsItems, bottomsGrid, 'bottoms');

            console.log('✅ 上衣与下衣数据渲染完成', { tops: topsItems.length, bottoms: bottomsItems.length });
        } catch (error) {
            console.error('❌ 同时加载上衣/下衣失败:', error);
            // 失败时单独在两个grid输出错误信息（如果存在）
            const topsGrid = document.getElementById('tops-grid');
            const bottomsGrid = document.getElementById('bottoms-grid');
            const errorHtml = `<div style="text-align:center; padding: 20px; color:#b00;">加载失败：${error.message}</div>`;
            if (topsGrid) topsGrid.innerHTML = errorHtml;
            if (bottomsGrid) bottomsGrid.innerHTML = errorHtml;
        }
    }

    isItemSelected(item) {
        if (this.selectedDress && this.selectedDress.item.id === item.id) {
            return true;
        }
        if (this.selectedTopBottom) {
            if (this.selectedTopBottom.tops && this.selectedTopBottom.tops.id === item.id) {
                return true;
            }
            if (this.selectedTopBottom.bottoms && this.selectedTopBottom.bottoms.id === item.id) {
                return true;
            }
        }
        return false;
    }

    // 获取选中的服装信息
    getSelectedClothingInfo() {
        if (this.selectedDress) {
            return {
                name: this.selectedDress.item.name,
                category: '连衣裙',
                imageUrl: this.selectedDress.item.imageUrl,
                purchaseUrl: this.selectedDress.item.purchaseUrl
            };
        } else if (this.selectedTopBottom) {
            const tops = this.selectedTopBottom.tops;
            const bottoms = this.selectedTopBottom.bottoms;
            
            if (tops && bottoms) {
                return {
                    name: `${tops.name} + ${bottoms.name}`,
                    category: '上衣+下衣',
                    imageUrl: tops.imageUrl, // 使用上衣图片
                    purchaseUrl: tops.purchaseUrl || bottoms.purchaseUrl
                };
            } else if (tops) {
                return {
                    name: tops.name,
                    category: '上衣',
                    imageUrl: tops.imageUrl,
                    purchaseUrl: tops.purchaseUrl
                };
            } else if (bottoms) {
                return {
                    name: bottoms.name,
                    category: '下衣',
                    imageUrl: bottoms.imageUrl,
                    purchaseUrl: bottoms.purchaseUrl
                };
            }
        }
        
        return {
            name: '未选择服装',
            category: '',
            imageUrl: '',
            purchaseUrl: ''
        };
    }

    showApiErrorMessage(errorMessage = 'API服务器连接失败') {
        // 在服装网格中显示错误提示
        try {
            const grid = this.getCurrentGrid();
            const errorHtml = `
                <div class="api-error-message" style="
                    grid-column: 1 / -1;
                    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
                    border: 1px solid #dc3545;
                    border-radius: 8px;
                    padding: 20px;
                    margin: 10px;
                    text-align: center;
                    color: #721c24;
                    box-shadow: 0 2px 8px rgba(220,53,69,0.2);
                ">
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                        🚫 无法连接到服务器
                    </div>
                    <div style="margin-bottom: 15px; line-height: 1.5;">
                        ${errorMessage}<br>
                        请检查网络连接和API服务器状态后重试。
                    </div>
                    <div style="font-size: 0.9em; color: #6c757d;">
                        解决方案：1. 检查配置页面中的服务器地址 | 2. 确保API服务器正在运行 | 3. 重启应用
                    </div>
                </div>
            `;
            grid.innerHTML = errorHtml;
        } catch (error) {
            console.warn('⚠️ 无法显示错误消息:', error.message);
        }
    }

    showNoDataMessage() {
        // 显示无数据提示
        try {
            const grid = this.getCurrentGrid();
            const noDataHtml = `
                <div class="no-data-message" style="
                    grid-column: 1 / -1;
                    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
                    border: 1px solid #ffc107;
                    border-radius: 8px;
                    padding: 20px;
                    margin: 10px;
                    text-align: center;
                    color: #856404;
                    box-shadow: 0 2px 8px rgba(255,193,7,0.2);
                ">
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                        📦 暂无服装数据
                    </div>
                    <div style="margin-bottom: 15px; line-height: 1.5;">
                        当前分类下暂无可用的服装数据。<br>
                        请尝试切换其他分类或联系管理员添加服装数据。
                    </div>
                </div>
            `;
            grid.innerHTML = noDataHtml;
        } catch (error) {
            console.warn('⚠️ 无法显示无数据消息:', error.message);
        }
    }

    // 本地数据方法已移除 - 客户端只从API服务器加载数据

    // 辅助方法：将相对路径转换为完整的HTTP URL
    getImageUrl(relativePath) {
        if (!relativePath) {
            return '';
        }
        
        // 如果已经是完整的URL（以http或https开头），直接返回
        if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
            return relativePath;
        }
        
        // 如果以斜杠开头，去掉斜杠
        const cleanPath = relativePath.startsWith('/') ? relativePath.substring(1) : relativePath;
        
        // 根据项目记忆中的规范，为相对路径添加COS_FOLDER前缀
        // COS_FOLDER的实际值是 'clothinges/'
        const COS_FOLDER = 'clothinges/';
        // 使用CDN域名（clothing.0086studios.xyz）构建完整的URL
        // 注意：API服务器域名是 clothing-api.0086studios.xyz，不要混淆
        return `https://clothing.0086studios.xyz/${COS_FOLDER}${cleanPath}`;
    }

    selectClothing(item) {
        // 选择来源：根据当前分类判断
        const isDress = this.currentCategory === 'dresses';
        const isTopBottom = this.currentCategory === 'tops-bottoms';
        
        if (isDress) {
            // 点击同一条目切换选中/取消
            if (this.selectedDress && this.selectedDress.item.id === item.id) {
                this.selectedDress = null;
                this.isDressSelected = false;
                this.lastSelectionType = null;
            } else {
            // 选择裙子时，清除所有上衣/下衣选择
            this.selectedDress = { item };
            this.selectedTopBottom = null;
            this.lastSelectionType = 'dress';
            this.isDressSelected = true;
            }
        } else if (isTopBottom) {
            // 选择上衣/下衣时，清除裙子选择
            this.selectedDress = null;
            this.isDressSelected = false;
            
            // 初始化selectedTopBottom对象
            if (!this.selectedTopBottom) {
                this.selectedTopBottom = { tops: null, bottoms: null };
            }
            
            // 根据子分类设置对应的选择，若再次点击同一条目则取消选中
            if (this.currentSubCategory === 'tops') {
                if (this.selectedTopBottom.tops && this.selectedTopBottom.tops.id === item.id) {
                    this.selectedTopBottom.tops = null;
                    this.lastSelectionType = null;
                } else {
                this.selectedTopBottom.tops = item;
                    this.lastSelectionType = 'topBottom';
                }
            } else if (this.currentSubCategory === 'bottoms') {
                if (this.selectedTopBottom.bottoms && this.selectedTopBottom.bottoms.id === item.id) {
                    this.selectedTopBottom.bottoms = null;
                    this.lastSelectionType = null;
                } else {
                this.selectedTopBottom.bottoms = item;
            this.lastSelectionType = 'topBottom';
                }
            }
        }

        // 更新 UI 选中样式（根据当前可见列表）
        document.querySelectorAll('.clothing-item').forEach(el => el.classList.remove('selected'));
        // 根据当前状态，给仍然选中的条目加上selected样式
        if (this.selectedDress) {
            const el = document.querySelector(`.clothing-item[data-id="${this.selectedDress.item.id}"]`);
            if (el) el.classList.add('selected');
        }
        if (this.selectedTopBottom) {
            if (this.selectedTopBottom.tops) {
                const elTop = document.querySelector(`.clothing-item[data-id="${this.selectedTopBottom.tops.id}"]`);
                if (elTop) elTop.classList.add('selected');
            }
            if (this.selectedTopBottom.bottoms) {
                const elBottom = document.querySelector(`.clothing-item[data-id="${this.selectedTopBottom.bottoms.id}"]`);
                if (elBottom) elBottom.classList.add('selected');
            }
        }

        // 更新提示与摘要
        this.updateCategoryTabsState();
        this.updateCategoryNotice();
        this.updateSelectionSummary();
    }

    updateSelectionSummary() {
        const selectedClothingEl = document.getElementById('selected-clothing');
        const proceedBtn = document.getElementById('proceed-btn');
        // 容器或按钮在某些早期时机可能尚未渲染，做空值保护
        if (!selectedClothingEl && !proceedBtn) {
            return;
        }
        
        let hasSelection = false;
        let summaryHTML = '';
        
        if (this.selectedDress) {
            // 显示裙子选择
            hasSelection = true;
            summaryHTML += `
                <div class="selected-item-display">
                    <img src="${this.getImageUrl(this.selectedDress.item.image)}" alt="${this.selectedDress.item.name}" />
                    <span>${this.selectedDress.item.name}</span>
                    <span class="item-type">裙子</span>
                </div>
            `;
        } else if (this.selectedTopBottom) {
            // 显示上衣/下衣选择
            if (this.selectedTopBottom.tops) {
                hasSelection = true;
                summaryHTML += `
                    <div class="selected-item-display">
                        <img src="${this.getImageUrl(this.selectedTopBottom.tops.image)}" alt="${this.selectedTopBottom.tops.name}" />
                        <span>${this.selectedTopBottom.tops.name}</span>
                        <span class="item-type">上衣</span>
                    </div>
                `;
            }
            if (this.selectedTopBottom.bottoms) {
                hasSelection = true;
                summaryHTML += `
                    <div class="selected-item-display">
                        <img src="${this.getImageUrl(this.selectedTopBottom.bottoms.image)}" alt="${this.selectedTopBottom.bottoms.name}" />
                        <span>${this.selectedTopBottom.bottoms.name}</span>
                        <span class="item-type">下衣</span>
                    </div>
                `;
            }
        }
        
        if (selectedClothingEl) {
        if (hasSelection) {
            selectedClothingEl.innerHTML = `
                <div class="selected-items-container">
                    <div class="selected-items-title">已选择的服装：</div>
                    <div class="selected-items-list">
                        ${summaryHTML}
                    </div>
                </div>
            `;
        } else {
            selectedClothingEl.innerHTML = '<span>尚未选择服装</span>';
            }
        }
        if (proceedBtn) {
            proceedBtn.disabled = !hasSelection;
        }
    }

    async startFittingProcess() {
        return new Promise(async (resolve, reject) => {
        // 检查是否有照片和服装选择
        if (!this.selectedDress && !this.selectedTopBottom) {
            this.showError('请确保已上传照片并选择服装');
                reject(new Error('未选择服装'));
            return;
        }

        this.showLoading('正在生成试衣效果...', '这可能需要几分钟时间，请耐心等待');

        try {
            // 确保API客户端已初始化
            if (!window.apiClient || !window.apiClient.token) {
                throw new Error('API客户端未初始化或未认证，请先完成设备认证');
            }
            
            console.log('🌐 使用 API-server 进行试穿任务管理');
            
            // 获取选中的衣服 ID
            let topClothesId = null;
            let bottomClothesId = null;
            
            if (this.selectedDress) {
                // 选择了裙子，作为上衣处理
                topClothesId = this.selectedDress.item.id;
            } else if (this.selectedTopBottom) {
                if (this.selectedTopBottom.tops) {
                    topClothesId = this.selectedTopBottom.tops.id;
                }
                if (this.selectedTopBottom.bottoms) {
                    bottomClothesId = this.selectedTopBottom.bottoms.id;
                }
            }

            if (!topClothesId) {
                throw new Error('未选择有效的上衣或裙子');
            }

            // 检查是否有任务ID（在上传照片时已创建任务）
            if (!this.currentTaskId) {
                throw new Error('未找到任务ID，请重新上传照片');
            }

            console.log('🚀 启动试穿任务:', {
                taskId: this.currentTaskId,
                sceneStr: this.qrSceneStr,
                topClothesId: topClothesId,
                bottomClothesId: bottomClothesId
            });

            // 启动试穿任务 - 通过API-server，传递sceneStr参数
            const taskResponse = await window.apiClient.startTryonTask(
                this.currentTaskId,
                topClothesId,
                bottomClothesId,
                this.qrSceneStr
            );

            if (!taskResponse.success) {
                throw new Error(taskResponse.error || '启动试穿任务失败');
            }

            this.currentTask = {
                taskId: this.currentTaskId,
                status: taskResponse.data.status
            };

            console.log('✅ API Server 试穿任务启动成功:', this.currentTask);

                // 设置任务完成回调
                this.onTaskComplete = (success, resultUrl) => {
                    if (success) {
                        console.log('✅ 试衣任务完成，resolve Promise');
                        resolve(resultUrl);
                    } else {
                        console.log('❌ 试衣任务失败，reject Promise');
                        reject(new Error('试衣任务失败'));
                    }
                };

                // 开始轮询任务状态（启动前清理旧定时器）
                this.stopTaskPolling();
            this.pollApiServerTaskStatus();

        } catch (error) {
            console.error('试衣流程错误:', error);
            this.hideLoading();
            this.showError('试衣生成失败: ' + error.message);
                reject(error);
        }
        });
    }

    // 使用新的 API Server 任务管理
    async startApiServerTask() {
        // 此方法已合并到startFittingProcess中
        return await this.startFittingProcess();
    }

    // 【已弃用】原有的 RunningHub 直接调用流程
    // 现在强制使用 API-server，不再支持直接调用 RunningHub
    async startLegacyRunningHubTask() {
        throw new Error('直接调用 RunningHub 的模式已被禁用，请使用 API-server 模式');
    }

    // 轮询 API Server 任务状态
    async pollApiServerTaskStatus() {
        const maxAttempts = 60; // 最多检查5分钟（每5秒一次）
        let attempts = 0;

        console.log('🔄 开始轮询 API Server 任务状态，任务ID:', this.currentTask.taskId);

        // 使用 setInterval 而不是递归
        this.taskPollTimer = setInterval(async () => {
            attempts++;
            console.log(`🔄 第 ${attempts} 次轮询任务状态...`, {
                currentPage: this.currentPage,
                taskId: this.currentTask?.taskId,
                attempts: attempts,
                maxAttempts: maxAttempts
            });
            
            // 如果已经离开结果流程，停止轮询
            if (this.currentPage === 'welcome-page' || this.currentPage === 'scan-to-get-page') {
                console.log('🚫 已离开结果流程，停止任务轮询', {
                    currentPage: this.currentPage,
                    attempts: attempts
                });
                this.stopTaskPolling();
                return;
            }
            
            // 检查是否超过最大尝试次数
            if (attempts >= maxAttempts) {
                console.error('⏰ 轮询超时，已达到最大尝试次数');
                this.stopTaskPolling();
                this.hideLoading();
                this.showError('任务超时，请稍后重试');
                return;
            }
            
            try {
                const statusResponse = await window.apiClient.getTaskStatus(this.currentTask.taskId);
                
                if (statusResponse.success) {
                    const taskData = statusResponse.data;
                    this.currentTask.status = taskData.status;
                    console.log(`📊 任务状态更新: ${taskData.status}`);

                    // 更新进度文本
                    const progressText = document.getElementById('progress-text');
                    if (progressText) {
                        switch(taskData.status) {
                            case 'QUEUED':
                            case 'PENDING':
                                progressText.textContent = '任务排队中...';
                                console.log('⏳ 任务排队中，等待执行...');
                                break;
                            case 'PROCESSING':
                                progressText.textContent = '正在生成试衣效果...';
                                console.log('🚀 任务正在执行中...');
                                break;
                            case 'COMPLETED':
                                progressText.textContent = '生成完成！';
                                console.log('✅ 任务执行完成');
                                
                                // 检查是否有结果URL，尝试多种可能的字段名
                                const resultUrl = taskData.resultUrl || taskData.imageUrl || taskData.image || taskData.result;
                                console.log('🔍 检查结果URL:', { 
                                    resultUrl, 
                                    hasResultUrl: !!taskData.resultUrl,
                                    hasImageUrl: !!taskData.imageUrl,
                                    hasImage: !!taskData.image,
                                    hasResult: !!taskData.result,
                                    taskData: taskData
                                });
                                
                                if (resultUrl) {
                                    this.hideLoading();
                                    // 仅当当前仍在结果流程时才展示结果，避免已返回首页还加载图片
                                    console.log('🔍 轮询中检查是否显示结果:', {
                                        resultUrl: resultUrl,
                                        currentPage: this.currentPage,
                                        shouldShow: this.currentPage !== 'welcome-page' && this.currentPage !== 'scan-to-get-page'
                                    });
                                    
                                    if (this.currentPage !== 'welcome-page' && this.currentPage !== 'scan-to-get-page') {
                                        console.log('✅ 轮询中调用 showResult');
                                    this.showResult(resultUrl);
                                    } else {
                                        console.log('🚫 已离开结果流程，跳过结果展示');
                                    }
                                    
                                    // 调用任务完成回调
                                    if (this.onTaskComplete) {
                                        this.onTaskComplete(true, resultUrl);
                                    }
                                    
                                    // 任务已结束，停止轮询
                                    this.stopTaskPolling();
                                    return;
                                } else {
                                    console.warn('⚠️ 任务已完成但没有返回结果URL');
                                    // 即使没有结果URL，也隐藏加载界面并显示结果页面
                                    this.hideLoading();
                                    
                                    console.log('🔍 轮询中检查是否显示空结果:', {
                                        currentPage: this.currentPage,
                                        shouldShow: this.currentPage !== 'welcome-page' && this.currentPage !== 'scan-to-get-page'
                                    });
                                    
                                    if (this.currentPage !== 'welcome-page' && this.currentPage !== 'scan-to-get-page') {
                                    // 可以显示一个默认的提示信息
                                        console.log('✅ 轮询中调用 showResult (空字符串)');
                                    this.showResult(''); // 传入空字符串
                                    } else {
                                        console.log('🚫 已离开结果流程，跳过结果展示');
                                    }
                                    
                                    // 调用任务完成回调
                                    if (this.onTaskComplete) {
                                        this.onTaskComplete(true, '');
                                    }
                                    
                                    this.stopTaskPolling();
                                    return;
                                }
                                break;
                            case 'FAILED':
                                console.error('❌ 任务执行失败');
                                this.stopTaskPolling();
                                this.hideLoading();
                                this.showError(taskData.errorMessage || '任务执行失败');
                                
                                // 调用任务完成回调
                                if (this.onTaskComplete) {
                                    this.onTaskComplete(false, null);
                                }
                                return;
                            default:
                                console.log(`⚠️ 未知任务状态: ${taskData.status}`);
                                progressText.textContent = `任务状态: ${taskData.status}`;
                        }
                    }

                    console.log(`📈 轮询进度: ${attempts}/${maxAttempts}`);
                } else {
                    console.error('❌ 状态查询失败:', statusResponse.error);
                }

            } catch (error) {
                console.error('❌ 轮询任务状态错误:', error);
                this.stopTaskPolling();
                this.hideLoading();
                this.showError('获取任务状态失败: ' + error.message);
            }
        }, 5000); // 每5秒检查一次
    }
    
    // 停止任务轮询
    stopTaskPolling() {
        if (this.taskPollTimer) {
            clearInterval(this.taskPollTimer);
            this.taskPollTimer = null;
            console.log('🛑 任务轮询已停止');
        }
    }

    showResult(imageUrl) {
        console.log('🔍 showResult 被调用:', {
            imageUrl: imageUrl,
            currentPage: this.currentPage
        });
        
        // 如果当前已回到首页，则不再切换到结果页，避免回流
        if (this.currentPage === 'welcome-page') {
            console.log('🚫 showResult 被阻止执行: 当前在首页');
            return;
        }
        
        console.log('✅ showResult 继续执行，切换到结果页面');
        this.resultImageUrl = imageUrl;
        this.setPage('results-page');
        
        const resultImg = document.getElementById('result-image');
        const loadingIndicator = document.getElementById('loading-indicator');
        const saveBtn = document.getElementById('save-btn');
        
        if (resultImg) {
            resultImg.src = imageUrl;
            // 隐藏加载指示器
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            // 显示图片元素
            resultImg.style.display = 'block';
            resultImg.onload = () => {
                this.adjustImageContainer();
                // 添加淡入效果
                resultImg.classList.add('fade-in');
                // 图片成功展示后再启动倒计时（60s）
                this.startCountdown();
                // 显示保存按钮
                if (saveBtn) {
                    saveBtn.classList.add('show');
                }
            };
            // 添加错误处理
            resultImg.onerror = () => {
                console.error('❌ 图片加载失败:', {
                    imageUrl: imageUrl,
                    currentPage: this.currentPage,
                    resultImageUrl: this.resultImageUrl,
                    stackTrace: new Error().stack
                });
                // 重新显示加载指示器并显示错误信息
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'flex';
                    const progressText = document.getElementById('progress-text');
                    if (progressText) {
                        progressText.textContent = '图片加载失败';
                    }
                }
                this.showError('图片加载失败，请重试');
            };
        }
        
        // 显示操作按钮
        const resultActions = document.getElementById('result-actions');
        if (resultActions) {
            resultActions.style.display = 'flex';
        }
        
        // 显示风格信息（如果有的话）
        const styleInfo = document.getElementById('style-info');
        if (styleInfo) {
            styleInfo.style.display = 'flex';
        }
        
        // 移除自动推送试装结果到用户的调用
        // this.pushTryonResultToUser(imageUrl);
    }

    adjustImageContainer() {
        const container = document.querySelector('.result-image-container');
        const img = document.getElementById('result-image');
        
        if (container && img && img.complete) {
            const imgRatio = img.naturalWidth / img.naturalHeight;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const containerRatio = containerWidth / containerHeight;
            
            if (imgRatio > containerRatio) {
                // 图片更宽，以宽度为准
                img.style.width = '100%';
                img.style.height = 'auto';
            } else {
                // 图片更高，以高度为准
                img.style.width = 'auto';
                img.style.height = '100%';
            }
        }
    }

    async generateDownloadQR() {
        try {
            // 确保API客户端已初始化
            if (!window.apiClient) {
                console.error('API客户端未初始化');
                return;
            }
            
            // 检查是否已有sceneStr
            if (!this.qrSceneStr) {
                throw new Error('缺少二维码场景值');
            }
            
            // 获取设备MAC地址
            let macAddress = this.macAddress;
            if (!macAddress) {
                // 如果应用状态中没有MAC地址，尝试从系统获取
                try {
                    const { ipcRenderer } = require('electron');
                    macAddress = await ipcRenderer.invoke('get-mac-address');
                } catch (error) {
                    console.error('获取MAC地址失败:', error);
                    macAddress = '00:11:22:33:44:55'; // 默认值
                }
            }
            
            // 处理MAC地址：去掉冒号作为设备唯一标识
            const deviceId = macAddress ? macAddress.replace(/:/g, '') : macAddress;
            
            // 获取当前选择的服装信息
            const clothingInfo = this.getSelectedClothingInfo();
            
            // 获取结果图片URL
            const imageUrl = this.resultImageUrl;
            
            if (!imageUrl) {
                throw new Error('没有可用的试衣结果图片');
            }
            
            // 获取服装购买链接
            let purchaseUrl = '';
            if (this.selectedDress) {
                purchaseUrl = this.selectedDress.item.purchaseUrl || '';
            } else if (this.selectedTopBottom) {
                const topItem = this.selectedTopBottom.tops;
                const bottomItem = this.selectedTopBottom.bottoms;
                // 优先使用上衣的购买链接
                purchaseUrl = (topItem && topItem.purchaseUrl) || (bottomItem && bottomItem.purchaseUrl) || '';
            }
            
            // 调用API生成二维码，传递sceneStr和MAC地址
            const response = await window.apiClient.generateDownloadQR({
                sceneStr: this.qrSceneStr,  // 使用二维码场景值
                macAddress: deviceId,  // 使用处理后的MAC地址
                imageUrl: imageUrl,
                purchaseUrl: purchaseUrl,
                clothesName: clothingInfo.name || '试装结果'
            });
            
            if (response.success) {
                // 显示二维码
                const qrImg = document.getElementById('download-qr-img');
                if (qrImg) {
                    qrImg.src = response.qrCode.dataURL;
                }
                console.log('✅ 下载二维码生成成功');
            } else {
                throw new Error(response.error || '生成二维码失败');
            }
        } catch (error) {
            console.error('❌ 生成下载二维码失败:', error);
            this.showError('生成下载二维码失败: ' + error.message);
        }
    }

    // 推送试装结果到用户
    async pushTryonResultToUser(imageUrl) {
        try {
            // 确保API客户端已初始化
            if (!window.apiClient) {
                console.error('API客户端未初始化');
                return;
            }
            
            // 检查必要参数
            if (!this.qrSceneStr || !imageUrl) {
                console.warn('缺少必要参数，无法推送试装结果');
                return;
            }
            
            // 获取当前选择的服装信息
            const clothingInfo = this.getSelectedClothingInfo();
            
            // 获取服装购买链接
            let purchaseUrl = '';
            if (this.selectedDress) {
                purchaseUrl = this.selectedDress.item.purchaseUrl || '';
            } else if (this.selectedTopBottom) {
                const topItem = this.selectedTopBottom.tops;
                const bottomItem = this.selectedTopBottom.bottoms;
                // 优先使用上衣的购买链接
                purchaseUrl = (topItem && topItem.purchaseUrl) || (bottomItem && bottomItem.purchaseUrl) || '';
            }
            
            // 调用API推送试装结果
            const response = await window.apiClient.pushTryonResult({
                sceneStr: this.qrSceneStr,  // 使用二维码场景值
                imageUrl: imageUrl,
                purchaseUrl: purchaseUrl,
                clothesName: clothingInfo.name || '试装结果'
            });
            
            if (response.success) {
                console.log('✅ 试装结果推送成功');
            } else {
                throw new Error(response.error || '推送试装结果失败');
            }
        } catch (error) {
            console.error('❌ 推送试装结果失败:', error);
            // 不向用户显示错误，只在控制台记录
        }
    }

    startCountdown() {
        const countdownEl = document.getElementById('countdown');
        if (!countdownEl) return;
        
        let timeLeft = 60; // 60秒倒计时
        countdownEl.textContent = timeLeft;
        
        const timer = setInterval(() => {
            timeLeft--;
            countdownEl.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                // 倒计时结束后自动返回欢迎页面并自动刷新二维码
                this.setPage('welcome-page').then(() => {
                    // 清理本次任务关联的sceneStr，标识单次任务结束
                    this.qrSceneStr = null;
                    this.resetForNextUser();
                    this.stopTaskPolling();
                    // 返回首页后自动生成（或刷新）二维码，确保可继续扫码试装
                    this.generateWechatQRCode();
                });
            }
        }, 1000);
    }

    // 清理本次使用过程中的缓存数据与UI状态，准备下一位用户
    resetForNextUser() {
        try {
            console.log('🔄 重置状态，准备下一位用户...');
            
            // 清理选择与结果
            this.selectedClothing = null;
            this.selectedTopBottom = null;
            this.selectedDress = null;
            this.lastSelectionType = null;
            this.selectedStyle = null;
            this.isDressSelected = false;
            this.currentTask = null;
            this.currentTaskId = null;
            this.resultImageUrl = null;

            // 清理扫码获取页面状态
            this.scanQrCodeData = null;
            this.scanCountdown = 300;
            this.scanPushStatus = 'pending';
            this.scanPollTimer = null;
            this.scanCountdownTimer = null;
            
            // 停止任务轮询定时器
            this.stopTaskPolling();

            // 重置流程位置
            this.currentCategory = 'tops-bottoms';
            this.currentSubCategory = 'tops';
            this.currentGender = 'female';

            // 清理用户图片缓存
            if (this.userProfile) {
                this.userProfile.photo = null;
                this.userProfile.photoFileName = null;
                this.userProfile.fullBodyShotNameInRH = null;
            }

            // 清理结果页UI（仅在结果页面存在时清理）
            if (this.currentPage === 'results-page') {
                const resultImg = document.getElementById('result-image');
                const loadingIndicator = document.getElementById('loading-indicator');
                const saveBtn = document.getElementById('save-btn');
                if (resultImg) {
                    resultImg.src = '';
                    resultImg.style.display = 'none';
                    resultImg.classList.remove('fade-in');
                }
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'flex';
                    const progressText = document.getElementById('progress-text');
                    if (progressText) progressText.textContent = '正在生成中...';
                }
                if (saveBtn) {
                    saveBtn.classList.remove('show');
                }
            }

            // ⭐ 清理服装选择页UI（增强清理逻辑）
            const topsGrid = document.getElementById('tops-grid');
            const bottomsGrid = document.getElementById('bottoms-grid');
            if (topsGrid) topsGrid.innerHTML = '';
            if (bottomsGrid) bottomsGrid.innerHTML = '';
            
            // 清理所有已选择的服装项样式
            document.querySelectorAll('.clothing-item.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // 重置选择摘要和继续按钮
            const selectedClothingEl = document.getElementById('selected-clothing');
            const proceedBtn = document.getElementById('proceed-btn');
            if (selectedClothingEl) selectedClothingEl.innerHTML = '<span>尚未选择服装</span>';
            if (proceedBtn) proceedBtn.disabled = true;
            
            console.log('✅ 状态重置完成');
        } catch (e) {
            console.warn('重置下一位用户状态时出现问题:', e);
        }
    }

    // 保存图片函数，在用户点击保存图片按钮时调用
    async saveImage() {
        try {
            console.log('📥 用户点击保存图片按钮');
            
            // 检查是否有结果图片URL
            if (!this.resultImageUrl) {
                throw new Error('没有可保存的试衣结果图片');
            }
            
            // 跳转到扫码获取图片页面
            console.log('🔄 跳转到扫码获取图片页面');
            
            // 停止任务轮询，因为用户已经离开结果流程
            this.stopTaskPolling();
            console.log('🛑 已停止任务轮询，用户离开结果流程');
            
            await this.setPage('scan-to-get-page');
            await this.initializeScanToGetPage();
        } catch (error) {
            console.error('❌ 保存图片失败:', error);
            // 失败也跳回首页，避免阻塞现场
            await this.setPage('welcome-page');
            this.qrSceneStr = null;
            this.resetForNextUser();
            this.stopTaskPolling();
            await this.generateWechatQRCode();
        }
    }

    showLoading(title, message) {
        const modal = document.getElementById('global-loading');
        const titleEl = document.getElementById('loading-title');
        const messageEl = document.getElementById('loading-message');
        
        // 如果有标题，更新标题；否则只更新消息
        if (titleEl && title) {
            titleEl.textContent = title;
        } else if (messageEl) {
            // 如果没有标题，将标题和消息都显示在消息元素中
            messageEl.textContent = title || message;
            if (title && message && title !== message) {
                messageEl.textContent += ' ' + message;
            }
        }
        
        if (modal) modal.style.display = 'flex';
    }

    hideLoading() {
        const modal = document.getElementById('global-loading');
        if (modal) modal.style.display = 'none';
    }

    // ================= 扫码获取图片页面功能 =================
    
    // 初始化扫码获取图片页面
    async initializeScanToGetPage() {
        console.log('📱 初始化扫码获取图片页面...');
        
        try {
            // 检查必要的数据
            if (!this.qrSceneStr || !this.currentTaskId) {
                throw new Error('缺少必要的任务信息');
            }
            
            // 显示加载状态
            this.showScanLoading();
            
            // 激活推送二维码
            await this.activatePushQrCode();
            
            // 开始倒计时
            this.startScanCountdown();
            
            console.log('✅ 扫码获取图片页面初始化完成');
            
        } catch (error) {
            console.error('❌ 初始化扫码获取图片页面失败:', error);
            this.showScanError('初始化失败: ' + error.message);
        }
    }
    
    // 激活推送二维码
    async activatePushQrCode() {
        console.log('🔄 激活推送二维码...');
        
        try {
            // 检查API客户端状态
            if (!window.apiClient) {
                throw new Error('API客户端未初始化');
            }
            
            if (!window.apiClient.token) {
                throw new Error('设备未认证');
            }
            
            // 检查必要参数
            if (!this.currentTaskId) {
                throw new Error('任务ID不存在');
            }
            
            // 使用API客户端调用激活推送二维码接口
            const response = await window.apiClient.activatePushQrCode({
                taskId: this.currentTaskId,
                originalSceneStr: this.qrSceneStr // 可选参数
            });
            
            if (response.success) {
                // 根据新接口响应格式处理数据
                this.scanQrCodeData = response.activation.qrCode;
                this.scanCountdown = response.activation.qrCode.expiresIn || 60; // 默认1分钟
                this.activationSceneStr = response.activation.activationSceneStr;
                this.originalSceneStr = response.activation.originalSceneStr;
                this.taskInfo = response.activation.taskInfo;
                this.userInfo = response.activation.userInfo;
                
                this.showScanQrCode();
                console.log('✅ 推送二维码激活成功', {
                    taskId: this.currentTaskId,
                    activationSceneStr: this.activationSceneStr,
                    expiresIn: this.scanCountdown
                });
            } else {
                throw new Error(response.error || '激活失败');
            }
            
        } catch (error) {
            console.error('❌ 激活推送二维码失败:', error);
            throw error;
        }
    }
    
    // 显示扫码加载状态
    showScanLoading() {
        const loadingEl = document.getElementById('scan-loading');
        const qrImageEl = document.getElementById('scan-qr-image');
        const countdownEl = document.getElementById('countdown-timer');
        
        if (loadingEl) loadingEl.style.display = 'flex';
        if (qrImageEl) qrImageEl.style.display = 'none';
        if (countdownEl) countdownEl.style.display = 'none';
        
        this.updateScanStatus('pending', '⏳', '正在生成二维码...');
    }
    
    // 显示扫码二维码
    showScanQrCode() {
        const loadingEl = document.getElementById('scan-loading');
        const qrImageEl = document.getElementById('scan-qr-image');
        const countdownEl = document.getElementById('countdown-timer');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (qrImageEl) {
            qrImageEl.src = this.scanQrCodeData.dataURL;
            qrImageEl.style.display = 'block';
        }
        if (countdownEl) countdownEl.style.display = 'block';
        
        this.updateScanStatus('pending', '📱', '请扫描二维码');
    }
    
    // 显示扫码错误
    showScanError(message) {
        const loadingEl = document.getElementById('scan-loading');
        const qrImageEl = document.getElementById('scan-qr-image');
        const countdownEl = document.getElementById('countdown-timer');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (qrImageEl) qrImageEl.style.display = 'none';
        if (countdownEl) countdownEl.style.display = 'none';
        
        this.updateScanStatus('failed', '❌', message);
    }
    
    // 更新扫码状态
    updateScanStatus(status, icon, text) {
        this.scanPushStatus = status;
        
        const statusItem = document.getElementById('status-item');
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        
        if (statusItem) {
            statusItem.className = `status-item ${status}`;
        }
        if (statusIcon) {
            statusIcon.textContent = icon;
        }
        if (statusText) {
            statusText.textContent = text;
        }
    }
    
    // 开始扫码倒计时
    startScanCountdown() {
        this.scanCountdownTimer = setInterval(() => {
            this.scanCountdown--;
            this.updateScanCountdown();
            
            if (this.scanCountdown <= 0) {
                clearInterval(this.scanCountdownTimer);
                this.scanCountdownTimer = null;
                this.handleScanTimeout();
            }
        }, 1000);
    }
    
    // 更新扫码倒计时显示
    updateScanCountdown() {
        const countdownText = document.getElementById('countdown-text');
        if (countdownText) {
            const minutes = Math.floor(this.scanCountdown / 60);
            const seconds = this.scanCountdown % 60;
            countdownText.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    // 处理扫码超时
    handleScanTimeout() {
        console.log('⏰ 扫码超时，返回首页');
        this.returnToHomeFromScan();
    }
    
    
    
    
    // 刷新扫码二维码
    async refreshScanQrCode() {
        console.log('🔄 刷新扫码二维码...');
        
        try {
            // 停止当前倒计时
            if (this.scanCountdownTimer) {
                clearInterval(this.scanCountdownTimer);
                this.scanCountdownTimer = null;
            }
            
            // 重新激活二维码
            await this.activatePushQrCode();
            
            // 重新开始倒计时
            this.startScanCountdown();
            
            console.log('✅ 扫码二维码刷新成功');
            
        } catch (error) {
            console.error('❌ 刷新扫码二维码失败:', error);
            this.showScanError('刷新失败: ' + error.message);
        }
    }
    
    // 从扫码页面返回首页
    async returnToHomeFromScan() {
        console.log('🏠 从扫码页面返回首页...');
        
        // 清理扫码页面状态
        this.scanQrCodeData = null;
        this.scanCountdown = 60; // 改为1分钟
        this.scanPushStatus = 'pending';
        this.activationSceneStr = null;
        this.originalSceneStr = null;
        this.taskInfo = null;
        this.userInfo = null;
        
        // 停止倒计时
        if (this.scanCountdownTimer) {
            clearInterval(this.scanCountdownTimer);
            this.scanCountdownTimer = null;
        }
        
        // 停止任务轮询定时器
        this.stopTaskPolling();
        
        // 清理扫码页面UI
        this.clearScanToGetPage();
        
        // 清理任务状态
        this.qrSceneStr = null;
        this.currentTaskId = null;
        this.resultImageUrl = null;
        
        
        // 重置摄像头状态，确保下次进入拍照页面时能正确初始化
        console.log('📸 重置摄像头状态，准备下一位用户...');
        if (cameraInitialized) {
            // 不反初始化摄像头，只重置状态标志，保持摄像头流活跃
            // 这样下次进入拍照页面时能更快响应
            console.log('📸 保持摄像头流活跃，重置状态标志');
        }
        
        // 重置用户状态
        this.resetForNextUser();
        
        // 返回首页
        await this.setPage('welcome-page');
        await this.generateWechatQRCode();
        
        console.log('✅ 已返回首页，准备下一位用户');
    }
    
    // 清理扫码获取页面UI
    clearScanToGetPage() {
        const loadingEl = document.getElementById('scan-loading');
        const qrImageEl = document.getElementById('scan-qr-image');
        const countdownEl = document.getElementById('countdown-timer');
        const statusItem = document.getElementById('status-item');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (qrImageEl) {
            qrImageEl.src = '';
            qrImageEl.style.display = 'none';
        }
        if (countdownEl) countdownEl.style.display = 'none';
        if (statusItem) {
            statusItem.className = 'status-item pending';
        }
        
        this.updateScanStatus('pending', '⏳', '等待扫码中...');
    }
    

    showError(message) {
        const modal = document.getElementById('error-modal');
        const messageEl = document.getElementById('error-message');
        
        if (messageEl) messageEl.textContent = message;
        if (modal) modal.style.display = 'flex';
    }

    // 关闭错误提示框
    closeErrorModal() {
        const modal = document.getElementById('error-modal');
        if (modal) modal.style.display = 'none';
    }

    async backToCamera() {
        // 跳转到拍照页面，摄像头已经在首页初始化了
        await this.setPage('profile-page');
    }

    // 确保设备已认证
    async ensureDeviceAuthenticated() {
        try {
            // 检查是否已有认证令牌
            if (window.apiClient && window.apiClient.token) {
                console.log('✅ 设备已认证');
                return;
            }
            
            console.log('⚠️ 设备未认证，开始认证流程...');
            
            // 获取MAC地址用于设备认证
            if (!this.macAddress) {
                await this.getMacAddress();
            }
            
            if (this.macAddress) {
                // 处理MAC地址：去掉冒号，作为设备唯一标识
                const deviceId = this.macAddress.replace(/:/g, '');
                console.log('📱 使用处理后的MAC地址进行设备认证:', this.macAddress, '->', deviceId);
                
                // 执行设备认证
                const authResponse = await window.apiClient.authenticateDevice(deviceId, '衣等舱客户端');
                
                if (authResponse.success) {
                    console.log('✅ 设备认证成功');
                    // 认证成功后，API客户端会自动设置token和deviceId
                    // 从返回的设备信息中获取distributionId字段（如果存在）
                    if (authResponse.device && authResponse.device.distributionId) {
                        console.log('🆔 获取到分销ID:', authResponse.device.distributionId);
                        // 可以在这里存储分销ID到应用状态中
                        this.distributionId = authResponse.device.distributionId;
                    }
                    
                    // 同时保存设备ID
                    if (authResponse.device && authResponse.device.id) {
                        this.deviceId = authResponse.device.id;
                    }
                } else {
                    throw new Error(authResponse.error || '设备认证失败');
                }
            } else {
                throw new Error('无法获取设备MAC地址进行认证');
            }
        } catch (error) {
            console.error('❌ 设备认证失败:', error);
            
            // 检查是否是网络错误，如果是则启用离线模式
            if (error.message.includes('Failed to fetch') || 
                error.message.includes('ERR_NETWORK_CHANGED') ||
                error.message.includes('ERR_INTERNET_DISCONNECTED')) {
                console.warn('🌐 检测到网络错误，启用离线模式');
                if (window.apiClient) {
                    window.apiClient.setOfflineMode(true);
                }
                return {
                    success: false,
                    offline: true,
                    error: '网络连接失败，已启用离线模式'
                };
            }
            
            throw error;
        }
    }

    // 显示离线模式通知
    showOfflineNotification() {
        console.log('🌐 显示离线模式通知');
        
        // 创建离线通知元素
        const offlineNotification = document.createElement('div');
        offlineNotification.id = 'offline-notification';
        offlineNotification.className = 'offline-notification';
        offlineNotification.innerHTML = `
            <div class="offline-content">
                <div class="offline-icon">🌐</div>
                <div class="offline-text">
                    <h3>离线模式</h3>
                    <p>网络连接不可用，部分功能可能受限</p>
                </div>
                <button class="offline-close" onclick="this.parentElement.parentElement.remove()">×</button>
            </div>
        `;
        
        // 添加样式
        const style = document.createElement('style');
        style.textContent = `
            .offline-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                color: white;
                padding: 16px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 300px;
                animation: slideInRight 0.5s ease-out;
            }
            
            .offline-content {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .offline-icon {
                font-size: 24px;
                flex-shrink: 0;
            }
            
            .offline-text h3 {
                margin: 0 0 4px 0;
                font-size: 16px;
                font-weight: 600;
            }
            
            .offline-text p {
                margin: 0;
                font-size: 14px;
                opacity: 0.9;
            }
            
            .offline-close {
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 0;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background-color 0.2s;
                flex-shrink: 0;
            }
            
            .offline-close:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }
            
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        
        document.head.appendChild(style);
        document.body.appendChild(offlineNotification);
        
        // 5秒后自动隐藏
        setTimeout(() => {
            if (offlineNotification.parentElement) {
                offlineNotification.style.animation = 'slideInRight 0.5s ease-out reverse';
                setTimeout(() => {
                    if (offlineNotification.parentElement) {
                        offlineNotification.remove();
                    }
                }, 500);
            }
        }, 5000);
    }

    // 显示离线模式占位符二维码
    showOfflineQRCode() {
        console.log('🌐 显示离线模式占位符二维码');
        
        const qrImg = document.getElementById('wechat-qr-image');
        if (qrImg) {
            // 创建一个SVG占位符二维码
            const svgQRCode = `
                <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="200" fill="#ffffff"/>
                    <rect x="20" y="20" width="160" height="160" fill="#000000" rx="8"/>
                    <rect x="40" y="40" width="120" height="120" fill="#ffffff" rx="4"/>
                    <rect x="60" y="60" width="80" height="80" fill="#000000" rx="2"/>
                    <rect x="80" y="80" width="40" height="40" fill="#ffffff" rx="1"/>
                    <text x="100" y="180" font-family="Arial, sans-serif" font-size="12" fill="#666666" text-anchor="middle">离线模式</text>
                </svg>
            `;
            
            const dataURL = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgQRCode)));
            qrImg.src = dataURL;
            
            // 更新二维码标签
            const qrLabel = document.querySelector('.qr-label');
            if (qrLabel) {
                qrLabel.textContent = '离线模式 - 请检查网络连接';
                qrLabel.style.color = '#ff6b6b';
            }
            
            console.log('✅ 离线模式占位符二维码已显示');
        }
    }
}

// 全局应用状态实例
const appState = new AppState();

// 摄像头相关变量
let cameraVideo = null;
let cameraCanvas = null;
let cameraStream = null;
let cameraInitialized = false;
let cameraRotationDeg = -90;

// DOM加载完成后初始化
document.addEventListener('DOMContentLoaded', async () => {
    console.log('🚀 衣等舱应用开始初始化...');
    
    try {
        // 初始化动态缩放
        initializeResponsiveLayout();
        
        // 1. 先加载配置文件
        console.log('📋 加载配置文件...');
        const cfg = appState.getConfig();
        console.log('📋 配置文件已加载:', cfg);
        
        // 验证配置加载是否成功
        if (cfg && typeof cfg === 'object') {
            console.log('✅ 配置文件加载成功');
            if (cfg.camera && cfg.camera.deviceId) {
                console.log('📸 配置中指定的摄像头设备:', cfg.camera.deviceId);
            } else {
                console.log('📸 配置中未指定摄像头设备，将使用默认设备');
            }
        } else {
            console.warn('⚠️ 配置文件加载失败或格式错误，使用默认配置');
        }
        
        // 2. 初始化API客户端
        if (window.apiClient && typeof window.apiClient.initialize === 'function') {
            await window.apiClient.initialize();
        } else {
            console.error('❌ API客户端未正确初始化或缺少initialize方法');
        }
        
        // 3. 显示欢迎页面（立即显示，不等待异步初始化）
        appState.setPage('welcome-page');
        
        // 4. 异步初始化欢迎页面功能（不阻塞页面显示）
        setTimeout(async () => {
            try {
                console.log('🔄 开始异步初始化欢迎页面功能...');
                await appState.initializeWelcomePage();
                appState.welcomePageInitialized = true; // 标记初始化完成
                console.log('✅ 欢迎页面功能初始化完成');
            } catch (error) {
                console.error('❌ 欢迎页面功能初始化失败:', error);
            }
        }, 100); // 延迟100ms确保页面已显示
        
        console.log('ℹ️ 拍照页再初始化摄像头，首页不再初始化');
        
        console.log('✅ 衣等舱应用初始化完成');
    } catch (error) {
        console.error('❌ 应用初始化失败:', error);
        appState.showError('应用初始化失败: ' + error.message);
    }
});

// 应用退出时反初始化摄像头
window.addEventListener('beforeunload', () => {
    console.log('🚪 应用即将退出，反初始化摄像头...');
    deinitializeCamera();
});

// 初始化响应式布局
function initializeResponsiveLayout() {
    console.log('📐 初始化响应式布局...');
    
    // 计算和应用布局
    function applyLayout() {
        const windowHeight = window.innerHeight;
        const windowWidth = window.innerWidth;
        const app = document.getElementById('app');
        
        if (app) {
            // 高度100%，宽度根据1080*1920比例计算
            const calculatedWidth = windowHeight * 1080 / 1920;
            
            app.style.width = calculatedWidth + 'px';
            app.style.height = windowHeight + 'px';
            
            console.log('📏 窗口尺寸:', windowWidth, 'x', windowHeight);
            console.log('📐 应用尺寸:', calculatedWidth, 'x', windowHeight);
            
            // 设置CSS变量
            document.documentElement.style.setProperty('--scale-factor', 1);
        }
    }
    
    // 初始应用
    applyLayout();
    
    // 监听窗口大小变化
    window.addEventListener('resize', () => {
        applyLayout();
    });
    
    console.log('✅ 响应式布局初始化完成');
}

// 摄像头初始化
async function initializeCamera() {
    console.log('📸 初始化摄像头...');
    
    try {
        cameraVideo = document.getElementById('camera-video');
        cameraCanvas = document.getElementById('camera-canvas');
        
        // 若视频/画布元素未就绪，先启用UI再获取引用（避免时序问题）
        if (!cameraVideo || !cameraCanvas) {
            console.warn('⚠️ 未找到摄像头元素，尝试启用摄像头UI...');
            enableCameraUI();
            cameraVideo = document.getElementById('camera-video');
            cameraCanvas = document.getElementById('camera-canvas');
            if (!cameraVideo || !cameraCanvas) {
                throw new Error('无法找到摄像头元素');
            }
        }
        
        // 使用已加载的配置中的摄像头设备ID
        let preferredDeviceId = null;
        try {
            // 重新获取配置以确保使用最新配置
            const cfg = appState.getConfig();
            preferredDeviceId = cfg && cfg.camera && cfg.camera.deviceId ? cfg.camera.deviceId : null;
            console.log('📸 从配置中读取摄像头设备ID:', preferredDeviceId || '未配置');
        } catch (e) {
            console.log('📸 读取摄像头配置失败，使用默认设备:', e);
        }

        // 目标分辨率：1280x720
        // 注意：相机不支持时由浏览器协商到可用值
        let videoConstraints = {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            aspectRatio: { ideal: 16/9 },
            frameRate: { ideal: 30, max: 30 }
        };
        
        // 如果配置了特定设备ID，使用 exact 约束强制使用该设备
        const hasSpecificDevice = preferredDeviceId && preferredDeviceId.trim() !== '';
        if (hasSpecificDevice) {
            videoConstraints = { ...videoConstraints, deviceId: { exact: preferredDeviceId } };
            console.log('📸 强制使用配置的摄像头设备 (exact):', preferredDeviceId);
        } else {
            videoConstraints = { ...videoConstraints, facingMode: 'user' };
            console.log('📸 使用默认摄像头设备');
        }

		try {
			const requestedConstraints = {
				video: {
					...videoConstraints
				}
			};
			console.log('📤 请求摄像头约束:', requestedConstraints);
			cameraStream = await navigator.mediaDevices.getUserMedia(requestedConstraints);
			console.log('✅ 已获取摄像头流（设备原始比例/默认分辨率）');
			// 初始化成功后立即尝试提升到最大分辨率，以避免绑定后画面跳变
			try { const t = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0]; await upgradeVideoTrackToMax(t); } catch {}
		} catch (e1) {
			// 如果是 NotReadableError，说明设备被占用或硬件问题
			if (e1.name === 'NotReadableError') {
				console.error('❌ 摄像头设备无法启动 (NotReadableError):', e1.message);
				throw new Error('摄像头无法启动。可能原因：\n1. 摄像头被其他应用占用\n2. 摄像头驱动问题\n3. 请关闭其他使用摄像头的应用后重试');
			}
			
			// 如果是 OverconstrainedError，尝试放宽约束
			if (e1.name === 'OverconstrainedError') {
				console.warn('⚠️ 约束过于严格，尝试使用弱约束回退:', e1.message);
				// 如果配置了特定设备，在回退时移除 deviceId
				try {
					const fallbackConstraints = {
						video: {
							width: { min: 1280 },
							height: { min: 720 },
							aspectRatio: { ideal: 16/9 },
							frameRate: { ideal: 30, max: 30 }
						}
					};
					console.log('📤 回退请求摄像头约束（第一层）:', fallbackConstraints);
					cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
					console.log('✅ 第一层回退成功');
				} catch (e2) {
					console.warn('⚠️ 第一层回退失败，尝试第二层回退（仅分辨率要求）:', e2.message);
					// 第二层回退：移除 aspectRatio 约束
					try {
						const fallbackConstraints2 = {
							video: {
								width: { min: 1280 },
								height: { min: 720 },
								frameRate: { ideal: 30, max: 30 }
							}
						};
						console.log('📤 回退请求摄像头约束（第二层）:', fallbackConstraints2);
						cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints2);
						console.log('✅ 第二层回退成功');
					} catch (e3) {
						console.warn('⚠️ 第二层回退失败，尝试第三层回退（仅帧率要求）:', e3.message);
						// 第三层回退：移除所有分辨率约束，仅保留帧率
						try {
							const fallbackConstraints3 = {
								video: {
									frameRate: { ideal: 30, max: 30 }
								}
							};
							console.log('📤 回退请求摄像头约束（第三层）:', fallbackConstraints3);
							cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints3);
							console.log('✅ 第三层回退成功');
						} catch (e4) {
							console.warn('⚠️ 第三层回退失败，尝试最后回退（无约束）:', e4.message);
							// 最后回退：完全不设置约束，使用任何可用摄像头
							const fallbackConstraints4 = {
								video: true
							};
							console.log('📤 回退请求摄像头约束（最后回退）:', fallbackConstraints4);
							cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints4);
							console.log('✅ 最后回退成功');
						}
					}
				}
			} else {
				// 其他错误类型直接抛出
				throw e1;
			}
		}
        
        await bindStreamAndPlay(cameraVideo, cameraStream);
        cameraInitialized = true;
        // 应用预览旋转
        applyCameraPreviewRotation();
        
        // 等待视频元素就绪
        await waitForVideoReady();
        try {
            console.log('📺 预览实际尺寸 videoWidth x videoHeight:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
            try {
                const track = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0];
                const sets = track && track.getSettings ? track.getSettings() : {};
                console.log('📐 首次初始化后的 track settings:', sets);
            } catch {}
        } catch {}

        // 不对摄像头添加任何分辨率约束，使用设备默认最大可用分辨率
        try {
            const track = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0];
            const getSafe = (fn) => { try { return fn(); } catch { return undefined; } };
            console.log('🎛️ capabilities:', getSafe(() => track && track.getCapabilities && track.getCapabilities()));
            console.log('📐 settings:', getSafe(() => track && track.getSettings && track.getSettings()));
        } catch {}
        
        console.log('✅ 摄像头初始化成功');
    } catch (error) {
        console.error('❌ 摄像头初始化失败:', error);
        // 传递错误消息给用户界面
        const errorMsg = error.message || error.toString();
        showCameraError(errorMsg);
    }
}

// 绑定视频流并播放，避免并发打断播放
async function bindStreamAndPlay(videoEl, stream) {
    if (!videoEl) throw new Error('video element missing');
    // 增加版本号，防止并发重入
    if (typeof window.__cameraBindVersion !== 'number') window.__cameraBindVersion = 0;
    const myVersion = ++window.__cameraBindVersion;
    try { videoEl.pause && videoEl.pause(); } catch {}
    try { videoEl.srcObject = null; } catch {}
    videoEl.srcObject = stream;
    try {
        const track = stream && stream.getVideoTracks ? stream.getVideoTracks()[0] : null;
        const sets = track && track.getSettings ? track.getSettings() : {};
        console.log('🔗 绑定流到视频元素', {
            version: myVersion,
            hasStream: !!stream,
            hasTrack: !!track,
            trackState: track ? track.readyState : 'no-track',
            trackSettings: sets
        });
    } catch {}
    // 等待下一帧，确保加载请求提交
    await new Promise(r => setTimeout(r, 0));
    // 仅当没有新的绑定发生时再播放
    if (myVersion === window.__cameraBindVersion) {
        try {
            await (videoEl.play && videoEl.play());
            console.log('▶️ play() 成功');
        } catch (e) {
            console.warn('⚠️ play() 失败:', e && e.message);
        }
    }
}

// 将视频轨道提升到设备支持的最大分辨率（仅在首次绑定成功后执行一次）
async function upgradeVideoTrackToMax(track) {
    try {
        if (!track || !track.getCapabilities || !track.applyConstraints) return;
        // 使用全局 WeakSet 记录已升级的轨道，避免重复提升
        if (!window.__upgradedTracks) window.__upgradedTracks = new WeakSet();
        if (window.__upgradedTracks.has(track)) return;
        const caps = track.getCapabilities();
        const targetHD = { width: 1280, height: 720 };
        const targetFHD = { width: 1920, height: 1080 };

        // 1) 优先 exact 1280x720（若设备允许）
        if (
            caps.width && typeof caps.width.max === 'number' && caps.width.max >= targetHD.width &&
            caps.height && typeof caps.height.max === 'number' && caps.height.max >= targetHD.height
        ) {
            try {
                const consHdExact = { width: { exact: targetHD.width }, height: { exact: targetHD.height } };
                if (caps.frameRate && typeof caps.frameRate.max === 'number') consHdExact.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
                await track.applyConstraints(consHdExact);
                const setsHd = track.getSettings ? track.getSettings() : {};
                console.log('🔧 提升分辨率（exact 1280x720）:', { applied: setsHd });
                window.__upgradedTracks.add(track);
                return;
            } catch (exQhd) {
                console.warn('⚠️ exact 1280x720 失败，尝试 ideal 1280x720 + min 720p:', exQhd && exQhd.message);
            }
        }

        // 2) ideal 1280x720，最低保证 1280x720
        try {
            const consHdIdeal = {
                width: { ideal: Math.min(caps.width?.max || targetHD.width, targetHD.width), min: targetHD.width },
                height: { ideal: Math.min(caps.height?.max || targetHD.height, targetHD.height), min: targetHD.height }
            };
            if (caps.frameRate && typeof caps.frameRate.max === 'number') consHdIdeal.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
            await track.applyConstraints(consHdIdeal);
            const setsHdIdeal = track.getSettings ? track.getSettings() : {};
            console.log('🔧 提升分辨率（ideal 1280x720 + min 720p）:', { requested: consHdIdeal, applied: setsHdIdeal });
            window.__upgradedTracks.add(track);
            return;
        } catch (exQhdIdeal) {
            console.warn('⚠️ ideal 1280x720 失败，尝试 720p:', exQhdIdeal && exQhdIdeal.message);
        }

        // 3) exact 1080p（如允许）
        if (
            caps.width && typeof caps.width.max === 'number' && caps.width.max >= targetFHD.width &&
            caps.height && typeof caps.height.max === 'number' && caps.height.max >= targetFHD.height
        ) {
            try {
                const consFhdExact = { width: { exact: targetFHD.width }, height: { exact: targetFHD.height } };
                if (caps.frameRate && typeof caps.frameRate.max === 'number') consFhdExact.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
                await track.applyConstraints(consFhdExact);
                const setsExact1080 = track.getSettings ? track.getSettings() : {};
                console.log('🔧 提升分辨率（exact 1080p）:', { applied: setsExact1080 });
                window.__upgradedTracks.add(track);
                return;
            } catch (ex1080) {
                console.warn('⚠️ exact 1080p 失败，尝试 ideal 1080p:', ex1080 && ex1080.message);
            }
        }

        // 4) ideal 720p
        try {
            const idealCons = {
                width: { ideal: Math.min(caps.width?.max || targetHD.width, targetHD.width), min: targetHD.width },
                height: { ideal: Math.min(caps.height?.max || targetHD.height, targetHD.height), min: targetHD.height }
            };
            if (caps.frameRate && typeof caps.frameRate.max === 'number') idealCons.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
            await track.applyConstraints(idealCons);
            const setsIdeal720 = track.getSettings ? track.getSettings() : {};
            console.log('🔧 提升分辨率（ideal 720p）:', { requested: idealCons, applied: setsIdeal720 });
            window.__upgradedTracks.add(track);
            return;
        } catch (exIdeal) {
            console.warn('⚠️ ideal 720p 失败:', exIdeal && exIdeal.message);
        }

        // 最后：按设备最大能力提升（best effort）
        const consMax = {};
        if (caps.width && typeof caps.width.max === 'number') consMax.width = { ideal: caps.width.max };
        if (caps.height && typeof caps.height.max === 'number') consMax.height = { ideal: caps.height.max };
        if (caps.frameRate && typeof caps.frameRate.max === 'number') consMax.frameRate = { ideal: Math.min(30, caps.frameRate.max) };
        if (Object.keys(consMax).length > 0) {
            await track.applyConstraints(consMax);
            const setsMax = track.getSettings ? track.getSettings() : {};
            console.log('🔧 提升分辨率（设备max）:', { requested: consMax, applied: setsMax });
        }
        try { window.__upgradedTracks.add(track); } catch {}
    } catch (e) {
        console.warn('⚠️ 提升到最大分辨率失败（忽略）:', e && e.message);
    }
}

// 确保摄像头已就绪并展示UI（供拍照页复用）
async function ensureCameraReadyAndShowUI() {
    try {
        // 已初始化且轨道存活则直接展示UI
        if (cameraInitialized && cameraStream && cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0] && cameraStream.getVideoTracks()[0].readyState === 'live') {
            console.log('✅ 摄像头已初始化且存活，直接启用UI');
            await enableCameraUI();
            cameraVideo = document.getElementById('camera-video') || cameraVideo;
            if (cameraVideo) {
                await bindStreamAndPlay(cameraVideo, cameraStream);
                // 仅在绑定成功后执行一次最大分辨率提升
                // 绑定后不再重复提升，避免多次变化（upgradeVideoTrackToMax 内部已做一次性保护）
                try { const t = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0]; await upgradeVideoTrackToMax(t); } catch {}
                applyCameraPreviewRotation();
                // 重试等待就绪，最多3次
                for (let i = 0; i < 3; i++) {
                    try {
                        await waitForVideoReady();
                        console.log('📺 拍照页预览尺寸:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
                        break;
                    } catch (e) {
                        console.warn('⚠️ 拍照页等待视频就绪重试', i + 1, e && e.message);
                        await new Promise(r => setTimeout(r, 200));
                    }
                }
            }
            return true;
        }
        // 否则执行初始化
        console.log('⚠️ 摄像头未就绪，开始初始化...');
        await initializeCamera();
        if (cameraInitialized && cameraStream) {
            await enableCameraUI();
            cameraVideo = document.getElementById('camera-video') || cameraVideo;
            if (cameraVideo) {
                await bindStreamAndPlay(cameraVideo, cameraStream);
                try { const t = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0]; await upgradeVideoTrackToMax(t); } catch {}
                applyCameraPreviewRotation();
                for (let i = 0; i < 3; i++) {
                    try {
                        await waitForVideoReady();
                        console.log('📺 拍照页初始化后预览尺寸:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
                        break;
                    } catch (e) {
                        console.warn('⚠️ 拍照页初始化后等待就绪重试', i + 1, e && e.message);
                        await new Promise(r => setTimeout(r, 200));
                    }
                }
            }
            return true;
        }
        return false;
    } catch (e) {
        console.error('❌ ensureCameraReadyAndShowUI 失败:', e);
        return false;
    }
}

// 等待视频元素就绪
function waitForVideoReady() {
    return new Promise((resolve, reject) => {
        if (!cameraVideo) {
            console.error('❌ waitForVideoReady: 视频元素不存在');
            reject(new Error('视频元素不存在'));
            return;
        }
        
        // 如果已经就绪，直接返回
        if (cameraVideo.readyState >= 2) {
            console.log('📸 视频元素已就绪，readyState:', cameraVideo.readyState);
            resolve();
            return;
        }
        
        console.log('📸 等待视频元素就绪，当前readyState:', cameraVideo.readyState);
        
        // 设置超时
        const timeout = setTimeout(() => {
            try {
                const srcObj = cameraVideo.srcObject;
                const track = srcObj && srcObj.getVideoTracks ? srcObj.getVideoTracks()[0] : null;
                const trackSettings = track && track.getSettings ? track.getSettings() : {};
                const trackState = track ? track.readyState : 'no-track';
                console.warn('⚠️ 等待视频元素就绪超时', {
                    videoExists: !!cameraVideo,
                    readyState: cameraVideo.readyState,
                    videoSize: { w: cameraVideo.videoWidth, h: cameraVideo.videoHeight },
                    hasSrcObject: !!srcObj,
                    trackState,
                    trackSettings
                });
            } catch {}
            reject(new Error('视频元素就绪超时'));
        }, 5000); // 5秒超时
        
        // 监听视频元数据加载完成
        const onLoadedMetadata = () => {
            clearTimeout(timeout);
            cameraVideo.removeEventListener('loadedmetadata', onLoadedMetadata);
            console.log('✅ 视频元素就绪，readyState:', cameraVideo.readyState);
            resolve();
        };
        
        cameraVideo.addEventListener('loadedmetadata', onLoadedMetadata);
    });
}

// 启用摄像头UI
async function enableCameraUI() {
    const cameraContainer = document.querySelector('.camera-container');
    if (cameraContainer) {
        // 若已有video元素，避免重建造成引用丢失；否则才插入UI结构
        let existingVideo = document.getElementById('camera-video');
        if (!existingVideo) {
            cameraContainer.innerHTML = `
                <video id="camera-video" autoplay playsinline muted></video>
                <canvas id="camera-canvas" style="display: none;"></canvas>
                <div class="camera-overlay">
                    <div class="camera-instructions">
                        <h3>请站在摄像头前拍摄全身照</h3>
                        <p>确保全身都在画面中</p>
                    </div>
                    <button class="generate-button floating" onclick="generateTryOn()" id="generate-btn">
                        拍照
                    </button>
                </div>`;
        }

        // 绑定/更新引用并确保流绑定与就绪
        cameraVideo = document.getElementById('camera-video');
        cameraCanvas = document.getElementById('camera-canvas');
        if (cameraVideo && cameraStream) {
            await bindStreamAndPlay(cameraVideo, cameraStream);
            applyCameraPreviewRotation();
            console.log('✅ 摄像头UI已启用并恢复');
            // 等待就绪并打印尺寸，若异常尺寸则短延迟重试一次
            (async () => {
                let ok = false;
                for (let i = 0; i < 3; i++) {
                    try { await waitForVideoReady(); ok = true; break; } catch { await new Promise(r => setTimeout(r, 150)); }
                }
                try {
                    console.log('📺 拍照页预览尺寸:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
                    if (ok && (cameraVideo.videoWidth < 100 || cameraVideo.videoHeight < 100)) {
                        console.warn('⚠️ 预览尺寸异常，尝试重新绑定流');
                        await bindStreamAndPlay(cameraVideo, cameraStream);
                        applyCameraPreviewRotation();
                        await waitForVideoReady().catch(() => {});
                        console.log('📺 重新绑定后预览尺寸:', cameraVideo.videoWidth, 'x', cameraVideo.videoHeight);
                    }
                } catch {}
            })();
        } else {
            console.error('❌ 摄像头UI恢复失败:', {
                cameraVideo: !!cameraVideo,
                cameraStream: !!cameraStream
            });
        }
    }
}

// 预览旋转：将视频元素按 cameraRotationDeg 旋转（CSS，不影响拍照渲染）
function applyCameraPreviewRotation() {
    try {
        const video = document.getElementById('camera-video');
        if (!video) return;
        // 逆时针 90°：设置 cameraRotationDeg = -90 或按需设置
        video.style.transformOrigin = 'center center';
        // 预览保持镜像（自拍体验更自然）+ 旋转角度
        video.style.transform = 'scaleX(-1) rotate(' + cameraRotationDeg + 'deg)';
        // 若需要在旋转后铺满可视区域，可按容器尺寸额外调整 scale，这里保留默认
    } catch (e) { console.error('应用预览旋转失败:', e); }
}

// 提供全局函数以便外部快速设置旋转角度，并立即作用于预览
window.setCameraRotation = function(deg) {
    try {
        cameraRotationDeg = Number(deg) || 0;
        applyCameraPreviewRotation();
    } catch (e) { console.error('设置预览旋转失败:', e); }
};

function showCameraError(errorMessage) {
    const cameraContainer = document.querySelector('.camera-container');
    if (cameraContainer) {
        const message = errorMessage || '请检查摄像头权限或刷新页面重试';
        // 将换行符转换为 <br> 标签
        const formattedMessage = message.replace(/\n/g, '<br>');
        cameraContainer.innerHTML = `<div class="camera-error"><h3>摄像头无法启动</h3><p>${formattedMessage}</p><button onclick="location.reload()">刷新页面</button></div>`;
    }
}

// 检查摄像头流状态
function checkCameraStreamStatus() {
    if (!cameraStream) {
        console.log('❌ 摄像头流不存在');
        return false;
    }
    
    const tracks = cameraStream.getTracks();
    if (tracks.length === 0) {
        console.log('❌ 摄像头流没有轨道');
        return false;
    }
    
    const videoTrack = tracks.find(track => track.kind === 'video');
    if (!videoTrack) {
        console.log('❌ 摄像头流没有视频轨道');
        return false;
    }
    
    if (videoTrack.readyState !== 'live') {
        console.log('❌ 摄像头视频轨道状态不是live:', videoTrack.readyState);
        return false;
    }
    
    // 检查视频元素是否正常显示
    if (cameraVideo && cameraVideo.readyState < 2) {
        console.log('❌ 视频元素未就绪，readyState:', cameraVideo.readyState);
        return false;
    }
    
    // 显示当前使用的摄像头设备信息
    const settings = videoTrack.getSettings();
    console.log('✅ 摄像头流状态正常，当前使用设备:', {
        deviceId: settings.deviceId,
        label: videoTrack.label,
        width: settings.width,
        height: settings.height,
        videoReadyState: cameraVideo ? cameraVideo.readyState : 'N/A'
    });
    
    return true;
}

// 验证当前摄像头是否与配置一致
function verifyCameraConfig() {
    try {
        const cfg = appState.getConfig();
        const configuredDeviceId = cfg?.camera?.deviceId;
        
        if (!configuredDeviceId) {
            console.log('📸 配置中未指定摄像头设备，使用默认设备');
            return true;
        }
        
        if (!cameraStream) {
            console.log('❌ 摄像头流不存在，无法验证配置');
            return false;
        }
        
        const videoTrack = cameraStream.getTracks().find(track => track.kind === 'video');
        if (!videoTrack) {
            console.log('❌ 没有视频轨道，无法验证配置');
            return false;
        }
        
        const settings = videoTrack.getSettings();
        const currentDeviceId = settings.deviceId;
        
        if (currentDeviceId === configuredDeviceId) {
            console.log('✅ 摄像头配置验证通过，使用配置的设备:', configuredDeviceId);
            return true;
        } else {
            console.warn('⚠️ 摄像头配置不匹配:', {
                configured: configuredDeviceId,
                current: currentDeviceId
            });
            return false;
        }
    } catch (error) {
        console.error('❌ 验证摄像头配置失败:', error);
        return false;
    }
}

// 反初始化摄像头
function deinitializeCamera() {
    console.log('📸 反初始化摄像头...');
    
    try {
        // 停止摄像头流
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => {
                track.stop();
                console.log('🛑 停止摄像头轨道:', track.kind);
            });
            cameraStream = null;
        }
        
        // 清理视频元素
        if (cameraVideo) {
            cameraVideo.srcObject = null;
        }
        
        // 重置状态
        cameraInitialized = false;
        
        console.log('✅ 摄像头反初始化完成');
    } catch (error) {
        console.error('❌ 摄像头反初始化失败:', error);
    }
}

// 拍照功能 - 不上传，只保存到本地
async function capturePhoto() {
    if (!cameraVideo || !cameraCanvas) {
        console.error('摄像头未初始化');
        return;
    }

    try {
        // 原始视频尺寸（横屏）
        const videoWidth = cameraVideo.videoWidth;
        const videoHeight = cameraVideo.videoHeight;

        const rot = ((cameraRotationDeg % 360) + 360) % 360; // 归一化到 [0,360)
        const isQuarterTurn = rot === 90 || rot === 270; // 仅±90°时交换宽高

        // 画布尺寸：当旋转±90°时，交换宽高得到竖屏；其它角度按原尺寸
        cameraCanvas.width = isQuarterTurn ? videoHeight : videoWidth;
        cameraCanvas.height = isQuarterTurn ? videoWidth : videoHeight;

        const ctx = cameraCanvas.getContext('2d');
        ctx.save();

        // 将坐标系移动到画布中心，按旋转角度旋转（与预览一致，使用 cameraRotationDeg）
        ctx.translate(cameraCanvas.width / 2, cameraCanvas.height / 2);
        ctx.rotate((cameraRotationDeg * Math.PI) / 180);

        // 把原始视频帧绘制到以中心为原点的坐标系中，确保完整画面
        ctx.drawImage(
            cameraVideo,
            -videoWidth / 2,
            -videoHeight / 2,
            videoWidth,
            videoHeight
        );

        ctx.restore();

        // 获取完整照片数据
        const fullPhotoData = cameraCanvas.toDataURL('image/jpeg', 0.8);

        // 统一时间戳，命名原图与裁剪图
        const timestamp = Date.now();
        const originalPhotoFileName = 'photo_' + timestamp + '_original.jpg';
        const croppedPhotoFileName = 'photo_' + timestamp + '.jpg';

        // 创建裁剪后的照片（720x1024）
        const croppedPhotoData = await cropPhotoTo720x1024(fullPhotoData);

        // 保存到应用状态
        appState.userProfile.photo = croppedPhotoData; // 使用裁剪后的照片
        appState.userProfile.photoFileName = croppedPhotoFileName;
        appState.userProfile.originalPhotoFileName = originalPhotoFileName;

        // 保存原始照片到本地uploads文件夹
        try {
            await savePhotoToUploads(fullPhotoData, originalPhotoFileName);
            console.log('✅ 原始照片已保存到uploads文件夹:', originalPhotoFileName);
        } catch (saveOriginalError) {
            console.warn('⚠️ 保存原始照片到uploads文件夹失败:', saveOriginalError);
        }

        // 保存裁剪后的照片到本地uploads文件夹
        try {
            await savePhotoToUploads(croppedPhotoData, croppedPhotoFileName);
            console.log('✅ 裁剪照片已保存到uploads文件夹:', croppedPhotoFileName);
        } catch (saveCroppedError) {
            console.warn('⚠️ 保存裁剪照片到uploads文件夹失败:', saveCroppedError);
        }
        
        console.log('照片拍摄和裁剪成功，尺寸：720x1024');
        return croppedPhotoData;
    } catch (error) {
        console.error('拍照失败:', error);
        return null;
    }
}

// 新的拍照流程：带倒计时，拍照后跳转到确认页面
async function capturePhotoWithCountdown() {
    const captureBtn = document.getElementById('capture-btn');
    if (!captureBtn) {
        console.error('未找到拍照按钮');
        return;
    }

    // 禁用按钮
    captureBtn.disabled = true;
    captureBtn.style.pointerEvents = 'none';
    captureBtn.classList.add('countdown');
    
    let countdown = 5;
    
    // 更新按钮文本
    const updateButtonText = () => {
        captureBtn.textContent = '拍摄倒计时 ' + countdown + ' 秒';
    };
    
    // 初始显示
    updateButtonText();
    
    // 倒计时动画效果
    const countdownInterval = setInterval(() => {
        countdown--;
        
        if (countdown > 0) {
            updateButtonText();
            
            // 添加脉冲动画效果
            captureBtn.style.transform = 'translateX(-50%) scale(1.1)';
            setTimeout(() => {
                captureBtn.style.transform = 'translateX(-50%) scale(1)';
            }, 150);
        } else {
            // 倒计时结束，开始拍照
            clearInterval(countdownInterval);
            captureBtn.classList.remove('countdown');
            captureBtn.textContent = '正在拍摄...';
            
            // 延迟一点时间让用户看到"正在拍摄"的提示
            setTimeout(async () => {
                try {
                    // 拍照（不上传）
                    const photoData = await capturePhoto();
                    if (!photoData) {
                        appState.showError('拍照失败，请重试');
                        resetCaptureButton();
                        return;
                    }

                    // 保存照片数据到状态
                    appState.capturedPhotoData = photoData;
                    
                    // 显示拍照确认页面
                    const capturedPhoto = document.getElementById('captured-photo');
                    if (capturedPhoto) {
                        capturedPhoto.src = photoData;
                    }
                    
                    // 切换到拍照确认页面
                    await appState.setPage('photo-confirm-page');
                    
                    // 重置按钮状态
                    resetCaptureButton();
                } catch (error) {
                    console.error('拍照流程错误:', error);
                    appState.showError('拍照失败，请检查摄像头权限');
                    resetCaptureButton();
                }
            }, 300);
        }
    }, 1000);
}

// 重置拍照按钮状态
function resetCaptureButton() {
    const captureBtn = document.getElementById('capture-btn');
    if (captureBtn) {
        captureBtn.disabled = false;
        captureBtn.style.pointerEvents = 'auto';
        captureBtn.textContent = '拍照';
        captureBtn.style.transform = 'translateX(-50%)';
        captureBtn.classList.remove('countdown');
    }
}

// 裁剪照片为720x1024尺寸
function cropPhotoTo720x1024(photoDataUrl) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
            // 创建裁剪画布
            const cropCanvas = document.createElement('canvas');
            const cropCtx = cropCanvas.getContext('2d');
            
            // 设置目标尺寸
            const targetWidth = 720;
            const targetHeight = 1024;
            cropCanvas.width = targetWidth;
            cropCanvas.height = targetHeight;
            
            // 获取原始图片尺寸
            const srcWidth = img.width;
            const srcHeight = img.height;
            
            console.log('原始图片尺寸: ' + srcWidth + 'x' + srcHeight);
            console.log('目标尺寸: ' + targetWidth + 'x' + targetHeight);
            
            // 策略：保证输出高度一致为 1024。
            // 1) 以高度为基准进行等比缩放，得到 scaledWidth。
            // 2) 若 scaledWidth >= 720：水平居中裁剪到 720 宽（不会出现黑边）。
            // 3) 若 scaledWidth < 720：允许左右留黑边，将缩放后的图像居中放置在 720x1024 画布上。

            // 填充黑色背景，确保不足时出现黑边
            cropCtx.fillStyle = '#000';
            cropCtx.fillRect(0, 0, targetWidth, targetHeight);

            const scale = targetHeight / srcHeight;
            const scaledWidth = srcWidth * scale;

            if (scaledWidth >= targetWidth) {
                // 宽度足够：放大到以高度为准，超出的部分裁掉（水平中心裁剪）
                const drawX = (targetWidth - scaledWidth) / 2; // 负值，超出会被画布裁剪
                cropCtx.drawImage(
                    img,
                    0, 0, srcWidth, srcHeight,
                    drawX, 0, scaledWidth, targetHeight
                );
            } else {
                // 宽度不足：允许黑边，水平居中放置缩放后的图像
                const offsetX = (targetWidth - scaledWidth) / 2;
                cropCtx.drawImage(
                    img,
                    0, 0, srcWidth, srcHeight,
                    offsetX, 0, scaledWidth, targetHeight
                );
            }
            
            // 转换为 base64
            const croppedDataUrl = cropCanvas.toDataURL('image/jpeg', 0.8);
            console.log('照片裁剪完成，新尺寸: 720x1024');
            
            resolve(croppedDataUrl);
        };
        
        img.onerror = function() {
            console.error('图片加载失败，返回原始数据');
            resolve(photoDataUrl); // 如果失败，返回原始数据
        };
        
        img.src = photoDataUrl;
    });
}

// 修改generateTryOn函数，使用摄像头拍照
function generateTryOn() {
    // 检查摄像头是否就绪
    try {
        if (!cameraVideo || !cameraCanvas) {
            // 懒加载获取一次，避免首次为 null
            cameraVideo = document.getElementById('camera-video');
            cameraCanvas = document.getElementById('camera-canvas');
        }

        if (!cameraInitialized || !cameraVideo || !cameraVideo.srcObject) {
            appState.showError('摄像头未就绪，请允许摄像头权限或稍后重试');
            return;
        }

        // 开始5秒倒计时
        startCountdown();
    } catch (e) {
        console.error('generateTryOn 执行错误:', e);
        appState.showError('拍照失败，请检查摄像头权限');
    }
}

// 开始倒计时
function startCountdown() {
    const generateBtn = document.getElementById('generate-btn');
    if (!generateBtn) return;

    // 禁用按钮并添加倒计时样式
    generateBtn.disabled = true;
    generateBtn.style.pointerEvents = 'none';
    generateBtn.classList.add('countdown');
    
    let countdown = 5;
    
    // 更新按钮文本
    const updateButtonText = () => {
        generateBtn.textContent = '拍摄倒计时 ' + countdown + ' 秒';
    };
    
    // 初始显示
    updateButtonText();
    
    // 倒计时动画效果
    const countdownInterval = setInterval(() => {
        countdown--;
        
        if (countdown > 0) {
            updateButtonText();
            
            // 添加脉冲动画效果
            generateBtn.style.transform = 'translateX(-50%) scale(1.1)';
            setTimeout(() => {
                generateBtn.style.transform = 'translateX(-50%) scale(1)';
            }, 150);
        } else {
            // 倒计时结束，开始拍照
            clearInterval(countdownInterval);
            generateBtn.classList.remove('countdown');
            generateBtn.textContent = '正在拍摄...';
            
            // 延迟一点时间让用户看到"正在拍摄"的提示
            setTimeout(() => {
                takePhoto();
            }, 300);
        }
    }, 1000);
}

// 执行拍照
async function takePhoto() {
    try {
        const photoData = await capturePhoto();
        if (!photoData) {
            appState.showError('拍照失败，请重试');
            resetGenerateButton();
            return;
        }

        uploadPhotoToServer(photoData);
    } catch (e) {
        console.error('拍照执行错误:', e);
        appState.showError('拍照失败，请检查摄像头权限');
        resetGenerateButton();
    }
}

// 重置按钮状态
function resetGenerateButton() {
    const generateBtn = document.getElementById('generate-btn');
    if (generateBtn) {
        generateBtn.disabled = false;
        generateBtn.style.pointerEvents = 'auto';
        generateBtn.textContent = '拍照';
        generateBtn.style.transform = 'translateX(-50%)';
        generateBtn.classList.remove('countdown');
    }
}

// 上传照片到服务器和RunningHub
async function uploadPhotoToServer(photoData) {
    try {
        appState.showLoading('正在上传照片（720x1024尺寸）...');
        
        // 将base64转换为Blob
        const response = await fetch(photoData);
        const blob = await response.blob();
        
        console.log('上传照片信息: 尺寸 720x1024, 文件大小: ' + blob.size + ' bytes');
        
        // 确保API客户端存在
        if (!window.apiClient) {
            console.log('❌ window.apiClient 不存在，创建新的API客户端实例...');
            if (typeof window.ApiClient === 'function') {
                window.apiClient = new window.ApiClient();
                console.log('✅ 新的API客户端实例创建成功');
            } else {
                console.error('❌ 无法创建新的API客户端实例，window.ApiClient类型:', typeof window.ApiClient);
                throw new Error('无法创建API客户端实例');
            }
        }
        
        // 确保API客户端已初始化
        if (!window.apiClient.initialized) {
            console.log('🔄 API客户端尚未初始化，执行初始化...');
            try {
                if (typeof window.apiClient.initialize === 'function') {
                    await window.apiClient.initialize();
                    console.log('✅ API客户端初始化完成');
                } else {
                    console.error('❌ API客户端缺少initialize方法');
                    throw new Error('API客户端初始化方法缺失');
                }
            } catch (initError) {
                console.error('❌ API客户端初始化失败:', initError);
                throw new Error('API客户端初始化失败: ' + initError.message);
            }
        }
        
        // // 强制设置正确的API服务器地址（修复端口配置问题）
        // const expectedBaseUrl = 'https://clothing-api.0086studios.xyz';
        // if (window.apiClient && window.apiClient.baseUrl !== expectedBaseUrl) {
        //     console.log('🔧 修复API客户端地址配置:', window.apiClient.baseUrl, '->', expectedBaseUrl);
        //     window.apiClient.baseUrl = expectedBaseUrl;
        // }
        
        // 检查设备是否已认证，如果未认证则尝试认证
        if (!window.apiClient.token) {
            console.log('⚠️ 设备未认证，尝试进行设备认证...');
            try {
                // 获取MAC地址用于设备认证
                let macAddress = appState.macAddress;
                if (!macAddress) {
                    console.log('🔍 尝试获取设备MAC地址...');
                    await appState.getMacAddress();
                    macAddress = appState.macAddress;
                }
                
                if (macAddress) {
                    // 处理MAC地址：去掉冒号作为设备唯一标识
                    const deviceId = macAddress.replace(/:/g, '');
                    console.log('📱 使用处理后的MAC地址进行设备认证:', macAddress, '->', deviceId);
                    const authResponse = await window.apiClient.authenticateDevice(deviceId, '衣等舱客户端');
                    if (authResponse.success) {
                        console.log('✅ 设备认证成功，获得token:', authResponse.token ? '***' : '无');
                    } else {
                        throw new Error(authResponse.error || '设备认证失败');
                    }
                } else {
                    throw new Error('无法获取设备MAC地址进行认证');
                }
            } catch (authError) {
                console.error('❌ 设备认证失败:', authError);
                throw new Error('设备认证失败: ' + authError.message);
            }
        }
        
        // 最终检查API客户端状态
        if (!window.apiClient || !window.apiClient.token) {
            const errorMsg = !window.apiClient ? 'API客户端未初始化' : '设备未认证';
            console.error('❌ API客户端状态检查失败:', errorMsg);
            throw new Error('API客户端未初始化或未认证，请先完成设备认证');
        }
        
        // 检查用户是否已关注微信公众号
        console.log('🔍 检查用户是否已关注微信公众号...');
        let isSubscribed = false;
        
        // 开发模式跳过登录时，不检查微信关注状态
        if (appState.devModeSkippedLogin) {
            console.log('✅ 开发模式：跳过微信关注状态检查');
            isSubscribed = true;
        } else {
            try {
                // 使用二维码场景值检查用户关注状态
                if (appState.qrSceneStr && window.apiClient) {
                    const response = await window.apiClient.checkWechatStatus(appState.qrSceneStr);
                    console.log('🔍 微信状态检查响应:', response);
                    
                    // 检查是否已关注（兼容isSubscribed和isVerified两种字段）
                    isSubscribed = response.isSubscribed || response.isVerified;
                    
                    if (response.success && isSubscribed) {
                        console.log('✅ 用户已关注微信公众号');
                    } else {
                        console.log('⚠️ 用户尚未关注微信公众号');
                    }
                }
            } catch (wechatError) {
                console.error('❌ 检查微信关注状态失败:', wechatError);
            }
            
            // 如果用户未关注公众号，提示用户先关注
            if (!isSubscribed) {
                throw new Error('请先微信扫码关注公众号完成验证');
            }
        }
        
        console.log('开始上传裁剪后的照片到 API Server...');
        // 添加调试信息
        console.log('调试信息 - appState.qrSceneStr:', appState.qrSceneStr);
        console.log('调试信息 - appState:', appState);
        
        // 上传用户照片，新接口会直接创建任务并返回任务ID
        // 传递sceneStr参数以关联微信用户和任务
        const uploadResponse = await window.apiClient.uploadPhoto(blob, appState.qrSceneStr);
        console.log('照片上传结果:', uploadResponse);
        
        if (!uploadResponse.success) {
            throw new Error(uploadResponse.error || '照片上传失败');
        }
        
        // 保存任务ID（新接口直接返回任务ID）
        appState.currentTaskId = uploadResponse.data.taskId;
        console.log('✅ 照片上传成功，任务ID:', appState.currentTaskId);
        
        appState.hideLoading();
        
        // 重置按钮状态
        resetGenerateButton();
        
        // 反初始化摄像头，释放资源
        deinitializeCamera();
        
        // 跳转到服装选择页面
        await appState.setPage('clothing-page');
        
    } catch (error) {
        console.error('上传照片错误:', error);
        appState.hideLoading();
        appState.showError('照片上传失败: ' + error.message);
        
        // 出错时也要重置按钮状态
        resetGenerateButton();
        
        // 出错时也要反初始化摄像头
        deinitializeCamera();
    }
}

function backToCamera() {
    appState.backToCamera();
}

// 添加goBack函数，用于返回上一页
function goBack() {
    // 根据当前页面决定返回到哪个页面
    switch(appState.currentPage) {
        case 'clothing-page':
            // 从服装选择页返回到个人信息页
            appState.setPage('profile-page');
            break;
        case 'results-page':
            // 从结果页返回到服装选择页
            appState.setPage('clothing-page');
            break;
        case 'style-page':
            // 从风格页返回到结果页
            appState.setPage('results-page');
            break;
        case 'config-page':
            // 从配置页返回到欢迎页
            appState.setPage('welcome-page');
            break;
        default:
            // 默认返回到欢迎页
            appState.setPage('welcome-page');
            break;
    }
}

// 添加proceedToFitting函数
function proceedToFitting() {
    appState.startFittingProcess();
}

// 创建全局函数，供HTML中直接调用
window.startExperience = function() {
    appState.startExperience();
};

window.openConfigPage = function() {
    appState.openConfigPage();
};

// 添加手动刷新二维码的全局函数
window.refreshWechatQRCode = function() {
    appState.refreshWechatQRCode();
};

// 新增：以对话框形式打开/关闭配置
window.openConfig = function() {
    try {
        const modal = document.getElementById('config-modal');
        if (modal) {
            modal.style.display = 'flex';
            if (typeof loadConfigIntoForm === 'function') loadConfigIntoForm();
            if (typeof initializeDeviceInfo === 'function') initializeDeviceInfo();
            if (typeof refreshCameraList === 'function') refreshCameraList();
        }
    } catch (e) { console.error(e); }
};

window.closeConfig = function() {
    const modal = document.getElementById('config-modal');
    if (modal) modal.style.display = 'none';
    // 关闭配置后回到首页
    if (window.appState && typeof window.appState.setPage === 'function') {
        window.appState.setPage('welcome-page');
    }
};

// 添加关闭错误提示框的全局函数
window.closeErrorModal = function() {
    const modal = document.getElementById('error-modal');
    if (modal) modal.style.display = 'none';
};

// 添加刷新设备状态的全局函数
window.refreshDeviceStatus = function() {
    appState.refreshDeviceStatus();
};

// 添加goBack和proceedToFitting的全局函数
window.goBack = goBack;
window.proceedToFitting = async function() {
    try {
        console.log('🚀 开始试衣流程...');
        const resultUrl = await appState.startFittingProcess();
        console.log('✅ 试衣流程完成:', resultUrl);
    } catch (error) {
        console.error('❌ 试衣流程失败:', error);
    }
};

// 添加保存图片的全局函数
window.saveImage = function() {
    appState.saveImage();
};

// 添加扫码获取图片页面的全局函数
window.goBackToResult = function() {
    appState.setPage('results-page');
};

window.refreshScanQrCode = function() {
    appState.refreshScanQrCode();
};

window.goBackToHome = function() {
    appState.returnToHomeFromScan();
};

// 添加测试API服务器连接的全局函数
window.testApiServerConnection = async function() {
    try {
        console.log('🔍 开始测试API服务器连接...');
        
        // 获取输入的API服务器地址
        const input = document.getElementById('cfg-api-server-url');
        let testUrl = input ? input.value.trim() : '';
        
        // 如果没有输入，使用当前的baseUrl
        if (!testUrl) {
            testUrl = window.apiClient ? window.apiClient.baseUrl : 'https://clothing-api.0086studios.xyz';
        }
        
        console.log('🎯 测试目标:', testUrl);
        
        // 显示加载状态
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '测试中...';
        button.disabled = true;
        
        // 发送测试请求
        const response = await fetch(`${testUrl}/health`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        // 恢复按钮状态
        button.textContent = originalText;
        button.disabled = false;
        
        if (response.ok) {
            console.log('✅ 连接成功:', data);
            alert(`✅ 连接成功！

服务器: ${testUrl}
状态: ${data.status}
时间: ${data.timestamp || '未知'}`);
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('❌ 连接失败:', error);
        
        // 恢复按钮状态
        if (event && event.target) {
            event.target.textContent = '测试API服务器连接';
            event.target.disabled = false;
        }
        
        let errorMessage = '❌ 连接失败！\n\n';
        
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            errorMessage += '错误: 无法连接到服务器\n\n可能原因：\n';
            errorMessage += '1. 服务器未启动\n';
            errorMessage += '2. 地址错误\n';
            errorMessage += '3. 网络问题\n';
            errorMessage += '4. 防火墙阻止';
        } else {
            errorMessage += `错误: ${error.message}`;
        }
        
        alert(errorMessage);
    }
};

// ================= 配置表单 & 设备信息 =================
function loadConfigIntoForm() {
    try {
        const cfg = appState.getConfig();
        const get = (id) => document.getElementById(id);
        // API服务器
        if (get('cfg-api-server-url')) get('cfg-api-server-url').value = cfg.apiServerUrl || appState.apiServerUrl || '';
        // 设备
        if (get('cfg-device-mac')) get('cfg-device-mac').value = appState.macAddress || cfg.device?.mac || '';
        if (get('cfg-camera-device') && cfg.camera?.deviceId) get('cfg-camera-device').value = cfg.camera.deviceId;
    } catch (e) { console.error('加载配置到表单失败:', e); }
}

async function initializeDeviceInfo() {
    try {
        await appState.getMacAddress();
        const macInput = document.getElementById('cfg-device-mac');
        if (macInput) macInput.value = appState.macAddress || '';
        await refreshCameraList();
    } catch (e) { console.error('初始化设备信息失败:', e); }
}

async function refreshMacAddress() {
    try {
        await appState.getMacAddress();
        const macInput = document.getElementById('cfg-device-mac');
        if (macInput) macInput.value = appState.macAddress || '';
    } catch (e) { console.error('刷新MAC失败:', e); }
}

async function refreshCameraList() {
    try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
            throw new Error('当前环境不支持枚举媒体设备');
        }
        const select = document.getElementById('cfg-camera-device');
        if (!select) return;
        select.innerHTML = '<option value="">正在加载摄像头设备...</option>';
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoInputs = devices.filter(d => d.kind === 'videoinput');
        select.innerHTML = '';
        const cfg = appState.getConfig();
        const savedId = cfg.camera?.deviceId;
        console.log('📸 配置中保存的摄像头设备ID:', savedId || '未配置');
        
        videoInputs.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.textContent = d.label || ('摄像头 ' + (select.options.length + 1));
            if (savedId && d.deviceId === savedId) {
                opt.selected = true;
                console.log('📸 选中配置的摄像头:', d.label || d.deviceId);
            }
            select.appendChild(opt);
        });
        
        // 如果没有选中的摄像头，选择第一个可用的
        if (!select.value && videoInputs[0]) {
            select.value = videoInputs[0].deviceId;
            console.log('📸 自动选择第一个摄像头:', videoInputs[0].label || videoInputs[0].deviceId);
        }
    } catch (e) { console.error('刷新摄像头列表失败:', e); }
}

async function switchCamera() {
    try {
        const select = document.getElementById('cfg-camera-device');
        if (!select || !select.value) return;
        // 停止旧流
        if (cameraStream) {
            cameraStream.getTracks().forEach(t => t.stop());
            cameraStream = null;
        }
        // 申请新流，使用更宽松的约束
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    deviceId: { ideal: select.value }
                }
            });
            // 不添加分辨率约束，仅打印能力与当前设置
            try {
                const track = cameraStream.getVideoTracks && cameraStream.getVideoTracks()[0];
                const getSafe = (fn) => { try { return fn(); } catch { return undefined; } };
                console.log('🎛️ 切换后 capabilities:', getSafe(() => track && track.getCapabilities && track.getCapabilities()));
                console.log('📐 切换后 settings:', getSafe(() => track && track.getSettings && track.getSettings()));
            } catch {}
        } catch (constraintError) {
            console.warn('⚠️ 使用指定设备失败，尝试使用默认设备:', constraintError);
            // 如果指定设备失败，尝试使用默认设备
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
        }
        cameraVideo = document.getElementById('camera-video') || cameraVideo;
        if (cameraVideo) {
            cameraVideo.srcObject = cameraStream;
            applyCameraPreviewRotation();
        }
        cameraInitialized = true;
        // 立即保存配置（选中摄像头）
        const cfg = appState.getConfig();
        const newCfg = {
            ...cfg,
            camera: { ...(cfg.camera || {}), deviceId: select.value }
        };
        appState.setConfig(newCfg);
        console.log('✅ 已切换并保存摄像头设备:', select.value);
    } catch (e) { console.error('切换摄像头失败:', e); }
}

function collectConfigFromForm() {
    const get = (id) => document.getElementById(id);
    const cfg = appState.getConfig();
    return {
        ...cfg,
        apiServerUrl: get('cfg-api-server-url')?.value || cfg.apiServerUrl || '',
        device: {
            ...(cfg.device || {}),
            mac: get('cfg-device-mac')?.value || appState.macAddress || ''
        },
        camera: {
            ...(cfg.camera || {}),
            deviceId: get('cfg-camera-device')?.value || cfg.camera?.deviceId || ''
        }
    };
}

window.saveConfig = async function() {
    try {
        const newCfg = collectConfigFromForm();
        appState.setConfig(newCfg);
        console.log('✅ 配置已保存到本机');
        // 保存后回到首页
        closeConfig();
        if (window.apiClient) {
            // 若API服务器地址变更，更新客户端
            if (newCfg.apiServerUrl && window.apiClient.baseUrl !== newCfg.apiServerUrl) {
                window.apiClient.baseUrl = newCfg.apiServerUrl;
            }
        }
        // 如果选择了摄像头，重新初始化摄像头以使用新配置
        if (newCfg.camera?.deviceId) {
            console.log('🔄 摄像头配置已更改，重新初始化摄像头...');
            // 反初始化当前摄像头
            deinitializeCamera();
            // 重新初始化摄像头以使用新配置
            await initializeCamera();
            console.log('✅ 摄像头已使用新配置重新初始化');
        }
    } catch (e) {
        console.error('保存配置失败:', e);
        appState.showError('保存配置失败: ' + e.message);
    }
};

// 保存照片到uploads文件夹（测试功能）
async function savePhotoToUploads(photoDataUrl, fileName) {
    try {
        // 将base64数据转换为Buffer
        const base64Data = photoDataUrl.replace(/^data:image\/jpeg;base64,/, '');
        const buffer = Buffer.from(base64Data, 'base64');
        
        // 通过IPC调用主进程保存文件
        const { ipcRenderer } = require('electron');
        const result = await ipcRenderer.invoke('save-photo-to-uploads', buffer, fileName);
        
        if (result.success) {
            console.log('✅ 照片保存成功:', result.filePath);
            return result;
        } else {
            throw new Error(result.error || '保存失败');
        }
    } catch (error) {
        console.error('❌ 保存照片到uploads文件夹失败:', error);
        throw error;
    }
}

// 将AppState类和实例挂载到window对象上，供其他脚本访问
window.AppState = AppState;
window.appState = appState;

// 添加拍照相关的全局函数
// 注意：直接将函数引用赋值给 window，而不是包装成新函数
window.capturePhotoWithCountdown = capturePhotoWithCountdown;

window.retakePhoto = function() {
    if (appState && typeof appState.retakePhoto === 'function') {
        appState.retakePhoto();
    } else {
        console.error('retakePhoto方法未定义');
    }
};

window.confirmPhoto = function() {
    if (appState && typeof appState.confirmPhoto === 'function') {
        appState.confirmPhoto();
    } else {
        console.error('confirmPhoto方法未定义');
    }
};

// 添加时尚偏好选择页面的全局函数
window.selectCustomStyle = function() {
    if (appState && typeof appState.selectCustomStyle === 'function') {
        appState.selectCustomStyle();
    } else {
        console.error('selectCustomStyle方法未定义');
    }
};

window.selectRecommendedStyle = function() {
    if (appState && typeof appState.selectRecommendedStyle === 'function') {
        appState.selectRecommendedStyle();
    } else {
        console.error('selectRecommendedStyle方法未定义');
    }
};

window.endSession = function() {
    if (appState && typeof appState.endSession === 'function') {
        appState.endSession();
    } else {
        console.error('endSession方法未定义');
    }
};

window.goBackToPhotoConfirm = function() {
    if (appState && typeof appState.goBackToPhotoConfirm === 'function') {
        appState.goBackToPhotoConfirm();
    } else {
        console.error('goBackToPhotoConfirm方法未定义');
    }
};

// 添加服装选择弹窗的全局函数
window.openClothingModal = function(category) {
    if (appState && typeof appState.openClothingModal === 'function') {
        appState.openClothingModal(category);
    } else {
        console.error('openClothingModal方法未定义');
    }
};

window.closeClothingModal = function() {
    if (appState && typeof appState.closeClothingModal === 'function') {
        appState.closeClothingModal();
    } else {
        console.error('closeClothingModal方法未定义');
    }
};

window.selectClothingInModal = function(item, category, element) {
    if (appState && typeof appState.selectClothingInModal === 'function') {
        appState.selectClothingInModal(item, category, element);
    } else {
        console.error('selectClothingInModal方法未定义');
    }
};

// 添加结果图片保持页面的全局函数
window.retakeFitting = function() {
    if (appState && typeof appState.retakeFitting === 'function') {
        appState.retakeFitting();
    } else {
        console.error('retakeFitting方法未定义');
    }
};

// 添加扫码下载图片页面的全局函数
window.continueFitting = function() {
    if (appState && typeof appState.continueFitting === 'function') {
        appState.continueFitting();
    } else {
        console.error('continueFitting方法未定义');
    }
};

window.goBackToPreference = function() {
    if (appState && typeof appState.goBackToPreference === 'function') {
        appState.goBackToPreference();
    } else {
        console.error('goBackToPreference方法未定义');
    }
};

window.goBackToClothing = function() {
    if (appState && typeof appState.goBackToClothing === 'function') {
        appState.goBackToClothing();
    } else {
        console.error('goBackToClothing方法未定义');
    }
};

window.saveImage = function() {
    if (appState && typeof appState.saveImage === 'function') {
        appState.saveImage();
    } else {
        console.error('saveImage方法未定义');
    }
};

console.log('衣等舱应用已初始化');
